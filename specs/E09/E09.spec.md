# Spec: E09 - Strategy Builder

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E09
clickup_task_id: ''
title: Strategy Builder
type: epic

# === HIERARCHY ===
parent: null
children:
  - E09-F01
  - E09-F02
  - E09-F03
  - E09-F04
epic: E09
feature: null
task: null
domain: strategy

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 70
actual_hours: 0

# === METADATA ===
tags:
  - strategy
  - composition
  - versioning
  - risk-management
effort: epic
risk: medium
---

**Status**: Draft
**Type**: Epic
**Parent**: null
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Executive Summary

Compose discovered rules into complete trading strategies with entry/exit rules, position sizing, and risk management. Organize strategies in a versioned library with full change tracking. The Strategy Builder enables traders to combine pattern discovery outputs into executable trading systems.

## Execution Flow

```
1. Create new strategy
   → Name and describe the strategy
   → Select entry rule from formula library
2. Configure exit conditions
   → Select exit rule OR set stop-loss/take-profit
   → Validate at least one exit method exists
3. Configure risk management
   → Set position size, max positions
   → Set daily loss limits (optional)
4. Validate and save
   → Check strategy completeness
   → Create version snapshot
   → Persist to repository
5. Ready for backtesting
   → Return: SUCCESS with executable strategy
```

## User Stories

### Primary User Story
**As a** trader
**I want to** compose trading strategies from discovered rules
**So that** I can create complete, executable trading systems

### Additional Stories
- **As a** trader, **I want to** select rules from a library, **So that** I can reuse proven patterns
- **As a** trader, **I want to** configure risk parameters, **So that** I can control position sizing
- **As a** trader, **I want to** track strategy versions, **So that** I can audit changes over time
- **As a** trader, **I want to** duplicate strategies, **So that** I can create variations

## Acceptance Scenarios

### Scenario 1: Happy Path - Create Strategy
**Given** valid entry rule from formula library
**When** strategy is composed with risk config
**Then** strategy is saved and ready for backtesting

### Scenario 2: Edge Case - Multiple Exit Methods
**Given** both exit rule and stop-loss configured
**When** strategy is validated
**Then** both methods are preserved (earliest triggers)

### Scenario 3: Error Case - No Exit Method
**Given** strategy without exit rule or stop-loss
**When** validate() is called
**Then** ValidationError is returned

## Requirements

### Functional Requirements
- **FR-001**: Create strategy with entry, exit, and stop-loss rules
- **FR-002**: Select rules from formula library
- **FR-003**: Configure all risk parameters
- **FR-004**: Save and load strategies
- **FR-005**: Version control for strategy changes

### Non-Functional Requirements
- **NFR-001**: Performance: < 100ms for strategy save
- **NFR-002**: Reliability: Version history never lost
- **NFR-003**: Testability: All validation rules testable

### Technical Constraints
- **TC-001**: Depends on E05 DSL Parser for rule validation
- **TC-002**: Depends on E08 Pattern Discovery for rule source
- **TC-003**: Uses DuckDB for local persistence

## Key Entities

### Entity: Strategy
- **Description**: Complete trading strategy (aggregate root)
- **Key Attributes**: id, name, entry_rule, exit_rule, stop_loss_rule, risk_config, version
- **Relationships**: Contains StrategyRule, RiskConfig

### Entity: StrategyRule
- **Description**: Rule reference within strategy
- **Key Attributes**: formula_id, expression, parameters
- **Relationships**: References Formula from E05

### Entity: RiskConfig
- **Description**: Risk management configuration
- **Key Attributes**: position_size_pct, max_positions, stop_loss_pct, take_profit_pct
- **Relationships**: Embedded in Strategy

### Entity: StrategyVersion
- **Description**: Strategy change history
- **Key Attributes**: id, strategy_id, version, snapshot, change_description
- **Relationships**: Belongs to Strategy

## Dependencies

### Upstream Dependencies
- [ ] E05: DSL Parser & Evaluator (FormulaService)
- [ ] E08: Pattern Discovery (rule source)
- [ ] E01: Qt Framework (UI patterns)
- [ ] E02: Storage Layer (DuckDB)

### Downstream Impact
- [ ] E10 (Paper Trading): Will use strategies for execution
- [ ] E11 (Execution): Will use strategies for live trading

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Performance requirements specified
- [x] Validation rules defined
- [x] UI mockups reviewed

### Quality Gates
- [ ] All features pass acceptance criteria
- [ ] 80% test coverage
- [ ] No critical bugs
- [ ] Documentation complete

## Child Specs

### Features

| ID | Title | Status | Tasks | Effort |
|----|-------|--------|-------|--------|
| [E09-F01](F01/E09-F01.spec.md) | Domain Model | Draft | 3 | M |
| [E09-F02](F02/E09-F02.spec.md) | Use Cases | Draft | 3 | M |
| [E09-F03](F03/E09-F03.spec.md) | Repository Layer | Draft | 2 | M |
| [E09-F04](F04/E09-F04.spec.md) | UI Components | Draft | 5 | L |

### Tasks by Feature

#### E09-F01: Domain Model
| ID | Title | Effort | Wave |
|----|-------|--------|------|
| [E09-F01-T01](F01/T01/E09-F01-T01.spec.md) | Define Strategy entity (aggregate root) | M | 1 |
| [E09-F01-T02](F01/T02/E09-F01-T02.spec.md) | Define StrategyRule and RiskConfig | M | 1 |
| [E09-F01-T03](F01/T03/E09-F01-T03.spec.md) | Define StrategyVersion for versioning | S | 2 |

#### E09-F02: Use Cases
| ID | Title | Effort | Wave |
|----|-------|--------|------|
| [E09-F02-T01](F02/T01/E09-F02-T01.spec.md) | Implement CreateStrategyUseCase | M | 3 |
| [E09-F02-T02](F02/T02/E09-F02-T02.spec.md) | Implement UpdateStrategyUseCase with versioning | M | 3 |
| [E09-F02-T03](F02/T03/E09-F02-T03.spec.md) | Implement StrategyLibraryUseCase | M | 3 |

#### E09-F03: Repository Layer
| ID | Title | Effort | Wave |
|----|-------|--------|------|
| [E09-F03-T01](F03/T01/E09-F03-T01.spec.md) | Implement IStrategyRepository interface | S | 2 |
| [E09-F03-T02](F03/T02/E09-F03-T02.spec.md) | Implement DuckDBStrategyRepository | M | 2 |

#### E09-F04: UI Components
| ID | Title | Effort | Wave |
|----|-------|--------|------|
| [E09-F04-T01](F04/T01/E09-F04-T01.spec.md) | Create StrategyView main layout | M | 4 |
| [E09-F04-T02](F04/T02/E09-F04-T02.spec.md) | Create StrategyListWidget | M | 4 |
| [E09-F04-T03](F04/T03/E09-F04-T03.spec.md) | Create StrategyEditorWidget | L | 4 |
| [E09-F04-T04](F04/T04/E09-F04-T04.spec.md) | Create RuleSelectorDialog | M | 4 |
| [E09-F04-T05](F04/T05/E09-F04-T05.spec.md) | Create RiskConfigWidget | M | 4 |

## Wave Analysis (Parallelization)

```
Wave 1 (Parallel - Foundation):     2 tasks
├── E09-F01-T01: Define Strategy entity [P]
└── E09-F01-T02: Define StrategyRule and RiskConfig [P]

Wave 2 (Parallel - Infrastructure): 3 tasks
├── E09-F01-T03: Define StrategyVersion (depends on T01)
├── E09-F03-T01: Implement IStrategyRepository [P]
└── E09-F03-T02: Implement DuckDBStrategyRepository [P]

Wave 3 (Parallel - Application):    3 tasks
├── E09-F02-T01: Implement CreateStrategyUseCase [P]
├── E09-F02-T02: Implement UpdateStrategyUseCase [P]
└── E09-F02-T03: Implement StrategyLibraryUseCase [P]

Wave 4 (UI - Sequential Flow):      5 tasks
├── E09-F04-T01: Create StrategyView main layout
├── E09-F04-T02: Create StrategyListWidget [P after T01]
├── E09-F04-T03: Create StrategyEditorWidget [P after T01]
├── E09-F04-T04: Create RuleSelectorDialog [after T03]
└── E09-F04-T05: Create RiskConfigWidget [after T03]
```

**Total Waves**: 4
**Max Parallelism**: 3 concurrent tasks
**Critical Path**: F01-T01 → F01-T03 → F03-T02 → F02-T01 → F04-T01 → F04-T03

## Success Criteria

### Acceptance Criteria
- [ ] Create strategy with entry, exit, and stop-loss rules
- [ ] Select rules from formula library
- [ ] Configure all risk parameters
- [ ] Save and load strategies
- [ ] Version control for strategy changes
- [ ] Entry rule required validation
- [ ] At least one exit method required validation
- [ ] Position size between 1-100% validation
- [ ] Clear validation error messages
- [ ] MockBrokerGateway enables full offline testing

### Definition of Done
- [ ] All features implemented
- [ ] All acceptance scenarios pass
- [ ] Performance targets met
- [ ] Zero critical bugs
- [ ] 80% test coverage
- [ ] Code reviewed and approved
- [ ] Documentation updated
- [ ] Deployed to staging

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| E05 DSL dependency not ready | Medium | High | Mock FormulaService |
| Complex UI layout | Medium | Low | Qt Designer prototyping |
| Version snapshot data loss | Low | High | Round-trip serialization tests |
| Formula reference breaks | Low | Medium | Validate formula_id exists |

## Notes and Clarifications

### Open Questions
- None currently

### Decisions Made
- 2025-12-30: Strategy is mutable (version increments on update)
- 2025-12-30: StrategyRule and RiskConfig are immutable (frozen)
- 2025-12-30: Use dict serialization for version snapshots
- 2025-12-30: Use DuckDB with JSON columns for nested objects

### Research Needed
- [ ] Verify E05 FormulaService API compatibility
- [ ] Test DuckDB JSON column performance

## Artifacts

### Input Documents
- [Product Requirements Document](../../docs/prd.md) Section 5.4

### Output Artifacts (to be generated)
- [ ] `E09.context.md` - Implementation context and progress
- [ ] `E09.pre-docs.md` - Pre-implementation documentation
- [ ] `E09.post-docs.md` - Post-implementation learnings

## Architecture

### Strategy Components (PRD 5.4.1)

```
┌─────────────────────────────────────────────────────────────┐
│                      TRADING STRATEGY                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Entry Rule:     rsi(14) < 30 AND close > sma(close, 20)    │
│                                                              │
│  Exit Rule:      rsi(14) > 70 OR close < sma(close, 20)     │
│                                                              │
│  Stop-Loss:      -2% from entry price                        │
│                                                              │
│  Take-Profit:    +6% from entry price                        │
│                                                              │
│  Position Size:  10% of portfolio per trade                  │
│                                                              │
│  Max Positions:  5 concurrent                                │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Component Structure

```
src/presentation/views/strategy/
├── strategy_view.py            # Main strategy view
├── strategy_list_widget.py     # Strategy library list
├── strategy_editor_widget.py   # Strategy composition editor
├── rule_selector_dialog.py     # Rule selection from library
└── risk_config_widget.py       # Risk management config
```

### UI Mockup: Strategy Editor (PRD 5.4.2, 5.4.3)

```
┌─────────────────────────────────────────────────────────────────────────┐
│ Strategy Builder                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│ Strategy Name: [RSI Momentum Strategy                    ]               │
│ Description:   [Buy oversold stocks with momentum confirmation          ]│
│                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │ Entry Rule                                            [규칙 선택 ▼] │ │
│ │                                                                       │ │
│ │ ┌─────────────────────────────────────────────────────────────────┐ │ │
│ │ │ rsi(14) < 30 AND close > sma(close, 20)                         │ │ │
│ │ └─────────────────────────────────────────────────────────────────┘ │ │
│ │ Parameters: RSI Period [14]  SMA Period [20]  RSI Threshold [30]   │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │ Exit Rule                                             [규칙 선택 ▼] │ │
│ │                                                                       │ │
│ │ ┌─────────────────────────────────────────────────────────────────┐ │ │
│ │ │ rsi(14) > 70 OR close < sma(close, 20)                          │ │ │
│ │ └─────────────────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │ Risk Management                                                      │ │
│ │                                                                       │ │
│ │ Stop-Loss:        [-2.0]% from entry price                           │ │
│ │ Take-Profit:      [+6.0]% from entry price                           │ │
│ │ Position Size:    [10]% of portfolio per trade                       │ │
│ │ Max Positions:    [5] concurrent trades                              │ │
│ │ Max Daily Loss:   [5.0]% (optional)                                  │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│                           [저장]  [백테스트 실행]  [페이퍼 트레이딩]    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## References

- PRD Section 5.4: Strategy Builder
- E05: DSL Parser & Evaluator
- E08: Pattern Discovery (rule source)

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
