# Spec: E09-F01-T02 - Define StrategyRule and RiskConfig

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E09-F01-T02
clickup_task_id: '86ew0fnzh'
title: Define StrategyRule and RiskConfig
type: task

# === HIERARCHY ===
parent: E09-F01
children: []
epic: E09
feature: F01
task: T02
domain: strategy

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags:
  - domain
  - value-object
  - strategy
  - risk
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: E09-F01
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Executive Summary

Create immutable value objects for strategy composition: StrategyRule for referencing formula library rules or custom expressions, and RiskConfig for position sizing and risk management parameters.

## Execution Flow

```
1. Create StrategyRule frozen dataclass
   → Fields: formula_id (optional), expression, parameters
   → Factory method from_formula() for library rules
   → Factory method fixed_percentage() for stop-loss/take-profit
2. Create RiskConfig frozen dataclass
   → Fields: position_size_pct, max_positions
   → Fields: stop_loss_pct, take_profit_pct, max_daily_loss_pct
   → Optional trailing_stop_pct
3. Ensure immutability
   → frozen=True for both dataclasses
   → Return: SUCCESS with value objects ready
```

## User Stories

### Primary User Story
**As a** developer
**I want to** use immutable rule and risk configuration objects
**So that** strategy composition is type-safe and consistent

## Acceptance Scenarios

### Scenario 1: Create Rule from Formula
**Given** Formula with id=1 and expression "rsi(14) < 30"
**When** StrategyRule.from_formula() is called
**Then** StrategyRule with formula_id=1 and expression is returned

### Scenario 2: Create Fixed Percentage Rule
**Given** stop-loss of -2%
**When** StrategyRule.fixed_percentage(-2.0) is called
**Then** StrategyRule with expression "FIXED_PCT:-2.0" is returned

### Scenario 3: Create Risk Config
**Given** position_size=10, max_positions=5
**When** RiskConfig is created
**Then** all fields are accessible and object is immutable

## Requirements

### Functional Requirements
- **FR-001**: StrategyRule frozen dataclass with formula reference
- **FR-002**: StrategyRule.from_formula() factory method
- **FR-003**: StrategyRule.fixed_percentage() factory method
- **FR-004**: RiskConfig frozen dataclass with all risk parameters

### Non-Functional Requirements
- **NFR-001**: Immutable (frozen=True)
- **NFR-002**: Use Decimal for percentage values
- **NFR-003**: Type hints on all fields

### Technical Constraints
- **TC-001**: Python dataclass with frozen=True
- **TC-002**: Use decimal.Decimal for percentages

## Dependencies

### Upstream Dependencies
- None (can be implemented in parallel with T01)

### Downstream Impact
- [ ] E09-F01-T01: Strategy uses these value objects
- [ ] E09-F02: Use cases construct these objects

## Gate Checks

### Pre-Implementation Gates
- [x] Fields defined in E09 spec
- [x] Factory methods defined

### Quality Gates
- [ ] Unit tests for factory methods
- [ ] Immutability tests
- [ ] Test coverage > 80%

## Success Criteria

### Acceptance Criteria
- [ ] StrategyRule implemented with factories
- [ ] RiskConfig implemented
- [ ] Both are immutable
- [ ] Tests passing

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Documentation complete

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Decimal conversion errors | Low | Medium | Consistent Decimal usage |

## Artifacts

### Input Documents
- [Parent Feature](../E09-F01.spec.md)
- [Epic Section 3.1](../../E09.spec.md)

### Output Artifacts
- `src/domain/entities/strategy_rule.py`
- `src/domain/entities/risk_config.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
