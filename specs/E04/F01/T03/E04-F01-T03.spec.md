---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E04-F01-T03
clickup_task_id: '86ew020d6'
title: Define ICollectionJobRepository Interface
type: task

# === HIERARCHY ===
parent: E04-F01
children: []
epic: E04
feature: F01
task: T03
domain: data-collection

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-01-15'
updated: '2025-01-15'
due_date: ''
estimated_hours: 2
actual_hours: 0

# === METADATA ===
tags: [domain-model, repository, interface, ddd]
effort: small
risk: low
---

# Spec: E04-F01-T03 - Define ICollectionJobRepository Interface

**Status**: Draft
**Type**: Task
**Parent**: E04-F01
**Created**: 2025-01-15
**Updated**: 2025-01-15

## Executive Summary

Define the abstract repository interface for CollectionJob persistence. This interface follows the Repository pattern from DDD, defining the contract for CRUD operations and queries while allowing infrastructure implementations to be swapped without affecting domain logic.

## Execution Flow

```
1. Create abstract base class
   → Import ABC, abstractmethod
   → Define ICollectionJobRepository(ABC)

2. Define CRUD methods
   → save(job: CollectionJob) -> None
   → get_by_id(job_id: str) -> Optional[CollectionJob]
   → delete(job_id: str) -> bool

3. Define query methods
   → list_by_status(status: JobStatus, limit, offset) -> list[CollectionJob]
   → list_recent(limit, since) -> list[CollectionJob]
   → get_running_jobs() -> list[CollectionJob]

4. Define atomic update methods
   → update_status(job_id, status, error_message) -> bool
   → add_failed_symbol(job_id, symbol, error) -> None
   → get_stats(job_id) -> Optional[JobStats]

5. Define JobStats dataclass
   → total, completed, failed, total_candles
```

## User Stories

### Primary User Story
**As a** developer implementing persistence
**I want to** a clear repository interface contract
**So that** I can implement storage without domain coupling

## Acceptance Scenarios

### Scenario 1: Interface Completeness
**Given** the ICollectionJobRepository interface
**When** implementing a concrete repository
**Then** all required methods are defined for full job lifecycle

### Scenario 2: Mock Implementation
**Given** the interface
**When** creating InMemoryCollectionJobRepository for tests
**Then** all methods can be easily implemented with dict storage

## Requirements

### Functional Requirements
- **FR-001**: Interface MUST define async save method
- **FR-002**: Interface MUST define async get_by_id method
- **FR-003**: Interface MUST define query methods for filtering
- **FR-004**: Interface MUST define atomic status update method
- **FR-005**: Interface MUST define failed symbol tracking method
- **FR-006**: JobStats MUST aggregate job statistics

### Technical Constraints
- **TC-001**: Must use ABC and abstractmethod
- **TC-002**: All methods must be async
- **TC-003**: No implementation details in interface

## Key Entities

### Entity: ICollectionJobRepository
- **Description**: Abstract repository interface
- **Methods**: save, get_by_id, delete, list_by_status, list_recent, get_running_jobs, update_status, add_failed_symbol, get_stats

### Entity: JobStats
- **Description**: Aggregated statistics for a job
- **Key Attributes**: total, completed, failed, total_candles

## Dependencies

### Upstream Dependencies
- [x] E04-F01-T01: CollectionJob entity

### Downstream Impact
- [ ] E04-F02: Uses repository for job persistence
- [ ] Infrastructure: Implements interface

## Success Criteria

### Acceptance Criteria
- [ ] All CRUD operations defined
- [ ] Query methods for filtering defined
- [ ] Atomic update methods defined
- [ ] JobStats dataclass created

### Definition of Done
- [ ] ABC interface complete
- [ ] All methods abstract
- [ ] Full type hints
- [ ] Mock implementation for testing

## Artifacts

### Output Files
```
src/domain/repositories/
├── __init__.py
└── collection_job_repository.py  # ICollectionJobRepository, JobStats

tests/mocks/
└── collection_job_repository.py  # InMemoryCollectionJobRepository
```

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
