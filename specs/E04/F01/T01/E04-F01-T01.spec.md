---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E04-F01-T01
clickup_task_id: '86ew020d1'
title: Create CollectionJob Entity
type: task

# === HIERARCHY ===
parent: E04-F01
children: []
epic: E04
feature: F01
task: T01
domain: data-collection

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-01-15'
updated: '2025-01-15'
due_date: ''
estimated_hours: 2
actual_hours: 0

# === METADATA ===
tags: [domain-model, entity, aggregate-root, state-machine]
effort: small
risk: low
---

# Spec: E04-F01-T01 - Create CollectionJob Entity

**Status**: Draft
**Type**: Task
**Parent**: E04-F01
**Created**: 2025-01-15
**Updated**: 2025-01-15

## Executive Summary

Implement the CollectionJob aggregate root entity that represents a data collection job. This is the central domain entity managing collection job lifecycle with state transitions, validation rules, and business logic.

## Execution Flow

```
1. Create JobStatus enum
   → Define states: PENDING, RUNNING, PAUSED, COMPLETED, FAILED, CANCELLED
   → Use Python Enum class

2. Create CollectionOptions value object
   → Frozen dataclass with defaults
   → Validate: max_retries >= 0
   → Validate: batch_size > 0
   → If validation fails: ERROR "Invalid option value"

3. Create CollectionJob dataclass
   → All required fields with type hints
   → Optional fields with defaults
   → Validate: start_date <= end_date
   → Validate: symbols list not empty

4. Implement state transition methods
   → start(): PENDING → RUNNING, set started_at
   → pause(): RUNNING → PAUSED
   → resume(): PAUSED → RUNNING
   → complete(): RUNNING → COMPLETED, set completed_at
   → fail(message): * → FAILED, set error_message
   → If invalid transition: ERROR "Cannot transition from {current} to {target}"
```

## User Stories

### Primary User Story
**As a** developer implementing collection features
**I want to** a CollectionJob entity with proper lifecycle management
**So that** I can track and control data collection jobs reliably

## Acceptance Scenarios

### Scenario 1: Valid State Transition
**Given** a CollectionJob in PENDING state
**When** start() is called
**Then** status becomes RUNNING and started_at is set to current time

### Scenario 2: Invalid State Transition
**Given** a CollectionJob in COMPLETED state
**When** start() is called
**Then** ValueError is raised with message "Cannot start job in COMPLETED state"

### Scenario 3: Validation on Creation
**Given** invalid date range (start > end)
**When** CollectionJob is created
**Then** ValueError is raised with message "start_date must be before end_date"

## Requirements

### Functional Requirements
- **FR-001**: Entity MUST track job lifecycle through JobStatus enum
- **FR-002**: Entity MUST enforce valid state transitions
- **FR-003**: Entity MUST validate date range on creation
- **FR-004**: Entity MUST validate symbols list is not empty
- **FR-005**: CollectionOptions MUST validate max_retries and batch_size

### Technical Constraints
- **TC-001**: Must use Python dataclass
- **TC-002**: No infrastructure dependencies (pure domain)
- **TC-003**: Full type hints required

## Key Entities

### Entity: CollectionJob
- **Description**: Aggregate root for collection job
- **Key Attributes**: id, broker_id, symbols[], timeframe, start_date, end_date, options, status, created_at, started_at, completed_at, failed_symbols[], error_message
- **State Machine**: PENDING → RUNNING ↔ PAUSED → COMPLETED/FAILED/CANCELLED

## Dependencies

### Upstream Dependencies
- None (foundation entity)

### Downstream Impact
- [ ] E04-F01-T02: Uses JobStatus
- [ ] E04-F02: Uses CollectionJob

## Success Criteria

### Acceptance Criteria
- [ ] JobStatus enum with all states
- [ ] CollectionOptions with validation
- [ ] CollectionJob with all fields
- [ ] State transition methods working
- [ ] is_terminal property correct

### Definition of Done
- [ ] Unit tests for entity creation
- [ ] Tests for all state transitions
- [ ] Tests for validation errors
- [ ] 100% type coverage

## Artifacts

### Output Files
```
src/domain/entities/
├── __init__.py
└── collection_job.py  # JobStatus, CollectionOptions, CollectionJob
```

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
