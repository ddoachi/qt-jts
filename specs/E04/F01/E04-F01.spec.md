---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E04-F01
clickup_task_id: ''
title: Domain Model
type: feature

# === HIERARCHY ===
parent: E04
children: [E04-F01-T01, E04-F01-T02, E04-F01-T03]
epic: E04
feature: F01
domain: data-collection

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-01-15'
updated: '2025-01-15'
due_date: ''
estimated_hours: 8
actual_hours: 0

# === METADATA ===
tags: [domain-model, ddd, entities, value-objects]
effort: small
risk: low
---

# Spec: E04-F01 - Domain Model

**Status**: Draft
**Type**: Feature
**Parent**: E04
**Created**: 2025-01-15
**Updated**: 2025-01-15

## Executive Summary

Define the core domain entities and interfaces for the historical data collection feature. This feature establishes the foundational domain model following DDD principles, including CollectionJob aggregate root, CollectionProgress value object, and repository interfaces to enable testable and maintainable data collection operations.

## Execution Flow

```
1. Define CollectionJob aggregate root
   → Create dataclass with all required fields
   → Implement JobStatus enum for lifecycle states
   → Add state transition methods (start, pause, resume, complete, fail)
   → If invalid transition: ERROR "Cannot transition from {current} to {target}"

2. Define CollectionProgress value object
   → Create frozen dataclass (immutable)
   → Implement calculated properties (progress_pct, rate, estimated_remaining)
   → Validate input ranges

3. Define CollectionOptions value object
   → Create frozen dataclass with defaults
   → Validate max_retries >= 0
   → Validate batch_size > 0

4. Define ICollectionJobRepository interface
   → Abstract CRUD operations
   → Query methods (by status, recent, running)
   → Atomic update methods
   → Return: SUCCESS with complete domain model
```

## User Stories

### Primary User Story
**As a** developer implementing collection features
**I want to** have well-defined domain entities with clear contracts
**So that** I can build reliable collection functionality with proper encapsulation

### Additional Stories
- **As a** developer, **I want to** immutable value objects, **So that** I avoid state mutation bugs
- **As a** tester, **I want to** entities without infrastructure dependencies, **So that** I can unit test in isolation

## Acceptance Scenarios

### Scenario 1: Job State Transitions
**Given** a CollectionJob in PENDING state
**When** start() is called
**Then** status changes to RUNNING and started_at is set

### Scenario 2: Invalid State Transition
**Given** a CollectionJob in COMPLETED state
**When** start() is called
**Then** ValueError is raised with descriptive message

### Scenario 3: Progress Calculation
**Given** a CollectionProgress with 50 completed out of 100 total
**When** progress_pct is accessed
**Then** returns 50.0

## Requirements

### Functional Requirements
- **FR-001**: CollectionJob MUST track lifecycle states (PENDING, RUNNING, PAUSED, COMPLETED, FAILED, CANCELLED)
- **FR-002**: CollectionJob MUST enforce valid state transitions
- **FR-003**: CollectionProgress MUST calculate progress percentage accurately
- **FR-004**: CollectionProgress MUST estimate remaining time based on rate
- **FR-005**: CollectionOptions MUST validate input ranges
- **FR-006**: ICollectionJobRepository MUST define async CRUD operations

### Non-Functional Requirements
- **NFR-001**: All entities MUST have full type hints
- **NFR-002**: Value objects MUST be immutable (frozen dataclass)
- **NFR-003**: No infrastructure dependencies in domain layer

### Technical Constraints
- **TC-001**: Must use Python dataclasses
- **TC-002**: Must follow DDD patterns from E01
- **TC-003**: No Qt or database imports in domain layer

## Key Entities

### Entity: CollectionJob
- **Description**: Data collection job aggregate root managing lifecycle
- **Key Attributes**: id, broker_id, symbols[], timeframe, start_date, end_date, status, options, created_at, started_at, completed_at, failed_symbols[], error_message
- **Relationships**: Contains CollectionOptions, produces CollectionProgress snapshots

### Entity: CollectionProgress
- **Description**: Immutable snapshot of job progress
- **Key Attributes**: job_id, total_symbols, completed_symbols, failed_symbols, total_candles, elapsed_seconds, current_symbol
- **Relationships**: Belongs to CollectionJob

### Entity: CollectionOptions
- **Description**: Configuration value object for collection behavior
- **Key Attributes**: incremental, retry_failed, include_delisted, max_retries, batch_size
- **Relationships**: Embedded in CollectionJob

## Dependencies

### Upstream Dependencies
- [x] E02: Storage concepts for repository pattern

### Downstream Impact
- [ ] E04-F02: Collection Execution depends on these entities
- [ ] E04-F03: Progress Monitoring uses CollectionProgress

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] All entity attributes defined
- [x] State machine transitions documented

### Quality Gates
- [ ] All entities testable in isolation
- [ ] No circular dependencies
- [ ] Type hints complete

## Tasks Preview

### Implementation Tasks
- [ ] E04-F01-T01 [P] Create CollectionJob entity with state machine
- [ ] E04-F01-T02 [P] Create CollectionProgress value object
- [ ] E04-F01-T03 [P] Define ICollectionJobRepository interface

**[P]** = Can be executed in parallel

## Success Criteria

### Acceptance Criteria
- [ ] CollectionJob entity with full lifecycle management
- [ ] CollectionProgress correctly calculates all metrics
- [ ] CollectionOptions validates input ranges
- [ ] ICollectionJobRepository defines all required operations

### Definition of Done
- [ ] Unit tests for all entity behaviors
- [ ] State machine transition tests
- [ ] No infrastructure dependencies
- [ ] Full type hints on all public interfaces

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Overly complex state machine | Low | Medium | Keep states minimal, document transitions |
| Missing validation rules | Low | Low | TDD approach catches gaps early |

## Notes and Clarifications

### Decisions Made
- 2025-01-15: Using frozen dataclass for value objects
- 2025-01-15: JobStatus as Enum for type safety

## Artifacts

### Input Documents
- [E04 Epic](../E04.spec.md)
- DDD patterns reference

### Output Artifacts
- [ ] `E04-F01.context.md` - Implementation progress
- [ ] `E04-F01.pre-docs.md` - Pre-implementation planning

### Children Specs
| ID | Title | Effort |
|----|-------|--------|
| [E04-F01-T01](T01/E04-F01-T01.spec.md) | Create CollectionJob Entity | S |
| [E04-F01-T02](T02/E04-F01-T02.spec.md) | Create CollectionProgress Value Object | S |
| [E04-F01-T03](T03/E04-F01-T03.spec.md) | Define ICollectionJobRepository Interface | S |

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
