---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E04-F02-T02
clickup_task_id: '86ew020da'
title: Implement Collection Worker with Rate Limiting
type: task

# === HIERARCHY ===
parent: E04-F02
children: []
epic: E04
feature: F02
task: T02
domain: data-collection

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-01-15'
updated: '2025-01-15'
due_date: ''
estimated_hours: 8
actual_hours: 0

# === METADATA ===
tags: [worker, rate-limiting, async, background]
effort: large
risk: medium
---

# Spec: E04-F02-T02 - Implement Collection Worker with Rate Limiting

**Status**: Draft
**Type**: Task
**Parent**: E04-F02
**Created**: 2025-01-15
**Updated**: 2025-01-15

## Executive Summary

Implement the background worker that executes data collection jobs with rate limiting. Uses token bucket algorithm to respect broker API limits, processes symbols in batches, handles pause/resume signals, and emits progress events for real-time monitoring.

## Execution Flow

```
1. Start worker execution
   → Mark job as RUNNING
   → Set started_at timestamp
   → Persist to repository

2. Process symbols in batches
   → For each batch (configurable size):
     → Check shutdown_event (graceful stop)
     → Wait on pause_event (pause/resume)
     → For each symbol in batch:
       → Acquire rate limit token (blocking)
       → Fetch candles from broker
       → Validate candle data
       → Save to candle repository
       → Track completed count
     → Emit progress event

3. Handle errors per symbol
   → Catch exception
   → Add to failed_symbols list
   → If too many failures: pause job
   → Continue with next symbol

4. Complete job
   → If shutdown: status = PAUSED
   → If too many failures: status = FAILED
   → Else: status = COMPLETED
   → Set completed_at
   → Persist final state
```

## User Stories

### Primary User Story
**As a** system
**I want to** process collection jobs reliably in background
**So that** users can continue working while data downloads

## Acceptance Scenarios

### Scenario 1: Rate Limit Compliance
**Given** broker rate limit is 15 req/sec
**When** worker processes 100 symbols
**Then** request rate never exceeds 15 req/sec

### Scenario 2: Pause Signal
**Given** worker is processing symbols
**When** pause() is called
**Then** worker finishes current symbol and waits

### Scenario 3: Graceful Shutdown
**Given** worker is processing symbols
**When** shutdown() is called
**Then** worker stops within 1 second and saves state

### Scenario 4: Progress Events
**Given** batch_size is 10
**When** 10 symbols are processed
**Then** progress event is emitted with updated counts

## Requirements

### Functional Requirements
- **FR-001**: Worker MUST acquire rate limit token before each API call
- **FR-002**: Worker MUST process in configurable batch sizes
- **FR-003**: Worker MUST emit progress after each batch
- **FR-004**: Worker MUST support pause/resume via events
- **FR-005**: Worker MUST handle shutdown gracefully

### Non-Functional Requirements
- **NFR-001**: Zero rate limit violations
- **NFR-002**: Shutdown within 1 second
- **NFR-003**: Memory proportional to batch size

### Technical Constraints
- **TC-001**: Must use asyncio.Event for pause/shutdown
- **TC-002**: Must use token bucket for rate limiting
- **TC-003**: Must be testable with mock dependencies

## Key Entities

### Entity: CollectionWorker
- **Key Attributes**: job_repo, broker_gateway, candle_repo, rate_limiter, event_emitter
- **Methods**: run(job), pause(), resume(), shutdown()

### Entity: IRateLimiter
- **Methods**: acquire(tokens=1) - blocking token acquisition

## Dependencies

### Upstream Dependencies
- [x] E04-F02-T01: StartCollectionUseCase dispatches jobs
- [x] E03: Rate limiter, broker gateway

### Downstream Impact
- [ ] E04-F02-T03: Uses for retry logic
- [ ] E04-F03: Receives progress events

## Success Criteria

### Acceptance Criteria
- [ ] Rate limiting works correctly
- [ ] Batch processing with progress
- [ ] Pause/resume signals handled
- [ ] Graceful shutdown working
- [ ] Errors tracked per symbol

### Definition of Done
- [ ] Unit tests with mock broker
- [ ] Rate limit compliance tests
- [ ] Pause/resume tests
- [ ] Integration test

## Artifacts

### Output Files
```
src/application/workers/
└── collection_worker.py

src/application/services/
└── rate_limiter.py  # If not in E03
```

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
