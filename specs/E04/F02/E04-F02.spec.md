---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E04-F02
clickup_task_id: ''
title: Collection Execution
type: feature

# === HIERARCHY ===
parent: E04
children: [E04-F02-T01, E04-F02-T02, E04-F02-T03]
epic: E04
feature: F02
domain: data-collection

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-01-15'
updated: '2025-01-15'
due_date: ''
estimated_hours: 24
actual_hours: 0

# === METADATA ===
tags: [collection, rate-limiting, async, worker]
effort: large
risk: medium
---

# Spec: E04-F02 - Collection Execution

**Status**: Draft
**Type**: Feature
**Parent**: E04
**Created**: 2025-01-15
**Updated**: 2025-01-15

## Executive Summary

Implement the core data collection engine that fetches historical OHLCV candle data from brokers. This feature handles rate limiting via token bucket algorithm, batch processing, error recovery with exponential backoff retry logic, and background worker dispatch for robust bulk data collection.

## Execution Flow

```
1. Start Collection Use Case
   → Resolve symbols from market/sector criteria
   → If no symbols: ERROR "No symbols found matching criteria"
   → If incremental: filter already-collected symbols
   → If all collected: ERROR "All data already collected"
   → Create CollectionJob entity
   → Persist job to repository
   → Dispatch to background worker

2. Worker Execution
   → Mark job as RUNNING
   → For each batch of symbols:
     → Wait if paused
     → For each symbol in batch:
       → Acquire rate limit token (blocking)
       → Fetch candles from broker gateway
       → Validate candle data
       → Save to candle repository
       → Update progress
     → If rate limit exceeded: WARN "Rate limit hit, backing off"
     → Emit progress event

3. Error Handling
   → Classify error (transient vs permanent)
   → If transient: add to retry queue with exponential backoff
   → If permanent: mark symbol as failed
   → If too many failures: pause job

4. Completion
   → Process retry queue
   → Mark job as COMPLETED or FAILED
   → Return: SUCCESS with collection summary
```

## User Stories

### Primary User Story
**As a** trader
**I want to** download years of historical data for thousands of symbols
**So that** I can backtest strategies on comprehensive historical data

### Additional Stories
- **As a** trader, **I want to** never get blocked by broker API, **So that** my account remains in good standing
- **As a** trader, **I want to** failed symbols retried automatically, **So that** I get maximum data coverage

## Acceptance Scenarios

### Scenario 1: Successful Collection
**Given** user requests collection for 100 symbols
**When** collection completes
**Then** all 100 symbols have data saved and job status is COMPLETED

### Scenario 2: Rate Limit Compliance
**Given** broker rate limit is 15 req/sec
**When** worker processes symbols
**Then** request rate never exceeds 15 req/sec

### Scenario 3: Retry on Failure
**Given** a symbol fails with timeout error
**When** retry policy is applied
**Then** symbol is retried up to max_retries times with exponential backoff

### Scenario 4: Incremental Mode
**Given** symbol already has data up to yesterday
**When** incremental collection runs
**Then** only today's data is fetched

## Requirements

### Functional Requirements
- **FR-001**: System MUST resolve symbols from market/sector criteria
- **FR-002**: System MUST filter already-collected symbols in incremental mode
- **FR-003**: System MUST respect broker rate limits using token bucket
- **FR-004**: System MUST process symbols in configurable batch sizes
- **FR-005**: System MUST retry transient failures with exponential backoff
- **FR-006**: System MUST emit progress events after each batch

### Non-Functional Requirements
- **NFR-001**: Performance: Process 2,500 symbols in < 4 hours
- **NFR-002**: Reliability: Zero rate limit violations
- **NFR-003**: Memory: Usage proportional to batch size only

### Technical Constraints
- **TC-001**: Must use E03 rate limiter and broker gateway
- **TC-002**: Must use E02 candle repository for storage
- **TC-003**: Must use async/await for I/O operations

## Key Entities

### Entity: StartCollectionRequest
- **Description**: Request DTO for starting collection
- **Key Attributes**: broker_id, markets[], sectors[], symbols[], timeframe, start_date, end_date, options

### Entity: CollectionWorker
- **Description**: Background worker processing collection jobs
- **Key Attributes**: job_repo, broker_gateway, candle_repo, rate_limiter, event_emitter
- **Relationships**: Processes CollectionJob, uses RetryManager

### Entity: RetryManager
- **Description**: Manages retry queue with exponential backoff
- **Key Attributes**: policy, queue[], stats
- **Relationships**: Works with CollectionWorker

## Dependencies

### Upstream Dependencies
- [x] E04-F01: Domain Model - CollectionJob, CollectionProgress entities
- [x] E03: Broker Integration - Rate limiter, broker gateway
- [x] E02: Storage Layer - Candle repository

### Downstream Impact
- [ ] E04-F03: Progress Monitoring consumes progress events
- [ ] E04-F05: UI displays collection progress

## Gate Checks

### Pre-Implementation Gates
- [x] Rate limiting strategy defined (token bucket)
- [x] Retry policy defined (exponential backoff)
- [x] Batch size configurable

### Quality Gates
- [ ] Rate limit never exceeded in tests
- [ ] All error paths have retry logic
- [ ] Memory usage validated

## Tasks Preview

### Implementation Tasks
- [ ] E04-F02-T01 Implement StartCollectionUseCase
- [ ] E04-F02-T02 Implement CollectionWorker with rate limiting (depends on T01)
- [ ] E04-F02-T03 Implement RetryManager with exponential backoff (depends on T02)

## Success Criteria

### Acceptance Criteria
- [ ] Collection job starts and runs in background
- [ ] Rate limiting prevents broker API blocks
- [ ] Failed symbols are tracked and retried
- [ ] Incremental mode skips existing data
- [ ] Job can be paused and resumed

### Definition of Done
- [ ] Unit tests with mock broker gateway
- [ ] Integration tests for full collection flow
- [ ] Test coverage > 80%
- [ ] Performance validated (2500 symbols < 4 hours)

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Rate limit exceeded | Medium | High | Conservative rate limit with 80% safety margin |
| Memory exhaustion | Low | Medium | Streaming batch processing |
| Network timeouts | Medium | Low | Retry with exponential backoff |

## Notes and Clarifications

### Decisions Made
- 2025-01-15: Token bucket algorithm for rate limiting
- 2025-01-15: Exponential backoff with jitter for retries
- 2025-01-15: Batch size default: 100 symbols

## Artifacts

### Input Documents
- [E04 Epic](../E04.spec.md)
- [E04-F01 Domain Model](../F01/E04-F01.spec.md)

### Output Artifacts
- [ ] `E04-F02.context.md` - Implementation progress
- [ ] `E04-F02.pre-docs.md` - Pre-implementation planning

### Children Specs
| ID | Title | Effort |
|----|-------|--------|
| [E04-F02-T01](T01/E04-F02-T01.spec.md) | Implement StartCollectionUseCase | L |
| [E04-F02-T02](T02/E04-F02-T02.spec.md) | Implement Collection Worker with Rate Limiting | L |
| [E04-F02-T03](T03/E04-F02-T03.spec.md) | Implement Retry Logic | M |

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
