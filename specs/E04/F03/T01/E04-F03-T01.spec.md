---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E04-F03-T01
clickup_task_id: '86ew020dg'
title: Implement GetCollectionProgressUseCase
type: task

# === HIERARCHY ===
parent: E04-F03
children: []
epic: E04
feature: F03
task: T01
domain: data-collection

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-01-15'
updated: '2025-01-15'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [use-case, progress, real-time, monitoring]
effort: medium
risk: low
---

# Spec: E04-F03-T01 - Implement GetCollectionProgressUseCase

**Status**: Draft
**Type**: Task
**Parent**: E04-F03
**Created**: 2025-01-15
**Updated**: 2025-01-15

## Executive Summary

Implement the use case for querying real-time collection progress. This provides accurate metrics including completion percentage, processing rate, and estimated time remaining for monitoring UI components.

## Execution Flow

```
1. Receive job_id for progress query
   → Validate job exists in repository
   → If not found: ERROR "Job not found"

2. Retrieve job and current stats
   → Get job entity from repository
   → Get current statistics from progress tracker

3. Calculate elapsed time
   → If started_at exists: elapsed = now - started_at
   → Else: elapsed = 0

4. Build CollectionProgress snapshot
   → Populate all metrics from job and stats
   → Return immutable progress object
```

## User Stories

### Primary User Story
**As a** developer implementing progress UI
**I want to** accurate progress calculations from an immutable snapshot
**So that** I can display reliable progress information

## Acceptance Scenarios

### Scenario 1: Progress for Running Job
**Given** a job with 100 symbols, 50 completed
**When** GetCollectionProgressUseCase.execute() is called
**Then** returns CollectionProgress with 50% progress

### Scenario 2: Job Not Found
**Given** a non-existent job ID
**When** execute() is called
**Then** raises JobNotFoundError

### Scenario 3: Accurate Time Estimation
**Given** 50 symbols completed in 50 seconds, 50 remaining
**When** progress is calculated
**Then** estimated_remaining_seconds is approximately 50

## Requirements

### Functional Requirements
- **FR-001**: Use case MUST return accurate progress percentage
- **FR-002**: Use case MUST calculate processing rate correctly
- **FR-003**: Use case MUST estimate remaining time reasonably
- **FR-004**: Use case MUST return immutable progress snapshot
- **FR-005**: Progress query MUST be non-blocking

### Non-Functional Requirements
- **NFR-001**: Progress query must complete in < 10ms
- **NFR-002**: No blocking during progress calculation

### Technical Constraints
- **TC-001**: Must use async/await
- **TC-002**: Must return CollectionProgress value object
- **TC-003**: Must handle all job states gracefully

## Key Entities

### Entity: GetCollectionProgressUseCase
- **Key Attributes**: job_repo, progress_tracker
- **Methods**: execute(job_id) -> CollectionProgress

### Entity: IProgressTracker
- **Description**: Interface for real-time progress tracking
- **Methods**: get_stats(job_id), update(job_id, symbol, candles, success)

### Entity: ProgressStats
- **Key Attributes**: completed, failed, total_candles, current_symbol

## Dependencies

### Upstream Dependencies
- [x] E04-F01-T02: CollectionProgress value object
- [x] E04-F01-T03: ICollectionJobRepository interface

### Downstream Impact
- [ ] E04-F05-T02: CollectionProgressWidget consumes progress

## Success Criteria

### Acceptance Criteria
- [ ] Returns accurate progress metrics
- [ ] Calculates rate correctly
- [ ] Estimates remaining time reasonably
- [ ] Handles job not found error
- [ ] Works for all job states

### Definition of Done
- [ ] Unit tests for calculations
- [ ] Edge cases: just started, nearly complete
- [ ] Error cases: invalid job ID
- [ ] Performance tested

## Artifacts

### Output Files
```
src/application/use_cases/
└── get_collection_progress.py

src/application/services/
└── progress_tracker.py  # IProgressTracker, ProgressStats
```

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
