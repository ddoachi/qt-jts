# Spec: E12-F03-T02 - Implement Position Price Updates

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E12-F03-T02
clickup_task_id: ''
title: Implement Position Price Updates
type: task

# === HIERARCHY ===
parent: E12-F03
children: []
epic: E12
feature: F03
task: T02
domain: paper-trading

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 5
actual_hours: 0

# === METADATA ===
tags:
  - position
  - price-update
  - pnl
  - real-time
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: E12-F03
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Executive Summary

Implement position price update logic that updates VirtualPosition.current_price when new quotes arrive. Automatically recalculates unrealized P&L and emits portfolio update events for UI refresh.

## Execution Flow

```
1. Update position price on quote
   → Check if symbol in portfolio.positions
   → Update position.current_price
   → P&L auto-recalculates via property
2. Track day P&L changes
   → Store day start values
   → Calculate day_pnl difference
   → Update portfolio.day_pnl
3. Emit portfolio update event
   → Notify UI of changes
   → Include updated totals
   → Return: SUCCESS with updates working
```

## User Stories

### Primary User Story
**As a** trader
**I want to** see real-time position values
**So that** I can monitor my virtual portfolio performance

## Acceptance Scenarios

### Scenario 1: Update Position Price
**Given** position in 005930 with current_price=71000
**When** new quote arrives with price=72500
**Then** position.current_price becomes 72500

### Scenario 2: Automatic P&L Recalculation
**Given** position updated to new price
**Then** unrealized_pnl and unrealized_pnl_pct reflect new values

### Scenario 3: Portfolio Total Value Update
**Given** position prices updated
**Then** portfolio.total_value reflects new totals

### Scenario 4: Day P&L Tracking
**Given** position started day at 71000, now 72500
**Then** day_pnl reflects today's gain

## Requirements

### Functional Requirements
- **FR-001**: Update position.current_price on quote
- **FR-002**: P&L auto-recalculates
- **FR-003**: Day P&L tracking
- **FR-004**: Portfolio update events

### Non-Functional Requirements
- **NFR-001**: Price updates within 1 second
- **NFR-002**: Thread-safe updates

### Technical Constraints
- **TC-001**: Decimal arithmetic
- **TC-002**: Event-driven updates

## Dependencies

### Upstream Dependencies
- [ ] E12-F03-T01: Subscription provides quotes
- [ ] E12-F01-T02: Portfolio entities

### Downstream Impact
- [ ] E12-F04-T02: UI displays updated values

## Gate Checks

### Pre-Implementation Gates
- [x] Subscription implemented
- [x] Portfolio entities defined

### Quality Gates
- [ ] Unit tests for price updates
- [ ] Test coverage > 80%

## Success Criteria

### Acceptance Criteria
- [ ] Prices update correctly
- [ ] P&L calculations accurate
- [ ] Day P&L tracking works
- [ ] Events emitted

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Documentation complete

## Artifacts

### Input Documents
- [Parent Feature](../E12-F03.spec.md)

### Output Artifacts
- Updated `src/services/paper_trading/runner.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
