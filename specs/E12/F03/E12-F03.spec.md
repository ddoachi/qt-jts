# Spec: E12-F03 - Real-Time Data Integration

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E12-F03
clickup_task_id: ''
title: Real-Time Data Integration
type: feature

# === HIERARCHY ===
parent: E12
children:
  - E12-F03-T01
  - E12-F03-T02
epic: E12
feature: F03
task: null
domain: paper-trading

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 10
actual_hours: 0

# === METADATA ===
tags:
  - real-time
  - market-data
  - broker
  - grpc
effort: medium
risk: medium
---

**Status**: Draft
**Type**: Feature
**Parent**: E12
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Executive Summary

Integrate real-time market data from broker gateways for paper trading sessions. Implement subscription management for symbol watchlists and position price updates. This feature ensures paper trading reflects actual market conditions with proper rate limiting.

## Execution Flow

```
1. Implement real-time data subscription
   → Subscribe to broker quote stream
   → Respect rate limits (15-20 req/sec)
   → Handle reconnection on disconnect
2. Implement position price updates
   → Update VirtualPosition.current_price on quote
   → Recalculate unrealized P&L
   → Emit portfolio update events
   → Return: SUCCESS with real-time data flowing
```

## User Stories

### Primary User Story
**As a** trader
**I want to** see real-time prices in my paper trading session
**So that** my virtual positions reflect actual market conditions

### Additional Stories
- **As a** trader, **I want to** auto-update position values, **So that** I can see current P&L
- **As a** developer, **I want to** handle broker disconnections, **So that** the session recovers gracefully

## Acceptance Scenarios

### Scenario 1: Subscribe to Symbol Quotes
**Given** session with symbols [005930, 000660, 035720]
**When** session starts
**Then** broker gateway subscribes to all symbols

### Scenario 2: Update Position Price
**Given** position in 005930 with current_price=71000
**When** new quote arrives with price=72500
**Then** position.current_price updates to 72500 and P&L recalculates

### Scenario 3: Handle Disconnection
**Given** active subscription
**When** broker connection drops
**Then** reconnect and resubscribe automatically

## Requirements

### Functional Requirements
- **FR-001**: Subscribe to quote stream for session symbols
- **FR-002**: Update position prices on new quotes
- **FR-003**: Handle broker disconnection/reconnection
- **FR-004**: Respect broker rate limits

### Non-Functional Requirements
- **NFR-001**: Price updates within 1 second
- **NFR-002**: No data loss during pause
- **NFR-003**: Memory-efficient streaming

### Technical Constraints
- **TC-001**: Use gRPC streaming from E03
- **TC-002**: Rate limit: 15 req/sec (Creon), 20 req/sec (eBest)
- **TC-003**: Async subscription handling

## Dependencies

### Upstream Dependencies
- [ ] E03: IBrokerGateway with subscribe_quotes method
- [ ] E12-F01: VirtualPosition entity

### Downstream Impact
- [ ] E12-F02: Engine uses this for market data
- [ ] E12-F04: UI displays updated prices

## Gate Checks

### Pre-Implementation Gates
- [x] E03 gateway interface available
- [x] Rate limiting understood
- [x] Streaming pattern clear

### Quality Gates
- [ ] Integration tests with mock broker
- [ ] Reconnection tests
- [ ] Test coverage > 80%

## Tasks Preview

| ID | Title | Effort | Wave | Dependencies |
|----|-------|--------|------|--------------|
| [E12-F03-T01](T01/E12-F03-T01.spec.md) | Implement Real-Time Subscription | M | 1 | E03 |
| [E12-F03-T02](T02/E12-F03-T02.spec.md) | Implement Position Price Updates | M | 2 | T01, E12-F01 |

**Wave Dependencies**: T01 → T02

## Success Criteria

### Acceptance Criteria
- [ ] Quotes received for all subscribed symbols
- [ ] Position prices update in real-time
- [ ] Reconnection works correctly
- [ ] Rate limits respected

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Integration tests passing
- [ ] Documentation updated

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Rate limit exceeded | Medium | High | Proper throttling, queue management |
| Connection instability | Medium | Medium | Exponential backoff, retry logic |
| Data loss on reconnect | Low | Medium | Stateful recovery |

## Notes and Clarifications

### Decisions Made
- 2025-12-30: Use broker's native streaming when available
- 2025-12-30: Fallback to polling with rate limiting
- 2025-12-30: Store last known price for gap handling

## Artifacts

### Input Documents
- [Parent Epic](../E12.spec.md)
- [E03](../../E03/E03.spec.md) - Broker Integration
- PRD Section 5.7

### Output Artifacts
- [ ] `E12-F03.pre-docs.md` - Pre-implementation documentation
- [ ] `E12-F03.post-docs.md` - Post-implementation learnings

## References

- PRD Section 5.7: Paper Trading
- E03: Broker Integration
- gRPC streaming documentation

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
