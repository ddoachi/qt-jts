# Spec: E12-F02-T03 - Implement Signal Detection

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E12-F02-T03
clickup_task_id: '86ew0fpgy'
title: Implement Signal Detection Logic
type: task

# === HIERARCHY ===
parent: E12-F02
children: []
epic: E12
feature: F02
task: T03
domain: paper-trading

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 5
actual_hours: 0

# === METADATA ===
tags:
  - signal
  - detection
  - strategy
  - indicators
effort: medium
risk: medium
---

**Status**: Draft
**Type**: Task
**Parent**: E12-F02
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Executive Summary

Implement signal detection logic within `PaperTradingRunner`. Evaluate entry rules for symbols without positions and exit rules for held positions. Use ProcessingEngine to evaluate strategy formulas against recent candle data.

## Execution Flow

```
1. Implement _check_entry_signals
   → Get recent candles for symbol
   → Convert to DataFrame
   → Evaluate entry rule formula
   → If triggered: create ENTRY signal
   → Calculate position size
   → Emit signal
2. Implement _check_exit_signals
   → Get position data
   → Get recent candles
   → Evaluate exit rule formula
   → If triggered: create EXIT signal
   → Set quantity from position
   → Emit signal
3. Implement _get_recent_candles
   → Fetch from broker gateway
   → Return list of candles
4. Implement _calculate_position_size
   → Based on available cash
   → Risk management rules
   → Return quantity
   → Return: SUCCESS with detection working
```

## User Stories

### Primary User Story
**As a** trader
**I want to** receive trading signals based on my strategy
**So that** I know when to enter/exit positions

## Acceptance Scenarios

### Scenario 1: Detect Entry Signal
**Given** strategy with entry rule "RSI < 30"
**When** symbol's RSI drops to 28
**Then** ENTRY signal is emitted with BUY direction

### Scenario 2: Detect Exit Signal
**Given** held position with exit rule "RSI > 70"
**When** position's RSI rises to 75
**Then** EXIT signal is emitted with SELL direction

### Scenario 3: No Signal When Condition Not Met
**Given** strategy with entry rule "RSI < 30"
**When** symbol's RSI is 45
**Then** no signal is emitted

### Scenario 4: Position Size Calculation
**Given** available cash 50M, price 71000
**When** entry signal is generated
**Then** quantity is calculated based on risk rules

## Requirements

### Functional Requirements
- **FR-001**: _check_entry_signals evaluates entry rule
- **FR-002**: _check_exit_signals evaluates exit rule
- **FR-003**: Uses ProcessingEngine for formula evaluation
- **FR-004**: Position size calculation

### Non-Functional Requirements
- **NFR-001**: Signal detection < 100ms
- **NFR-002**: Handles missing candle data gracefully

### Technical Constraints
- **TC-001**: Use E06 ProcessingEngine
- **TC-002**: pandas DataFrame for candle data

## Dependencies

### Upstream Dependencies
- [ ] E12-F02-T02: Runner base implementation
- [ ] E06: ProcessingEngine for formula evaluation
- [ ] E09: Strategy entry/exit rules

### Downstream Impact
- [ ] E12-F04-T03: UI displays generated signals

## Gate Checks

### Pre-Implementation Gates
- [x] Runner implemented
- [x] ProcessingEngine available

### Quality Gates
- [ ] Unit tests with mock engine
- [ ] Test coverage > 80%

## Success Criteria

### Acceptance Criteria
- [ ] Entry signals detected correctly
- [ ] Exit signals detected correctly
- [ ] Position sizing works
- [ ] Tests passing

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Documentation complete

## Artifacts

### Input Documents
- [Parent Feature](../E12-F02.spec.md)

### Output Artifacts
- Updated `src/services/paper_trading/runner.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
