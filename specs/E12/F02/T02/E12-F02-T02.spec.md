# Spec: E12-F02-T02 - Implement PaperTradingRunner

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E12-F02-T02
clickup_task_id: ''
title: Implement PaperTradingRunner
type: task

# === HIERARCHY ===
parent: E12-F02
children: []
epic: E12
feature: F02
task: T02
domain: paper-trading

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 8
actual_hours: 0

# === METADATA ===
tags:
  - engine
  - runner
  - async
  - market-data
effort: large
risk: medium
---

**Status**: Draft
**Type**: Task
**Parent**: E12-F02
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Executive Summary

Implement `PaperTradingRunner` class that runs the main paper trading loop. Subscribes to market data, processes quotes, manages VirtualPortfolio, and emits signals to registered handlers. Supports pause/resume/stop lifecycle.

## Execution Flow

```
1. Define class with dependencies
   → PaperTradingSession, IBrokerGateway, ProcessingEngine
   → Initialize VirtualPortfolio with session capital
   → Signal handlers list
2. Implement run loop
   → Subscribe to broker quotes
   → While running: process quotes for each symbol
   → Handle pause state (sleep)
   → Rate limit (1 second interval)
3. Implement _process_quote
   → Update position prices if held
   → Check exit signals for held positions
   → Check entry signals for non-held symbols
4. Implement signal handler pattern
   → on_signal(handler) registration
   → _emit_signal dispatches to handlers
5. Implement lifecycle methods
   → pause(), resume(), stop()
   → Unsubscribe on stop
   → Return: SUCCESS with runner working
```

## User Stories

### Primary User Story
**As a** developer
**I want to** run paper trading session loop
**So that** market data is processed and signals are generated

## Acceptance Scenarios

### Scenario 1: Process Quote Update
**Given** running session with position in 005930
**When** new quote arrives (price=72500)
**Then** position.current_price updates to 72500

### Scenario 2: Pause Processing
**Given** running session
**When** pause() is called
**Then** quote processing stops but subscription remains

### Scenario 3: Emit Signal
**Given** running session with signal handler registered
**When** entry condition is met
**Then** signal is emitted to all handlers

### Scenario 4: Stop and Cleanup
**Given** running session
**When** stop() is called
**Then** unsubscribes from quotes and exits loop

## Requirements

### Functional Requirements
- **FR-001**: Async run loop with quote processing
- **FR-002**: Signal handler registration and dispatch
- **FR-003**: Pause/resume/stop lifecycle
- **FR-004**: Quote subscription management

### Non-Functional Requirements
- **NFR-001**: 1-second rate limit between iterations
- **NFR-002**: Non-blocking operations
- **NFR-003**: Graceful error handling

### Technical Constraints
- **TC-001**: asyncio for concurrency
- **TC-002**: Callback pattern for signals

## Dependencies

### Upstream Dependencies
- [ ] E12-F02-T01: SessionManager creates runner
- [ ] E12-F01: Domain entities
- [ ] E03: IBrokerGateway

### Downstream Impact
- [ ] E12-F02-T03: Signal detection adds logic to runner
- [ ] E12-F02-T04: Execution adds logic to runner

## Gate Checks

### Pre-Implementation Gates
- [x] SessionManager defined
- [x] Gateway interface available

### Quality Gates
- [ ] Unit tests with mock gateway
- [ ] Test coverage > 80%

## Success Criteria

### Acceptance Criteria
- [ ] Run loop works correctly
- [ ] Position prices update
- [ ] Lifecycle methods work
- [ ] Tests passing

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Documentation complete

## Artifacts

### Input Documents
- [Parent Feature](../E12-F02.spec.md)

### Output Artifacts
- `src/services/paper_trading/runner.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
