# Epic E12: Paper Trading

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E12
clickup_task_id: ''
title: Paper Trading
type: epic

# === HIERARCHY ===
parent: null
children:
  - E12-F01
  - E12-F02
  - E12-F03
  - E12-F04
  - E12-F05
epic: E12
feature: null
task: null
domain: paper-trading

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 76
actual_hours: 0

# === METADATA ===
tags:
  - paper-trading
  - simulation
  - real-time
  - virtual-portfolio
effort: large
risk: medium
platform: Cross-platform (gRPC for data)
dependencies:
  - E03 (Broker)
  - E06 (Processing)
  - E09 (Strategy)
prd_sections: '5.7'
---

## Metadata

| Field | Value |
|-------|-------|
| Epic ID | E12 |
| Title | Paper Trading |
| Status | Draft |
| Platform | Cross-platform (gRPC for data) |
| Dependencies | E03 (Broker), E06 (Processing), E09 (Strategy) |
| PRD Sections | 5.7 |

## Features

| ID | Title | Effort | Status | Tasks |
|----|-------|--------|--------|-------|
| [E12-F01](F01/E12-F01.spec.md) | Domain Entities & Value Objects | M | Draft | 3 |
| [E12-F02](F02/E12-F02.spec.md) | Paper Trading Engine | L | Draft | 4 |
| [E12-F03](F03/E12-F03.spec.md) | Real-Time Data Integration | M | Draft | 2 |
| [E12-F04](F04/E12-F04.spec.md) | UI Components | L | Draft | 4 |
| [E12-F05](F05/E12-F05.spec.md) | Persistence & History | M | Draft | 2 |

---

## 1. Overview

### 1.1 Purpose

Test strategies with simulated money in real-time market conditions:
- Real-time market data from brokers
- Virtual portfolio with no real money
- Signal generation and trade simulation
- Performance tracking over time

### 1.2 Goals

1. **Real-Time**: Live market data integration
2. **Safe**: No real money at risk
3. **Realistic**: Simulate real trading conditions
4. **Trackable**: Record and analyze all trades

---

## 2. Architecture

### 2.1 Paper Trading Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Paper Trading Session                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Market     â”‚â”€â”€â”€â–ºâ”‚  Signal     â”‚â”€â”€â”€â–ºâ”‚  Virtual    â”‚â”€â”€â”€â–ºâ”‚  Positionâ”‚ â”‚
â”‚  â”‚  Data Feed  â”‚    â”‚  Generator  â”‚    â”‚  Executor   â”‚    â”‚  Tracker â”‚ â”‚
â”‚  â”‚             â”‚    â”‚             â”‚    â”‚             â”‚    â”‚          â”‚ â”‚
â”‚  â”‚  Real-time  â”‚    â”‚  Entry/Exit â”‚    â”‚  Simulate   â”‚    â”‚  Track   â”‚ â”‚
â”‚  â”‚  from gRPC  â”‚    â”‚  detection  â”‚    â”‚  fills      â”‚    â”‚  P&L     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚                   â”‚                   â”‚                  â”‚     â”‚
â”‚        â”‚                   â–¼                   â”‚                  â”‚     â”‚
â”‚        â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                  â”‚     â”‚
â”‚        â”‚           â”‚  Signal     â”‚             â”‚                  â”‚     â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Display    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Component Structure

```
src/presentation/views/paper_trading/
â”œâ”€â”€ paper_trading_view.py       # Main paper trading view
â”œâ”€â”€ session_config_widget.py    # Session configuration
â”œâ”€â”€ portfolio_widget.py         # Portfolio display
â”œâ”€â”€ signals_widget.py           # Signal list and actions
â”œâ”€â”€ session_stats_widget.py     # Session statistics
â””â”€â”€ chart_widget.py             # Real-time chart
```

---

## 3. Domain Model

### 3.1 Paper Trading Session (PRD 5.7.1)

```python
@dataclass
class PaperTradingSession:
    """Paper trading session entity"""
    id: str
    strategy: Strategy
    data_source: BrokerConfig  # Broker for market data
    symbols: list[str]  # Watchlist
    virtual_capital: Decimal
    status: SessionStatus  # PENDING, RUNNING, PAUSED, STOPPED
    started_at: Optional[datetime] = None
    stopped_at: Optional[datetime] = None
    created_at: datetime = field(default_factory=datetime.utcnow)

class SessionStatus(Enum):
    PENDING = "pending"
    RUNNING = "running"
    PAUSED = "paused"
    STOPPED = "stopped"

@dataclass
class SessionConfig:
    """Session configuration"""
    strategy: Strategy
    data_source_broker: str
    symbols: list[str]
    virtual_capital: Decimal = Decimal("100000000")  # 1ì–µì›
    duration_days: Optional[int] = None  # Optional auto-stop
```

### 3.2 Virtual Portfolio

```python
@dataclass
class VirtualPortfolio:
    """Virtual portfolio for paper trading"""
    session_id: str
    cash: Decimal
    positions: dict[str, VirtualPosition]
    total_pnl: Decimal = Decimal(0)
    day_pnl: Decimal = Decimal(0)

    @property
    def total_value(self) -> Decimal:
        positions_value = sum(p.market_value for p in self.positions.values())
        return self.cash + positions_value

@dataclass
class VirtualPosition:
    """Virtual position"""
    symbol: str
    symbol_name: str
    quantity: int
    avg_price: Decimal
    current_price: Decimal
    entry_time: datetime

    @property
    def market_value(self) -> Decimal:
        return self.current_price * self.quantity

    @property
    def unrealized_pnl(self) -> Decimal:
        return (self.current_price - self.avg_price) * self.quantity

    @property
    def unrealized_pnl_pct(self) -> float:
        if self.avg_price == 0:
            return 0
        return float((self.current_price - self.avg_price) / self.avg_price) * 100
```

### 3.3 Trading Signal

```python
@dataclass
class TradingSignal:
    """Real-time trading signal"""
    id: str
    session_id: str
    symbol: str
    symbol_name: str
    signal_type: SignalType  # ENTRY, EXIT
    direction: TradeDirection  # BUY, SELL
    price: Decimal
    quantity: int
    reason: str  # Strategy rule that triggered
    timestamp: datetime = field(default_factory=datetime.utcnow)
    status: SignalStatus = SignalStatus.PENDING
    executed_at: Optional[datetime] = None
    executed_price: Optional[Decimal] = None

class SignalType(Enum):
    ENTRY = "entry"
    EXIT = "exit"

class SignalStatus(Enum):
    PENDING = "pending"  # Waiting for user action
    EXECUTED = "executed"  # User confirmed execution
    REJECTED = "rejected"  # User rejected
    EXPIRED = "expired"  # Signal expired
```

---

## 4. Paper Trading Engine

### 4.1 Session Manager

```python
class PaperTradingSessionManager:
    """Manage paper trading sessions"""

    def __init__(
        self,
        broker_gateway: IBrokerGateway,
        processing_engine: ProcessingEngine,
        session_repo: IPaperTradingSessionRepository
    ):
        self._broker = broker_gateway
        self._engine = processing_engine
        self._repo = session_repo
        self._active_sessions: dict[str, PaperTradingRunner] = {}

    async def start_session(
        self,
        config: SessionConfig
    ) -> PaperTradingSession:
        """Start a new paper trading session"""
        session = PaperTradingSession(
            id=str(uuid.uuid4()),
            strategy=config.strategy,
            data_source=self._broker.config,
            symbols=config.symbols,
            virtual_capital=config.virtual_capital,
            status=SessionStatus.RUNNING,
            started_at=datetime.utcnow()
        )

        await self._repo.save(session)

        # Create and start runner
        runner = PaperTradingRunner(
            session=session,
            broker=self._broker,
            engine=self._engine
        )
        self._active_sessions[session.id] = runner

        asyncio.create_task(runner.run())

        return session

    async def pause_session(self, session_id: str) -> None:
        """Pause a running session"""
        if session_id in self._active_sessions:
            await self._active_sessions[session_id].pause()
            session = await self._repo.get_by_id(session_id)
            session.status = SessionStatus.PAUSED
            await self._repo.save(session)

    async def resume_session(self, session_id: str) -> None:
        """Resume a paused session"""
        if session_id in self._active_sessions:
            await self._active_sessions[session_id].resume()
            session = await self._repo.get_by_id(session_id)
            session.status = SessionStatus.RUNNING
            await self._repo.save(session)

    async def stop_session(self, session_id: str) -> PaperTradingSession:
        """Stop a session and finalize results"""
        if session_id in self._active_sessions:
            runner = self._active_sessions[session_id]
            await runner.stop()
            del self._active_sessions[session_id]

        session = await self._repo.get_by_id(session_id)
        session.status = SessionStatus.STOPPED
        session.stopped_at = datetime.utcnow()
        await self._repo.save(session)

        return session
```

### 4.2 Paper Trading Runner

```python
class PaperTradingRunner:
    """Runs a paper trading session"""

    def __init__(
        self,
        session: PaperTradingSession,
        broker: IBrokerGateway,
        engine: ProcessingEngine
    ):
        self._session = session
        self._broker = broker
        self._engine = engine
        self._portfolio = VirtualPortfolio(
            session_id=session.id,
            cash=session.virtual_capital,
            positions={}
        )
        self._is_running = False
        self._is_paused = False
        self._signal_handlers: list[Callable[[TradingSignal], None]] = []

    def on_signal(self, handler: Callable[[TradingSignal], None]):
        """Register signal handler"""
        self._signal_handlers.append(handler)

    async def run(self):
        """Main run loop"""
        self._is_running = True

        # Subscribe to real-time data
        await self._broker.subscribe_quotes(self._session.symbols)

        while self._is_running:
            if self._is_paused:
                await asyncio.sleep(1)
                continue

            # Process market updates
            for symbol in self._session.symbols:
                quote = await self._broker.get_latest_quote(symbol)
                if quote:
                    await self._process_quote(symbol, quote)

            await asyncio.sleep(1)  # Rate limit

    async def _process_quote(self, symbol: str, quote: Quote):
        """Process a market quote"""
        # Update position prices
        if symbol in self._portfolio.positions:
            self._portfolio.positions[symbol].current_price = quote.price
            # Check exit conditions
            await self._check_exit_signals(symbol, quote)
        else:
            # Check entry conditions
            await self._check_entry_signals(symbol, quote)

    async def _check_entry_signals(self, symbol: str, quote: Quote):
        """Check if entry conditions are met"""
        # Get recent candles for indicator calculation
        candles = await self._get_recent_candles(symbol)
        if not candles:
            return

        # Evaluate entry rule
        df = pd.DataFrame([asdict(c) for c in candles])
        df.set_index('timestamp', inplace=True)

        result = self._engine._formula_service.evaluate(
            self._session.strategy.entry_rule.to_formula(),
            df,
            self._session.strategy.entry_rule.parameters
        )

        if result.iloc[-1]:
            # Generate entry signal
            quantity = self._calculate_position_size(quote.price)
            signal = TradingSignal(
                id=str(uuid.uuid4()),
                session_id=self._session.id,
                symbol=symbol,
                symbol_name=quote.symbol_name,
                signal_type=SignalType.ENTRY,
                direction=TradeDirection.BUY,
                price=quote.price,
                quantity=quantity,
                reason="Entry rule triggered"
            )
            await self._emit_signal(signal)

    async def _emit_signal(self, signal: TradingSignal):
        """Emit signal to handlers"""
        for handler in self._signal_handlers:
            try:
                handler(signal)
            except Exception as e:
                logging.error(f"Signal handler error: {e}")

    async def execute_signal(self, signal: TradingSignal) -> bool:
        """Execute a trading signal (called by UI)"""
        if signal.signal_type == SignalType.ENTRY:
            cost = signal.price * signal.quantity
            if cost > self._portfolio.cash:
                return False

            self._portfolio.cash -= cost
            self._portfolio.positions[signal.symbol] = VirtualPosition(
                symbol=signal.symbol,
                symbol_name=signal.symbol_name,
                quantity=signal.quantity,
                avg_price=signal.price,
                current_price=signal.price,
                entry_time=datetime.utcnow()
            )
        else:  # EXIT
            if signal.symbol not in self._portfolio.positions:
                return False

            position = self._portfolio.positions[signal.symbol]
            proceeds = signal.price * position.quantity
            pnl = proceeds - (position.avg_price * position.quantity)

            self._portfolio.cash += proceeds
            self._portfolio.total_pnl += pnl
            del self._portfolio.positions[signal.symbol]

        signal.status = SignalStatus.EXECUTED
        signal.executed_at = datetime.utcnow()
        signal.executed_price = signal.price

        return True

    async def pause(self):
        self._is_paused = True

    async def resume(self):
        self._is_paused = False

    async def stop(self):
        self._is_running = False
        await self._broker.unsubscribe_quotes(self._session.symbols)
```

---

## 5. UI Components

### 5.1 Paper Trading View (PRD 5.7.2)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Paper Trading Session: RSI Momentum Strategy                             â”‚
â”‚ Status: Running                    Started: 2024-12-20       [ì¼ì‹œì •ì§€] â”‚
â”‚ Data: Creon (15 req/s)                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚ Portfolio Value: â‚©103,250,000 (+3.25%)                                  â”‚
â”‚                                                                          â”‚
â”‚ Open Positions:                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ 005930 ì‚¼ì„±ì „ìž  500ì£¼  @â‚©71,000  í˜„ìž¬ê°€ â‚©72,500 (+2.1%)          â”‚  â”‚
â”‚ â”‚ 000660 SKí•˜ì´ë‹‰ìŠ¤ 100ì£¼ @â‚©125,000 í˜„ìž¬ê°€ â‚©128,000 (+2.4%)         â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚ Today's Signals:                                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ 09:15 ðŸŸ¢ BUY  035720 ì¹´ì¹´ì˜¤    Entry signal triggered    [ì‹¤í–‰]   â”‚  â”‚
â”‚ â”‚ 10:30 ðŸ”´ SELL 005380 í˜„ëŒ€ì°¨    Exit signal triggered     [ì‹¤í–‰]   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚ Performance:                                                             â”‚
â”‚ â”œâ”€ Total Trades: 12                                                      â”‚
â”‚ â”œâ”€ Win Rate: 66.7%                                                       â”‚
â”‚ â””â”€ Avg Trade: +0.8%                                                      â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Portfolio Widget

```python
class PortfolioWidget(QWidget):
    """Display virtual portfolio"""

    position_selected = Signal(str)  # symbol

    def __init__(self, parent=None):
        super().__init__(parent)
        self._portfolio: Optional[VirtualPortfolio] = None
        self._setup_ui()

    def _setup_ui(self):
        layout = QVBoxLayout(self)

        # Portfolio value header
        header = QHBoxLayout()
        self._value_label = QLabel("Portfolio Value: â‚©0")
        self._value_label.setStyleSheet("font-size: 18px; font-weight: bold;")
        self._pnl_label = QLabel("(+0.00%)")
        header.addWidget(self._value_label)
        header.addWidget(self._pnl_label)
        header.addStretch()
        layout.addLayout(header)

        # Positions table
        self._table = QTableWidget()
        self._table.setColumnCount(6)
        self._table.setHorizontalHeaderLabels([
            "Symbol", "Name", "Qty", "Avg Price", "Current", "P&L"
        ])
        self._table.setSelectionBehavior(QTableWidget.SelectRows)
        self._table.itemSelectionChanged.connect(self._on_selection_changed)
        layout.addWidget(self._table)

    def set_portfolio(self, portfolio: VirtualPortfolio):
        """Update portfolio display"""
        self._portfolio = portfolio

        # Update header
        total_value = portfolio.total_value
        initial_value = portfolio.cash + sum(
            p.avg_price * p.quantity for p in portfolio.positions.values()
        )
        pnl_pct = ((total_value - initial_value) / initial_value) * 100 if initial_value else 0

        self._value_label.setText(f"Portfolio Value: â‚©{total_value:,.0f}")
        self._pnl_label.setText(f"({'+' if pnl_pct >= 0 else ''}{pnl_pct:.2f}%)")
        self._pnl_label.setStyleSheet(
            "color: green" if pnl_pct >= 0 else "color: red"
        )

        # Update table
        self._table.setRowCount(len(portfolio.positions))
        for i, (symbol, pos) in enumerate(portfolio.positions.items()):
            self._table.setItem(i, 0, QTableWidgetItem(symbol))
            self._table.setItem(i, 1, QTableWidgetItem(pos.symbol_name))
            self._table.setItem(i, 2, QTableWidgetItem(str(pos.quantity)))
            self._table.setItem(i, 3, QTableWidgetItem(f"â‚©{pos.avg_price:,.0f}"))
            self._table.setItem(i, 4, QTableWidgetItem(f"â‚©{pos.current_price:,.0f}"))

            pnl_item = QTableWidgetItem(
                f"{'+' if pos.unrealized_pnl >= 0 else ''}â‚©{pos.unrealized_pnl:,.0f} ({pos.unrealized_pnl_pct:+.1f}%)"
            )
            pnl_item.setForeground(
                QColor("green") if pos.unrealized_pnl >= 0 else QColor("red")
            )
            self._table.setItem(i, 5, pnl_item)
```

### 5.3 Signals Widget

```python
class SignalsWidget(QWidget):
    """Display and act on trading signals"""

    signal_executed = Signal(TradingSignal)
    signal_rejected = Signal(TradingSignal)

    def __init__(self, parent=None):
        super().__init__(parent)
        self._signals: list[TradingSignal] = []
        self._setup_ui()

    def _setup_ui(self):
        layout = QVBoxLayout(self)

        # Header
        header = QLabel("Today's Signals")
        header.setStyleSheet("font-weight: bold;")
        layout.addWidget(header)

        # Signal list
        self._list = QListWidget()
        layout.addWidget(self._list)

    def add_signal(self, signal: TradingSignal):
        """Add new signal to display"""
        self._signals.append(signal)

        # Create signal item
        item = QListWidgetItem()
        widget = self._create_signal_widget(signal)
        item.setSizeHint(widget.sizeHint())

        self._list.addItem(item)
        self._list.setItemWidget(item, widget)

        # Scroll to bottom
        self._list.scrollToBottom()

    def _create_signal_widget(self, signal: TradingSignal) -> QWidget:
        """Create widget for a single signal"""
        widget = QWidget()
        layout = QHBoxLayout(widget)
        layout.setContentsMargins(5, 5, 5, 5)

        # Time
        time_label = QLabel(signal.timestamp.strftime("%H:%M"))
        layout.addWidget(time_label)

        # Direction icon
        if signal.direction == TradeDirection.BUY:
            icon_label = QLabel("ðŸŸ¢ BUY")
        else:
            icon_label = QLabel("ðŸ”´ SELL")
        layout.addWidget(icon_label)

        # Symbol
        symbol_label = QLabel(f"{signal.symbol} {signal.symbol_name}")
        layout.addWidget(symbol_label)

        # Reason
        reason_label = QLabel(signal.reason)
        reason_label.setStyleSheet("color: #666;")
        layout.addWidget(reason_label)

        layout.addStretch()

        # Action buttons
        if signal.status == SignalStatus.PENDING:
            execute_btn = QPushButton("ì‹¤í–‰")
            execute_btn.clicked.connect(lambda: self._on_execute(signal))
            layout.addWidget(execute_btn)

            reject_btn = QPushButton("ë¬´ì‹œ")
            reject_btn.clicked.connect(lambda: self._on_reject(signal))
            layout.addWidget(reject_btn)
        else:
            status_label = QLabel(signal.status.value)
            layout.addWidget(status_label)

        return widget

    def _on_execute(self, signal: TradingSignal):
        self.signal_executed.emit(signal)

    def _on_reject(self, signal: TradingSignal):
        signal.status = SignalStatus.REJECTED
        self.signal_rejected.emit(signal)
```

---

## 6. Tasks Breakdown

| Task ID | Title | Effort | Dependencies |
|---------|-------|--------|--------------|
| E12-F01-T01 | Define PaperTradingSession entity | M | E09 |
| E12-F01-T02 | Define VirtualPortfolio and VirtualPosition | M | T01 |
| E12-F01-T03 | Define TradingSignal | M | T01 |
| E12-F02-T01 | Implement PaperTradingSessionManager | L | F01 |
| E12-F02-T02 | Implement PaperTradingRunner | L | F01, E03, E06 |
| E12-F02-T03 | Implement signal detection logic | M | F02-T02 |
| E12-F02-T04 | Implement virtual order execution | M | F02-T02 |
| E12-F03-T01 | Implement real-time data subscription | M | E03 |
| E12-F03-T02 | Implement position price updates | M | F03-T01 |
| E12-F04-T01 | Create PaperTradingView | L | E01 |
| E12-F04-T02 | Create PortfolioWidget | M | F04-T01 |
| E12-F04-T03 | Create SignalsWidget | M | F04-T01 |
| E12-F04-T04 | Create SessionStatsWidget | M | F04-T01 |
| E12-F05-T01 | Implement session persistence | M | F01 |
| E12-F05-T02 | Implement trade history recording | M | F02 |

---

## 7. Acceptance Criteria (PRD 8.5)

### 7.1 Functional

- [ ] ì‹¤ì‹œê°„ ì‹œìž¥ ë°ì´í„° ë°˜ì˜ (rate limit ì¤€ìˆ˜)
- [ ] ì‹œê·¸ë„ ë°œìƒ ì‹œ ì•Œë¦¼
- [ ] ê°€ìƒ í¬ì§€ì…˜ ì¶”ì 
- [ ] ì„¸ì…˜ ì¤‘ì§€/ìž¬ê°œ ê°€ëŠ¥

### 7.2 Real-Time

- [ ] Price updates within 1 second
- [ ] Signal detection immediate
- [ ] No data loss during pause

### 7.3 Testing

- [ ] Unit tests with mock broker
- [ ] Integration tests for session lifecycle
- [ ] Test coverage > 80%

---

## 8. References

- PRD Section 5.7: Paper Trading
- E03: Broker Integration (real-time data)
- E06: Processing Engine (signal detection)
- E09: Strategy Builder
