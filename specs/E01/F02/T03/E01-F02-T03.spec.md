# Spec: E01-F02-T03 - Define SettingsSchema with All Application Settings

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E01-F02-T03
clickup_task_id: '86ew020a9'
title: Define SettingsSchema with All Application Settings
type: task

# === HIERARCHY ===
parent: E01-F02
children: []
epic: E01
feature: F02
task: T03
domain: application-framework

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 2
actual_hours: 0

# === METADATA ===
tags: [settings, schema, configuration, defaults, validation]
effort: small
risk: low
parallel: true
---

**Status**: Draft
**Type**: Task
**Parent**: E01-F02 (Settings Management)
**Created**: 2025-12-28
**Updated**: 2025-12-28
**Parallel**: [P] Can be executed in parallel with T01, T02, T06

## Executive Summary

Define the `SettingsSchema` class that provides a centralized registry of all application settings, including default values, data types, descriptions, and encryption requirements. This schema serves as the single source of truth for application configuration, enabling validation, documentation, and type-safe access to settings throughout the application.

## Execution Flow

```
1. Define SettingsSchema as dataclass or class with setting definitions
   → Group settings by category (general, trading, broker, ui, etc.)
   → For each setting: Define key, default value, type, description, encrypted flag
   → Return: Schema definition ready for use by SettingsService and UI

2. Access setting definition (get_definition operation)
   → Look up setting by key in schema
   → If found: Return SettingDefinition with all metadata
   → If not found: WARN "Unknown setting key: {key}"
   → Return: SettingDefinition or None

3. Get default value (get_default operation)
   → Look up setting definition by key
   → Return default value from definition
   → If not found: Return None

4. Validate setting value (validate operation)
   → Look up setting definition by key
   → Check value type matches expected type
   → If type mismatch: ERROR "Invalid type for {key}: expected {type}, got {actual}"
   → If custom validator defined: Run validator function
   → If validation fails: ERROR "Validation failed for {key}: {reason}"
   → Return: SUCCESS or validation error

5. Get all settings by category (get_category operation)
   → Filter all settings by category (e.g., "general", "trading")
   → Return: List of SettingDefinitions in category
```

## User Stories

### Primary User Story
**As a** developer
**I want to** have a centralized schema of all application settings
**So that** I know what settings exist, their defaults, and their types

### Additional Stories
- **As a** developer, **I want to** validate settings values against schema, **So that** invalid configurations are rejected early
- **As a** UI developer, **I want to** generate settings UI from schema, **So that** I don't manually maintain setting definitions in multiple places
- **As a** developer, **I want to** know which settings require encryption, **So that** sensitive data is always protected

## Acceptance Scenarios

### Scenario 1: Happy Path - Retrieve Setting Definition
**Given** SettingsSchema is defined with "general/language" setting
**When** requesting definition for "general/language"
**Then** the system should return SettingDefinition with:
  - key: "general/language"
  - default: "ko"
  - type: str
  - description: "Application UI language"
  - encrypted: False

### Scenario 2: Default Value Retrieval
**Given** SettingsSchema defines "trading/default_quantity" with default 1
**When** requesting default for "trading/default_quantity"
**Then** the system should return integer 1

### Scenario 3: Settings Grouped by Category
**Given** SettingsSchema has multiple categories (general, trading, broker, ui)
**When** requesting all settings in "general" category
**Then** the system should return list of all general settings
**And** trading settings should NOT be included

### Scenario 4: Encrypted Settings Flag
**Given** SettingsSchema defines "broker/api_key" with encrypted=True
**When** checking if "broker/api_key" requires encryption
**Then** the system should return True
**And** SettingsService should use set_encrypted() for this setting

### Scenario 5: Error Case - Unknown Setting
**Given** SettingsSchema is defined
**When** requesting definition for non-existent key "unknown/setting"
**Then** the system should log WARNING "Unknown setting key: unknown/setting"
**And** return None

## Requirements

### Functional Requirements
- **FR-001**: Schema MUST define all application settings with defaults
- **FR-002**: Schema MUST organize settings by category (general, trading, broker, ui)
- **FR-003**: Schema MUST specify data type for each setting (str, int, bool, float, Path)
- **FR-004**: Schema MUST indicate which settings require encryption (encrypted flag)
- **FR-005**: Schema MUST provide descriptions for all settings (for UI tooltips)
- **FR-006**: Schema MUST support setting lookup by key
- **FR-007**: Schema MUST support filtering settings by category
- **FR-008**: Schema MUST provide default value retrieval

### Non-Functional Requirements
- **NFR-001**: Maintainability: Schema MUST be centralized (single source of truth)
- **NFR-002**: Maintainability: Adding new settings MUST require changes in one place only
- **NFR-003**: Documentation: All settings MUST have descriptions
- **NFR-004**: Type Safety: All settings MUST have explicit types defined
- **NFR-005**: Extensibility: Schema MUST support custom validators (future)

### Technical Constraints
- **TC-001**: Must use Python dataclass or TypedDict for setting definitions
- **TC-002**: Must organize settings with hierarchical keys (category/subcategory/name)
- **TC-003**: Must mark sensitive settings (API keys, passwords) as encrypted=True
- **TC-004**: Must provide sensible defaults that work out-of-the-box

## Key Entities

### Entity: SettingDefinition
- **Description**: Metadata for a single application setting
- **Key Attributes**:
  - `key` (str): Hierarchical setting key (e.g., "general/theme")
  - `default` (Any): Default value if not set by user
  - `type` (Type): Expected data type (str, int, bool, float, Path)
  - `description` (str): Human-readable description for UI
  - `encrypted` (bool): Whether setting requires encryption
  - `category` (str): Setting category (general, trading, broker, ui)
  - `validator` (Optional[Callable]): Custom validation function (future)

### Entity: SettingsSchema
- **Description**: Registry of all application settings
- **Key Attributes**:
  - `SETTINGS` (Dict[str, SettingDefinition]): All setting definitions
  - `CATEGORIES` (Dict[str, List[str]]): Settings grouped by category
- **Key Methods**:
  - `get_definition(key: str) -> Optional[SettingDefinition]`: Get setting metadata
  - `get_default(key: str) -> Any`: Get default value
  - `get_category(category: str) -> List[SettingDefinition]`: Get settings in category
  - `is_encrypted(key: str) -> bool`: Check if setting requires encryption

## Dependencies

### Upstream Dependencies
None (definition/documentation only)

### Downstream Impact
- [ ] E01-F02-T04 (SettingsDialog): Will use schema to generate UI
- [ ] E01-F02-T05 (Validation): Will use schema to validate values
- [ ] E01-F02-T02 (SettingsService): May use schema for validation (optional)

### External Dependencies
- `dataclasses` (for SettingDefinition)
- `typing` (for type hints)
- `pathlib.Path` (for Path type)

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] All required setting categories identified (general, trading, broker, ui)
- [x] Default values defined for all settings
- [x] Encrypted settings identified (API keys, passwords)

### Quality Gates
- [ ] All application settings defined in schema
- [ ] All settings have default values
- [ ] All settings have descriptions
- [ ] All sensitive settings marked as encrypted
- [ ] Settings organized logically by category

## Success Criteria

### Acceptance Criteria
- [ ] SettingsSchema defines all application settings
- [ ] Settings organized by category (general, trading, broker, ui)
- [ ] All settings have default values defined
- [ ] All settings have data types specified
- [ ] All settings have descriptions (for UI)
- [ ] Sensitive settings marked as encrypted=True
- [ ] get_definition() returns setting metadata
- [ ] get_default() returns default values
- [ ] get_category() returns settings by category
- [ ] is_encrypted() correctly identifies encrypted settings

### Definition of Done
- [ ] Code implemented in `src/infrastructure/config/settings_schema.py`
- [ ] Documentation added for all settings (inline comments)
- [ ] Unit tests written in `tests/unit/infrastructure/test_settings_schema.py`
- [ ] All tests passing
- [ ] Type hints added to all methods
- [ ] README documentation updated with settings list

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Missing settings definitions | Medium | Medium | Review all features, comprehensive checklist |
| Incorrect default values | Low | Low | Test defaults in integration tests |
| Sensitive settings not encrypted | Low | Critical | Security review, checklist of credentials |
| Schema becomes too complex | Low | Low | Keep simple, avoid over-engineering |

## Implementation Details

### File Structure
```
src/infrastructure/config/
├── __init__.py
└── settings_schema.py            # SettingsSchema and SettingDefinition

tests/unit/infrastructure/
├── __init__.py
└── test_settings_schema.py       # Unit tests
```

### Settings Categories and Examples
```python
# General Settings
general/language: str = "ko"              # UI language (ko, en)
general/theme: str = "light"              # UI theme (light, dark)
general/startup_check_updates: bool = True

# Trading Settings
trading/default_quantity: int = 1         # Default order quantity
trading/default_price_type: str = "limit" # Default order type
trading/enable_sound_alerts: bool = True

# Broker Settings (Encrypted)
broker/api_key: str = ""                  # API key (ENCRYPTED)
broker/api_secret: str = ""               # API secret (ENCRYPTED)
broker/account_number: str = ""           # Account number (ENCRYPTED)
broker/endpoint_url: str = ""             # Broker endpoint

# UI Settings
ui/window_geometry: str = ""              # MainWindow geometry
ui/splitter_state: str = ""               # Splitter positions
ui/chart_interval: str = "1m"             # Default chart interval
```

### Class Interface
```python
@dataclass
class SettingDefinition:
    """Metadata for a single application setting."""
    key: str
    default: Any
    type: Type
    description: str
    encrypted: bool = False
    category: str = ""
    validator: Optional[Callable[[Any], bool]] = None


class SettingsSchema:
    """Centralized registry of all application settings."""

    # All setting definitions
    SETTINGS: Dict[str, SettingDefinition] = {
        "general/language": SettingDefinition(
            key="general/language",
            default="ko",
            type=str,
            description="Application UI language",
            encrypted=False,
            category="general"
        ),
        # ... more settings ...
    }

    @staticmethod
    def get_definition(key: str) -> Optional[SettingDefinition]:
        """Get setting definition by key."""

    @staticmethod
    def get_default(key: str) -> Any:
        """Get default value for setting."""

    @staticmethod
    def get_category(category: str) -> List[SettingDefinition]:
        """Get all settings in category."""

    @staticmethod
    def is_encrypted(key: str) -> bool:
        """Check if setting requires encryption."""
```

## Notes and Clarifications

### Decisions Made
- 2025-12-28: Use dataclass for SettingDefinition for clarity and type safety
- 2025-12-28: Organize settings with hierarchical keys (category/subcategory/name)
- 2025-12-28: Mark API keys, secrets, and credentials as encrypted=True
- 2025-12-28: Provide sensible defaults that work without configuration (language="ko", etc.)

### Settings to Define
1. **General**: language, theme, startup behavior
2. **Trading**: default quantities, price types, alerts
3. **Broker**: API credentials, endpoints, account info (encrypted)
4. **UI**: window geometry, splitter states, chart preferences

### Research Needed
None - Schema is a simple data structure

## Artifacts

### Input Documents
- [Parent Spec](../E01-F02.spec.md) (Feature E01-F02)
- [Product Requirements Document](../../../../docs/product-requirements-document.md) (Section 6.2)

### Output Artifacts
- [ ] `src/infrastructure/config/settings_schema.py` - Implementation
- [ ] `tests/unit/infrastructure/test_settings_schema.py` - Unit tests
- [ ] Settings documentation (inline comments and README)

---
*Template Version: 2.0.0 - Task-level spec*
