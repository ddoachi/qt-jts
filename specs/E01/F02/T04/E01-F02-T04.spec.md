# Spec: E01-F02-T04 - Create SettingsDialog UI for Editing Settings

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E01-F02-T04
clickup_task_id: '86ew020ac'
title: Create SettingsDialog UI for Editing Settings
type: task

# === HIERARCHY ===
parent: E01-F02
children: []
epic: E01
feature: F02
task: T04
domain: application-framework

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [ui, settings, dialog, qwidget, forms]
effort: medium
risk: low
parallel: false
---

**Status**: Draft
**Type**: Task
**Parent**: E01-F02 (Settings Management)
**Created**: 2025-12-28
**Updated**: 2025-12-28
**Dependencies**: Requires T02 (SettingsService), T03 (SettingsSchema)

## Executive Summary

Create a `SettingsDialog` UI component that allows users to view and edit application settings through a graphical interface. This dialog will be organized by setting categories (General, Trading, Broker, UI), auto-generated from the SettingsSchema, and integrated with SettingsService for persistence. The dialog includes input validation, password masking for encrypted settings, and apply/cancel functionality.

## Execution Flow

```
1. Open SettingsDialog (on user action)
   → Create QDialog with tabbed interface (one tab per category)
   → Load current settings from SettingsService
   → Populate form fields based on SettingsSchema
   → For encrypted settings: Show masked input (password field)
   → Display dialog to user

2. User edits setting value
   → Update internal state (not yet saved)
   → If validation enabled: Validate on change
   → If invalid: Show error message near field
   → Enable "Apply" button (changes pending)

3. User clicks "Apply" button
   → For each modified setting:
     → Validate value against schema (type, range, etc.)
     → If invalid: Show error, prevent save
     → If valid: Save to SettingsService
   → For encrypted settings: Use set_encrypted()
   → For normal settings: Use set()
   → Show success message "Settings saved"
   → Emit settings_changed signal
   → Keep dialog open

4. User clicks "OK" button
   → Perform "Apply" logic (save all changes)
   → If save successful: Close dialog
   → If save failed: Show errors, keep dialog open

5. User clicks "Cancel" button
   → Discard all unsaved changes
   → Close dialog without saving

6. Auto-generate form fields from SettingsSchema
   → For each setting in schema:
     → Get type, default, description
     → If type=bool: Create QCheckBox
     → If type=str: Create QLineEdit (or QComboBox for enums)
     → If type=int/float: Create QSpinBox/QDoubleSpinBox
     → If encrypted=True: Use QLineEdit with echoMode=Password
     → Add QLabel with description as tooltip
   → Group fields by category in tabs
```

## User Stories

### Primary User Story
**As a** trader
**I want to** edit application settings through a graphical interface
**So that** I can customize my trading environment without editing config files

### Additional Stories
- **As a** user, **I want to** see settings organized by category, **So that** I can find relevant settings easily
- **As a** user, **I want to** see validation errors immediately, **So that** I know what values are acceptable
- **As a** user, **I want to** cancel changes without saving, **So that** I can experiment without commitment
- **As a** security-conscious user, **I want to** see masked password fields, **So that** credentials aren't visible over my shoulder

## Acceptance Scenarios

### Scenario 1: Happy Path - Open and View Settings
**Given** the application is running with saved settings
**When** the user opens the Settings dialog
**Then** the dialog should display all settings organized by category tabs
**And** current values should be populated in form fields
**And** encrypted settings should show as masked password fields

### Scenario 2: Edit and Apply Setting
**Given** the Settings dialog is open
**When** the user changes "general/theme" from "light" to "dark"
**And** clicks the "Apply" button
**Then** the setting should be saved to SettingsService
**And** a success message should appear
**And** the dialog should remain open
**And** settings_changed signal should be emitted

### Scenario 3: Validation Error
**Given** the Settings dialog is open
**When** the user enters invalid value (e.g., negative number for quantity)
**And** clicks "Apply"
**Then** an error message should appear near the field
**And** the setting should NOT be saved
**And** the dialog should remain open

### Scenario 4: Cancel Discards Changes
**Given** the Settings dialog is open with unsaved changes
**When** the user clicks "Cancel"
**Then** all changes should be discarded
**And** the dialog should close
**And** SettingsService should NOT be modified

### Scenario 5: Encrypted Setting Input
**Given** the Settings dialog is open
**When** the user enters broker API key in the encrypted field
**Then** the input should be masked (password field)
**And** when saved, set_encrypted() should be called
**And** the plaintext should never be logged

## Requirements

### Functional Requirements
- **FR-001**: Dialog MUST display all settings from SettingsSchema
- **FR-002**: Dialog MUST organize settings by category using tabs
- **FR-003**: Dialog MUST populate fields with current values from SettingsService
- **FR-004**: Dialog MUST validate input before saving
- **FR-005**: Dialog MUST provide Apply, OK, Cancel buttons
- **FR-006**: Dialog MUST use password fields for encrypted settings
- **FR-007**: Dialog MUST emit settings_changed signal when settings are saved
- **FR-008**: Dialog MUST show validation errors near invalid fields
- **FR-009**: Dialog MUST auto-generate form fields from SettingsSchema

### Non-Functional Requirements
- **NFR-001**: Usability: Settings MUST be organized logically by category
- **NFR-002**: Usability: Field labels MUST show setting descriptions as tooltips
- **NFR-003**: Usability: Validation errors MUST be clear and actionable
- **NFR-004**: Performance: Dialog MUST open in < 100ms
- **NFR-005**: Accessibility: All fields MUST have labels and tab order
- **NFR-006**: Maintainability: Adding new settings MUST only require schema update

### Technical Constraints
- **TC-001**: Must use PySide6.QtWidgets.QDialog
- **TC-002**: Must use QTabWidget for category organization
- **TC-003**: Must use QLineEdit with echoMode=Password for encrypted settings
- **TC-004**: Must inject SettingsService via dependency injection
- **TC-005**: Must reference SettingsSchema for field generation

## Key Entities

### Entity: SettingsDialog
- **Description**: QDialog for editing application settings
- **Key Attributes**:
  - `_settings` (SettingsService): Service for reading/writing settings
  - `_schema` (SettingsSchema): Schema for field generation
  - `_modified_fields` (Dict[str, Any]): Pending unsaved changes
  - `_tabs` (QTabWidget): Category tabs container
- **Key Methods**:
  - `__init__(settings: SettingsService)`: Initialize dialog
  - `_load_settings()`: Load current values from SettingsService
  - `_generate_ui()`: Auto-generate form fields from schema
  - `_apply_changes()`: Save all modified settings
  - `_validate_fields() -> bool`: Validate all fields
  - `_on_apply_clicked()`: Handle Apply button
  - `_on_ok_clicked()`: Handle OK button
  - `_on_cancel_clicked()`: Handle Cancel button
- **Signals**:
  - `settings_changed`: Emitted when settings are saved

## Dependencies

### Upstream Dependencies
- [x] E01-F02-T02 (SettingsService): Required for reading/writing settings
- [x] E01-F02-T03 (SettingsSchema): Required for UI generation

### Downstream Impact
- [ ] E01-F01 (MainWindow): Will integrate SettingsDialog in menu

### External Dependencies
- `PySide6.QtWidgets` (QDialog, QTabWidget, QLineEdit, QCheckBox, etc.)
- `PySide6.QtCore` (Signal, Slot)

## Gate Checks

### Pre-Implementation Gates
- [ ] T02 (SettingsService) completed and tested
- [ ] T03 (SettingsSchema) completed and tested
- [x] UI layout designed (tabbed interface with categories)
- [x] Validation requirements defined

### Quality Gates
- [ ] UI matches design specifications
- [ ] All settings from schema are displayed
- [ ] Validation works correctly
- [ ] Apply/OK/Cancel buttons work as expected
- [ ] settings_changed signal emitted correctly

## Success Criteria

### Acceptance Criteria
- [ ] SettingsDialog opens and displays all settings
- [ ] Settings organized by category tabs (General, Trading, Broker, UI)
- [ ] Current values loaded from SettingsService
- [ ] Form fields auto-generated from SettingsSchema
- [ ] Encrypted settings use password fields (masked input)
- [ ] Apply button saves changes and keeps dialog open
- [ ] OK button saves changes and closes dialog
- [ ] Cancel button discards changes and closes dialog
- [ ] Validation errors shown near invalid fields
- [ ] settings_changed signal emitted on save
- [ ] Dialog opens in < 100ms

### Definition of Done
- [ ] Code implemented in `src/presentation/dialogs/settings_dialog.py`
- [ ] UI tests written in `tests/unit/presentation/test_settings_dialog.py`
- [ ] Manual testing on all platforms (Windows, macOS, Linux)
- [ ] All tests passing
- [ ] Type hints and docstrings added
- [ ] Integration with MainWindow menu completed
- [ ] Screenshots added to documentation

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| UI too complex | Low | Medium | Keep simple, one tab per category |
| Validation too strict | Low | Low | Test with realistic values, iterate |
| Performance issues | Low | Low | Lazy load tabs if needed |
| Platform-specific UI bugs | Medium | Low | Test on all platforms early |

## Implementation Details

### File Structure
```
src/presentation/dialogs/
├── __init__.py
└── settings_dialog.py            # SettingsDialog implementation

tests/unit/presentation/
├── __init__.py
└── test_settings_dialog.py       # Unit/UI tests
```

### UI Layout (Wireframe)
```
┌─────────────────────────────────────────┐
│ Settings                           [X]  │
├─────────────────────────────────────────┤
│ ┌─────┬─────┬─────┬─────┐              │
│ │ Gen │ Trd │ Brkr│ UI  │              │
│ └─────┴─────┴─────┴─────┘              │
│ ┌───────────────────────────────────┐  │
│ │ General Settings                  │  │
│ │                                   │  │
│ │ Language:        [ko ▼]           │  │
│ │ Theme:           [light ▼]        │  │
│ │ Check updates:   [✓]              │  │
│ │                                   │  │
│ └───────────────────────────────────┘  │
│                                         │
│         [Apply] [OK] [Cancel]           │
└─────────────────────────────────────────┘
```

### Class Interface
```python
class SettingsDialog(QDialog):
    """Dialog for editing application settings."""

    settings_changed = Signal()  # Emitted when settings are saved

    def __init__(self, settings: SettingsService, parent: Optional[QWidget] = None) -> None:
        """Initialize settings dialog."""

    def _load_settings(self) -> None:
        """Load current settings from SettingsService into form fields."""

    def _generate_ui(self) -> None:
        """Auto-generate form fields from SettingsSchema."""

    def _apply_changes(self) -> bool:
        """Save all modified settings to SettingsService."""

    def _validate_fields(self) -> bool:
        """Validate all form fields before saving."""

    @Slot()
    def _on_apply_clicked(self) -> None:
        """Handle Apply button click."""

    @Slot()
    def _on_ok_clicked(self) -> None:
        """Handle OK button click."""

    @Slot()
    def _on_cancel_clicked(self) -> None:
        """Handle Cancel button click."""
```

## Notes and Clarifications

### Decisions Made
- 2025-12-28: Use tabbed interface for category organization (simple, familiar)
- 2025-12-28: Auto-generate form fields from SettingsSchema (DRY principle)
- 2025-12-28: Use Apply/OK/Cancel buttons (standard dialog pattern)
- 2025-12-28: Validate on Apply (not on every keystroke) for better UX
- 2025-12-28: Use QLineEdit with echoMode=Password for encrypted settings

### UI Design Principles
- Keep simple and uncluttered
- One tab per category (General, Trading, Broker, UI)
- Show tooltips with setting descriptions
- Immediate feedback for validation errors
- Disable Apply button when no changes

### Research Needed
None - Standard Qt dialog patterns

## Artifacts

### Input Documents
- [Parent Spec](../E01-F02.spec.md) (Feature E01-F02)
- [T02 Spec](../T02/E01-F02-T02.spec.md) (SettingsService)
- [T03 Spec](../T03/E01-F02-T03.spec.md) (SettingsSchema)

### Output Artifacts
- [ ] `src/presentation/dialogs/settings_dialog.py` - Implementation
- [ ] `tests/unit/presentation/test_settings_dialog.py` - UI tests
- [ ] Screenshots of dialog (for documentation)

---
*Template Version: 2.0.0 - Task-level spec*
