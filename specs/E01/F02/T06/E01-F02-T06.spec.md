# Spec: E01-F02-T06 - Implement Settings Export/Import for Backup

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E01-F02-T06
clickup_task_id: '86ew020ap'
title: Implement Settings Export/Import for Backup
type: task

# === HIERARCHY ===
parent: E01-F02
children: []
epic: E01
feature: F02
task: T06
domain: application-framework

# === WORKFLOW ===
status: draft
priority: low

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 2
actual_hours: 0

# === METADATA ===
tags: [settings, export, import, backup, json, portability]
effort: small
risk: low
parallel: true
---

**Status**: Draft
**Type**: Task
**Parent**: E01-F02 (Settings Management)
**Created**: 2025-12-28
**Updated**: 2025-12-28
**Parallel**: [P] Can be executed in parallel with T01, T02, T03

## Executive Summary

Implement export and import functionality for application settings, allowing users to backup their configurations to JSON files and restore them later. This feature supports migration to new machines, disaster recovery, and sharing configurations between team members. Exported files include all settings with encrypted values preserved in encrypted form.

## Execution Flow

```
1. Export settings to JSON file (export operation)
   → Create dictionary with all settings from QSettings
   → For each key in QSettings.allKeys():
     → Get value from QSettings
     → Add to export dictionary: {key: value}
     → NOTE: Encrypted values are exported as encrypted (base64)
   → Add metadata: export_version, export_date, app_version
   → Serialize dictionary to JSON with indent=2 (human-readable)
   → Write JSON to specified file path
   → If write fails: ERROR "Failed to export settings: {reason}"
   → Return: SUCCESS with file path

2. Import settings from JSON file (import operation)
   → Read JSON file from specified path
   → If file not found: ERROR "Import file not found: {path}"
   → If JSON invalid: ERROR "Invalid JSON format: {reason}"
   → Parse JSON to dictionary
   → Validate export_version compatibility
   → If incompatible: WARN "Settings exported from different version"
   → For each key-value pair in JSON:
     → If key exists in current QSettings: Optionally skip (preserve current)
     → Set value in QSettings using setValue()
     → NOTE: Encrypted values remain encrypted (no re-encryption needed)
   → Call sync() to persist imported settings
   → Return: SUCCESS with count of imported settings

3. Selective export (export_category operation)
   → Same as export, but filter by category (e.g., only "general/*")
   → Use case: Share only non-sensitive settings (exclude broker credentials)

4. Import with merge strategy (import_merge operation)
   → Import settings without overwriting existing values
   → For each key in import file:
     → If key NOT in current QSettings: Import value
     → If key exists: Skip (preserve current value)
   → Use case: Import defaults without losing user customizations

5. Validate import file before import (validate_import_file operation)
   → Read and parse JSON file
   → Check file structure (has required metadata)
   → Check export_version compatibility
   → Validate all keys against SettingsSchema (optional)
   → Return: ValidationResult (success, error_message)
   → Use case: Pre-check before actual import
```

## User Stories

### Primary User Story
**As a** user
**I want to** export my application settings to a file
**So that** I can backup my configuration or transfer it to another machine

### Additional Stories
- **As a** user, **I want to** import settings from a backup file, **So that** I can restore my configuration after reinstalling the application
- **As a** team member, **I want to** share my settings with colleagues, **So that** we can maintain consistent configurations
- **As a** user, **I want to** import settings without overwriting my customizations, **So that** I can merge configurations safely

## Acceptance Scenarios

### Scenario 1: Happy Path - Export Settings
**Given** the application has multiple settings configured
**When** the user exports settings to "backup.json"
**Then** a JSON file should be created at the specified path
**And** the file should contain all settings in key-value format
**And** the file should include metadata (version, date)
**And** encrypted values should be exported as encrypted (not plaintext)

### Scenario 2: Import Settings (Replace Mode)
**Given** a valid settings backup file "backup.json" exists
**When** the user imports settings from "backup.json"
**Then** all settings from the file should be loaded into QSettings
**And** existing settings should be overwritten
**And** the application should use imported settings immediately
**And** a success message should indicate count of imported settings

### Scenario 3: Import with Merge (Preserve Existing)
**Given** a settings backup file with some overlapping keys
**When** the user imports with merge strategy
**Then** only new keys (not present in current QSettings) should be imported
**And** existing settings should NOT be overwritten
**And** the user should be notified of merged settings count

### Scenario 4: Edge Case - Invalid Import File
**Given** an invalid or corrupted JSON file
**When** the user attempts to import settings
**Then** the system should log ERROR "Invalid JSON format"
**And** display error message to user
**And** NOT modify current settings (abort import)

### Scenario 5: Selective Export - Exclude Credentials
**Given** the application has general and broker settings
**When** the user exports only "general/*" category
**Then** the export file should contain only general settings
**And** broker credentials should NOT be included in export
**And** the file should be safe to share with others

## Requirements

### Functional Requirements
- **FR-001**: System MUST export all settings to JSON file
- **FR-002**: System MUST import settings from valid JSON file
- **FR-003**: System MUST preserve encrypted values in encrypted form (no plaintext in export)
- **FR-004**: System MUST include metadata in export (version, date)
- **FR-005**: System MUST support selective export by category (optional)
- **FR-006**: System MUST support merge import (preserve existing settings)
- **FR-007**: System MUST validate import file before importing
- **FR-008**: System MUST handle import errors gracefully (no partial imports)

### Non-Functional Requirements
- **NFR-001**: Security: Exported files MUST NOT contain plaintext credentials
- **NFR-002**: Usability: Export/import MUST provide progress feedback
- **NFR-003**: Reliability: Import failures MUST NOT corrupt existing settings
- **NFR-004**: Performance: Export/import MUST complete in < 1 second for typical settings
- **NFR-005**: Compatibility: Export format MUST be forward/backward compatible
- **NFR-006**: Portability: Exported JSON MUST be human-readable and editable

### Technical Constraints
- **TC-001**: Must use JSON format for export files (portable, human-readable)
- **TC-002**: Must export QSettings keys as-is (including encrypted values)
- **TC-003**: Must validate JSON structure on import
- **TC-004**: Must use atomic write operations (write to temp file, then rename)
- **TC-005**: Must handle file I/O errors gracefully

## Key Entities

### Entity: SettingsExporter
- **Description**: Handles exporting settings to JSON files
- **Key Methods**:
  - `export_to_file(file_path: Path, category: Optional[str]) -> bool`
  - `_collect_settings(category: Optional[str]) -> Dict[str, Any]`
  - `_add_metadata(settings_dict: Dict[str, Any]) -> Dict[str, Any]`
  - `_write_json(data: Dict[str, Any], file_path: Path) -> bool`

### Entity: SettingsImporter
- **Description**: Handles importing settings from JSON files
- **Key Methods**:
  - `import_from_file(file_path: Path, merge: bool) -> int`
  - `validate_import_file(file_path: Path) -> ValidationResult`
  - `_read_json(file_path: Path) -> Dict[str, Any]`
  - `_check_version_compatibility(metadata: Dict[str, Any]) -> bool`
  - `_apply_settings(settings_dict: Dict[str, Any], merge: bool) -> int`

### Entity: ExportMetadata
- **Description**: Metadata included in export files
- **Key Attributes**:
  - `export_version` (str): Schema version (e.g., "1.0")
  - `export_date` (str): ISO 8601 timestamp
  - `app_version` (str): Application version
  - `settings_count` (int): Number of settings exported

## Dependencies

### Upstream Dependencies
None (uses SettingsService which is available from T02)

### Downstream Impact
- [ ] E01-F02-T04 (SettingsDialog): May add Export/Import buttons to UI

### External Dependencies
- `json` (for serialization)
- `pathlib.Path` (for file operations)
- `datetime` (for timestamps)

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Export format defined (JSON with metadata)
- [x] Security requirements clear (encrypted values stay encrypted)
- [x] Import strategies defined (replace vs. merge)

### Quality Gates
- [ ] Unit tests for export operation
- [ ] Unit tests for import operation (replace and merge)
- [ ] Unit tests for validation
- [ ] Edge case tests (invalid JSON, corrupted files)
- [ ] Security review (no plaintext credentials in export)

## Success Criteria

### Acceptance Criteria
- [ ] export_to_file() creates valid JSON file
- [ ] Exported file contains all settings
- [ ] Exported file includes metadata (version, date)
- [ ] Encrypted values remain encrypted in export
- [ ] import_from_file() loads settings correctly
- [ ] Import with merge preserves existing settings
- [ ] Invalid import files are rejected gracefully
- [ ] Selective export by category works correctly
- [ ] Export/import completes in < 1 second
- [ ] No plaintext credentials in export files

### Definition of Done
- [ ] Code implemented in `src/infrastructure/services/settings_io.py`
- [ ] Unit tests written in `tests/unit/infrastructure/test_settings_io.py`
- [ ] All tests passing (> 90% coverage for this module)
- [ ] Type hints and docstrings added
- [ ] Example export file documented
- [ ] Integration with SettingsDialog (optional UI buttons)

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Export exposes credentials | Low | Critical | Keep encrypted values encrypted, security review |
| Import corrupts settings | Low | High | Validate before import, atomic operations |
| Version incompatibility | Medium | Medium | Include version metadata, graceful fallback |
| File I/O errors | Medium | Low | Graceful error handling, clear error messages |

## Implementation Details

### File Structure
```
src/infrastructure/services/
├── __init__.py
├── settings_service.py           # From T02
└── settings_io.py                # SettingsExporter, SettingsImporter

tests/unit/infrastructure/
├── __init__.py
└── test_settings_io.py           # Unit tests
```

### Export File Format (JSON)
```json
{
  "_metadata": {
    "export_version": "1.0",
    "export_date": "2025-12-28T10:30:00Z",
    "app_version": "1.0.0",
    "settings_count": 8
  },
  "settings": {
    "general/language": "ko",
    "general/theme": "dark",
    "trading/default_quantity": 1,
    "broker/api_key": "Z0FBQUFBQm1kR... (encrypted base64)",
    "broker/api_secret": "Z0FBQUFBQm1kR... (encrypted base64)",
    "ui/window_geometry": "AdnQywADAAA..."
  }
}
```

### Class Interface
```python
class SettingsExporter:
    """Handles exporting settings to JSON files."""

    def __init__(self, settings: SettingsService) -> None:
        """Initialize exporter with SettingsService."""

    def export_to_file(self, file_path: Path, category: Optional[str] = None) -> bool:
        """Export settings to JSON file (optionally filtered by category)."""

    def _collect_settings(self, category: Optional[str] = None) -> Dict[str, Any]:
        """Collect settings from QSettings (optionally filtered)."""

    def _add_metadata(self, settings_dict: Dict[str, Any]) -> Dict[str, Any]:
        """Add export metadata to settings dictionary."""

    def _write_json(self, data: Dict[str, Any], file_path: Path) -> bool:
        """Write dictionary to JSON file atomically."""


class SettingsImporter:
    """Handles importing settings from JSON files."""

    def __init__(self, settings: SettingsService) -> None:
        """Initialize importer with SettingsService."""

    def import_from_file(self, file_path: Path, merge: bool = False) -> int:
        """Import settings from JSON file (returns count of imported settings)."""

    def validate_import_file(self, file_path: Path) -> ValidationResult:
        """Validate import file before importing."""

    def _read_json(self, file_path: Path) -> Dict[str, Any]:
        """Read and parse JSON file."""

    def _check_version_compatibility(self, metadata: Dict[str, Any]) -> bool:
        """Check if export version is compatible."""

    def _apply_settings(self, settings_dict: Dict[str, Any], merge: bool) -> int:
        """Apply imported settings to QSettings."""
```

### Usage Examples
```python
# Export all settings
exporter = SettingsExporter(settings_service)
exporter.export_to_file(Path("backup.json"))

# Export only general settings (safe to share)
exporter.export_to_file(Path("general_settings.json"), category="general")

# Import settings (replace mode)
importer = SettingsImporter(settings_service)
count = importer.import_from_file(Path("backup.json"), merge=False)
print(f"Imported {count} settings")

# Import settings (merge mode - preserve existing)
count = importer.import_from_file(Path("defaults.json"), merge=True)
print(f"Merged {count} new settings")

# Validate before importing
result = importer.validate_import_file(Path("backup.json"))
if result.success:
    importer.import_from_file(Path("backup.json"))
else:
    print(f"Invalid import file: {result.error_message}")
```

## Notes and Clarifications

### Decisions Made
- 2025-12-28: Use JSON format for portability and human-readability
- 2025-12-28: Keep encrypted values encrypted in export (no plaintext)
- 2025-12-28: Include metadata for version compatibility checking
- 2025-12-28: Support merge strategy for safe imports
- 2025-12-28: Use atomic writes (temp file + rename) to prevent corruption

### Export/Import Strategies
1. **Full export/import**: All settings (for backup/migration)
2. **Selective export**: Filter by category (for sharing non-sensitive settings)
3. **Replace import**: Overwrite all settings (for full restore)
4. **Merge import**: Only add new settings (for defaults/templates)

### Security Considerations
- Encrypted settings are exported as-is (encrypted base64 strings)
- No plaintext credentials in export files
- Users should protect export files containing encrypted credentials
- Consider warning users about sharing files with encrypted data

### Research Needed
None - Standard JSON I/O patterns

## Artifacts

### Input Documents
- [Parent Spec](../E01-F02.spec.md) (Feature E01-F02)

### Output Artifacts
- [ ] `src/infrastructure/services/settings_io.py` - Implementation
- [ ] `tests/unit/infrastructure/test_settings_io.py` - Unit tests
- [ ] Example export file (for documentation)

---
*Template Version: 2.0.0 - Task-level spec*
