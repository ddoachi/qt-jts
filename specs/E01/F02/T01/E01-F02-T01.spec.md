# Spec: E01-F02-T01 - Implement EncryptionService with Key Derivation

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E01-F02-T01
clickup_task_id: '86ew020a1'
title: Implement EncryptionService with Key Derivation
type: task

# === HIERARCHY ===
parent: E01-F02
children: []
epic: E01
feature: F02
task: T01
domain: application-framework

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 2
actual_hours: 0

# === METADATA ===
tags: [encryption, security, fernet, cryptography, key-derivation]
effort: small
risk: medium
parallel: true
---

**Status**: Draft
**Type**: Task
**Parent**: E01-F02 (Settings Management)
**Created**: 2025-12-28
**Updated**: 2025-12-28
**Parallel**: [P] Can be executed in parallel with T02, T03, T06

## Executive Summary

Implement the `EncryptionService` class that provides industry-standard encryption and decryption for sensitive settings data (API keys, passwords, credentials). This service uses Fernet symmetric encryption from the cryptography library and derives encryption keys from machine-specific data to ensure secure, stable key generation without requiring user passwords.

## Execution Flow

```
1. Initialize EncryptionService on first instantiation
   → Generate machine-specific identifier (UUID from MAC address or hostname)
   → Derive encryption key using PBKDF2HMAC with machine ID as password
   → Create Fernet cipher with derived key
   → If key derivation fails: ERROR "Failed to derive encryption key: {reason}"
   → Return: SUCCESS with initialized service

2. Encrypt plaintext value (encrypt operation)
   → Validate input is not empty
   → Encode plaintext to UTF-8 bytes
   → Encrypt using Fernet cipher
   → Encode encrypted bytes to base64 string
   → Return: Encrypted string (base64-encoded)

3. Decrypt encrypted value (decrypt operation)
   → Decode base64 string to encrypted bytes
   → Attempt decryption using Fernet cipher
   → If decryption fails: Log WARNING "Decryption failed: {reason}"
   → If decryption fails: Return empty string (graceful degradation)
   → Decode decrypted bytes to UTF-8 string
   → Return: Plaintext string or empty string on failure
```

## User Stories

### Primary User Story
**As a** developer
**I want to** encrypt and decrypt sensitive settings data securely
**So that** API keys and credentials cannot be easily read from storage

### Additional Stories
- **As a** security-conscious developer, **I want to** use industry-standard encryption (Fernet), **So that** I avoid vulnerabilities from custom cryptography
- **As a** developer, **I want to** derive encryption keys from machine-specific data, **So that** keys remain stable across application restarts without user intervention

## Acceptance Scenarios

### Scenario 1: Happy Path - Encrypt and Decrypt
**Given** EncryptionService is initialized successfully
**When** encrypting plaintext "secret_api_key_123"
**Then** the encrypted value should be a base64-encoded string
**And** decrypting that value should return "secret_api_key_123"

### Scenario 2: Key Derivation Stability
**Given** EncryptionService is initialized on first run
**When** the application restarts and EncryptionService is initialized again
**Then** the derived encryption key should be identical
**And** previously encrypted values should decrypt correctly

### Scenario 3: Edge Case - Empty String Encryption
**Given** EncryptionService is initialized
**When** encrypting an empty string ""
**Then** the system should return an encrypted value (not error)
**And** decrypting should return empty string ""

### Scenario 4: Error Case - Corrupted Encrypted Data
**Given** EncryptionService is initialized
**When** attempting to decrypt corrupted or invalid base64 data
**Then** the system should log WARNING "Decryption failed"
**And** return empty string (not crash)

### Scenario 5: Security - Plaintext Not in Encrypted Output
**Given** EncryptionService encrypts "my_secret_password"
**When** examining the encrypted output
**Then** the plaintext "my_secret_password" should NOT appear in the output
**And** the output should be base64-encoded ciphertext

## Requirements

### Functional Requirements
- **FR-001**: System MUST derive encryption key from machine-specific identifier
- **FR-002**: System MUST use PBKDF2HMAC with SHA256 for key derivation
- **FR-003**: System MUST use Fernet symmetric encryption for encrypt/decrypt
- **FR-004**: System MUST handle encryption of UTF-8 strings
- **FR-005**: System MUST return base64-encoded strings from encrypt operation
- **FR-006**: System MUST handle decryption failures gracefully (return empty string)
- **FR-007**: Derived key MUST be stable across application restarts

### Non-Functional Requirements
- **NFR-001**: Performance: Encryption MUST complete in < 50ms
- **NFR-002**: Performance: Decryption MUST complete in < 50ms
- **NFR-003**: Security: MUST use industry-standard cryptography library
- **NFR-004**: Security: MUST NOT log encryption keys or plaintext values
- **NFR-005**: Reliability: Decryption failures MUST NOT crash the application
- **NFR-006**: Maintainability: All methods MUST have type hints and docstrings

### Technical Constraints
- **TC-001**: Must use cryptography library's Fernet implementation
- **TC-002**: Must derive key using PBKDF2HMAC (100,000 iterations minimum)
- **TC-003**: Must use machine UUID (from MAC address or hostname) as password
- **TC-004**: Must handle InvalidToken exception during decryption
- **TC-005**: Must encode/decode using UTF-8 for all string operations

## Key Entities

### Entity: EncryptionService
- **Description**: Provides encryption and decryption for sensitive settings
- **Key Attributes**:
  - `_key` (bytes): Derived encryption key
  - `_cipher` (Fernet): Fernet cipher instance
- **Key Methods**:
  - `__init__()`: Initialize service with key derivation
  - `encrypt(plaintext: str) -> str`: Encrypt plaintext to base64 string
  - `decrypt(encrypted: str) -> str`: Decrypt base64 string to plaintext
  - `_derive_key() -> bytes`: Derive encryption key from machine ID
  - `_get_machine_id() -> str`: Get stable machine identifier

## Dependencies

### Upstream Dependencies
None (foundation component)

### Downstream Impact
- [ ] E01-F02-T02 (SettingsService): Will use EncryptionService for encrypted settings

### External Dependencies
- `cryptography` library (Fernet, PBKDF2HMAC)
- `uuid` module (for machine ID generation)
- `hashlib` module (for hashing)

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Performance requirements specified (< 50ms for encrypt/decrypt)
- [x] Security requirements defined (Fernet, PBKDF2HMAC)
- [x] Error handling requirements clear (graceful decryption failure)

### Quality Gates
- [ ] Unit tests for encrypt/decrypt operations
- [ ] Unit tests for key derivation stability
- [ ] Unit tests for error handling (corrupted data)
- [ ] Performance tests (< 50ms requirement)
- [ ] Security review (no logging of sensitive data)

## Success Criteria

### Acceptance Criteria
- [ ] EncryptionService initializes successfully with derived key
- [ ] Encryption produces base64-encoded ciphertext
- [ ] Decryption recovers original plaintext correctly
- [ ] Derived key is stable across application restarts
- [ ] Decryption failures return empty string (no crash)
- [ ] Plaintext values are not visible in encrypted output
- [ ] Encryption completes in < 50ms
- [ ] Decryption completes in < 50ms
- [ ] No encryption keys or plaintext are logged

### Definition of Done
- [ ] Code implemented in `src/infrastructure/services/encryption_service.py`
- [ ] Unit tests written in `tests/unit/infrastructure/test_encryption_service.py`
- [ ] All tests passing (100% coverage for this module)
- [ ] Type hints and docstrings added to all methods
- [ ] Security review completed (no sensitive data logging)
- [ ] Performance benchmarked (< 50ms verified)

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Encryption key loss | Low | High | Use stable machine ID (MAC address UUID), document derivation process |
| Decryption failures | Low | Medium | Graceful failure handling (return empty string), log warnings |
| Performance issues | Low | Low | Use efficient Fernet implementation, benchmark early |
| Key derivation instability | Low | High | Test key derivation across restarts, use stable machine identifiers |

## Implementation Details

### File Structure
```
src/infrastructure/services/
├── __init__.py
└── encryption_service.py         # EncryptionService implementation

tests/unit/infrastructure/
├── __init__.py
└── test_encryption_service.py    # Unit tests
```

### Class Interface
```python
class EncryptionService:
    """Provides encryption and decryption for sensitive settings."""

    def __init__(self) -> None:
        """Initialize with machine-specific key derivation."""

    def encrypt(self, plaintext: str) -> str:
        """Encrypt plaintext string to base64-encoded ciphertext."""

    def decrypt(self, encrypted: str) -> str:
        """Decrypt base64-encoded ciphertext to plaintext (or empty on failure)."""

    def _derive_key(self) -> bytes:
        """Derive encryption key from machine ID using PBKDF2HMAC."""

    def _get_machine_id(self) -> str:
        """Get stable machine identifier (UUID from MAC or hostname)."""
```

## Notes and Clarifications

### Decisions Made
- 2025-12-28: Use Fernet (symmetric encryption) instead of asymmetric for performance and simplicity
- 2025-12-28: Derive key from machine UUID instead of user password for automatic key management
- 2025-12-28: Return empty string on decryption failure instead of raising exception for graceful degradation
- 2025-12-28: Use 100,000 PBKDF2 iterations (OWASP recommendation for 2025)

### Research Needed
None - Fernet and PBKDF2HMAC are well-documented in cryptography library

## Artifacts

### Input Documents
- [Parent Spec](../E01-F02.spec.md) (Feature E01-F02)
- [cryptography library documentation](https://cryptography.io/en/latest/fernet/)

### Output Artifacts
- [ ] `src/infrastructure/services/encryption_service.py` - Implementation
- [ ] `tests/unit/infrastructure/test_encryption_service.py` - Unit tests

---
*Template Version: 2.0.0 - Task-level spec*
