# Epic E01: Application Framework

## Metadata

| Field | Value |
|-------|-------|
| Epic ID | E01 |
| Title | Application Framework |
| Status | Draft |
| Platform | Cross-platform (Linux/macOS/Windows) |
| Dependencies | None (Foundation) |
| PRD Sections | 6.1, 6.2 |

---

## 1. Overview

### 1.1 Purpose

Establish the foundational PySide6 application framework including:
- Main window structure with navigation
- Settings management (QSettings)
- Dependency injection container
- Plugin architecture for extensibility
- Logging and error handling infrastructure
- Application lifecycle management

### 1.2 Goals

1. **Testable Architecture**: DDD-inspired layered architecture enabling TDD
2. **Modular Design**: Each feature as a pluggable module
3. **Cross-Platform**: Consistent experience across Linux, macOS, Windows
4. **Professional UX**: Responsive UI with proper async handling

---

## 2. Architecture

### 2.1 DDD Layer Structure

```
qt-jts/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ domain/                    # Domain Layer (Pure Python, no Qt)
â”‚   â”‚   â”œâ”€â”€ entities/              # Aggregate roots, entities
â”‚   â”‚   â”œâ”€â”€ value_objects/         # Immutable value objects
â”‚   â”‚   â”œâ”€â”€ repositories/          # Repository interfaces (ABC)
â”‚   â”‚   â”œâ”€â”€ services/              # Domain services
â”‚   â”‚   â””â”€â”€ events/                # Domain events
â”‚   â”‚
â”‚   â”œâ”€â”€ application/               # Application Layer
â”‚   â”‚   â”œâ”€â”€ use_cases/             # Use case implementations
â”‚   â”‚   â”œâ”€â”€ services/              # Application services
â”‚   â”‚   â”œâ”€â”€ dto/                   # Data transfer objects
â”‚   â”‚   â””â”€â”€ interfaces/            # Port interfaces
â”‚   â”‚
â”‚   â”œâ”€â”€ infrastructure/            # Infrastructure Layer
â”‚   â”‚   â”œâ”€â”€ persistence/           # Repository implementations
â”‚   â”‚   â”œâ”€â”€ grpc/                  # gRPC client adapters
â”‚   â”‚   â”œâ”€â”€ config/                # Configuration management
â”‚   â”‚   â””â”€â”€ logging/               # Logging infrastructure
â”‚   â”‚
â”‚   â””â”€â”€ presentation/              # Presentation Layer (Qt)
â”‚       â”œâ”€â”€ main_window/           # Main window and navigation
â”‚       â”œâ”€â”€ widgets/               # Reusable widgets
â”‚       â”œâ”€â”€ views/                 # Feature views
â”‚       â”œâ”€â”€ view_models/           # MVVM view models
â”‚       â””â”€â”€ resources/             # Icons, styles, translations
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/                      # Unit tests (domain, application)
â”‚   â”œâ”€â”€ integration/               # Integration tests
â”‚   â””â”€â”€ e2e/                       # End-to-end UI tests
â”‚
â”œâ”€â”€ configs/                       # Application configs
â””â”€â”€ scripts/                       # Build and development scripts
```

### 2.2 Dependency Flow

```
Presentation â†’ Application â†’ Domain
      â†“              â†“
Infrastructure â†â”€â”€â”€â”€â”˜
```

**Rule**: Dependencies only flow inward. Domain has no external dependencies.

### 2.3 Qt Integration Pattern

```python
# Presentation layer uses Qt, but view models are testable
class PortfolioViewModel(QObject):
    """MVVM ViewModel - bridges domain and UI"""

    portfolio_updated = Signal(object)  # Qt Signal

    def __init__(self, portfolio_service: IPortfolioService):
        super().__init__()
        self._service = portfolio_service  # Injected, mockable

    def refresh(self) -> None:
        """Fetch and emit portfolio data"""
        portfolio = self._service.get_portfolio()
        self.portfolio_updated.emit(portfolio)
```

---

## 3. Features

### F01: Main Window & Navigation

**Description**: Core application window with sidebar navigation.

**UI Mockup** (from PRD 6.1):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Joohan Trading System                               [User] [Settings]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  [ğŸ“Š ëŒ€ì‹œë³´ë“œ]  [ğŸ“¥ ë°ì´í„° ìˆ˜ì§‘]  [ğŸ” ìŠ¤ìºë„ˆ]  [ğŸ“ˆ ë°±í…ŒìŠ¤íŠ¸]             â”‚
â”‚                                                                          â”‚
â”‚  [ğŸ“ ì „ëµ]  [ğŸ’µ í˜ì´í¼ íŠ¸ë ˆì´ë”©]  [âš¡ ì‹¤ì „ ë§¤ë§¤]  [âš™ï¸ ê³„ì¢Œ ê´€ë¦¬]        â”‚
â”‚                                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚                         [Content Area]                                   â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Components**:
- `MainWindow`: QMainWindow with stacked widget for views
- `NavigationBar`: Custom widget with navigation buttons
- `StatusBar`: Connection status, rate limit indicators

### F02: Settings Management

**Description**: Persistent application settings using QSettings.

**Settings Categories**:
| Category | Examples |
|----------|----------|
| General | Language, theme, startup behavior |
| Broker | Connection URLs, credentials (encrypted) |
| UI | Window geometry, column widths |
| Trading | Default position size, risk limits |

**Implementation**:
```python
class SettingsService:
    """Cross-platform settings management"""

    def __init__(self):
        self._settings = QSettings("JoohanTech", "JTS")

    def get(self, key: str, default: Any = None) -> Any:
        return self._settings.value(key, default)

    def set(self, key: str, value: Any) -> None:
        self._settings.setValue(key, value)
```

### F03: Dependency Injection Container

**Description**: Lightweight DI for testability.

**Pattern**: Service Locator with registration

```python
class Container:
    """Simple DI container"""

    _services: dict[type, Any] = {}

    @classmethod
    def register(cls, interface: type, implementation: Any) -> None:
        cls._services[interface] = implementation

    @classmethod
    def resolve(cls, interface: type) -> Any:
        return cls._services[interface]
```

### F04: Logging Infrastructure

**Description**: Structured logging with file rotation.

**Requirements**:
- Log levels: DEBUG, INFO, WARNING, ERROR, CRITICAL
- File rotation (10MB, 5 backups)
- Structured format (JSON for parsing)
- Qt message handler integration

### F05: Error Handling

**Description**: Centralized error handling with user-friendly messages.

**Pattern**:
```python
class ApplicationError(Exception):
    """Base application error"""

    def __init__(self, message: str, user_message: str = None):
        super().__init__(message)
        self.user_message = user_message or message

class ErrorHandler:
    """Centralized error handling"""

    def handle(self, error: Exception) -> None:
        if isinstance(error, ApplicationError):
            self._show_user_message(error.user_message)
        else:
            self._show_generic_error()
        self._log_error(error)
```

---

## 4. Technical Specifications

### 4.1 Technology Stack

| Component | Technology |
|-----------|------------|
| UI Framework | PySide6 (Qt 6.5+) |
| Python Version | 3.11+ |
| Dependency Management | Poetry |
| Testing | pytest, pytest-qt |
| Linting | ruff, mypy |
| Formatting | black |

### 4.2 Qt Threading Model

```python
# Background work pattern
class WorkerThread(QThread):
    result_ready = Signal(object)
    error_occurred = Signal(Exception)

    def __init__(self, task: Callable):
        super().__init__()
        self._task = task

    def run(self):
        try:
            result = self._task()
            self.result_ready.emit(result)
        except Exception as e:
            self.error_occurred.emit(e)
```

### 4.3 Signal/Slot Communication

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Signal      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ViewModel  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    View     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²                               â”‚
       â”‚         User Action           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Tasks Breakdown

| Task ID | Title | Effort | Dependencies |
|---------|-------|--------|--------------|
| E01-F01-T01 | Create project structure with Poetry | S | - |
| E01-F01-T02 | Implement MainWindow skeleton | M | T01 |
| E01-F01-T03 | Create NavigationBar widget | M | T02 |
| E01-F01-T04 | Implement view stacking/routing | M | T02 |
| E01-F02-T01 | Create SettingsService | S | T01 |
| E01-F02-T02 | Create SettingsDialog | M | T01, F02-T01 |
| E01-F03-T01 | Implement DI Container | S | T01 |
| E01-F03-T02 | Create application bootstrap | M | T01, F03-T01 |
| E01-F04-T01 | Configure logging infrastructure | S | T01 |
| E01-F05-T01 | Implement ErrorHandler | S | T01 |
| E01-F05-T02 | Create error dialog components | S | T01, F05-T01 |

**Effort Legend**: S = Small (< 2 hours), M = Medium (2-4 hours), L = Large (4-8 hours)

---

## 6. Acceptance Criteria

### 6.1 Functional

- [ ] Application launches without errors on Linux, macOS, Windows
- [ ] Navigation between all main views works correctly
- [ ] Settings persist across application restarts
- [ ] All errors are caught and displayed with user-friendly messages
- [ ] Logs are written to rotating log files

### 6.2 Non-Functional

- [ ] Application starts in < 2 seconds
- [ ] UI remains responsive during background operations
- [ ] Memory usage < 200MB at idle
- [ ] All public interfaces have type hints

### 6.3 Testing

- [ ] Unit test coverage > 80% for domain and application layers
- [ ] Integration tests for settings persistence
- [ ] UI tests for navigation flow

---

## 7. TDD Approach

### 7.1 Test Structure

```
tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ domain/                # Domain entity tests
â”‚   â”œâ”€â”€ application/           # Use case tests
â”‚   â””â”€â”€ infrastructure/        # Adapter tests (mocked)
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ test_settings.py       # Settings persistence
â”‚   â””â”€â”€ test_container.py      # DI resolution
â””â”€â”€ e2e/
    â””â”€â”€ test_navigation.py     # UI navigation flows
```

### 7.2 Example Test (Red-Green-Refactor)

```python
# RED: Write failing test first
def test_settings_service_persists_value():
    service = SettingsService()
    service.set("test.key", "test_value")

    # Simulate app restart
    new_service = SettingsService()
    assert new_service.get("test.key") == "test_value"

# GREEN: Implement minimum to pass
# REFACTOR: Clean up implementation
```

---

## 8. DDD Patterns

### 8.1 Domain Events

```python
@dataclass(frozen=True)
class DomainEvent:
    """Base class for domain events"""
    occurred_at: datetime = field(default_factory=datetime.utcnow)

@dataclass(frozen=True)
class SettingsChangedEvent(DomainEvent):
    key: str
    old_value: Any
    new_value: Any
```

### 8.2 Repository Pattern

```python
from abc import ABC, abstractmethod

class ISettingsRepository(ABC):
    """Repository interface - domain layer"""

    @abstractmethod
    def get(self, key: str) -> Optional[Any]: ...

    @abstractmethod
    def set(self, key: str, value: Any) -> None: ...

# Infrastructure implementation
class QSettingsRepository(ISettingsRepository):
    """QSettings-backed implementation"""

    def __init__(self):
        self._settings = QSettings("JoohanTech", "JTS")

    def get(self, key: str) -> Optional[Any]:
        return self._settings.value(key)

    def set(self, key: str, value: Any) -> None:
        self._settings.setValue(key, value)
```

---

## 9. Platform Notes

### 9.1 Linux

- Primary development platform
- Use system Qt or bundled Qt
- XDG Base Directory for configs: `~/.config/JoohanTech/JTS/`

### 9.2 macOS

- Bundle as .app for distribution
- Settings in: `~/Library/Preferences/com.joohantech.jts.plist`
- Notarization required for distribution

### 9.3 Windows

- Settings in Registry: `HKEY_CURRENT_USER\Software\JoohanTech\JTS`
- Consider PyInstaller for distribution
- Test COM compatibility for potential future Creon direct integration

---

## 10. References

- [PySide6 Documentation](https://doc.qt.io/qtforpython/)
- [DDD in Python](https://cosmicpython.com/)
- PRD Section 6: User Interface Requirements
- Existing JTS: `/home/joohan/dev/project-jts/jts/` (architecture patterns)
