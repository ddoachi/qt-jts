# Spec: E01-F01-T04 - Add StatusBar with connection indicators

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E01-F01-T04
clickup_task_id: '86ew0209t'
title: Add StatusBar with connection indicators
type: task

# === HIERARCHY ===
parent: E01-F01
children: []
epic: E01
feature: F01
task: T04
domain: application-framework

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [ui, pyside6, status-bar, connection-status, parallel]
effort: medium
risk: low
parallel: true
---

**Status**: Draft
**Type**: Task
**Parent**: E01-F01 (Main Window & Navigation)
**Created**: 2025-12-28
**Updated**: 2025-12-28
**Parallel**: [P] Can be executed in parallel with T01, T02, T06

## Executive Summary

Implement a custom `StatusBar` widget to be displayed at the bottom of MainWindow. The status bar will show broker connection status indicators (Interactive Brokers, Alpaca), system status messages, and timestamp information. This provides traders with critical connection state awareness at all times.

## Execution Flow

```
1. Create StatusBar class inheriting from QWidget
   → Import PySide6.QtWidgets (QWidget, QHBoxLayout, QLabel)
   → Initialize with horizontal layout
   → Set fixed height (25px) for consistency

2. Create connection status indicator widgets
   → Create IBConnectionIndicator (QLabel with icon/text)
   → Create AlpacaConnectionIndicator (QLabel with icon/text)
   → Initialize with "Disconnected" state and gray icon
   → Apply indicator styling (colors, borders, padding)

3. Create status message area
   → Create QLabel for general status messages
   → Set alignment to left
   → Apply text styling (font, color)
   → Initialize with "Ready" message

4. Create timestamp display
   → Create QLabel for current time display
   → Set alignment to right
   → Create QTimer to update every second
   → Format: "HH:MM:SS" (24-hour format)

5. Arrange widgets in layout
   → Add IB indicator (left)
   → Add Alpaca indicator (left)
   → Add spacer (stretch)
   → Add status message (center-left)
   → Add spacer (stretch)
   → Add timestamp (right)
   → Set margins and spacing

6. Implement connection status update methods
   → set_ib_status(connected: bool, message: str = "")
     → Update IB indicator color and text
     → Green icon if connected, gray if disconnected
     → Show connection message in tooltip
   → set_alpaca_status(connected: bool, message: str = "")
     → Update Alpaca indicator similarly
   → Log status changes

7. Implement status message API
   → show_message(message: str, duration: int = 0)
     → Display message in status area
     → If duration > 0: Auto-clear after milliseconds
     → If duration = 0: Persist until next message
   → clear_message()
     → Clear status message, show "Ready"

8. Implement auto-updating timestamp
   → Create _update_timestamp() method
   → Get current time: QDateTime.currentDateTime()
   → Format and update timestamp label
   → Connect to QTimer.timeout signal

9. Apply StatusBar styling
   → Background color: light gray
   → Border-top: subtle separator
   → Font: smaller than main UI
   → Connection indicators: pill-shaped with icons
```

## User Stories

### Primary User Story
**As a** trader
**I want to** see broker connection status at a glance in the status bar
**So that** I know if I'm connected before attempting trades or data requests

### Additional Stories
- **As a** trader, **I want to** see system status messages, **So that** I'm informed of important events and operations
- **As a** trader, **I want to** see the current time, **So that** I can correlate events with timestamps

## Acceptance Scenarios

### Scenario 1: Happy Path - StatusBar Display
**Given** MainWindow is initialized with StatusBar
**When** the window is displayed
**Then** the status bar should be visible at the bottom
**And** IB connection indicator should show "Disconnected" with gray icon
**And** Alpaca connection indicator should show "Disconnected" with gray icon
**And** status message should show "Ready"
**And** timestamp should show current time in HH:MM:SS format

### Scenario 2: Connection Status Update
**Given** StatusBar is displayed with disconnected indicators
**When** set_ib_status(True, "Connected to TWS") is called
**Then** IB indicator should turn green
**And** IB indicator text should show "IB: Connected"
**And** tooltip should show "Connected to TWS"

### Scenario 3: Status Message Display
**Given** StatusBar is displayed
**When** show_message("Loading market data...", duration=3000) is called
**Then** the status message should display "Loading market data..."
**And** after 3 seconds the message should clear to "Ready"

### Scenario 4: Timestamp Updates
**Given** StatusBar is displayed
**When** 1 second elapses
**Then** the timestamp should update to show new current time
**And** the format should remain HH:MM:SS

## Requirements

### Functional Requirements
- **FR-001**: StatusBar MUST display connection indicators for IB and Alpaca
- **FR-002**: StatusBar MUST provide set_ib_status() and set_alpaca_status() methods
- **FR-003**: StatusBar MUST display general status messages
- **FR-004**: StatusBar MUST provide show_message() method with optional duration
- **FR-005**: StatusBar MUST display current time updated every second
- **FR-006**: StatusBar MUST visually distinguish connected vs disconnected state (color)

### Non-Functional Requirements
- **NFR-001**: Connection status updates MUST be instant (< 50ms visual feedback)
- **NFR-002**: Timestamp updates MUST be accurate to within 1 second
- **NFR-003**: StatusBar MUST have fixed height to prevent layout shifts

### Technical Constraints
- **TC-001**: Must use PySide6.QtWidgets.QWidget as base class
- **TC-002**: Must use QTimer for timestamp updates
- **TC-003**: Must use QHBoxLayout for horizontal arrangement
- **TC-004**: Must integrate with MainWindow as bottom widget

## Key Entities

### Entity: StatusBar
- **Description**: Bottom status bar with connection and status indicators
- **Key Attributes**:
  - `_ib_indicator: QLabel` - IB connection status widget
  - `_alpaca_indicator: QLabel` - Alpaca connection status widget
  - `_status_label: QLabel` - General status message widget
  - `_timestamp_label: QLabel` - Current time display
  - `_timer: QTimer` - Timer for timestamp updates
- **Key Methods**:
  - `set_ib_status(connected: bool, message: str = "") -> None`
  - `set_alpaca_status(connected: bool, message: str = "") -> None`
  - `show_message(message: str, duration: int = 0) -> None`
  - `clear_message() -> None`
  - `_update_timestamp() -> None`

## Dependencies

### Upstream Dependencies
None - This task can be executed in parallel

### Downstream Impact
- [ ] T03: StatusBar will be added to MainWindow layout
- [ ] E02/E03 features: Will update connection status via StatusBar API

## Implementation Details

### File Structure
```
src/presentation/status_bar.py
tests/unit/presentation/test_status_bar.py
```

### Code Skeleton
```python
from PySide6.QtWidgets import QWidget, QHBoxLayout, QLabel, QSpacerItem, QSizePolicy
from PySide6.QtCore import QTimer, QDateTime, Slot
from typing import Optional

class StatusBar(QWidget):
    """Bottom status bar with connection and system status."""

    def __init__(self):
        """Initialize status bar."""
        super().__init__()
        self._setup_ui()
        self._start_timer()

    def _setup_ui(self) -> None:
        """Setup the user interface."""
        layout = QHBoxLayout(self)
        layout.setContentsMargins(5, 2, 5, 2)
        layout.setSpacing(10)

        # Connection indicators
        self._ib_indicator = self._create_indicator("IB: Disconnected", False)
        self._alpaca_indicator = self._create_indicator("Alpaca: Disconnected", False)

        layout.addWidget(self._ib_indicator)
        layout.addWidget(self._alpaca_indicator)

        # Spacer
        layout.addItem(QSpacerItem(20, 10, QSizePolicy.Expanding, QSizePolicy.Minimum))

        # Status message
        self._status_label = QLabel("Ready")
        self._status_label.setStyleSheet("color: #2c3e50; font-size: 12px;")
        layout.addWidget(self._status_label)

        # Spacer
        layout.addItem(QSpacerItem(20, 10, QSizePolicy.Expanding, QSizePolicy.Minimum))

        # Timestamp
        self._timestamp_label = QLabel()
        self._timestamp_label.setStyleSheet("color: #7f8c8d; font-size: 12px;")
        layout.addWidget(self._timestamp_label)

        # Styling
        self.setFixedHeight(25)
        self.setStyleSheet("""
            StatusBar {
                background-color: #ecf0f1;
                border-top: 1px solid #bdc3c7;
            }
        """)

    def _create_indicator(self, text: str, connected: bool) -> QLabel:
        """Create connection status indicator.

        Args:
            text: Indicator text
            connected: Connection state

        Returns:
            Configured QLabel
        """
        label = QLabel(text)
        color = "#27ae60" if connected else "#95a5a6"
        label.setStyleSheet(f"""
            QLabel {{
                background-color: {color};
                color: white;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 11px;
                font-weight: bold;
            }}
        """)
        return label

    def _start_timer(self) -> None:
        """Start timestamp update timer."""
        self._timer = QTimer(self)
        self._timer.timeout.connect(self._update_timestamp)
        self._timer.start(1000)  # Update every second
        self._update_timestamp()  # Initial update

    @Slot()
    def _update_timestamp(self) -> None:
        """Update timestamp display."""
        current_time = QDateTime.currentDateTime().toString("hh:mm:ss")
        self._timestamp_label.setText(current_time)

    def set_ib_status(self, connected: bool, message: str = "") -> None:
        """Set Interactive Brokers connection status.

        Args:
            connected: True if connected, False if disconnected
            message: Optional status message for tooltip
        """
        status_text = "IB: Connected" if connected else "IB: Disconnected"
        self._ib_indicator.setText(status_text)

        color = "#27ae60" if connected else "#95a5a6"
        self._ib_indicator.setStyleSheet(f"""
            QLabel {{
                background-color: {color};
                color: white;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 11px;
                font-weight: bold;
            }}
        """)

        if message:
            self._ib_indicator.setToolTip(message)

    def set_alpaca_status(self, connected: bool, message: str = "") -> None:
        """Set Alpaca connection status.

        Args:
            connected: True if connected, False if disconnected
            message: Optional status message for tooltip
        """
        status_text = "Alpaca: Connected" if connected else "Alpaca: Disconnected"
        self._alpaca_indicator.setText(status_text)

        color = "#27ae60" if connected else "#95a5a6"
        self._alpaca_indicator.setStyleSheet(f"""
            QLabel {{
                background-color: {color};
                color: white;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 11px;
                font-weight: bold;
            }}
        """)

        if message:
            self._alpaca_indicator.setToolTip(message)

    def show_message(self, message: str, duration: int = 0) -> None:
        """Show status message.

        Args:
            message: Message to display
            duration: Duration in milliseconds (0 = persistent)
        """
        self._status_label.setText(message)

        if duration > 0:
            QTimer.singleShot(duration, self.clear_message)

    def clear_message(self) -> None:
        """Clear status message."""
        self._status_label.setText("Ready")
```

### Integration with MainWindow
```python
# In MainWindow._setup_ui()
self._status_bar = StatusBar()

# Add to layout (assuming QVBoxLayout for main window)
main_layout.addWidget(self._status_bar)

# Or use setStatusBar if using QMainWindow's built-in status bar area
# self.setStatusBar(self._status_bar)
```

## Success Criteria

### Acceptance Criteria
- [ ] StatusBar widget created with fixed height
- [ ] IB and Alpaca connection indicators displayed
- [ ] Connection indicators show correct initial state (disconnected)
- [ ] set_ib_status() updates IB indicator color and text
- [ ] set_alpaca_status() updates Alpaca indicator color and text
- [ ] Status message area displays messages
- [ ] show_message() with duration auto-clears after specified time
- [ ] Timestamp displays current time in HH:MM:SS format
- [ ] Timestamp updates every second accurately
- [ ] StatusBar integrates cleanly into MainWindow

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing with 80%+ coverage
  - [ ] Test StatusBar initialization
  - [ ] Test set_ib_status() updates
  - [ ] Test set_alpaca_status() updates
  - [ ] Test show_message() with duration
  - [ ] Test timestamp updates
- [ ] Code follows PEP 8 style guidelines
- [ ] Docstrings complete for all public methods
- [ ] Visual styling verified on target platforms

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Timer not updating timestamp | Low | Low | Test QTimer functionality, add fallback manual update |
| Status updates lag or freeze UI | Low | Medium | Ensure updates are lightweight, test performance |
| Color scheme inconsistent across platforms | Low | Low | Test on all platforms, use platform-agnostic colors |

## Notes and Clarifications

### Design Decisions
- 2025-12-28: Use pill-shaped indicators for modern, professional appearance
- 2025-12-28: Fixed height (25px) prevents status bar from affecting main content layout
- 2025-12-28: Auto-clearing messages with duration for temporary notifications

### Implementation Notes
- Can be extended with additional indicators (e.g., network status, data feed status)
- Tooltip on connection indicators provides detailed connection information
- Consider adding click handler on indicators to show connection details dialog (future)

---
*Template Version: 2.0.0 - Task Level Spec*
