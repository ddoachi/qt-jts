# Spec: E01-F04 - Logging Infrastructure

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E01-F04
clickup_task_id: ''    # REQUIRED - Empty string if not yet created in ClickUp
title: Logging Infrastructure
type: feature

# === HIERARCHY ===
parent: E01
children: []
epic: E01
feature: F04
domain: application-framework

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 8
actual_hours: 0

# === METADATA ===
tags: [logging, infrastructure, debugging, monitoring, json]
effort: small
risk: low
---

**Status**: Draft
**Type**: Feature
**Parent**: E01 (Application Framework)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement structured logging infrastructure with file rotation, multiple log levels, and integration with Qt's message handling system. This feature provides structured logging with consistent JSON/text formatting, automatic file rotation to manage disk space, multiple log levels (DEBUG, INFO, WARNING, ERROR, CRITICAL), Qt message handler integration to capture Qt framework warnings/errors, performance-friendly non-blocking logging operations, and rich contextual information for debugging.

## Execution Flow

```
1. Initialize Logger on application startup
   → Create logger with name "JTS"
   → Set log level to DEBUG for maximum capture
   → Determine log directory (default: ~/.jts/logs)
   → Create log directory if not exists
   → If directory creation fails: ERROR "Failed to create log directory: {reason}"

2. Configure file handler with rotation
   → Create RotatingFileHandler with 10MB max size, 5 backups
   → Attach JsonFormatter for structured logs
   → Set handler level to DEBUG
   → Add handler to logger
   → If handler setup fails: WARN "File logging disabled: {reason}"

3. Configure console handler
   → Create StreamHandler for stdout
   → Attach TextFormatter for human-readable output
   → Set handler level to INFO (less verbose than file)
   → Add handler to logger

4. Install Qt message handler (optional)
   → Register qt_message_handler with qInstallMessageHandler
   → Map Qt message types to logging levels
   → If installation fails: WARN "Qt message handling not available"

5. Log message (any level: debug, info, warning, error, critical)
   → Receive message and optional context kwargs
   → Create LogRecord with metadata (timestamp, module, function, line)
   → Add extra context from kwargs if provided
   → Pass to configured handlers (file + console)
   → Each handler formats and writes message
   → If exception info provided: Include full traceback
   → Return: SUCCESS (logging is fire-and-forget)

6. Log rotation (automatic)
   → RotatingFileHandler monitors file size
   → When jts.log reaches 10MB:
     → Rename jts.log → jts.log.1
     → Rename jts.log.1 → jts.log.2 (cascade to .5)
     → Delete jts.log.5 (oldest backup)
     → Create new empty jts.log
   → Continue logging to new file
```

## User Stories

### Primary User Story
**As a** developer
**I want to** have comprehensive logging of all application events and errors
**So that** I can debug issues and understand application behavior in production

### Additional Stories
- **As a** developer, **I want to** see structured JSON logs in files, **So that** I can parse and analyze logs programmatically
- **As a** developer, **I want to** see human-readable logs in console, **So that** I can quickly understand what's happening during development
- **As a** developer, **I want to** capture Qt framework messages, **So that** I don't miss important warnings from the UI framework
- **As a** user, **I want to** have automatic log rotation, **So that** logs don't fill up my disk space over time

## Acceptance Scenarios

### Scenario 1: Happy Path - First Log Message
**Given** the application starts and Logger is initialized
**When** the first info message is logged
**Then** a log file should be created at ~/.jts/logs/jts.log
**And** the console should display the message with timestamp and level
**And** the file should contain JSON-formatted log entry

### Scenario 2: Log Levels Filtering
**Given** the Logger is configured with file=DEBUG, console=INFO
**When** a DEBUG message is logged
**Then** the message should appear in the log file
**And** the message should NOT appear in the console output

### Scenario 3: Exception Logging with Traceback
**Given** an exception occurs in the application
**When** logger.exception() is called with the exception
**Then** the log should include the exception message
**And** the log should include the full stack traceback
**And** the exception info should be in both file and console logs

### Scenario 4: Log Rotation at Size Limit
**Given** the log file jts.log has grown to 10MB
**When** the next log message is written
**Then** jts.log should be renamed to jts.log.1
**And** a new empty jts.log should be created
**And** logging should continue without interruption
**And** no log messages should be lost during rotation

### Scenario 5: Qt Message Integration
**Given** the Qt message handler is installed
**When** Qt framework emits a warning message
**Then** the warning should be logged through the Logger system
**And** the log should include "[Qt]" prefix
**And** the log should include Qt context (file, line number)

## Requirements

### Functional Requirements
- **FR-001**: System MUST write logs to rotating log files with 10MB max size and 5 backups
- **FR-002**: System MUST display INFO level and above messages to console
- **FR-003**: System MUST write DEBUG level and above messages to file
- **FR-004**: System MUST format file logs as parseable JSON
- **FR-005**: System MUST format console logs as human-readable text
- **FR-006**: System MUST capture Qt framework messages when handler is installed
- **FR-007**: System MUST include exception tracebacks when logging exceptions
- **FR-008**: System MUST create log directory automatically if it doesn't exist
- **FR-009**: System MUST support contextual logging (extra kwargs)

### Non-Functional Requirements
- **NFR-001**: Performance: Logging MUST have minimal performance impact (< 1ms per log call)
- **NFR-002**: Reliability: Log rotation MUST happen automatically at size limit without message loss
- **NFR-003**: Compatibility: Logs MUST be UTF-8 encoded to support Korean and all Unicode characters
- **NFR-004**: Usability: JSON logs MUST be valid JSON and parseable by standard tools
- **NFR-005**: Maintainability: All public methods MUST have type hints and docstrings

### Technical Constraints
- **TC-001**: Must use Python standard library logging module
- **TC-002**: Must use RotatingFileHandler for file rotation
- **TC-003**: Must encode logs as UTF-8
- **TC-004**: Must integrate with Qt using qInstallMessageHandler
- **TC-005**: Must use JSON format for structured file logs

## Key Entities

### Entity: Logger
- **Description**: Main logging interface providing log methods (debug, info, warning, error, critical, exception)
- **Key Attributes**: `_logger` (logging.Logger), handlers (list)
- **Relationships**: Registered in DI Container as singleton, used by all components

### Entity: JsonFormatter
- **Description**: Formats log records as JSON for file storage
- **Key Attributes**: N/A (formatter function)
- **Relationships**: Attached to RotatingFileHandler

### Entity: TextFormatter
- **Description**: Formats log records as human-readable text for console
- **Key Attributes**: Format string, date format
- **Relationships**: Attached to StreamHandler

## Dependencies

### Upstream Dependencies
- [ ] E01-F03 (DI Container): Logger will be registered as singleton service

### Downstream Impact
- [ ] All features: Will use Logger for debugging and monitoring
- [ ] E01-F05 (Error Handler): Will use Logger for error logging

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Performance requirements specified (< 1ms per log call)
- [x] Security requirements defined (N/A for logging)
- [x] Scale requirements clear (thousands of log messages per session)
- [x] PRD compliance verified

### Quality Gates
- [ ] Complexity justified (standard logging patterns, appropriate complexity)
- [ ] All requirements testable (unit and integration tests planned)
- [ ] Dependencies identified (minimal - only DI Container)
- [ ] Risk assessment complete (minimal risk with standard library)

## Tasks Preview

### Implementation Tasks
- [ ] T01 [P] Implement Logger class with log methods
- [ ] T02 [P] Implement JsonFormatter for structured logs
- [ ] T03 [P] Implement TextFormatter for console logs
- [ ] T04 [P] Configure rotating file handler
- [ ] T05 [P] Implement Qt message handler integration
- [ ] T06 Add logging configuration management (depends on T01-T04)

**[P]** = Can be executed in parallel

## Success Criteria

### Acceptance Criteria
- [ ] Logs are written to rotating log files (10MB max, 5 backups)
- [ ] Console displays INFO level and above messages
- [ ] File contains DEBUG level and above messages
- [ ] JSON format logs are parseable by json.loads()
- [ ] Qt framework messages are captured when handler installed
- [ ] Exception tracebacks are included in exception logs
- [ ] Log directory is created automatically if missing
- [ ] Logging has minimal performance impact (< 1ms per call)
- [ ] Log rotation happens automatically at 10MB size limit
- [ ] Logs are UTF-8 encoded and support Korean characters
- [ ] No log messages are lost during rotation

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Tests passing (unit, integration)
  - [ ] Unit tests for Logger methods (debug, info, warning, error, critical)
  - [ ] Unit tests for JsonFormatter output validation
  - [ ] Unit tests for TextFormatter output validation
  - [ ] Integration test for log file creation
  - [ ] Integration test for log rotation behavior
- [ ] Documentation updated (pre-docs, post-docs)
- [ ] Performance validated (< 1ms per log call)
- [ ] UTF-8 encoding verified with Korean test strings
- [ ] 80% test coverage achieved

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Log file permission errors | Low | Medium | Handle permission errors gracefully, fall back to console-only logging |
| Disk space exhaustion | Low | Medium | Rotating file handler limits total log size to ~50MB |
| Performance impact on I/O | Low | Low | Use buffered handlers, log asynchronously if needed |
| Log format breaking changes | Low | Low | Version log format, maintain backward compatibility |
| Qt message handler conflicts | Low | Low | Check if handler already installed, document limitations |

## Notes and Clarifications

### Open Questions
None - All requirements are clear

### Decisions Made
- 2025-12-28: Use JSON for file logs and plain text for console to balance parseability and readability
- 2025-12-28: Use RotatingFileHandler from standard library instead of TimedRotatingFileHandler for simpler size-based rotation
- 2025-12-28: Integrate with Qt message handler to capture all Qt framework messages in unified logging system
- 2025-12-28: Use UTF-8 encoding to support Korean and all international characters

### Research Needed
None - Python logging module is well-documented and battle-tested

## Artifacts

### Input Documents
- [Product Requirements Document](../../../docs/product-requirements-document.md)
- [Parent Spec](../E01.spec.md) (Epic E01)

### Output Artifacts (to be generated)
- [ ] `E01-F04.context.md` - Implementation context and progress
- [ ] `E01-F04.pre-docs.md` - Pre-implementation documentation ✓ (Already created)
- [ ] `E01-F04.post-docs.md` - Post-implementation learnings
- [ ] `E01-F04-implementation-narrative.md` - Comprehensive implementation story
- [ ] Source: `src/infrastructure/logging/logger.py`
- [ ] Source: `src/infrastructure/logging/formatters.py`
- [ ] Source: `src/infrastructure/logging/handlers.py`
- [ ] Unit tests: `tests/unit/infrastructure/logging/test_logger.py`
- [ ] Unit tests: `tests/unit/infrastructure/logging/test_formatters.py`
- [ ] Integration tests: `tests/integration/test_logging.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
