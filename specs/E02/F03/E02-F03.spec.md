# Spec: E02-F03 - Infrastructure Implementation

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E02-F03
clickup_task_id: ''
title: Infrastructure Implementation
type: feature

# === HIERARCHY ===
parent: E02
children: [E02-F03-T01, E02-F03-T02, E02-F03-T03, E02-F03-T04, E02-F03-T05, E02-F03-T06]
epic: E02
feature: F03
domain: storage

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 24
actual_hours: 0

# === METADATA ===
tags: [infrastructure, clickhouse, mongodb, repositories]
effort: large
risk: medium
---

**Status**: Draft
**Type**: Feature
**Parent**: [E02 - Storage Layer](../E02.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement concrete repository implementations using ClickHouse for time-series data (candles, symbols) and MongoDB for document data (formulas, strategies). This includes connection managers with pooling, retry logic, and production-ready repository implementations that fulfill the interfaces defined in E02-F02.

## Execution Flow

```
1. Create ClickHouseManager
   → Connection pooling and lifecycle management
   → Retry logic with exponential backoff
   → Health check capability
   → If connection fails: ERROR "ClickHouse connection failed"

2. Create MongoDBManager
   → PyMongo connection pooling
   → Database and collection access
   → Health check via ping
   → If connection fails: ERROR "MongoDB connection failed"

3. Implement ClickHouseCandleRepository
   → Batch inserts for 100k+ candles
   → Range queries with FINAL for deduplication
   → Coverage and count operations

4. Implement ClickHouseSymbolRepository
   → CRUD operations with code-based lookup
   → Market and search queries
   → ReplacingMergeTree for upserts

5. Implement MongoDBFormulaRepository
   → Document CRUD with ObjectId
   → Text search and tag queries
   → Index creation for performance

6. Implement MongoDBStrategyRepository
   → Complex document structure
   → Formula reference queries
   → Return: SUCCESS with all implementations
```

## User Stories

### Primary User Story
**As a** use case implementer
**I want to** inject production repository implementations
**So that** data is persisted to ClickHouse and MongoDB

### Additional Stories
- **As a** DevOps engineer, **I want to** connection health checks, **So that** I can monitor system health
- **As a** data engineer, **I want to** high-performance batch inserts, **So that** large imports complete quickly

## Acceptance Scenarios

### Scenario 1: ClickHouse Connection
**Given** valid ClickHouse credentials
**When** creating ClickHouseManager
**Then** connection is established with pooling

### Scenario 2: Batch Insert Performance
**Given** ClickHouseCandleRepository
**When** inserting 100,000 candles
**Then** operation completes in < 5 seconds

### Scenario 3: MongoDB Text Search
**Given** MongoDBFormulaRepository with indexed formulas
**When** searching by name or description
**Then** matching formulas are returned efficiently

### Scenario 4: Formula Reference Query
**Given** MongoDBStrategyRepository with strategies
**When** querying by formula ID
**Then** all strategies using that formula are returned

## Requirements

### Functional Requirements
- **FR-001**: ClickHouseManager MUST support connection pooling
- **FR-002**: ClickHouseManager MUST implement retry with exponential backoff
- **FR-003**: MongoDBManager MUST provide collection access
- **FR-004**: All repositories MUST implement their interface fully
- **FR-005**: ClickHouseCandleRepository MUST use FINAL for accurate reads
- **FR-006**: MongoDBFormulaRepository MUST create text indexes
- **FR-007**: All repositories MUST handle connection failures gracefully

### Non-Functional Requirements
- **NFR-001**: Insert 100,000 candles in < 5 seconds
- **NFR-002**: Query 1,000,000 candles in < 1 second
- **NFR-003**: MongoDB CRUD operations < 100ms each
- **NFR-004**: Health check response < 500ms

### Technical Constraints
- **TC-001**: Use clickhouse-driver >= 0.2.0
- **TC-002**: Use pymongo >= 4.0.0
- **TC-003**: Use tenacity for retry logic
- **TC-004**: Docker containers for integration tests

## Key Entities

### Class: ClickHouseManager
```python
class ClickHouseManager:
    def __init__(host, port, database, user, password, ...)
    def connect() -> Client
    def execute(query, params) -> Any
    def execute_many(query, data) -> None
    def health_check() -> bool
    def close() -> None
```

### Class: MongoDBManager
```python
class MongoDBManager:
    def __init__(uri, database, max_pool_size, ...)
    @property client: MongoClient
    @property db: Database
    def get_collection(name) -> Collection
    def health_check() -> bool
    def close() -> None
```

### Interface Implementations
```python
# ClickHouse
class ClickHouseCandleRepository(ICandleRepository): ...
class ClickHouseSymbolRepository(ISymbolRepository): ...

# MongoDB
class MongoDBFormulaRepository(IFormulaRepository): ...
class MongoDBStrategyRepository(IStrategyRepository): ...
```

## Dependencies

### Upstream Dependencies
- [ ] E02-F01: Domain entities (Symbol, Candle, Formula, Strategy)
- [ ] E02-F02: Repository interfaces to implement

### Downstream Impact
- [ ] E02-F04: Use cases use these implementations
- [ ] All production features depend on this infrastructure

## Gate Checks

### Pre-Implementation Gates
- [x] Database schemas defined
- [x] Connection parameters known
- [x] Docker containers available

### Quality Gates
- [ ] Integration tests passing
- [ ] Performance benchmarks met
- [ ] Test coverage > 85%

## Tasks Preview

### Implementation Tasks
- [ ] [E02-F03-T01](T01/E02-F03-T01.spec.md) Create ClickHouseManager [P]
- [ ] [E02-F03-T02](T02/E02-F03-T02.spec.md) Create MongoDBManager [P]
- [ ] [E02-F03-T03](T03/E02-F03-T03.spec.md) Implement ClickHouseCandleRepository
- [ ] [E02-F03-T04](T04/E02-F03-T04.spec.md) Implement ClickHouseSymbolRepository [P]
- [ ] [E02-F03-T05](T05/E02-F03-T05.spec.md) Implement MongoDBFormulaRepository [P]
- [ ] [E02-F03-T06](T06/E02-F03-T06.spec.md) Implement MongoDBStrategyRepository [P]

**[P]** = Can be executed in parallel

### Wave Analysis
```
Wave 1 (Parallel):    T01, T02 (Connection Managers)
Wave 2 (Parallel):    T03, T04, T05, T06 (Repository Implementations)
```

## Success Criteria

### Acceptance Criteria
- [ ] All repositories implement their interfaces
- [ ] Performance benchmarks pass
- [ ] Integration tests with Docker pass
- [ ] Behavior matches InMemory implementations

### Definition of Done
- [ ] Code reviewed
- [ ] Integration tests passing
- [ ] Performance verified
- [ ] Documentation complete

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| ClickHouse performance issues | Low | High | Proper indexing, FINAL usage |
| MongoDB connection pool exhaustion | Medium | Medium | Configure pool size properly |
| Schema mismatch with JTS DB | Low | High | Verify schemas before implementation |

## Notes and Clarifications

### Decisions Made
- 2025-12-28: Using existing JTS database schemas
- 2025-12-28: tenacity library for retry logic
- 2025-12-28: ReplacingMergeTree for ClickHouse deduplication

### Database Schemas

#### ClickHouse Tables
```sql
-- Candles table
CREATE TABLE candles (
    symbol String,
    exchange String,
    timeframe String,
    timestamp DateTime64(3),
    open Decimal64(4),
    high Decimal64(4),
    low Decimal64(4),
    close Decimal64(4),
    volume UInt64
) ENGINE = MergeTree()
ORDER BY (symbol, timeframe, timestamp);

-- Symbols table
CREATE TABLE symbols (
    code String,
    name String,
    market String,
    sector String,
    is_active UInt8,
    updated_at DateTime
) ENGINE = ReplacingMergeTree(updated_at)
ORDER BY code;
```

#### MongoDB Collections
```javascript
// formulas collection
{ _id, name, expression, category, description, tags, parameters, version, ... }

// strategies collection
{ _id, name, description, entryFormulaId, exitFormulaId, stopLossRule, riskConfig, ... }
```

## Artifacts

### Input Documents
- [E02 - Storage Layer](../E02.spec.md)
- [E02-F02 - Repository Interfaces](../F02/E02-F02.spec.md)

### Output Artifacts
- [ ] `src/infrastructure/database/clickhouse_manager.py`
- [ ] `src/infrastructure/database/mongodb_manager.py`
- [ ] `src/infrastructure/repositories/clickhouse/candle_repository.py`
- [ ] `src/infrastructure/repositories/clickhouse/symbol_repository.py`
- [ ] `src/infrastructure/repositories/mongodb/formula_repository.py`
- [ ] `src/infrastructure/repositories/mongodb/strategy_repository.py`
- [ ] `tests/integration/infrastructure/**/*.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
