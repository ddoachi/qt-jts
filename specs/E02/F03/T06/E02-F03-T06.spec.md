# Spec: E02-F03-T06 - Implement MongoDBStrategyRepository

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E02-F03-T06
clickup_task_id: '86ew01ym6'
title: Implement MongoDBStrategyRepository
type: task

# === HIERARCHY ===
parent: E02-F03
children: []
epic: E02
feature: F03
task: T06
domain: storage

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [infrastructure, mongodb, repository, strategy]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E02-F03 - Infrastructure Implementation](../E02-F03.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement the IStrategyRepository interface using MongoDB for trading strategy storage. Strategies combine multiple formulas with risk configuration, making them complex documents with embedded structures (StopLossRule, RiskConfig) and formula references.

## Execution Flow

```
1. Initialize repository
   → Get strategies collection
   → Create text index on name
   → Create indexes on formula ID fields

2. Implement CRUD operations
   → save(): Insert new or update existing
   → get_by_id(): Find by ObjectId
   → delete(): Remove by ObjectId

3. Implement query methods
   → get_all(): Return all strategies
   → search(): Text search on name
   → get_by_formula_id(): Find by entry/exit/stop formula

4. Implement conversions
   → _strategy_to_doc(): Entity to document with embedded objects
   → _doc_to_strategy(): Document to entity with defaults
   → Handle StopLossRule and RiskConfig
   → Return: SUCCESS with all methods implemented
```

## User Stories

### Primary User Story
**As a** strategy manager
**I want to** persist strategies to MongoDB
**So that** trading strategies are stored durably

### Additional Stories
- **As a** trader, **I want to** search strategies by name, **So that** I can find strategies
- **As a** developer, **I want to** find strategies using a formula, **So that** I can manage dependencies

## Acceptance Scenarios

### Scenario 1: Save Complex Document
**Given** Strategy with StopLossRule and RiskConfig
**When** saving and retrieving
**Then** all nested structures preserved

### Scenario 2: Formula Reference Query
**Given** strategies using formula_A
**When** querying get_by_formula_id("formula_A")
**Then** all referencing strategies returned

### Scenario 3: Default RiskConfig
**Given** Strategy saved without RiskConfig
**When** retrieving
**Then** default RiskConfig values applied

### Scenario 4: Search by Name
**Given** strategies with various names
**When** searching "RSI"
**Then** matching strategies returned

## Requirements

### Functional Requirements
- **FR-001**: save() MUST handle complex nested structures
- **FR-002**: get_by_id() MUST return None for invalid ObjectId
- **FR-003**: get_by_formula_id() MUST check entry, exit, and stop_loss
- **FR-004**: search() MUST use text search on name
- **FR-005**: StopLossRule MUST serialize/deserialize correctly
- **FR-006**: RiskConfig MUST have sensible defaults

### Non-Functional Requirements
- **NFR-001**: CRUD operations < 100ms
- **NFR-002**: Formula reference query efficient via indexes

### Technical Constraints
- **TC-001**: Use pymongo library
- **TC-002**: Create indexes for formula references
- **TC-003**: Use ObjectId for strategy IDs

## Key Entities

### Class: MongoDBStrategyRepository
```python
class MongoDBStrategyRepository(IStrategyRepository):
    def __init__(self, mongo_manager: MongoDBManager): ...

    def save(self, strategy: Strategy) -> Strategy: ...
    def get_by_id(self, strategy_id: str) -> Optional[Strategy]: ...
    def get_all(self) -> list[Strategy]: ...
    def search(self, query: str, limit: int = 20) -> list[Strategy]: ...
    def get_by_formula_id(self, formula_id: str) -> list[Strategy]: ...
    def delete(self, strategy_id: str) -> bool: ...
```

### Supporting Entities
```python
@dataclass
class StopLossRule:
    type: str  # 'formula', 'fixed_pct', 'trailing'
    formula_id: Optional[str] = None
    percentage: Optional[float] = None

@dataclass
class RiskConfig:
    position_size_pct: float = 5.0
    max_positions: int = 10
    take_profit_pct: Optional[float] = None
    max_daily_loss_pct: Optional[float] = None
```

## Dependencies

### Upstream Dependencies
- [ ] E02-F02-T01: IStrategyRepository interface
- [ ] E02-F03-T02: MongoDBManager
- [ ] E02-F03-T05: MongoDBFormulaRepository (formulas referenced)

### Downstream Impact
- [ ] Backtesting uses strategies with formulas

## Gate Checks

### Pre-Implementation Gates
- [x] Interface methods defined
- [x] MongoDBManager available

### Quality Gates
- [ ] Integration tests passing
- [ ] Test coverage > 90%

## Success Criteria

### Acceptance Criteria
- [ ] All interface methods implemented
- [ ] Complex documents handled correctly
- [ ] Formula reference query works
- [ ] Default values applied

### Definition of Done
- [ ] Code reviewed
- [ ] Integration tests passing
- [ ] Documentation complete

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Nested structure serialization | Low | High | Test complex documents |
| Missing default handling | Low | Medium | Use dataclass defaults |

## Artifacts

### Output Artifacts
- [ ] `src/domain/entities/strategy.py`
- [ ] `src/infrastructure/repositories/mongodb/strategy_repository.py`
- [ ] `tests/integration/infrastructure/repositories/mongodb/test_strategy_repository.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
