# Spec: E02-F03-T05 - Implement MongoDBFormulaRepository

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E02-F03-T05
clickup_task_id: '86ew01ym3'
title: Implement MongoDBFormulaRepository
type: task

# === HIERARCHY ===
parent: E02-F03
children: []
epic: E02
feature: F03
task: T05
domain: storage

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [infrastructure, mongodb, repository, formula]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E02-F03 - Infrastructure Implementation](../E02-F03.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement the IFormulaRepository interface using MongoDB for formula storage. Formulas are document-structured data with nested parameters and tags, making MongoDB an ideal fit. Supports text search across name, description, and tags.

## Execution Flow

```
1. Initialize repository
   → Get formulas collection
   → Create text indexes on name, description, tags
   → Create index on category and tags

2. Implement CRUD operations
   → save(): Insert new or update existing
   → get_by_id(): Find by ObjectId
   → delete(): Remove by ObjectId

3. Implement query methods
   → get_by_category(): Filter by category enum
   → get_by_tags(): $in query for tag matching
   → search(): Text search with fallback to regex
   → get_all(): Return all formulas

4. Implement conversions
   → _formula_to_doc(): Entity to MongoDB document
   → _doc_to_formula(): Document to entity
   → Return: SUCCESS with all methods implemented
```

## User Stories

### Primary User Story
**As a** formula manager
**I want to** persist formulas to MongoDB
**So that** formula definitions are stored durably

### Additional Stories
- **As a** trader, **I want to** search formulas by name, **So that** I can find useful formulas
- **As a** developer, **I want to** filter by tags, **So that** I can find related formulas

## Acceptance Scenarios

### Scenario 1: Save with Parameters
**Given** Formula with nested parameters
**When** saving and retrieving
**Then** parameters are preserved correctly

### Scenario 2: Text Search
**Given** formulas with various names
**When** searching "RSI"
**Then** matching formulas returned

### Scenario 3: Tag Query
**Given** formulas with tags ["momentum", "trend"]
**When** querying by tags ["momentum"]
**Then** matching formulas returned

### Scenario 4: Category Filter
**Given** formulas in SCAN and ENTRY categories
**When** querying by FormulaCategory.SCAN
**Then** only SCAN formulas returned

## Requirements

### Functional Requirements
- **FR-001**: save() MUST handle new and existing formulas
- **FR-002**: get_by_id() MUST return None for invalid ObjectId
- **FR-003**: get_by_category() MUST filter by category enum
- **FR-004**: get_by_tags() MUST match any tag in list
- **FR-005**: search() MUST use text search with regex fallback
- **FR-006**: Parameters MUST be serialized/deserialized correctly

### Non-Functional Requirements
- **NFR-001**: CRUD operations < 100ms
- **NFR-002**: Text search efficient via indexes

### Technical Constraints
- **TC-001**: Use pymongo library
- **TC-002**: Create text indexes on init
- **TC-003**: Use ObjectId for formula IDs

## Key Entities

### Class: MongoDBFormulaRepository
```python
class MongoDBFormulaRepository(IFormulaRepository):
    def __init__(self, mongo_manager: MongoDBManager): ...

    def save(self, formula: Formula) -> Formula: ...
    def get_by_id(self, formula_id: str) -> Optional[Formula]: ...
    def get_by_category(self, category: FormulaCategory) -> list[Formula]: ...
    def get_by_tags(self, tags: list[str]) -> list[Formula]: ...
    def search(self, query: str, limit: int = 20) -> list[Formula]: ...
    def get_all(self) -> list[Formula]: ...
    def delete(self, formula_id: str) -> bool: ...
```

## Dependencies

### Upstream Dependencies
- [ ] E02-F02-T01: IFormulaRepository interface
- [ ] E02-F03-T02: MongoDBManager

### Downstream Impact
- [ ] E02-F03-T06: Strategies reference formulas

## Gate Checks

### Pre-Implementation Gates
- [x] Interface methods defined
- [x] MongoDBManager available

### Quality Gates
- [ ] Integration tests passing
- [ ] Test coverage > 90%

## Success Criteria

### Acceptance Criteria
- [ ] All interface methods implemented
- [ ] Text indexes created
- [ ] Parameters serialized correctly
- [ ] Behavior matches InMemory implementation

### Definition of Done
- [ ] Code reviewed
- [ ] Integration tests passing
- [ ] Documentation complete

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Text index not created | Low | Medium | Ensure indexes on init |
| Parameter serialization error | Low | High | Test nested structures |

## Artifacts

### Output Artifacts
- [ ] `src/infrastructure/repositories/mongodb/formula_repository.py`
- [ ] `tests/integration/infrastructure/repositories/mongodb/test_formula_repository.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
