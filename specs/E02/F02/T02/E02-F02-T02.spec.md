# Spec: E02-F02-T02 - Implement InMemory Repositories

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E02-F02-T02
clickup_task_id: '86ew01yk9'
title: Implement InMemory Repositories (Testing)
type: task

# === HIERARCHY ===
parent: E02-F02
children: []
epic: E02
feature: F02
task: T02
domain: storage

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [repository, in-memory, testing, mock]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E02-F02 - Repository Interfaces](../E02-F02.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Create in-memory implementations of all repository interfaces for use in unit testing. These implementations store data in Python dictionaries and lists, providing fast, isolated test execution without database dependencies.

## Execution Flow

```
1. Implement InMemoryCandleRepository
   → Store candles in dict[(symbol_id, timeframe) -> list[Candle]]
   → Implement deduplication on save
   → Implement sorting by timestamp

2. Implement InMemorySymbolRepository
   → Store symbols in dict[id -> Symbol]
   → Auto-generate IDs for new symbols
   → Implement search with string matching

3. Implement InMemoryFormulaRepository
   → Store formulas in dict[id -> Formula]
   → Use UUID for new formula IDs
   → Implement tag-based queries

4. Add clear() method to all
   → Enable test isolation
   → Return: SUCCESS with all implementations
```

## User Stories

### Primary User Story
**As a** unit test author
**I want to** use in-memory repositories
**So that** tests run fast without database setup

### Additional Stories
- **As a** CI/CD pipeline, **I want to** isolated test runs, **So that** tests don't interfere with each other

## Acceptance Scenarios

### Scenario 1: Save and Retrieve
**Given** InMemoryCandleRepository
**When** saving candles then retrieving
**Then** same candles are returned

### Scenario 2: Deduplication
**Given** InMemoryCandleRepository with existing candles
**When** saving duplicate timestamps
**Then** duplicates are ignored

### Scenario 3: Test Isolation
**Given** InMemorySymbolRepository with data
**When** calling clear()
**Then** repository is empty

### Scenario 4: Search Functionality
**Given** InMemorySymbolRepository with symbols
**When** searching with partial name
**Then** matching symbols are returned

## Requirements

### Functional Requirements
- **FR-001**: All repositories MUST implement their interface fully
- **FR-002**: InMemoryCandleRepository MUST deduplicate by timestamp
- **FR-003**: InMemoryCandleRepository MUST sort by timestamp
- **FR-004**: InMemorySymbolRepository MUST auto-generate IDs
- **FR-005**: InMemoryFormulaRepository MUST support tag queries
- **FR-006**: All repositories MUST have clear() method

### Non-Functional Requirements
- **NFR-001**: Operations < 1ms for typical use
- **NFR-002**: Memory efficient for test data sizes

### Technical Constraints
- **TC-001**: Use dict and list for storage
- **TC-002**: Thread-safety not required (test use)

## Key Entities

### InMemoryCandleRepository
```python
class InMemoryCandleRepository(ICandleRepository):
    _data: dict[tuple[int, str], list[Candle]]

    def save_many(...) -> int
    def get_range(...) -> list[Candle]
    def clear() -> None
```

### InMemorySymbolRepository
```python
class InMemorySymbolRepository(ISymbolRepository):
    _symbols: dict[int, Symbol]
    _next_id: int

    def save(...) -> Symbol  # Auto-generates ID
    def clear() -> None
```

## Dependencies

### Upstream Dependencies
- [ ] E02-F02-T01: Repository interfaces

### Downstream Impact
- [ ] All unit tests use these implementations

## Gate Checks

### Pre-Implementation Gates
- [x] Interface methods known
- [x] Storage strategy defined

### Quality Gates
- [ ] All interface methods implemented
- [ ] Tests pass
- [ ] Test coverage > 95%

## Success Criteria

### Acceptance Criteria
- [ ] Implements all interface methods
- [ ] Deduplication works correctly
- [ ] Search returns correct results
- [ ] clear() resets state completely

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Used in other feature tests

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Behavior differs from production | Low | High | Use same tests for both |

## Artifacts

### Output Artifacts
- [ ] `src/infrastructure/repositories/in_memory/__init__.py`
- [ ] `src/infrastructure/repositories/in_memory/candle_repository.py`
- [ ] `src/infrastructure/repositories/in_memory/symbol_repository.py`
- [ ] `src/infrastructure/repositories/in_memory/formula_repository.py`
- [ ] `tests/unit/infrastructure/repositories/in_memory/test_*.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
