# Spec: E02-F01-T01 - Create Domain Entities

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E02-F01-T01
clickup_task_id: '86ew01yjr'
title: Create Domain Entities (Symbol, Candle, Formula)
type: task

# === HIERARCHY ===
parent: E02-F01
children: []
epic: E02
feature: F01
task: T01
domain: storage

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [domain, entities, symbol, candle, formula]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E02-F01 - Domain Entities](../E02-F01.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Create the core domain entities for the storage layer: Symbol (stock metadata), Candle (OHLCV price data), and Formula (scan/trading expressions). These entities form the foundation of the domain model and encapsulate business validation rules.

## Execution Flow

```
1. Create Symbol entity
   → Define dataclass with id, code, name, market, sector, is_active
   → Implement __post_init__ validation
   → If code empty: ERROR "Symbol code is required"
   → If code > 20 chars: ERROR "Symbol code too long"

2. Create Candle value object
   → Define frozen dataclass with OHLCV fields
   → Validate OHLC relationships in __post_init__
   → If high < low: ERROR "High must be >= Low"
   → Add computed properties (is_bullish, body_size, etc.)

3. Create Formula entity
   → Define dataclass with id, name, expression, category, etc.
   → Validate required fields
   → Implement with_parameters() method
   → If name empty: ERROR "Formula name is required"

4. Create unit tests
   → Test validation rules
   → Test computed properties
   → Return: SUCCESS with entities and tests
```

## User Stories

### Primary User Story
**As a** developer building the storage layer
**I want to** have validated domain entities
**So that** invalid data is rejected at the domain boundary

### Additional Stories
- **As a** tester, **I want to** entities with clear validation errors, **So that** I can verify edge cases

## Acceptance Scenarios

### Scenario 1: Create Valid Symbol
**Given** valid symbol data (code="005930", name="Samsung", market=KOSPI)
**When** creating a Symbol entity
**Then** the symbol is created with all fields populated

### Scenario 2: Symbol Code Validation
**Given** empty symbol code
**When** creating a Symbol entity
**Then** ValueError is raised with "Symbol code is required"

### Scenario 3: Candle OHLC Validation
**Given** candle with high=95, low=99
**When** creating a Candle value object
**Then** ValueError is raised with "High must be >= Low"

### Scenario 4: Formula Parameter Substitution
**Given** formula with expression "RSI(:period) < :threshold"
**When** calling with_parameters(period=14, threshold=30)
**Then** returns "RSI(14) < 30"

## Requirements

### Functional Requirements
- **FR-001**: Symbol MUST have id, code, name, market fields
- **FR-002**: Symbol MUST validate code is non-empty and max 20 chars
- **FR-003**: Candle MUST be immutable (frozen dataclass)
- **FR-004**: Candle MUST validate high >= low
- **FR-005**: Candle MUST validate high >= open and high >= close
- **FR-006**: Candle MUST validate low <= open and low <= close
- **FR-007**: Candle MUST have computed properties (is_bullish, body_size, etc.)
- **FR-008**: Formula MUST validate name and expression are non-empty
- **FR-009**: Formula MUST support parameter substitution

### Non-Functional Requirements
- **NFR-001**: Validation: All validation errors must be descriptive
- **NFR-002**: Performance: Entity creation < 1ms

### Technical Constraints
- **TC-001**: Use Python dataclasses
- **TC-002**: Use Decimal for price fields
- **TC-003**: No external dependencies

## Key Entities

### Entity: Symbol
```python
@dataclass
class Symbol:
    id: int
    code: str           # Max 20 chars
    name: str
    market: Market      # Enum
    sector: Optional[str] = None
    is_active: bool = True
```

### Value Object: Candle
```python
@dataclass(frozen=True)
class Candle:
    timestamp: datetime
    open: Decimal
    high: Decimal
    low: Decimal
    close: Decimal
    volume: int
    # Properties: is_bullish, is_bearish, body_size, range, upper_shadow, lower_shadow
```

### Entity: Formula
```python
@dataclass
class Formula:
    id: int
    name: str
    expression: str
    category: FormulaCategory
    description: Optional[str] = None
    tags: list[str] = field(default_factory=list)
    parameters: list[FormulaParameter] = field(default_factory=list)
    version: int = 1
```

## Dependencies

### Upstream Dependencies
- [ ] E01: Application Framework (project structure)

### Downstream Impact
- [ ] E02-F01-T02: Uses Market enum defined here
- [ ] E02-F01-T03: CandleSeries uses Symbol and Candle

## Gate Checks

### Pre-Implementation Gates
- [x] All entity fields defined
- [x] Validation rules documented
- [x] Computed properties specified

### Quality Gates
- [ ] All validation paths tested
- [ ] Type hints complete
- [ ] Test coverage > 95%

## Tasks Preview

### Implementation Tasks
- [ ] T001 Create Symbol entity with validation
- [ ] T002 Create Candle value object with properties
- [ ] T003 Create Formula entity with parameter substitution
- [ ] T004 Create unit tests for all entities

## Success Criteria

### Acceptance Criteria
- [ ] Symbol validates code length and presence
- [ ] Candle validates OHLC relationships
- [ ] Candle computes derived properties correctly
- [ ] Formula substitutes parameters correctly
- [ ] All entities have descriptive validation errors

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing (95% coverage)
- [ ] Type hints on all methods
- [ ] Docstrings complete

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Decimal precision loss | Low | Medium | Use Decimal consistently |
| Missing validation | Medium | Medium | Comprehensive test cases |

## Notes and Clarifications

### Decisions Made
- 2025-12-28: Using Decimal for all price fields to maintain precision
- 2025-12-28: Candle is frozen to ensure immutability
- 2025-12-28: Formula uses `:param` pattern for substitution

## Artifacts

### Input Documents
- [E02-F01 - Domain Entities](../E02-F01.spec.md)

### Output Artifacts
- [ ] `src/domain/entities/symbol.py`
- [ ] `src/domain/value_objects/candle.py`
- [ ] `src/domain/entities/formula.py`
- [ ] `tests/unit/domain/entities/test_symbol.py`
- [ ] `tests/unit/domain/value_objects/test_candle.py`
- [ ] `tests/unit/domain/entities/test_formula.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
