# Spec: E02-F01 - Domain Entities

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E02-F01
clickup_task_id: ''
title: Domain Entities
type: feature

# === HIERARCHY ===
parent: E02
children: [E02-F01-T01, E02-F01-T02, E02-F01-T03]
epic: E02
feature: F01
domain: storage

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 16
actual_hours: 0

# === METADATA ===
tags: [domain, entities, ddd, value-objects]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Feature
**Parent**: [E02 - Storage Layer](../E02.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Create the core domain entities and value objects for the storage layer following Domain-Driven Design principles. This feature establishes the foundational domain model including Symbol (stock metadata), Candle (OHLCV price data), Formula (trading expressions), and the CandleSeries aggregate. These pure domain objects have no external dependencies and encapsulate business rules at the entity level.

## Execution Flow

```
1. Define core enums (Market, Timeframe, FormulaCategory)
   → Validate: All enum values mapped to storage representations
   → If missing mapping: ERROR "Enum value not serializable"

2. Create value objects (Candle, FormulaParameter)
   → Ensure immutability via frozen dataclass
   → Validate OHLC rules in __post_init__
   → If validation fails: ERROR "Invalid candle data: {reason}"

3. Create entities (Symbol, Formula)
   → Implement validation in __post_init__
   → Add business methods (Formula.with_parameters)
   → If required field missing: ERROR "Required field: {field}"

4. Create CandleSeries aggregate
   → Implement sorted, deduplicated storage
   → Add lazy DataFrame conversion
   → Provide slicing operations
   → Return: SUCCESS with complete domain model
```

## User Stories

### Primary User Story
**As a** developer implementing storage features
**I want to** have well-defined domain entities with validation
**So that** business rules are enforced at the domain level

### Additional Stories
- **As a** tester, **I want to** domain objects with no external dependencies, **So that** I can unit test without mocking infrastructure
- **As a** data analyst, **I want to** CandleSeries with DataFrame conversion, **So that** I can perform calculations efficiently

## Acceptance Scenarios

### Scenario 1: Create Valid Candle
**Given** OHLCV data where high >= low and all prices positive
**When** creating a Candle value object
**Then** the candle is created successfully with computed properties (is_bullish, body_size)

### Scenario 2: Candle Validation Failure
**Given** OHLCV data where high < low
**When** creating a Candle value object
**Then** ValueError is raised with message "High must be >= Low"

### Scenario 3: CandleSeries Deduplication
**Given** a list of candles with duplicate timestamps
**When** creating a CandleSeries
**Then** only unique candles are stored, sorted by timestamp

## Requirements

### Functional Requirements
- **FR-001**: System MUST validate OHLC price relationships (high >= low, high >= open/close)
- **FR-002**: Candle value objects MUST be immutable (frozen dataclass)
- **FR-003**: Symbol entity MUST validate code is non-empty and <= 20 chars
- **FR-004**: Formula entity MUST support parameter substitution via with_parameters()
- **FR-005**: CandleSeries MUST maintain sorted order by timestamp
- **FR-006**: CandleSeries MUST deduplicate candles by timestamp

### Non-Functional Requirements
- **NFR-001**: Performance: CandleSeries DataFrame conversion < 100ms for 100k candles
- **NFR-002**: Memory: Lazy DataFrame conversion to avoid duplication
- **NFR-003**: Testability: Zero external dependencies in domain layer

### Technical Constraints
- **TC-001**: Must use Python dataclasses for entities
- **TC-002**: Must use Decimal for price precision
- **TC-003**: Cannot import infrastructure or application layer modules

## Key Entities

### Entity: Symbol
- **Description**: Stock symbol with exchange metadata
- **Key Attributes**: id, code, name, market, sector, is_active
- **Relationships**: Referenced by CandleSeries, Formula

### Entity: Formula
- **Description**: Trading/scanning formula with parameters
- **Key Attributes**: id, name, expression, category, parameters[], tags[]
- **Relationships**: Referenced by Strategy

### Value Object: Candle
- **Description**: Immutable OHLCV price data point
- **Key Attributes**: timestamp, open, high, low, close, volume
- **Properties**: is_bullish, is_bearish, body_size, range, upper_shadow, lower_shadow

### Aggregate: CandleSeries
- **Description**: Collection of candles for a symbol/timeframe
- **Key Attributes**: symbol, timeframe, candles[]
- **Operations**: slice(), head(), tail(), add_candles(), as_dataframe

## Dependencies

### Upstream Dependencies
- [ ] E01: Application Framework (project structure, base patterns)

### Downstream Impact
- [ ] E02-F02: Repository interfaces depend on these entities
- [ ] E02-F03: Infrastructure implements storage for these entities
- [ ] E02-F04: Use cases operate on these entities

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Performance requirements specified
- [x] All entity fields defined
- [x] Validation rules documented
- [x] PRD compliance verified

### Quality Gates
- [ ] All entities have __post_init__ validation
- [ ] All value objects are frozen
- [ ] All requirements testable
- [ ] Test coverage > 95%

## Tasks Preview

### Implementation Tasks
- [ ] [E02-F01-T01](T01/E02-F01-T01.spec.md) Create domain entities (Symbol, Candle, Formula)
- [ ] [E02-F01-T02](T02/E02-F01-T02.spec.md) [P] Create value objects and enums
- [ ] [E02-F01-T03](T03/E02-F01-T03.spec.md) Implement CandleSeries aggregate

**[P]** = Can be executed in parallel

## Success Criteria

### Acceptance Criteria
- [ ] All entities validate required fields
- [ ] All value objects are immutable
- [ ] CandleSeries maintains sorted, deduplicated data
- [ ] DataFrame conversion works correctly
- [ ] 95% test coverage

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing
- [ ] No external dependencies in domain layer
- [ ] Documentation complete
- [ ] Type hints on all public methods

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Decimal precision issues | Low | Medium | Use Decimal consistently, avoid float conversion |
| Performance on large series | Low | Medium | Lazy DataFrame conversion, efficient slicing |
| Breaking changes to entities | Medium | High | Version entities, use migrations |

## Notes and Clarifications

### Decisions Made
- 2025-12-28: Using frozen dataclasses for value objects to ensure immutability
- 2025-12-28: CandleSeries uses lazy DataFrame conversion to avoid memory duplication
- 2025-12-28: Formula parameters use substitution pattern `:param_name`

### Research Needed
- [ ] Benchmark DataFrame conversion for large datasets
- [ ] Evaluate alternative immutability patterns

## Artifacts

### Input Documents
- [E02 - Storage Layer](../E02.spec.md)
- [Product Requirements](../../../docs/product-requirements-document.md)

### Output Artifacts
- [ ] `E02-F01.context.md` - Implementation context and progress
- [ ] `E02-F01.pre-docs.md` - Pre-implementation documentation
- [ ] `E02-F01.post-docs.md` - Post-implementation learnings

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
