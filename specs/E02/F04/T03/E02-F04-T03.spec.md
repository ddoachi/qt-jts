# Spec: E02-F04-T03 - Create Data Validation Utilities

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E02-F04-T03
clickup_task_id: '86ew01yme'
title: Create Data Validation Utilities
type: task

# === HIERARCHY ===
parent: E02-F04
children: []
epic: E02
feature: F04
task: T03
domain: storage

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [validation, candle, ohlc, gap-detection, anomaly]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E02-F04 - Data Management Use Cases](../E02-F04.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Create reusable validation utilities for candle data integrity. These utilities ensure data quality before persistence and detect issues in existing datasets. Includes CandleValidator for OHLC rules, GapDetector for missing periods, and PriceAnomalyDetector for suspicious values.

## Execution Flow

```
1. Implement CandleValidator
   → Check High >= Low
   → Check High >= Open and Close
   → Check Low <= Open and Close
   → Check all prices positive
   → Check volume non-negative
   → Return list of ValidationError

2. Implement GapDetector
   → Sort candles by timestamp
   → Check intervals between consecutive candles
   → Identify gaps exceeding threshold
   → Calculate coverage percentage

3. Implement PriceAnomalyDetector
   → Calculate price change statistics
   → Identify outliers via z-score
   → Return anomaly records
   → Return: SUCCESS with all validators
```

## User Stories

### Primary User Story
**As a** data engineer
**I want to** validate candle data before import
**So that** data quality is maintained

### Additional Stories
- **As a** analyst, **I want to** detect gaps, **So that** I know about missing data
- **As a** monitor, **I want to** find anomalies, **So that** I can investigate errors

## Acceptance Scenarios

### Scenario 1: Valid Candle
**Given** candle with correct OHLC relationships
**When** validating
**Then** no errors returned

### Scenario 2: High < Low Error
**Given** candle with high=95, low=100
**When** validating
**Then** error about high < low returned

### Scenario 3: Gap Detection
**Given** candles for Mon, Tue, Thu (missing Wed)
**When** detecting gaps for daily timeframe
**Then** gap from Tue to Thu detected

### Scenario 4: Price Anomaly
**Given** candles with one 50% price jump
**When** detecting anomalies with 3 std threshold
**Then** anomaly flagged for that candle

## Requirements

### Functional Requirements
- **FR-001**: CandleValidator MUST check High >= Low
- **FR-002**: CandleValidator MUST check High >= Open and Close
- **FR-003**: CandleValidator MUST check Low <= Open and Close
- **FR-004**: CandleValidator MUST check positive prices
- **FR-005**: CandleValidator MUST check non-negative volume
- **FR-006**: GapDetector MUST identify time gaps
- **FR-007**: GapDetector MUST calculate coverage percentage
- **FR-008**: PriceAnomalyDetector MUST identify outliers

### Non-Functional Requirements
- **NFR-001**: Validate 100k candles in < 1 second
- **NFR-002**: Memory efficient for batch processing

### Technical Constraints
- **TC-001**: Pure Python, no external dependencies
- **TC-002**: Reusable across use cases

## Key Entities

### Class: ValidationError
```python
@dataclass
class ValidationError:
    candle_index: int
    timestamp: str
    field: str
    message: str
```

### Class: CandleValidator
```python
class CandleValidator:
    def validate(self, candle: Candle, index: int = 0) -> list[ValidationError]: ...
    def validate_batch(self, candles: list[Candle]) -> list[str]: ...
```

### Class: GapDetector
```python
class GapDetector:
    def detect_gaps(
        self,
        candles: list[Candle],
        timeframe: Timeframe,
        max_gap_multiplier: float = 1.5
    ) -> list[tuple[datetime, datetime]]: ...

    def count_expected_candles(
        self, start: datetime, end: datetime, timeframe: Timeframe
    ) -> int: ...

    def calculate_coverage(
        self, candles: list[Candle], start, end, timeframe
    ) -> float: ...
```

### Class: PriceAnomalyDetector
```python
class PriceAnomalyDetector:
    def __init__(self, std_threshold: float = 3.0): ...

    def detect(self, candles: list[Candle]) -> list[dict]: ...
```

## Dependencies

### Upstream Dependencies
- [ ] E02-F01: Candle value object, Timeframe enum

### Downstream Impact
- [ ] E02-F04-T01: ImportCandlesUseCase uses validators

## Gate Checks

### Pre-Implementation Gates
- [x] Domain entities defined
- [x] Validation rules specified

### Quality Gates
- [ ] Unit tests for all rules
- [ ] Edge case testing
- [ ] Test coverage > 95%

## Success Criteria

### Acceptance Criteria
- [ ] All OHLC rules validated
- [ ] Gap detection accurate for all timeframes
- [ ] Anomaly detection configurable
- [ ] Batch validation efficient

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Documentation complete

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Rules too strict | Low | Low | Make configurable |
| Gap detection edge cases | Low | Low | Test weekends/holidays |

## Artifacts

### Output Artifacts
- [ ] `src/application/validation/__init__.py`
- [ ] `src/application/validation/candle_validator.py`
- [ ] `src/application/validation/gap_detector.py`
- [ ] `src/application/validation/price_anomaly_detector.py`
- [ ] `tests/unit/application/validation/test_*.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
