# Spec: E02-F04-T02 - Create ExportCandlesUseCase

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E02-F04-T02
clickup_task_id: '86ew01ymb'
title: Create ExportCandlesUseCase
type: task

# === HIERARCHY ===
parent: E02-F04
children: []
epic: E02
feature: F04
task: T02
domain: storage

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [use-case, export, candle, csv, json, dataframe]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E02-F04 - Data Management Use Cases](../E02-F04.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Create a use case for exporting candle data to various formats (CSV, JSON, DataFrame). This enables data analysis, backtesting, and integration with external tools. Supports flexible date range filtering and optional metadata inclusion.

## Execution Flow

```
1. Validate symbol exists
   → Look up symbol by code
   → If not found: RAISE SymbolNotFoundError

2. Parse and validate timeframe
   → Convert string to Timeframe enum
   → If invalid: RAISE ValueError

3. Query candles from repository
   → Filter by symbol, timeframe, date range
   → Get sorted candle list

4. Format output
   → CSV: Header + rows with metadata comments
   → JSON: Object with candles array and metadata
   → DataFrame: Pandas with timestamp index
   → Return: SUCCESS with ExportCandlesResult
```

## User Stories

### Primary User Story
**As a** data analyst
**I want to** export candles to various formats
**So that** I can analyze data in different tools

### Additional Stories
- **As a** backtester, **I want to** export to DataFrame, **So that** I can use pandas/numpy
- **As an** integrator, **I want to** export to JSON, **So that** I can send to APIs

## Acceptance Scenarios

### Scenario 1: Export to CSV
**Given** candles for date range
**When** exporting to CSV format
**Then** CSV string with header and rows returned

### Scenario 2: Export to JSON
**Given** candles for date range
**When** exporting to JSON with metadata
**Then** JSON with candles array and metadata object

### Scenario 3: Export to DataFrame
**Given** candles for date range
**When** exporting to DataFrame
**Then** pandas DataFrame with timestamp index

### Scenario 4: Empty Range
**Given** no candles in date range
**When** exporting
**Then** empty result (not error)

## Requirements

### Functional Requirements
- **FR-001**: MUST validate symbol existence
- **FR-002**: MUST support CSV format with optional metadata
- **FR-003**: MUST support JSON format with optional metadata
- **FR-004**: MUST support pandas DataFrame format
- **FR-005**: MUST filter by date range
- **FR-006**: MUST return empty result for no data (not error)

### Non-Functional Requirements
- **NFR-001**: Export 1M candles efficiently
- **NFR-002**: Preserve Decimal precision in output

### Technical Constraints
- **TC-001**: Use pandas for DataFrame conversion
- **TC-002**: Use standard csv and json modules
- **TC-003**: ISO format for timestamps

## Key Entities

### Enum: ExportFormat
```python
class ExportFormat(str, Enum):
    CSV = "csv"
    JSON = "json"
    DATAFRAME = "dataframe"
```

### Class: ExportCandlesRequest
```python
@dataclass
class ExportCandlesRequest:
    symbol_code: str
    timeframe: str
    start_date: datetime
    end_date: datetime
    format: ExportFormat = ExportFormat.DATAFRAME
    include_metadata: bool = True
```

### Class: ExportCandlesResult
```python
@dataclass
class ExportCandlesResult:
    symbol_code: str
    timeframe: str
    start_date: datetime
    end_date: datetime
    candle_count: int
    format: ExportFormat
    data: Any  # str for CSV/JSON, pd.DataFrame for DATAFRAME

    @property
    def success(self) -> bool: ...
```

### Class: ExportCandlesUseCase
```python
class ExportCandlesUseCase:
    def __init__(
        self,
        candle_repo: ICandleRepository,
        symbol_repo: ISymbolRepository
    ): ...

    def execute(self, request: ExportCandlesRequest) -> ExportCandlesResult: ...
```

## Dependencies

### Upstream Dependencies
- [ ] E02-F02: ICandleRepository, ISymbolRepository interfaces
- [ ] pandas library for DataFrame export

### Downstream Impact
- [ ] Analysis tools use exported data
- [ ] Backtesting systems consume DataFrame output

## Gate Checks

### Pre-Implementation Gates
- [x] Repository interfaces defined
- [x] pandas available

### Quality Gates
- [ ] Unit tests for each format
- [ ] Test empty data handling
- [ ] Test coverage > 90%

## Success Criteria

### Acceptance Criteria
- [ ] CSV export with proper format
- [ ] JSON export with metadata
- [ ] DataFrame export with timestamp index
- [ ] Empty range handled gracefully

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Documentation complete

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Large export memory issues | Medium | Medium | Streaming for large data |
| Precision loss in float conversion | Low | Medium | Use str for Decimal |

## Artifacts

### Output Artifacts
- [ ] `src/application/use_cases/export_candles.py`
- [ ] `src/application/dto/export.py`
- [ ] `tests/unit/application/use_cases/test_export_candles.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
