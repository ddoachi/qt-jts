# Spec: E02-F04-T01 - Create ImportCandlesUseCase

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E02-F04-T01
clickup_task_id: '86ew01ym9'
title: Create ImportCandlesUseCase
type: task

# === HIERARCHY ===
parent: E02-F04
children: []
epic: E02
feature: F04
task: T01
domain: storage

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [use-case, import, candle, validation]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E02-F04 - Data Management Use Cases](../E02-F04.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Create a use case for importing historical candle data with validation, deduplication, and gap detection. This is a critical operation for populating the historical data store. The use case validates symbol existence, checks candle data quality, supports incremental imports, and detects gaps in the imported data.

## Execution Flow

```
1. Validate symbol exists
   → Look up symbol by code
   → If not found: RAISE SymbolNotFoundError
   → Get symbol ID for repository calls

2. Validate candle data
   → If validation enabled: Run CandleValidator
   → If errors found: Return result with validation_errors
   → Skip import if validation fails

3. Filter for incremental import
   → If incremental enabled: Check existing coverage
   → Filter out candles within existing range
   → Track skipped count

4. Save candles to repository
   → Call save_many with remaining candles
   → Track imported count

5. Detect gaps
   → Query all candles in range
   → Run GapDetector
   → Return: SUCCESS with ImportCandlesResult
```

## User Stories

### Primary User Story
**As a** data pipeline
**I want to** import candle data with validation
**So that** only quality data is persisted

### Additional Stories
- **As a** operator, **I want to** incremental import, **So that** I don't re-import existing data
- **As a** data engineer, **I want to** gap detection, **So that** I know about missing periods

## Acceptance Scenarios

### Scenario 1: Successful Import
**Given** valid candles and existing symbol
**When** executing import
**Then** all candles saved and count returned

### Scenario 2: Symbol Not Found
**Given** non-existent symbol code
**When** executing import
**Then** SymbolNotFoundError raised

### Scenario 3: Validation Failure
**Given** candles with OHLC errors
**When** executing with validate=True
**Then** import rejected with validation errors

### Scenario 4: Incremental Skip
**Given** existing data and overlapping import
**When** executing with incremental=True
**Then** only new candles imported, others skipped

## Requirements

### Functional Requirements
- **FR-001**: MUST validate symbol existence
- **FR-002**: MUST optionally validate candle data (validate flag)
- **FR-003**: MUST support incremental import (skip existing)
- **FR-004**: MUST detect gaps after import
- **FR-005**: MUST return detailed import result
- **FR-006**: MUST raise SymbolNotFoundError for invalid symbol

### Non-Functional Requirements
- **NFR-001**: Import 100k candles in < 10 seconds
- **NFR-002**: Memory efficient for large imports

### Technical Constraints
- **TC-001**: Use dependency injection for repositories
- **TC-002**: Use CandleValidator and GapDetector from T03

## Key Entities

### Class: ImportCandlesRequest
```python
@dataclass
class ImportCandlesRequest:
    symbol_code: str
    timeframe: Timeframe
    candles: list[Candle]
    incremental: bool = True  # Skip existing data
    validate: bool = True     # Run validation checks
```

### Class: ImportCandlesResult
```python
@dataclass
class ImportCandlesResult:
    symbol_code: str
    timeframe: str
    imported_count: int
    skipped_count: int
    total_count: int
    gaps_detected: list[tuple[datetime, datetime]]
    validation_errors: list[str]

    @property
    def success(self) -> bool: ...
```

### Class: ImportCandlesUseCase
```python
class ImportCandlesUseCase:
    def __init__(
        self,
        candle_repo: ICandleRepository,
        symbol_repo: ISymbolRepository,
        validator: CandleValidator | None = None,
        gap_detector: GapDetector | None = None
    ): ...

    def execute(self, request: ImportCandlesRequest) -> ImportCandlesResult: ...
```

## Dependencies

### Upstream Dependencies
- [ ] E02-F02: ICandleRepository, ISymbolRepository interfaces
- [ ] E02-F04-T03: CandleValidator, GapDetector utilities

### Downstream Impact
- [ ] Data pipelines use this for historical data import

## Gate Checks

### Pre-Implementation Gates
- [x] Repository interfaces defined
- [x] Validation utilities available (T03)

### Quality Gates
- [ ] Unit tests with mock repositories
- [ ] Test all scenarios
- [ ] Test coverage > 90%

## Success Criteria

### Acceptance Criteria
- [ ] Symbol validation works
- [ ] Candle validation optional
- [ ] Incremental import skips existing
- [ ] Gap detection after import
- [ ] Detailed result returned

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Documentation complete

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Validation too slow | Low | Medium | Batch validation |
| Gap detection inaccurate | Low | Low | Test edge cases |

## Artifacts

### Output Artifacts
- [ ] `src/application/use_cases/import_candles.py`
- [ ] `src/application/exceptions.py`
- [ ] `tests/unit/application/use_cases/test_import_candles.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
