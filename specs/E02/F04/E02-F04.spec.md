# Spec: E02-F04 - Data Management Use Cases

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E02-F04
clickup_task_id: ''
title: Data Management Use Cases
type: feature

# === HIERARCHY ===
parent: E02
children: [E02-F04-T01, E02-F04-T02, E02-F04-T03]
epic: E02
feature: F04
domain: storage

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 12
actual_hours: 0

# === METADATA ===
tags: [use-case, application-layer, import, export, validation]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Feature
**Parent**: [E02 - Storage Layer](../E02.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement application-layer use cases for data management operations. These use cases orchestrate domain entities and repositories to perform complex business operations like importing/exporting candle data with validation, deduplication, and format conversion.

## Execution Flow

```
1. Create Data Validation Utilities
   → CandleValidator for OHLC rules
   → GapDetector for time series gaps
   → PriceAnomalyDetector for outliers
   → If validation fails: Return validation errors

2. Create ImportCandlesUseCase
   → Validate symbol existence
   → Validate candle data quality
   → Incremental import (skip existing)
   → Detect gaps after import

3. Create ExportCandlesUseCase
   → Query candles by date range
   → Format output (CSV, JSON, DataFrame)
   → Include metadata if requested
   → Return: SUCCESS with all use cases implemented
```

## User Stories

### Primary User Story
**As a** data pipeline operator
**I want to** import and export candle data
**So that** historical data is managed efficiently

### Additional Stories
- **As a** analyst, **I want to** export to DataFrame, **So that** I can analyze in pandas
- **As a** data engineer, **I want to** validate before import, **So that** data quality is maintained

## Acceptance Scenarios

### Scenario 1: Incremental Import
**Given** existing candles for 2024 Q1
**When** importing overlapping Q1-Q2 data
**Then** only new Q2 data is imported

### Scenario 2: Validation Failure
**Given** candles with high < low
**When** importing with validation enabled
**Then** import rejected with errors

### Scenario 3: Export to CSV
**Given** candles for specific date range
**When** exporting to CSV
**Then** CSV file with proper format returned

### Scenario 4: Gap Detection
**Given** candle data with missing dates
**When** importing or querying
**Then** gaps are detected and reported

## Requirements

### Functional Requirements
- **FR-001**: ImportCandlesUseCase MUST validate symbol existence
- **FR-002**: ImportCandlesUseCase MUST support incremental import
- **FR-003**: ImportCandlesUseCase MUST detect and report gaps
- **FR-004**: ExportCandlesUseCase MUST support CSV, JSON, DataFrame
- **FR-005**: ExportCandlesUseCase MUST support date range filtering
- **FR-006**: CandleValidator MUST enforce OHLC price rules
- **FR-007**: GapDetector MUST identify missing periods

### Non-Functional Requirements
- **NFR-001**: Import 100k candles in < 10 seconds
- **NFR-002**: Export operations efficient for 1M+ candles

### Technical Constraints
- **TC-001**: Use cases in application layer
- **TC-002**: Depend only on repository interfaces
- **TC-003**: Support pandas DataFrame output

## Key Entities

### Class: ImportCandlesUseCase
```python
class ImportCandlesUseCase:
    def __init__(
        self,
        candle_repo: ICandleRepository,
        symbol_repo: ISymbolRepository,
        validator: CandleValidator | None = None,
        gap_detector: GapDetector | None = None
    ): ...

    def execute(self, request: ImportCandlesRequest) -> ImportCandlesResult: ...
```

### Class: ExportCandlesUseCase
```python
class ExportCandlesUseCase:
    def __init__(
        self,
        candle_repo: ICandleRepository,
        symbol_repo: ISymbolRepository
    ): ...

    def execute(self, request: ExportCandlesRequest) -> ExportCandlesResult: ...
```

### Class: CandleValidator
```python
class CandleValidator:
    def validate(self, candle: Candle, index: int = 0) -> list[ValidationError]: ...
    def validate_batch(self, candles: list[Candle]) -> list[str]: ...
```

### Class: GapDetector
```python
class GapDetector:
    def detect_gaps(
        self, candles: list[Candle], timeframe: Timeframe
    ) -> list[tuple[datetime, datetime]]: ...
    def calculate_coverage(
        self, candles, start, end, timeframe
    ) -> float: ...
```

## Dependencies

### Upstream Dependencies
- [ ] E02-F01: Domain entities (Symbol, Candle)
- [ ] E02-F02: Repository interfaces
- [ ] E02-F03: Repository implementations (for production use)

### Downstream Impact
- [ ] Data pipelines use import/export use cases
- [ ] Backtesting requires exported data

## Gate Checks

### Pre-Implementation Gates
- [x] Repository interfaces defined
- [x] Domain entities available

### Quality Gates
- [ ] Unit tests with in-memory repositories
- [ ] Test coverage > 90%

## Tasks Preview

### Implementation Tasks
- [ ] [E02-F04-T01](T01/E02-F04-T01.spec.md) Create ImportCandlesUseCase
- [ ] [E02-F04-T02](T02/E02-F04-T02.spec.md) Create ExportCandlesUseCase [P]
- [ ] [E02-F04-T03](T03/E02-F04-T03.spec.md) Create Data Validation Utilities [P]

**[P]** = Can be executed in parallel

### Wave Analysis
```
Wave 1 (Parallel):    T02, T03 (Export and Validation - independent)
Wave 2:               T01 (Import - uses validation from T03)
```

## Success Criteria

### Acceptance Criteria
- [ ] Import with validation works
- [ ] Incremental import skips existing
- [ ] Export to all formats works
- [ ] Gap detection accurate

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Documentation complete

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Validation too strict | Low | Medium | Configurable rules |
| Performance on large imports | Medium | Medium | Batch processing |

## Notes and Clarifications

### Decisions Made
- 2025-12-28: Validation is optional (controlled by flag)
- 2025-12-28: Use cases work with any repository implementation
- 2025-12-28: SymbolNotFoundError raised for invalid symbols

## Artifacts

### Input Documents
- [E02 - Storage Layer](../E02.spec.md)
- [E02-F02 - Repository Interfaces](../F02/E02-F02.spec.md)

### Output Artifacts
- [ ] `src/application/use_cases/import_candles.py`
- [ ] `src/application/use_cases/export_candles.py`
- [ ] `src/application/validation/candle_validator.py`
- [ ] `src/application/validation/gap_detector.py`
- [ ] `tests/unit/application/**/*.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
