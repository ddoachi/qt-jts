# Spec: E11-F04-T05 - ParameterHeatmapWidget

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E11-F04-T05
clickup_task_id: ''
title: ParameterHeatmapWidget
type: task

# === HIERARCHY ===
parent: E11-F04
children: []
epic: E11
feature: F04
task: T05
domain: presentation

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 6
actual_hours: 0

# === METADATA ===
tags: [ui, pyside6, widget, heatmap, visualization, matplotlib]
effort: large
risk: medium
wave: 7
parallel: false
---

**Status**: Draft
**Type**: Task
**Parent**: E11-F04 (Optimization UI Components)
**Wave**: 7 (Depends on T01 for integration)

## Executive Summary

Create the ParameterHeatmapWidget for visualizing parameter sensitivity through a 2D heatmap. Shows how changes in two selected parameters affect the optimization metric (e.g., Sharpe ratio). Uses color gradient to represent metric values, with warm colors for high values and cool colors for low values.

## User Stories

**As a** trader
**I want to** see how parameters affect performance visually
**So that** I can understand parameter sensitivity and robustness zones

## Acceptance Scenarios

### Scenario 1: Display Heatmap
**Given** optimization results with RSI Period and SMA Period
**When** both parameters selected for heatmap
**Then** 2D grid displays with RSI on X-axis, SMA on Y-axis
**And** cell colors represent Sharpe ratio values

### Scenario 2: Color Gradient
**Given** Sharpe values ranging from 0.5 to 2.0
**When** heatmap renders
**Then** 0.5 shows as cool color (blue)
**And** 2.0 shows as warm color (red)
**And** color bar legend shows scale

### Scenario 3: Hover Tooltip
**Given** heatmap displayed
**When** user hovers over a cell
**Then** tooltip shows "RSI: 14, SMA: 20, Sharpe: 1.85"

### Scenario 4: Parameter Selection
**Given** 3 parameters available
**When** user selects different X and Y parameters
**Then** heatmap updates with new axes

## Requirements

### Functional Requirements
- **FR-001**: MUST display 2D heatmap with selectable X/Y parameters
- **FR-002**: MUST use color gradient for metric visualization
- **FR-003**: MUST show color bar legend
- **FR-004**: SHOULD show tooltips on hover
- **FR-005**: MUST update when parameter selection changes

### Non-Functional Requirements
- **NFR-001**: Render smoothly for up to 100x100 grid
- **NFR-002**: Color scheme accessible (avoid red-green only)

### Technical Constraints
- **TC-001**: Use matplotlib for heatmap rendering
- **TC-002**: Embed matplotlib in Qt using FigureCanvas
- **TC-003**: Use viridis or plasma colormap for accessibility

## Implementation Details

### File Location
`src/presentation/views/optimization/param_heatmap_widget.py`

### Code Structure
```python
from PySide6.QtWidgets import QWidget, QVBoxLayout, QComboBox, QHBoxLayout
import matplotlib.pyplot as plt
from matplotlib.backends.backend_qtagg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure
import numpy as np

class ParameterHeatmapWidget(QWidget):
    """2D heatmap for parameter sensitivity visualization"""

    def __init__(self, parent=None):
        super().__init__(parent)
        self._results: list[ParameterResult] = []
        self._param_names: list[str] = []
        self._setup_ui()

    def _setup_ui(self):
        layout = QVBoxLayout(self)

        # Parameter selectors
        selector_layout = QHBoxLayout()
        self._x_selector = QComboBox()
        self._y_selector = QComboBox()
        self._x_selector.currentIndexChanged.connect(self._update_heatmap)
        self._y_selector.currentIndexChanged.connect(self._update_heatmap)
        selector_layout.addWidget(QLabel("X-Axis:"))
        selector_layout.addWidget(self._x_selector)
        selector_layout.addWidget(QLabel("Y-Axis:"))
        selector_layout.addWidget(self._y_selector)
        layout.addLayout(selector_layout)

        # Matplotlib canvas
        self._figure = Figure(figsize=(6, 5))
        self._canvas = FigureCanvas(self._figure)
        layout.addWidget(self._canvas)

    def set_results(self, results: list['ParameterResult']):
        """Set results and update parameter options"""
        self._results = results
        if results:
            self._param_names = list(results[0].parameters.keys())
            self._x_selector.clear()
            self._y_selector.clear()
            self._x_selector.addItems(self._param_names)
            self._y_selector.addItems(self._param_names)
            if len(self._param_names) >= 2:
                self._y_selector.setCurrentIndex(1)
        self._update_heatmap()

    def _update_heatmap(self):
        """Render heatmap with selected parameters"""
        if not self._results or len(self._param_names) < 2:
            return

        x_param = self._x_selector.currentText()
        y_param = self._y_selector.currentText()

        if x_param == y_param:
            return

        # Build data grid
        x_values = sorted(set(r.parameters[x_param] for r in self._results))
        y_values = sorted(set(r.parameters[y_param] for r in self._results))

        # Create lookup for Sharpe values
        sharpe_lookup = {}
        for r in self._results:
            key = (r.parameters[x_param], r.parameters[y_param])
            sharpe_lookup[key] = r.metrics.sharpe_ratio

        # Build grid
        grid = np.zeros((len(y_values), len(x_values)))
        for i, y in enumerate(y_values):
            for j, x in enumerate(x_values):
                grid[i, j] = sharpe_lookup.get((x, y), 0)

        # Plot
        self._figure.clear()
        ax = self._figure.add_subplot(111)
        im = ax.imshow(grid, cmap='viridis', aspect='auto',
                      extent=[x_values[0], x_values[-1], y_values[0], y_values[-1]],
                      origin='lower')
        ax.set_xlabel(x_param)
        ax.set_ylabel(y_param)
        ax.set_title('Sharpe Ratio Heatmap')
        self._figure.colorbar(im, ax=ax, label='Sharpe Ratio')
        self._canvas.draw()
```

## Dependencies

### Upstream
- E11-F01: ParameterResult with parameters and metrics
- matplotlib library

### Downstream
- E11-F04-T01: Integrated into OptimizationView

## Success Criteria

- [ ] Heatmap renders correctly with two parameters
- [ ] Color gradient accurately represents values
- [ ] Parameter selectors work correctly
- [ ] Colorbar legend displays
- [ ] Performance acceptable for large grids
- [ ] Viridis colormap used for accessibility

---
*Template Version: 2.0.0*
