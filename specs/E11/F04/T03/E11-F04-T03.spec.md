# Spec: E11-F04-T03 - ResultsTableWidget

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E11-F04-T03
clickup_task_id: '86ew0fpkz'
title: ResultsTableWidget
type: task

# === HIERARCHY ===
parent: E11-F04
children: []
epic: E11
feature: F04
task: T03
domain: presentation

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [ui, pyside6, widget, table, results, sorting]
effort: medium
risk: low
wave: 4
parallel: true
---

**Status**: Draft
**Type**: Task
**Parent**: E11-F04 (Optimization UI Components)
**Wave**: 4 (Can run in parallel with other F04 tasks)

## Executive Summary

Create the ResultsTableWidget for displaying optimization results in a sortable table format. Shows rank, parameter values, and key metrics (Sharpe, Return, etc.). Supports column-based sorting and row selection for detail view. Includes CSV export functionality.

## User Stories

**As a** trader
**I want to** see optimization results in a sortable table
**So that** I can compare different parameter combinations

## Acceptance Scenarios

### Scenario 1: Display Results
**Given** optimization completes with 100 results
**When** ResultsTableWidget.set_results() called
**Then** table shows 100 rows
**And** columns include: Rank, param names, Sharpe, Return

### Scenario 2: Sort by Column
**Given** results displayed
**When** user clicks "Sharpe" column header
**Then** results sort by Sharpe descending
**When** clicked again
**Then** results sort by Sharpe ascending

### Scenario 3: Select Row
**Given** results displayed
**When** user clicks a row
**Then** row_selected signal emits with ParameterResult
**And** row is highlighted

### Scenario 4: Export to CSV
**Given** results displayed
**When** user clicks "Export CSV"
**Then** file dialog opens
**And** CSV file saved with all data

## Requirements

### Functional Requirements
- **FR-001**: Table MUST show Rank, parameter values, and metrics columns
- **FR-002**: set_results() MUST populate table from list[ParameterResult]
- **FR-003**: Column headers MUST be clickable for sorting
- **FR-004**: MUST emit row_selected(ParameterResult) on row click
- **FR-005**: export_to_csv() MUST save all data to CSV file

### Technical Constraints
- **TC-001**: Use QTableView with QAbstractTableModel for performance
- **TC-002**: Use QSortFilterProxyModel for sorting
- **TC-003**: Limit initial display to 100 rows with pagination

## Implementation Details

### File Location
`src/presentation/views/optimization/results_table_widget.py`

### Code Structure
```python
from PySide6.QtWidgets import QWidget, QTableView, QVBoxLayout, QPushButton, QFileDialog
from PySide6.QtCore import Signal, QAbstractTableModel, QSortFilterProxyModel, Qt
import csv

class ResultsTableModel(QAbstractTableModel):
    """Custom model for optimization results"""

    def __init__(self, parent=None):
        super().__init__(parent)
        self._results: list[ParameterResult] = []
        self._param_names: list[str] = []

    def set_results(self, results: list['ParameterResult']):
        self.beginResetModel()
        self._results = results
        if results:
            self._param_names = list(results[0].parameters.keys())
        self.endResetModel()

    def rowCount(self, parent=None) -> int:
        return len(self._results)

    def columnCount(self, parent=None) -> int:
        # Rank + params + metrics (Sharpe, Return, Win Rate)
        return 1 + len(self._param_names) + 3

    def data(self, index, role=Qt.DisplayRole):
        if role != Qt.DisplayRole:
            return None

        result = self._results[index.row()]
        col = index.column()

        if col == 0:
            return result.rank
        elif col <= len(self._param_names):
            param_name = self._param_names[col - 1]
            return result.parameters.get(param_name, 0)
        else:
            metric_idx = col - len(self._param_names) - 1
            if metric_idx == 0:
                return f"{result.metrics.sharpe_ratio:.2f}"
            elif metric_idx == 1:
                return f"{result.metrics.total_return_pct:.1f}%"
            elif metric_idx == 2:
                return f"{result.metrics.win_rate:.1f}%"


class ResultsTableWidget(QWidget):
    """Sortable results table with export"""

    row_selected = Signal(object)  # ParameterResult

    def __init__(self, parent=None):
        super().__init__(parent)
        self._setup_ui()

    def _setup_ui(self):
        layout = QVBoxLayout(self)

        # Table with sorting
        self._model = ResultsTableModel()
        self._proxy = QSortFilterProxyModel()
        self._proxy.setSourceModel(self._model)

        self._table = QTableView()
        self._table.setModel(self._proxy)
        self._table.setSortingEnabled(True)
        self._table.clicked.connect(self._on_row_clicked)
        layout.addWidget(self._table)

        # Export button
        export_btn = QPushButton("Export to CSV")
        export_btn.clicked.connect(self.export_to_csv)
        layout.addWidget(export_btn)

    def set_results(self, results: list['ParameterResult']):
        self._model.set_results(results)

    def export_to_csv(self):
        path, _ = QFileDialog.getSaveFileName(self, "Export CSV", "", "CSV Files (*.csv)")
        if path:
            with open(path, 'w', newline='') as f:
                writer = csv.writer(f)
                # Write headers and data
                # ...
```

## Dependencies

### Upstream
- E11-F01: ParameterResult dataclass

### Downstream
- E11-F04-T01: Integrated into OptimizationView
- E11-F04-T05: Selected row triggers heatmap update

## Success Criteria

- [ ] Table displays results correctly
- [ ] Column sorting works (both directions)
- [ ] Row selection emits signal
- [ ] CSV export saves correct data
- [ ] Performance good with 1000+ results

---
*Template Version: 2.0.0*
