# Spec: E11-F03 - Walk-Forward Analyzer

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E11-F03
clickup_task_id: ''    # REQUIRED - Empty string if not yet created in ClickUp
title: Walk-Forward Analyzer
type: feature

# === HIERARCHY ===
parent: E11
children: [E11-F03-T01, E11-F03-T02]
epic: E11
feature: F03
domain: optimization

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 12
actual_hours: 0

# === METADATA ===
tags: [walk-forward, validation, robustness, overfitting-prevention]
effort: large
risk: medium
---

**Status**: Draft
**Type**: Feature
**Parent**: E11 (Strategy Optimization)
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Executive Summary

Implement the WalkForwardAnalyzer for robustness testing of optimized parameters. Walk-forward analysis divides the date range into multiple train/test splits, optimizes parameters on each training period, and validates on the corresponding test period. This prevents overfitting by measuring how well in-sample optimizations perform on out-of-sample data, producing a robustness score that indicates reliability.

## Execution Flow

```
1. WalkForwardAnalyzer.analyze() called with OptimizationConfig
   → Validate n_splits >= 2
   → Validate train_ratio in (0, 1)
   → If invalid: ERROR "Invalid walk-forward config"

2. Create train/test date splits
   → Divide total date range into n_splits segments
   → For each segment:
     → Training period = first (train_ratio * segment_length) days
     → Testing period = remaining days
   → Return list of (train_range, test_range) tuples

3. For each split:
   a. Run optimization on training period
      → Create OptimizationConfig with train_range
      → Set walk_forward_splits=0 to avoid recursion
      → Call GridSearchOptimizer.optimize()
      → Get best parameters from top result

   b. Test best parameters on out-of-sample period
      → Apply best parameters to strategy
      → Create BacktestConfig with test_range
      → Run single backtest
      → Store in-sample and out-sample metrics

4. Calculate aggregate metrics
   → avg_in_sample_sharpe = mean of all in-sample Sharpe ratios
   → avg_out_sample_sharpe = mean of all out-sample Sharpe ratios
   → robustness_score = avg_out / avg_in (if avg_in > 0)
   → is_robust = robustness_score > 0.5

5. Return WalkForwardResult
   → Include all splits with detailed metrics
   → Include aggregate robustness metrics
```

## User Stories

### Primary User Story
**As a** quantitative trader
**I want to** validate that optimized parameters work on unseen data
**So that** I avoid overfitting to historical noise

### Additional Stories
- **As a** trader, **I want to** see a clear robustness score, **So that** I know if my optimization is reliable
- **As a** trader, **I want to** see per-split performance, **So that** I understand how consistent the strategy is
- **As a** trader, **I want to** configure train/test ratios, **So that** I can balance in-sample fit vs out-sample validation

## Acceptance Scenarios

### Scenario 1: 5-Split Walk-Forward
**Given** a 2-year date range with 5 splits and 70% train ratio
**When** walk-forward analysis runs
**Then** each split should have ~110 days training, ~47 days testing
**And** 5 separate optimization runs should execute
**And** 5 out-of-sample backtests should validate the optimal parameters

### Scenario 2: Robustness Calculation
**Given** in-sample Sharpe ratios of [1.9, 1.8, 1.85, 1.9, 1.82]
**And** out-sample Sharpe ratios of [1.45, 1.28, 1.42, 1.25, 1.35]
**When** robustness is calculated
**Then** avg_in_sample_sharpe should be ~1.85
**And** avg_out_sample_sharpe should be ~1.35
**And** robustness_score should be ~0.73
**And** is_robust should be True

### Scenario 3: Robust Strategy Detection
**Given** robustness_score of 0.72
**When** is_robust is evaluated
**Then** it should be True (> 0.5 threshold)

### Scenario 4: Overfitted Strategy Detection
**Given** robustness_score of 0.25
**When** is_robust is evaluated
**Then** it should be False (< 0.5 threshold)
**And** this indicates significant overfitting

## Requirements

### Functional Requirements
- **FR-001**: System MUST divide date range into n_splits segments
- **FR-002**: System MUST apply train_ratio to determine training vs testing periods
- **FR-003**: System MUST run optimization on each training period independently
- **FR-004**: System MUST validate optimal parameters on corresponding test period
- **FR-005**: System MUST calculate average in-sample and out-sample Sharpe ratios
- **FR-006**: System MUST calculate robustness_score as out/in ratio
- **FR-007**: System MUST flag is_robust as True when robustness_score > 0.5

### Non-Functional Requirements
- **NFR-001**: Performance: Each split optimization uses same parallel execution as GridSearchOptimizer
- **NFR-002**: Observability: Log each split's progress and results
- **NFR-003**: Accuracy: Use consistent random seeds for reproducible results

### Technical Constraints
- **TC-001**: Must reuse GridSearchOptimizer for in-sample optimization
- **TC-002**: Must use E11-F01 domain models
- **TC-003**: Must set walk_forward_splits=0 when calling optimizer to prevent recursion

## Key Entities

### Entity: WalkForwardAnalyzer
- **Description**: Analyzer for walk-forward robustness testing
- **Key Attributes**: `_optimizer` (GridSearchOptimizer)
- **Key Methods**: `analyze()`, `_create_splits()`
- **Relationships**: Uses GridSearchOptimizer, produces WalkForwardResult

## Dependencies

### Upstream Dependencies
- [ ] E11-F01: Optimization Domain Models (WalkForwardResult, WalkForwardSplit)
- [ ] E11-F02: GridSearchOptimizer for in-sample optimization
- [ ] E10: BacktestEngine for out-of-sample validation

### Downstream Impact
- [ ] E11-F02: Integrated into GridSearchOptimizer.optimize() flow
- [ ] E11-F04: WalkForwardWidget displays results

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Performance requirements specified (uses parallel optimizer)
- [x] Security requirements defined (N/A)
- [x] Scale requirements clear (n_splits typically 3-10)
- [x] PRD compliance verified (Section 5.6.3)

### Quality Gates
- [ ] Complexity justified
- [ ] All requirements testable
- [ ] Dependencies identified and documented
- [ ] Risk assessment complete

## Tasks Preview

### Implementation Tasks
- [ ] T01 Create WalkForwardAnalyzer class with constructor
- [ ] T02 Implement _create_splits() for date range division
- [ ] T03 Implement per-split optimization loop
- [ ] T04 Implement out-of-sample validation backtest
- [ ] T05 Implement robustness metrics calculation
- [ ] T06 Integrate with GridSearchOptimizer

## Success Criteria

### Acceptance Criteria
- [ ] WalkForwardAnalyzer produces correct split boundaries
- [ ] Each split runs independent optimization
- [ ] Out-of-sample metrics correctly calculated
- [ ] Robustness score accurately reflects out/in ratio
- [ ] is_robust threshold at 0.5 works correctly
- [ ] Integration with GridSearchOptimizer functions end-to-end

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Tests passing
  - [ ] Unit tests for _create_splits() date calculations
  - [ ] Unit tests for robustness score calculation
  - [ ] Integration test with mock optimizer
- [ ] Documentation updated
- [ ] 80% test coverage achieved

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Infinite recursion if walk_forward_splits not reset | Low | High | Explicitly set to 0 in per-split config |
| Date split boundary errors | Medium | Medium | Thorough unit tests for edge cases |
| Long execution time (n_splits * optimization time) | High | Medium | Document expected time, add progress callbacks |

## Notes and Clarifications

### Decisions Made
- 2025-12-30: Robustness threshold at 0.5 per PRD ("at least 50% of in-sample performance")
- 2025-12-30: Use Sharpe ratio for robustness calculation (most common metric)
- 2025-12-30: Default 5 splits and 0.7 train ratio per E11 spec

### File Locations
- `src/domain/services/optimization/walk_forward_analyzer.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
