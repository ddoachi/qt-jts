# Spec: E11-F01 - Optimization Domain Models

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E11-F01
clickup_task_id: ''    # REQUIRED - Empty string if not yet created in ClickUp
title: Optimization Domain Models
type: feature

# === HIERARCHY ===
parent: E11
children: [E11-F01-T01, E11-F01-T02, E11-F01-T03]
epic: E11
feature: F01
domain: optimization

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 8
actual_hours: 0

# === METADATA ===
tags: [domain-model, dataclass, optimization, parameter-range]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Feature
**Parent**: E11 (Strategy Optimization)
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Executive Summary

Define the core domain models for strategy optimization, including OptimizationConfig for specifying parameter ranges, ParameterRange for individual parameter definitions, OptimizationResult for storing results, ParameterResult for individual parameter combination outcomes, and WalkForwardResult/WalkForwardSplit for walk-forward analysis. These models serve as the foundation for the optimization engine and UI components.

## Execution Flow

```
1. Define OptimizationConfig dataclass
   → Contains strategy reference, parameter ranges, optimization target
   → Includes walk-forward configuration (splits, train ratio)
   → Links to DateRange and symbol list

2. Define ParameterRange dataclass
   → Stores min/max/step values
   → Implements values() method to generate all values in range
   → Provides num_values property for combination counting

3. Define OptimizationTarget enum
   → SHARPE, TOTAL_RETURN, PROFIT_FACTOR, WIN_RATE, CALMAR
   → Used for result ranking

4. Define OptimizationResult dataclass
   → Aggregates all parameter combination results
   → Links to WalkForwardResult if walk-forward was run
   → Tracks execution time and creation timestamp

5. Define ParameterResult dataclass
   → Stores single parameter combination with metrics
   → Includes rank for sorted results

6. Define WalkForwardResult and WalkForwardSplit dataclasses
   → Store walk-forward analysis results
   → Calculate robustness score and is_robust flag
```

## User Stories

### Primary User Story
**As a** quantitative trader
**I want to** define parameter ranges for strategy optimization
**So that** I can systematically search for optimal parameter combinations

### Additional Stories
- **As a** developer, **I want to** have type-safe optimization configuration, **So that** I catch errors at compile time
- **As a** trader, **I want to** choose different optimization targets, **So that** I can optimize for my preferred metric

## Acceptance Scenarios

### Scenario 1: Parameter Range Generation
**Given** a ParameterRange with min=10, max=30, step=5
**When** I call the values() method
**Then** it should return [10, 15, 20, 25, 30]
**And** num_values should return 5

### Scenario 2: Optimization Config Validation
**Given** an OptimizationConfig with valid parameters
**When** the config is created
**Then** it should store all fields correctly
**And** walk_forward_splits should default to 5
**And** train_ratio should default to 0.7

### Scenario 3: Robustness Score Calculation
**Given** a WalkForwardResult with avg_in_sample_sharpe=2.0 and avg_out_sample_sharpe=1.4
**When** robustness_score is calculated
**Then** it should equal 0.7 (out/in ratio)
**And** is_robust should be True (>0.5)

## Requirements

### Functional Requirements
- **FR-001**: System MUST define OptimizationConfig with strategy, parameters, target, date range, symbols
- **FR-002**: System MUST support walk-forward configuration with splits and train ratio
- **FR-003**: ParameterRange MUST generate all values in range with given step
- **FR-004**: System MUST support 5 optimization targets: SHARPE, TOTAL_RETURN, PROFIT_FACTOR, WIN_RATE, CALMAR
- **FR-005**: OptimizationResult MUST track execution time and timestamp
- **FR-006**: WalkForwardResult MUST calculate robustness score as out/in ratio
- **FR-007**: is_robust flag MUST be True when robustness_score > 0.5

### Non-Functional Requirements
- **NFR-001**: All dataclasses MUST be immutable (frozen=True recommended)
- **NFR-002**: All fields MUST have type hints
- **NFR-003**: All classes MUST have docstrings explaining purpose

### Technical Constraints
- **TC-001**: Must use Python dataclasses with @dataclass decorator
- **TC-002**: Must use Enum for OptimizationTarget
- **TC-003**: Must integrate with existing Strategy and PerformanceMetrics types from E10

## Key Entities

### Entity: OptimizationConfig
- **Description**: Configuration for a strategy optimization run
- **Key Attributes**: `strategy`, `parameters`, `optimization_target`, `date_range`, `symbols`, `walk_forward_splits`, `train_ratio`
- **Relationships**: Contains list of ParameterRange, references Strategy

### Entity: ParameterRange
- **Description**: Defines min/max/step for a single strategy parameter
- **Key Attributes**: `name`, `min_value`, `max_value`, `step`, `current_value`
- **Relationships**: Contained by OptimizationConfig

### Entity: OptimizationTarget (Enum)
- **Description**: Metric to optimize for
- **Values**: SHARPE, TOTAL_RETURN, PROFIT_FACTOR, WIN_RATE, CALMAR

### Entity: OptimizationResult
- **Description**: Complete results from an optimization run
- **Key Attributes**: `id`, `config`, `combinations_tested`, `results`, `walk_forward_results`, `execution_time_ms`, `created_at`
- **Relationships**: Contains list of ParameterResult, optional WalkForwardResult

### Entity: ParameterResult
- **Description**: Result for a single parameter combination
- **Key Attributes**: `parameters` (dict), `metrics` (PerformanceMetrics), `rank`

### Entity: WalkForwardResult
- **Description**: Aggregate walk-forward analysis results
- **Key Attributes**: `splits`, `avg_in_sample_sharpe`, `avg_out_sample_sharpe`, `robustness_score`, `is_robust`
- **Relationships**: Contains list of WalkForwardSplit

### Entity: WalkForwardSplit
- **Description**: Single train/test split result
- **Key Attributes**: `split_index`, `train_start`, `train_end`, `test_start`, `test_end`, `optimal_params`, `in_sample_metrics`, `out_sample_metrics`

## Dependencies

### Upstream Dependencies
- [ ] E10: Backtesting - Strategy and PerformanceMetrics types
- [ ] E10: DateRange type for date configuration

### Downstream Impact
- [ ] E11-F02: Grid Search Optimizer uses these models
- [ ] E11-F03: Walk-Forward Analyzer produces these results
- [ ] E11-F04: UI components display these models

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Performance requirements specified (N/A - data models)
- [x] Security requirements defined (N/A)
- [x] Scale requirements clear (supports large parameter combinations)
- [x] PRD compliance verified (Section 5.6)

### Quality Gates
- [ ] Complexity justified
- [ ] All requirements testable
- [ ] Dependencies identified and documented
- [ ] Risk assessment complete

## Tasks Preview

### Implementation Tasks
- [ ] T01 [P] Define ParameterRange dataclass with values() and num_values
- [ ] T02 [P] Define OptimizationTarget enum
- [ ] T03 Define OptimizationConfig dataclass (depends on T01, T02)
- [ ] T04 [P] Define ParameterResult dataclass
- [ ] T05 [P] Define WalkForwardSplit dataclass
- [ ] T06 Define WalkForwardResult dataclass (depends on T05)
- [ ] T07 Define OptimizationResult dataclass (depends on T03, T04, T06)

**[P]** = Can be executed in parallel

## Success Criteria

### Acceptance Criteria
- [ ] All dataclasses defined with proper type hints
- [ ] ParameterRange.values() correctly generates value list
- [ ] OptimizationTarget enum has all 5 target types
- [ ] WalkForwardResult.is_robust correctly uses 0.5 threshold
- [ ] All classes have comprehensive docstrings
- [ ] Unit tests cover all dataclass methods

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Tests passing (unit tests for all dataclasses)
  - [ ] Unit tests for ParameterRange.values()
  - [ ] Unit tests for WalkForwardResult robustness calculation
- [ ] Documentation updated
- [ ] 90% test coverage achieved

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Breaking changes to E10 types | Low | High | Use interface/protocol for loose coupling |
| Large parameter ranges causing memory issues | Medium | Medium | Add validation for max combinations |

## Notes and Clarifications

### Decisions Made
- 2025-12-30: Use dataclasses for immutable domain models
- 2025-12-30: Robustness threshold set at 0.5 per PRD

### File Locations
- `src/domain/models/optimization.py` - All optimization domain models

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
