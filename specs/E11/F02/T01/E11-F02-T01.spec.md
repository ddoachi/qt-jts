# Spec: E11-F02-T01 - GridSearchOptimizer Core

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E11-F02-T01
clickup_task_id: '86ew0fpjt'
title: GridSearchOptimizer Core
type: task

# === HIERARCHY ===
parent: E11-F02
children: []
epic: E11
feature: F02
task: T01
domain: optimization

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [optimization, grid-search, parallel, engine]
effort: medium
risk: medium
wave: 4
parallel: false
---

**Status**: Draft
**Type**: Task
**Parent**: E11-F02 (Grid Search Optimizer Engine)
**Wave**: 4 (Depends on F01)

## Executive Summary

Create the GridSearchOptimizer class with constructor, combination generation using itertools.product, parameter application to strategy, and the main optimize() method structure. This forms the foundation for parallel execution.

## User Stories

**As a** developer
**I want to** generate all parameter combinations
**So that** I can test each combination systematically

## Acceptance Scenarios

### Scenario 1: Generate Combinations
**Given** 3 parameters with [5, 4, 5] values each
**When** _generate_combinations() is called
**Then** it returns 100 combinations (5 * 4 * 5)
**And** each combination is a dict with parameter names as keys

### Scenario 2: Apply Parameters
**Given** a strategy and parameter dict {"rsi_period": 14, "sma_period": 20}
**When** _apply_params() is called
**Then** it returns a strategy copy with updated parameters

### Scenario 3: Optimizer Initialization
**Given** BacktestEngine and max_workers=8
**When** GridSearchOptimizer is created
**Then** it stores engine reference and sets max_workers

## Requirements

### Functional Requirements
- **FR-001**: Constructor MUST accept BacktestEngine and optional max_workers
- **FR-002**: max_workers MUST default to CPU count
- **FR-003**: _generate_combinations() MUST create cartesian product of all parameter values
- **FR-004**: _apply_params() MUST create strategy copy with new parameters

### Technical Constraints
- **TC-001**: Use itertools.product for combination generation
- **TC-002**: Use ProcessPoolExecutor from concurrent.futures
- **TC-003**: Must not mutate original strategy

## Implementation Details

### File Location
`src/domain/services/optimization/grid_search_optimizer.py`

### Code Structure
```python
import itertools
import os
from concurrent.futures import ProcessPoolExecutor
from typing import Callable, Optional

class GridSearchOptimizer:
    """Grid search optimization engine"""

    def __init__(
        self,
        backtest_engine: 'BacktestEngine',
        max_workers: Optional[int] = None
    ):
        self._backtest_engine = backtest_engine
        self._max_workers = max_workers or (os.cpu_count() or 4)
        self._executor: Optional[ProcessPoolExecutor] = None

    def _generate_combinations(
        self,
        parameters: list['ParameterRange']
    ) -> list[dict[str, float]]:
        """Generate all parameter combinations using cartesian product"""
        if not parameters:
            return [{}]

        param_values = {p.name: p.values() for p in parameters}
        keys = list(param_values.keys())
        value_lists = [param_values[k] for k in keys]

        combinations = []
        for values in itertools.product(*value_lists):
            combinations.append(dict(zip(keys, values)))

        return combinations

    def _apply_params(
        self,
        strategy: 'Strategy',
        params: dict[str, float]
    ) -> 'Strategy':
        """Create strategy copy with new parameters"""
        # Implementation depends on Strategy interface
        return strategy.with_parameters(params)

    async def optimize(
        self,
        config: 'OptimizationConfig',
        progress_callback: Optional[Callable[[int, int], None]] = None
    ) -> 'OptimizationResult':
        """Run grid search optimization - implemented in T02/T03"""
        raise NotImplementedError("Implemented in T02/T03")
```

## Dependencies

### Upstream
- E11-F01: Domain models (ParameterRange, OptimizationConfig, OptimizationResult)
- E10: BacktestEngine, Strategy

### Downstream
- E11-F02-T02: Implements parallel execution
- E11-F02-T03: Implements result ranking

## Success Criteria

- [ ] GridSearchOptimizer class created with constructor
- [ ] _generate_combinations() produces correct cartesian product
- [ ] _apply_params() creates strategy copy (placeholder)
- [ ] Unit tests verify combination generation
- [ ] Unit tests verify initialization

---
*Template Version: 2.0.0*
