---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E07-F05-T01
clickup_task_id: '86ew020u1'
title: Implement CSV Export
type: task

# === HIERARCHY ===
parent: E07-F05
children: []
epic: E07
feature: F05
task: T01
domain: scanner

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags:
  - export
  - csv
  - encoding
effort: medium
risk: low
wave: 2
---

# Spec: E07-F05-T01 - Implement CSV Export

**Status**: Draft
**Type**: Task
**Parent**: [E07-F05](../E07-F05.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement CSV export for scan results with UTF-8 BOM encoding for Excel compatibility with Korean characters, proper value formatting, and configurable columns.

## Execution Flow

```
1. Define ExportColumn value object
   → key, label, formatter function

2. Define default columns
   → Symbol, Name, Time, Close, Volume, Vol Ratio, Change %

3. Export to CSV file
   → Open file with UTF-8 encoding
   → Write UTF-8 BOM (\ufeff)
   → Write header row with Korean labels
   → For each match, format and write row
   → Close file

4. Export to string (for in-memory use)
   → Same as file but to StringIO
   → Return: CSV string
```

## User Stories

### Primary User Story
**As a** trader
**I want to** export scan results to CSV
**So that** I can analyze them in Excel

## Acceptance Scenarios

### Scenario 1: Korean Characters in Excel
**Given** matches with Korean stock names
**When** I export to CSV and open in Excel
**Then** Korean characters display correctly

### Scenario 2: Currency Formatting
**Given** close price 72500
**When** exported
**Then** value is "72,500"

### Scenario 3: Custom Columns
**Given** only symbol and close columns selected
**When** exported
**Then** only those columns in output

### Scenario 4: Special Characters
**Given** stock name with comma
**When** exported
**Then** value is properly quoted

## Requirements

### Functional Requirements
- **FR-001**: MUST use UTF-8 with BOM encoding
- **FR-002**: MUST have Korean column labels
- **FR-003**: MUST format currency with comma separators
- **FR-004**: MUST escape special characters
- **FR-005**: MUST support column selection

### Non-Functional Requirements
- **NFR-001**: 10,000 rows in < 5 seconds

### Technical Constraints
- **TC-001**: UTF-8 BOM bytes: \xef\xbb\xbf
- **TC-002**: Use csv module with QUOTE_MINIMAL

## Key Entities

### Class: ScanExportService
```python
class ScanExportService:
    UTF8_BOM = '\ufeff'

    def export_to_csv(
        self,
        matches: list[ScanMatch],
        file_path: Path,
        columns: Optional[list[ExportColumn]] = None
    ) -> None

    def export_to_csv_string(
        self,
        matches: list[ScanMatch],
        columns: Optional[list[ExportColumn]] = None
    ) -> str
```

### Value Object: ExportColumn
```python
@dataclass(frozen=True)
class ExportColumn:
    key: str
    label: str
    formatter: Callable[[Any], str] = str
```

## Dependencies

### Upstream Dependencies
- [ ] E07-F01-T02: ScanMatch

### Downstream Impact
- [ ] E07-F05-T02: Excel export uses same structure

## Gate Checks

### Pre-Implementation Gates
- [ ] Column definitions finalized

### Quality Gates
- [ ] Korean character test
- [ ] Performance test 10,000 rows
- [ ] 90% test coverage

## Success Criteria

### Acceptance Criteria
- [ ] Korean displays in Excel
- [ ] Formatting correct
- [ ] Performance met
- [ ] Special chars escaped

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Tested in Excel

## Artifacts

### Input Documents
- [Feature Spec](../E07-F05.spec.md)

### Output Artifacts
- [ ] `src/application/services/scan_export_service.py`
- [ ] `src/domain/value_objects/export_column.py`

---
*Template Version: 2.0.0*
