---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E07-F04-T05
clickup_task_id: '86ew020tr'
title: Create FormulaEditorDialog
type: task

# === HIERARCHY ===
parent: E07-F04
children: []
epic: E07
feature: F04
task: T05
domain: scanner

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags:
  - ui
  - dialog
  - editor
effort: medium
risk: low
wave: 3
---

# Spec: E07-F04-T05 - Create FormulaEditorDialog

**Status**: Draft
**Type**: Task
**Parent**: [E07-F04](../E07-F04.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Create modal dialog for creating and editing formulas with syntax highlighting, real-time validation, category selection, and tag input.

## Execution Flow

```
1. Create dialog layout
   → Name input
   → Category dropdown
   → Expression text editor with syntax highlighting
   → Validation status label
   → Tags input
   → Description text area
   → Save/Cancel buttons

2. Create FormulaHighlighter
   → Highlight keywords (sma, ema, rsi, etc.)
   → Highlight numbers
   → Highlight variables (open, high, low, close, volume)
   → Highlight parameters (:param)

3. Real-time validation
   → On expression change, validate via E05
   → Show green checkmark if valid
   → Show red error message if invalid
   → Enable/disable save button

4. Handle save
   → Build CreateFormulaRequest or UpdateFormulaRequest
   → Emit formula_saved signal
   → Close dialog
   → Return: SUCCESS with dialog
```

## User Stories

### Primary User Story
**As a** trader
**I want to** create and edit formulas easily
**So that** I can define scanning patterns

## Acceptance Scenarios

### Scenario 1: Create Mode
**Given** no formula passed
**When** dialog opens
**Then** title is "Create Formula" and form is empty

### Scenario 2: Edit Mode
**Given** existing formula passed
**When** dialog opens
**Then** form is populated with formula data

### Scenario 3: Syntax Highlighting
**Given** expression "sma(close, 20)"
**When** typing
**Then** "sma" and "close" are colored

### Scenario 4: Validation Feedback
**Given** invalid expression "close >"
**When** typing
**Then** error message shown and save disabled

## Requirements

### Functional Requirements
- **FR-001**: MUST support create and edit modes
- **FR-002**: MUST have syntax highlighting
- **FR-003**: MUST validate expression in real-time
- **FR-004**: MUST show validation status
- **FR-005**: MUST enable save only when valid

### Non-Functional Requirements
- **NFR-001**: Validation < 100ms
- **NFR-002**: Highlighting updates instantly

### Technical Constraints
- **TC-001**: Use E05 FormulaService for validation
- **TC-002**: Use QSyntaxHighlighter

## Key Entities

### Class: FormulaEditorDialog
```python
class FormulaEditorDialog(QDialog):
    formula_saved = Signal(object)  # CreateFormulaRequest or (id, UpdateFormulaRequest)

    def __init__(
        self,
        formula_service: FormulaService,
        formula: Optional[Formula] = None
    ): ...
```

### Class: FormulaHighlighter
```python
class FormulaHighlighter(QSyntaxHighlighter):
    def highlightBlock(self, text: str) -> None
```

## Dependencies

### Upstream Dependencies
- [ ] E05: FormulaService for validation
- [ ] E07-F04-T01: ScannerView opens this

### Downstream Impact
- [ ] E07-F03: Creates formulas via use case

## Gate Checks

### Pre-Implementation Gates
- [ ] E05 FormulaService available

### Quality Gates
- [ ] Validation tested
- [ ] Highlighting tested
- [ ] 80% test coverage

## Success Criteria

### Acceptance Criteria
- [ ] Create and edit modes work
- [ ] Syntax highlighting works
- [ ] Validation shows correct status
- [ ] Save enabled only when valid

### Definition of Done
- [ ] Code reviewed
- [ ] UI tests passing

## Artifacts

### Input Documents
- [Feature Spec](../E07-F04.spec.md)

### Output Artifacts
- [ ] `src/presentation/views/scanner/formula_editor_dialog.py`

---
*Template Version: 2.0.0*
