---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E07-F01
clickup_task_id: ''
title: Domain Model
type: feature

# === HIERARCHY ===
parent: E07
children:
  - E07-F01-T01
  - E07-F01-T02
epic: E07
feature: F01
domain: scanner

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 6
actual_hours: 0

# === METADATA ===
tags:
  - domain-model
  - entities
  - value-objects
effort: medium
risk: low
wave: 1
---

# Spec: E07-F01 - Domain Model

**Status**: Draft
**Type**: Feature
**Parent**: [E07](../E07.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Define core domain entities and value objects for the Market Scanner feature. This includes `ScanSession` for tracking scanning sessions, `ScanConfig` for configuration, `ScanResults` for aggregated results, and `ScanMatch` for individual matches. These entities form the foundation for all scanner operations.

## Execution Flow

```
1. Define ScanStatus enum
   → Values: PENDING, RUNNING, COMPLETED, FAILED, CANCELLED
   → If missing: ERROR "ScanStatus enum required"

2. Create ScanConfig value object
   → Validate timeframe against allowed values
   → Validate markets list is not empty
   → If invalid timeframe: ERROR "Invalid timeframe: {value}"

3. Create SymbolFilter value object
   → Validate market cap range (min <= max)
   → If invalid range: ERROR "min_market_cap cannot exceed max_market_cap"

4. Create ScanSession entity
   → Implement status transitions with validation
   → If invalid transition: ERROR "Cannot transition from {from} to {to}"

5. Create ScanResults and ScanMatch value objects
   → Implement calculated properties (match_rate, avg_time)
   → Return: SUCCESS with complete domain model
```

## User Stories

### Primary User Story
**As a** trader
**I want to** have well-defined domain entities for scan operations
**So that** the scanner can track sessions, configurations, and results consistently

### Additional Stories
- **As a** developer, **I want to** have immutable value objects, **So that** data integrity is guaranteed
- **As a** developer, **I want to** have validated entities, **So that** invalid states are prevented

## Acceptance Scenarios

### Scenario 1: Create Valid Scan Session
**Given** a valid formula and configuration
**When** I create a new ScanSession
**Then** the session is created with PENDING status and unique ID

### Scenario 2: Invalid Timeframe
**Given** a configuration with invalid timeframe "2h"
**When** I create a ScanConfig
**Then** a ValueError is raised with message "Invalid timeframe: 2h"

### Scenario 3: Invalid Market Cap Range
**Given** min_market_cap > max_market_cap
**When** I create a SymbolFilter
**Then** a ValueError is raised with appropriate message

### Scenario 4: Status Transition
**Given** a session in PENDING status
**When** I call session.start()
**Then** status changes to RUNNING and started_at is set

## Requirements

### Functional Requirements
- **FR-001**: ScanSession MUST track status transitions (PENDING → RUNNING → COMPLETED/FAILED)
- **FR-002**: ScanConfig MUST validate timeframe against allowed values (1m, 5m, 15m, 1h, 1d, 1w)
- **FR-003**: ScanConfig MUST require at least one market
- **FR-004**: SymbolFilter MUST validate market cap range
- **FR-005**: All value objects MUST be immutable (frozen=True)
- **FR-006**: All entities MUST support JSON serialization

### Non-Functional Requirements
- **NFR-001**: Validation: All validation errors within 1ms
- **NFR-002**: Memory: Entity creation < 1KB per instance
- **NFR-003**: Thread Safety: Value objects immutable for concurrent access

### Technical Constraints
- **TC-001**: Must use Python dataclasses
- **TC-002**: Must integrate with E06 ProcessingEngine types (DateRange, etc.)
- **TC-003**: Must use Decimal for financial values

## Key Entities

### Entity: ScanSession
- **Description**: Represents a scanning session with lifecycle management
- **Key Attributes**: id, formula, config, status, results, created_at, completed_at
- **Relationships**: Has one ScanConfig, has optional ScanResults

### Entity: ScanConfig
- **Description**: Configuration for scan execution (immutable value object)
- **Key Attributes**: data_source, markets, timeframe, date_range, symbol_filter, parameters
- **Relationships**: Contains optional SymbolFilter

### Entity: SymbolFilter
- **Description**: Filter criteria for symbol selection (immutable value object)
- **Key Attributes**: sectors, min_market_cap, max_market_cap, include_symbols, exclude_symbols
- **Relationships**: Belongs to ScanConfig

### Entity: ScanResults
- **Description**: Aggregated scan results (immutable value object)
- **Key Attributes**: total_symbols_scanned, total_matches, matches, execution_time_ms
- **Relationships**: Contains list of ScanMatch

### Entity: ScanMatch
- **Description**: Individual scan match (immutable value object)
- **Key Attributes**: symbol, symbol_name, match_time, candle, indicator_values
- **Relationships**: References Candle from E06

## Dependencies

### Upstream Dependencies
- [ ] E06: ProcessingEngine for DateRange, Candle, DataSource types

### Downstream Impact
- [ ] E07-F02: Scan Execution uses these entities
- [ ] E07-F05: Export uses ScanResults and ScanMatch

## Gate Checks

### Pre-Implementation Gates
- [ ] No [NEEDS CLARIFICATION] markers remain
- [ ] All entity attributes defined
- [ ] All validation rules specified
- [ ] E06 types identified

### Quality Gates
- [ ] All value objects immutable
- [ ] All requirements testable
- [ ] Status transitions documented
- [ ] JSON serialization supported

## Tasks Preview

### Implementation Tasks
- [ ] T01 [P] Define ScanSession and ScanConfig entities
- [ ] T02 Define ScanResults and ScanMatch (depends on T01)

**[P]** = Can be executed in parallel

## Success Criteria

### Acceptance Criteria
- [ ] All entities created with proper types
- [ ] All validation rules implemented
- [ ] Status transitions work correctly
- [ ] JSON serialization round-trip works
- [ ] 90% test coverage

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing
- [ ] Documentation updated
- [ ] Type hints complete

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Type incompatibility with E06 | Low | Medium | Early integration testing |
| Missing validation rules | Low | Medium | Comprehensive test cases |

## Notes and Clarifications

### Decisions Made
- 2025-12-28: Use frozen dataclasses for value objects for immutability
- 2025-12-28: Use tuple instead of list for immutable collections

### File Structure
```
src/domain/
├── entities/
│   └── scan_session.py
├── value_objects/
│   ├── scan_config.py
│   └── scan_results.py
└── enums/
    └── scan_status.py
```

## Artifacts

### Input Documents
- [Product Requirements](../../../docs/prd.md)
- [Parent Spec](../E07.spec.md)

### Output Artifacts
- [ ] `E07-F01.context.md` - Implementation context
- [ ] `E07-F01.pre-docs.md` - Pre-implementation documentation
- [ ] `E07-F01.post-docs.md` - Post-implementation learnings

---
*Template Version: 2.0.0*
