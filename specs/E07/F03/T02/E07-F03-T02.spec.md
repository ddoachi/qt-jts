---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E07-F03-T02
clickup_task_id: '86ew020rq'
title: Add Formula Versioning
type: task

# === HIERARCHY ===
parent: E07-F03
children: []
epic: E07
feature: F03
task: T02
domain: scanner

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 2
actual_hours: 0

# === METADATA ===
tags:
  - versioning
  - formula
  - history
effort: small
risk: low
wave: 1
---

# Spec: E07-F03-T02 - Add Formula Versioning

**Status**: Draft
**Type**: Task
**Parent**: [E07-F03](../E07-F03.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Enhance Formula entity with version tracking: auto-increment version on updates, track update timestamp and user, optionally preserve version history.

## Execution Flow

```
1. Enhance Formula entity
   → Add version field (default 1)
   → Add updated_at field
   → Add updated_by field
   → Add increment_version() method

2. Create FormulaVersion value object (optional)
   → Frozen dataclass for history snapshots
   → Contains expression, description, tags at version

3. Integrate with FormulaLibraryUseCase
   → Call increment_version() on update
   → Optionally save version snapshot before update

4. Add version history methods (optional)
   → get_version_history(formula_id)
   → restore_version(formula_id, version)
   → Return: SUCCESS with versioned formula
```

## User Stories

### Primary User Story
**As a** trader
**I want to** track formula version history
**So that** I can see what changed

## Acceptance Scenarios

### Scenario 1: Version Increment
**Given** formula at version 1
**When** I update the expression
**Then** version becomes 2

### Scenario 2: Updated Timestamp
**Given** any formula update
**When** update completes
**Then** updated_at is set to now

### Scenario 3: Restore Version (Optional)
**Given** formula with version history
**When** I restore version 1
**Then** formula content matches version 1

## Requirements

### Functional Requirements
- **FR-001**: Version MUST increment on every update
- **FR-002**: updated_at MUST be set on update
- **FR-003**: updated_by SHOULD track who updated
- **FR-004**: Version history MAY be preserved (optional)

### Technical Constraints
- **TC-001**: Version is integer starting at 1
- **TC-002**: FormulaVersion is immutable

## Key Entities

### Entity: Formula (Enhanced)
```python
@dataclass
class Formula:
    # ... existing fields ...
    version: int = 1
    updated_at: Optional[datetime] = None
    updated_by: Optional[str] = None

    def increment_version(self, updated_by: str = None) -> None
    def to_version_snapshot(self) -> FormulaVersion
```

### Entity: FormulaVersion (Optional)
```python
@dataclass(frozen=True)
class FormulaVersion:
    formula_id: int
    version: int
    expression: str
    description: str
    tags: tuple[str, ...]
    created_at: datetime
```

## Dependencies

### Upstream Dependencies
- [ ] E07-F03-T01: FormulaLibraryUseCase

### Downstream Impact
- [ ] None - enhancement to existing

## Gate Checks

### Pre-Implementation Gates
- [ ] E07-F03-T01 complete

### Quality Gates
- [ ] Version increment tested
- [ ] Timestamp update tested
- [ ] 90% test coverage

## Success Criteria

### Acceptance Criteria
- [ ] Version increments correctly
- [ ] Timestamps update correctly
- [ ] Optional history works if implemented

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing

## Artifacts

### Input Documents
- [Feature Spec](../E07-F03.spec.md)
- [T01 Spec](../T01/E07-F03-T01.spec.md)

### Output Artifacts
- [ ] Updated `src/domain/entities/formula.py`
- [ ] Optional: `src/domain/value_objects/formula_version.py`

---
*Template Version: 2.0.0*
