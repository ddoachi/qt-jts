---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E07-F03
clickup_task_id: ''
title: Formula Library
type: feature

# === HIERARCHY ===
parent: E07
children:
  - E07-F03-T01
  - E07-F03-T02
epic: E07
feature: F03
domain: scanner

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 6
actual_hours: 0

# === METADATA ===
tags:
  - use-case
  - formula
  - library
effort: medium
risk: low
wave: 1
---

# Spec: E07-F03 - Formula Library

**Status**: Draft
**Type**: Feature
**Parent**: [E07](../E07.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement formula library management for creating, saving, and organizing reusable scan formulas. This includes CRUD operations, category/tag-based organization, search functionality, and version tracking for formula updates. Integrates with E05 DSL for formula validation.

## Execution Flow

```
1. Create formula request received
   → Validate name is not empty
   → If empty: ERROR "Formula name required"

2. Validate expression via E05 DSL
   → Parse expression
   → Extract parameters
   → If invalid: ERROR "Invalid expression: {details}"

3. Check for duplicate name
   → Query repository by name
   → If exists: ERROR "Formula with name already exists"

4. Create formula entity
   → Assign ID from repository
   → Set version to 1
   → Set created_at timestamp

5. Persist to repository
   → Save formula
   → Return: SUCCESS with created formula
```

## User Stories

### Primary User Story
**As a** trader
**I want to** save and organize my scan formulas
**So that** I can reuse them without retyping

### Additional Stories
- **As a** trader, **I want to** search formulas by name or tag, **So that** I can find them quickly
- **As a** trader, **I want to** categorize formulas, **So that** I can organize them logically
- **As a** trader, **I want to** track formula versions, **So that** I can see change history

## Acceptance Scenarios

### Scenario 1: Create Valid Formula
**Given** a valid expression "volume > average(volume, 20) * 2.5"
**When** I create a formula with name "Volume Surge"
**Then** the formula is saved with extracted parameters

### Scenario 2: Invalid Expression
**Given** an invalid expression "volume >"
**When** I try to create a formula
**Then** I receive validation error from E05 DSL

### Scenario 3: Duplicate Name
**Given** a formula named "Volume Surge" already exists
**When** I try to create another with the same name
**Then** I receive a DuplicateFormulaError

### Scenario 4: Update Increments Version
**Given** a formula at version 1
**When** I update the expression
**Then** the version becomes 2 and updated_at is set

## Requirements

### Functional Requirements
- **FR-001**: System MUST validate expression via E05 DSL before saving
- **FR-002**: System MUST extract parameters from expression
- **FR-003**: System MUST prevent duplicate formula names
- **FR-004**: System MUST increment version on updates
- **FR-005**: System MUST support search by name or tags
- **FR-006**: System MUST support category filtering

### Non-Functional Requirements
- **NFR-001**: Search: Return results in < 100ms
- **NFR-002**: Storage: Support 1000+ formulas per user

### Technical Constraints
- **TC-001**: Must integrate with E05 DSL for validation
- **TC-002**: Must use repository pattern for persistence

## Key Entities

### Entity: Formula
- **Description**: Reusable scan formula entity
- **Key Attributes**: id, name, expression, category, tags, parameters, version
- **Relationships**: Created by User, used by ScanSession

### Entity: FormulaCategory (Enum)
- **Values**: SCAN, ENTRY, EXIT, FILTER

### Entity: Parameter
- **Description**: Formula parameter definition
- **Key Attributes**: name, type, default_value, description

## Dependencies

### Upstream Dependencies
- [ ] E05: DSL Parser for expression validation and parameter extraction

### Downstream Impact
- [ ] E07-F02: RunScanUseCase uses formulas
- [ ] E07-F04-T02: FormulaLibraryWidget displays formulas
- [ ] E07-F04-T05: FormulaEditorDialog edits formulas

## Gate Checks

### Pre-Implementation Gates
- [ ] E05 DSL Parser available
- [ ] Repository interface defined
- [ ] Categories finalized

### Quality Gates
- [ ] All CRUD operations tested
- [ ] Validation edge cases covered
- [ ] Search performance verified

## Tasks Preview

### Implementation Tasks
- [ ] T01 [P] Implement FormulaLibraryUseCase
- [ ] T02 Add formula versioning (depends on T01)

**[P]** = Can be executed in parallel

## Success Criteria

### Acceptance Criteria
- [ ] CRUD operations work correctly
- [ ] Expression validation via E05 works
- [ ] Search returns correct results
- [ ] Version increments on update
- [ ] 90% test coverage

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing
- [ ] Integration with E05 verified
- [ ] Documentation updated

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| E05 DSL incompatibility | Low | High | Early integration testing |
| Search performance issues | Low | Medium | Index on name and tags |

## Notes and Clarifications

### Decisions Made
- 2025-12-28: Use E05 FormulaService for validation
- 2025-12-28: Version increment happens on any field update

### File Structure
```
src/application/
└── use_cases/
    └── formula_library_use_case.py

src/domain/
├── entities/
│   └── formula.py
├── repositories/
│   └── formula_repository.py
└── enums/
    └── formula_category.py
```

## Artifacts

### Input Documents
- [Product Requirements](../../../docs/prd.md)
- [Parent Spec](../E07.spec.md)

### Output Artifacts
- [ ] `E07-F03.context.md` - Implementation context
- [ ] `E07-F03.pre-docs.md` - Pre-implementation documentation
- [ ] `E07-F03.post-docs.md` - Post-implementation learnings

---
*Template Version: 2.0.0*
