---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E07-F03-T01
clickup_task_id: '86ew020rm'
title: Implement FormulaLibraryUseCase
type: task

# === HIERARCHY ===
parent: E07-F03
children: []
epic: E07
feature: F03
task: T01
domain: scanner

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags:
  - use-case
  - crud
  - formula
effort: medium
risk: low
wave: 1
---

# Spec: E07-F03-T01 - Implement FormulaLibraryUseCase

**Status**: Draft
**Type**: Task
**Parent**: [E07-F03](../E07-F03.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement the formula library use case with CRUD operations, expression validation via E05 DSL, category/tag filtering, and search functionality.

## Execution Flow

```
1. Create formula
   → Validate name not empty
   → Parse expression via E05 FormulaService
   → Extract parameters from parsed result
   → Check for duplicate name
   → If duplicate: ERROR "Formula with name already exists"
   → Persist and return formula

2. Update formula
   → Get existing formula by ID
   → If not found: ERROR "Formula not found"
   → Validate new expression if changed
   → Apply updates
   → Increment version
   → Persist and return formula

3. Delete formula
   → Get existing formula by ID
   → If not found: ERROR "Formula not found"
   → Remove from repository

4. Search formulas
   → Query repository with search term
   → Match against name and tags
   → Return matching formulas

5. Get by category
   → Query repository by category
   → Return filtered formulas
```

## User Stories

### Primary User Story
**As a** trader
**I want to** manage my formula library
**So that** I can reuse formulas across scans

## Acceptance Scenarios

### Scenario 1: Create Valid Formula
**Given** expression "volume > average(volume, 20) * 2.5"
**When** I create with name "Volume Surge"
**Then** formula is saved with extracted parameters

### Scenario 2: Invalid Expression
**Given** expression "volume >"
**When** I try to create
**Then** FormulaValidationError is raised

### Scenario 3: Duplicate Name
**Given** "Volume Surge" already exists
**When** I create another with same name
**Then** DuplicateFormulaError is raised

### Scenario 4: Search by Tag
**Given** formulas with tag "momentum"
**When** I search "momentum"
**Then** matching formulas are returned

## Requirements

### Functional Requirements
- **FR-001**: MUST validate expression via E05 before save
- **FR-002**: MUST extract parameters from expression
- **FR-003**: MUST prevent duplicate names
- **FR-004**: MUST support search by name or tags
- **FR-005**: MUST support category filtering

### Non-Functional Requirements
- **NFR-001**: Search < 100ms

### Technical Constraints
- **TC-001**: Integrate with E05 FormulaService
- **TC-002**: Use repository pattern

## Key Entities

### Class: FormulaLibraryUseCase
```python
class FormulaLibraryUseCase:
    def __init__(
        self,
        formula_repo: IFormulaRepository,
        formula_service: FormulaService
    ): ...

    async def create_formula(self, request: CreateFormulaRequest) -> Formula
    async def update_formula(self, id: int, request: UpdateFormulaRequest) -> Formula
    async def delete_formula(self, id: int) -> None
    async def get_by_id(self, id: int) -> Optional[Formula]
    async def get_all(self) -> list[Formula]
    async def get_by_category(self, category: FormulaCategory) -> list[Formula]
    async def search(self, query: str) -> list[Formula]
```

## Dependencies

### Upstream Dependencies
- [ ] E05: FormulaService for validation

### Downstream Impact
- [ ] E07-F03-T02: Versioning extends this
- [ ] E07-F04-T02: FormulaLibraryWidget uses this

## Gate Checks

### Pre-Implementation Gates
- [ ] E05 FormulaService available
- [ ] IFormulaRepository interface defined

### Quality Gates
- [ ] All CRUD operations tested
- [ ] Validation edge cases tested
- [ ] 90% test coverage

## Success Criteria

### Acceptance Criteria
- [ ] All CRUD operations work
- [ ] Expression validation works
- [ ] Search returns correct results
- [ ] 90% test coverage

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] E05 integration verified

## Artifacts

### Input Documents
- [Feature Spec](../E07-F03.spec.md)

### Output Artifacts
- [ ] `src/application/use_cases/formula_library_use_case.py`
- [ ] `src/domain/entities/formula.py`
- [ ] `src/domain/repositories/formula_repository.py`

---
*Template Version: 2.0.0*
