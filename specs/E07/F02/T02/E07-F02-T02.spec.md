---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E07-F02-T02
clickup_task_id: '86ew020re'
title: Implement Symbol Resolution with Filters
type: task

# === HIERARCHY ===
parent: E07-F02
children: []
epic: E07
feature: F02
task: T02
domain: scanner

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags:
  - filtering
  - symbols
  - service
effort: medium
risk: low
wave: 2
---

# Spec: E07-F02-T02 - Implement Symbol Resolution with Filters

**Status**: Draft
**Type**: Task
**Parent**: [E07-F02](../E07-F02.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement symbol filtering logic within the scan execution flow. Supports filtering by include/exclude lists, sector, and market cap range with proper filter ordering.

## Execution Flow

```
1. Receive symbol list and SymbolFilter
   → If filter is None: return original list

2. Apply include filter (restrictive)
   → If include_symbols specified: keep ONLY those
   → Intersection with current list

3. Apply exclude filter
   → Remove symbols in exclude_symbols

4. Apply sector filter
   → Query symbol_repo.get_sectors(symbols)
   → Keep only symbols in specified sectors

5. Apply market cap filter
   → Query symbol_repo.get_market_caps(symbols)
   → Filter by min/max range
   → Return: filtered symbol list
```

## User Stories

### Primary User Story
**As a** trader
**I want to** filter symbols before scanning
**So that** I focus on relevant stocks

## Acceptance Scenarios

### Scenario 1: Include Filter
**Given** include_symbols = ["005930", "000660"]
**When** filtering 2500 symbols
**Then** only those 2 symbols remain

### Scenario 2: Exclude Filter
**Given** exclude_symbols = ["005930"]
**When** filtering KOSPI market
**Then** Samsung is removed from list

### Scenario 3: Sector Filter
**Given** sectors = ["반도체"]
**When** filtering market
**Then** only semiconductor stocks remain

### Scenario 4: Market Cap Range
**Given** min_market_cap = 1조
**When** filtering
**Then** only large-cap stocks remain

### Scenario 5: Combined Filters
**Given** sector = "반도체" AND min_market_cap = 1조
**When** filtering
**Then** large-cap semiconductor stocks remain

## Requirements

### Functional Requirements
- **FR-001**: Include filter MUST restrict to ONLY specified symbols
- **FR-002**: Exclude filter MUST remove specified symbols
- **FR-003**: Sector filter MUST query repository for sector data
- **FR-004**: Market cap filter MUST handle min, max, or both
- **FR-005**: Filters MUST apply in order: include → exclude → sector → market_cap

### Non-Functional Requirements
- **NFR-001**: Filter 2500 symbols in < 1 second

### Technical Constraints
- **TC-001**: Use ISymbolRepository for metadata queries
- **TC-002**: Handle None/empty filters gracefully

## Key Entities

### Class: SymbolFilterService
```python
class SymbolFilterService:
    def __init__(self, symbol_repo: ISymbolRepository): ...

    async def apply_filter(
        self,
        symbols: list[str],
        filter_config: SymbolFilter
    ) -> list[str]: ...
```

## Dependencies

### Upstream Dependencies
- [ ] E07-F01-T01: SymbolFilter value object
- [ ] E07-F02-T01: RunScanUseCase calls this

### Downstream Impact
- [ ] None - internal service

## Gate Checks

### Pre-Implementation Gates
- [ ] E07-F02-T01 complete
- [ ] ISymbolRepository interface defined

### Quality Gates
- [ ] All filter types tested
- [ ] Combined filters tested
- [ ] Performance test for 2500 symbols

## Success Criteria

### Acceptance Criteria
- [ ] All filter types work correctly
- [ ] Filters apply in correct order
- [ ] Empty filter returns all symbols
- [ ] 90% test coverage

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Performance verified

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Repository query slow | Low | Medium | Batch queries |

## Artifacts

### Input Documents
- [Feature Spec](../E07-F02.spec.md)
- [T01 Spec](../T01/E07-F02-T01.spec.md)

### Output Artifacts
- [ ] `src/domain/services/symbol_filter_service.py`

---
*Template Version: 2.0.0*
