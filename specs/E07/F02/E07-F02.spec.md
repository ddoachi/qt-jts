---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E07-F02
clickup_task_id: ''
title: Scan Execution
type: feature

# === HIERARCHY ===
parent: E07
children:
  - E07-F02-T01
  - E07-F02-T02
epic: E07
feature: F02
domain: scanner

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 12
actual_hours: 0

# === METADATA ===
tags:
  - use-case
  - processing
  - scan-execution
effort: large
risk: medium
wave: 2
---

# Spec: E07-F02 - Scan Execution

**Status**: Draft
**Type**: Feature
**Parent**: [E07](../E07.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement the core scan execution use case that orchestrates symbol resolution, processing job creation, engine execution, and result aggregation. This feature integrates with E06 ProcessingEngine to execute scans across hundreds of symbols with real-time progress tracking.

## Execution Flow

```
1. Receive RunScanRequest with formula and config
   → Validate formula is not null
   → Validate config is valid
   → If invalid: ERROR "Invalid scan request"

2. Create ScanSession
   → Generate unique ID
   → Set status to PENDING
   → Persist to repository
   → If persist fails: ERROR "Failed to create session"

3. Resolve symbols from configuration
   → Get symbols for each market
   → Apply filters (include, exclude, sector, market cap)
   → If no symbols: WARN "No symbols match criteria"

4. Create ProcessingJob for engine
   → Build job with symbols, timeframe, formula
   → Set parameters from config

5. Execute scan with progress tracking
   → Update status to RUNNING
   → Call engine.process_batch()
   → Report progress via callback
   → If engine error: transition to FAILED

6. Aggregate results
   → Use SignalAggregator to process engine output
   → Convert to ScanResults with matches
   → Update status to COMPLETED
   → Return: SUCCESS with session
```

## User Stories

### Primary User Story
**As a** trader
**I want to** scan the entire market for patterns matching my formula
**So that** I can find trading opportunities quickly

### Additional Stories
- **As a** trader, **I want to** see scan progress in real-time, **So that** I know how long to wait
- **As a** trader, **I want to** filter symbols before scanning, **So that** I focus on relevant stocks

## Acceptance Scenarios

### Scenario 1: Successful Scan
**Given** a valid formula and KOSPI market selected
**When** I execute a scan
**Then** I receive results with all matching symbols within 30 seconds

### Scenario 2: Progress Updates
**Given** a scan of 500 symbols
**When** the scan is running
**Then** I receive progress updates showing completed/total count

### Scenario 3: Empty Results
**Given** a formula with very strict criteria
**When** no symbols match
**Then** I receive empty results with 0 matches (not an error)

### Scenario 4: Engine Failure
**Given** the processing engine encounters an error
**When** the scan is running
**Then** the session status is set to FAILED with error message

## Requirements

### Functional Requirements
- **FR-001**: System MUST scan 500+ symbols in < 30 seconds
- **FR-002**: System MUST provide real-time progress updates
- **FR-003**: System MUST persist session at each status transition
- **FR-004**: System MUST handle engine errors gracefully
- **FR-005**: System MUST support symbol filtering by market, sector, market cap

### Non-Functional Requirements
- **NFR-001**: Performance: 500 symbols with 1-year data in < 30 seconds
- **NFR-002**: Reliability: Resume capability on partial failure
- **NFR-003**: Memory: < 500MB for 500 symbol scan

### Technical Constraints
- **TC-001**: Must integrate with E06 ProcessingEngine
- **TC-002**: Must use async/await for non-blocking execution
- **TC-003**: Must support progress callbacks

## Key Entities

### Entity: RunScanUseCase
- **Description**: Orchestrates scan execution
- **Key Methods**: execute(request, progress_callback)
- **Dependencies**: ProcessingEngine, ISymbolRepository, IScanSessionRepository

### Entity: RunScanRequest
- **Description**: DTO for scan request
- **Key Attributes**: formula, config

### Entity: RunScanResponse
- **Description**: DTO for scan response
- **Key Attributes**: session, success, error

## Dependencies

### Upstream Dependencies
- [ ] E07-F01: Domain Model (ScanSession, ScanConfig, ScanResults)
- [ ] E06: ProcessingEngine for batch processing

### Downstream Impact
- [ ] E07-F04-T03: ScanResultsWidget displays results
- [ ] E07-F05: Export uses scan results

## Gate Checks

### Pre-Implementation Gates
- [ ] E07-F01 complete (domain model)
- [ ] E06 ProcessingEngine available
- [ ] Performance requirements clear (< 30s)

### Quality Gates
- [ ] Unit tests with mocked engine
- [ ] Integration tests with real data
- [ ] Performance test for 500 symbols

## Tasks Preview

### Implementation Tasks
- [ ] T01 Implement RunScanUseCase (depends on F01)
- [ ] T02 Implement symbol resolution with filters (depends on T01)

## Success Criteria

### Acceptance Criteria
- [ ] 500+ symbols scanned in < 30 seconds
- [ ] Real-time progress updates work
- [ ] Error handling covers all failure modes
- [ ] Session persisted at each transition
- [ ] 80% test coverage

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit and integration tests passing
- [ ] Performance validated with 500 symbols
- [ ] Documentation updated

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Performance target missed | Medium | High | Profile and optimize hot paths |
| Engine integration issues | Low | High | Early integration testing |
| Memory overflow with large scans | Low | Medium | Streaming/batching approach |

## Notes and Clarifications

### Decisions Made
- 2025-12-28: Use async/await for non-blocking scan execution
- 2025-12-28: Progress callback reports completed/total counts

### File Structure
```
src/application/
├── use_cases/
│   └── run_scan_use_case.py
├── services/
│   └── signal_aggregator.py
└── dto/
    └── scan_dto.py

src/domain/
└── repositories/
    └── scan_session_repository.py
```

## Artifacts

### Input Documents
- [Product Requirements](../../../docs/prd.md)
- [Parent Spec](../E07.spec.md)
- [Domain Model](../F01/E07-F01.spec.md)

### Output Artifacts
- [ ] `E07-F02.context.md` - Implementation context
- [ ] `E07-F02.pre-docs.md` - Pre-implementation documentation
- [ ] `E07-F02.post-docs.md` - Post-implementation learnings

---
*Template Version: 2.0.0*
