# Spec: E08-F05-T02 - Create EventSelectionWidget

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E08-F05-T02
clickup_task_id: '86ew021by'
title: Create EventSelectionWidget
type: task

# === HIERARCHY ===
parent: E08-F05
children: []
epic: E08
feature: F05
task: T02
domain: discovery

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 3
actual_hours: 0

# === METADATA ===
tags: [ui, pyqt, widget, selection, dropdown]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E08-F05](../E08-F05.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Create a widget that allows users to select scan session results as input events for pattern discovery. The widget displays a dropdown of recent scan sessions and shows the event count for the selected session.

## Execution Flow

```
1. Initialize EventSelectionWidget with IScanSessionRepository
   → Store repository reference
   → Call _setup_ui() and _load_sessions()

2. _setup_ui() creates layout
   → Add "Source:" label
   → Add QComboBox for session selection
   → Add info label for event count
   → Connect currentIndexChanged to _on_source_changed

3. _load_sessions() fetches available sessions (async)
   → Call repo.get_completed_sessions(limit=20)
   → Populate dropdown with "{formula_name} ({date})" format
   → Store session data in combo box items
   → Select first item if available

4. _on_source_changed() handles selection
   → Get session from combo box item data
   → Update info label with event count
   → Emit selection_changed signal

5. get_events() returns match list
   → Return session.results.matches or empty list
```

## User Stories

### Primary User Story
**As a** trader
**I want to** select a scan session as discovery input
**So that** I can discover patterns from my scan results

### Additional Stories
- **As a** trader, **I want to** see event counts, **So that** I know how much data is available
- **As a** developer, **I want to** async loading, **So that** UI stays responsive

## Acceptance Scenarios

### Scenario 1: Empty State
**Given** no completed scan sessions exist
**When** widget loads
**Then** dropdown is empty and info shows "Events: 0 matches available"

### Scenario 2: Sessions Loaded
**Given** 5 completed scan sessions exist
**When** widget loads
**Then** dropdown shows all 5 sessions

### Scenario 3: Selection Change
**Given** sessions are loaded
**When** I select a different session
**Then** selection_changed signal is emitted with the session

### Scenario 4: Event Count Display
**Given** a session with 47 matches is selected
**When** looking at info label
**Then** it shows "Events: 47 matches available"

### Scenario 5: Get Events
**Given** a session is selected
**When** get_events() is called
**Then** list of ScanMatch objects is returned

## Requirements

### Functional Requirements
- **FR-001**: Widget MUST show recent scan sessions in dropdown
- **FR-002**: Widget MUST display session as "{formula_name} ({date})"
- **FR-003**: Widget MUST show event count for selected session
- **FR-004**: Widget MUST emit selection_changed signal on change

### Non-Functional Requirements
- **NFR-001**: Async loading of sessions
- **NFR-002**: Responsive UI during loading

### Technical Constraints
- **TC-001**: Must use PyQt6/PySide6 QComboBox
- **TC-002**: Must integrate with IScanSessionRepository

## Key Entities

### Widget: EventSelectionWidget
- **Description**: Dropdown for selecting scan sessions
- **Signals**: selection_changed(ScanSession)
- **Methods**: get_selected_session(), get_events(), refresh()

## Dependencies

### Upstream Dependencies
- [x] E08-F05-T01: DiscoveryView (parent integration)
- [x] E07: ScanSession, ScanMatch, IScanSessionRepository

### Downstream Impact
- None (leaf widget)

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Layout design specified
- [x] Signal defined

### Quality Gates
- [ ] Widget implemented
- [ ] Async loading works
- [ ] Unit tests written

## Success Criteria

### Acceptance Criteria
- [ ] `EventSelectionWidget` class implemented
- [ ] Dropdown shows recent scan sessions
- [ ] Session display format: "{formula_name} ({date})"
- [ ] Event count displayed
- [ ] `selection_changed` signal emitted
- [ ] `get_events()` returns match list
- [ ] Handles empty sessions gracefully

### Definition of Done
- [ ] Async loading of sessions
- [ ] Unit tests for widget
- [ ] Integration with DiscoveryView

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Async UI issues | Low | Low | Use proper async patterns |
| Empty state handling | Low | Low | Test empty scenarios |

## Artifacts

### Input Documents
- [E08-F05-T01 DiscoveryView](../T01/E08-F05-T01.spec.md)
- E07: Market Scanner (ScanSession, ScanMatch)

### Output Artifacts
- [ ] `src/presentation/views/discovery/event_selection_widget.py`

---
*Template Version: 2.0.0*
