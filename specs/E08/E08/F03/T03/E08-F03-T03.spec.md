# Spec: E08-F03-T03 - Implement Formula Generation

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E08-F03-T03
clickup_task_id: '86ew0219r'
title: Implement Formula Generation
type: task

# === HIERARCHY ===
parent: E08-F03
children: []
epic: E08
feature: F03
task: T03
domain: discovery

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 3
actual_hours: 0

# === METADATA ===
tags: [pattern-mining, formula, dsl, statistics]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E08-F03](../E08-F03.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement formula generation that converts discovered conditions into DSL expressions, statistics calculation for discovered rules, and event filtering to find matching events. This completes the pattern mining pipeline.

## Execution Flow

```
1. _build_formula() converts conditions to DSL string
   → For each condition: format as "indicator operator threshold"
   → Join with " AND "
   → Return: formula string (e.g., "rsi(14) < 25 AND volume > 15000000")

2. _filter_matching_events() finds events matching conditions
   → For each event: check if all conditions are satisfied
   → Return: list of matching events

3. _calculate_statistics() computes metrics for matching events
   → Count success, failure, neutral
   → Calculate hit_rate = success / (success + failure)
   → Calculate avg_return, avg_success_return, avg_failure_return
   → Calculate profit_factor = total_gains / total_losses
   → Calculate max_consecutive_failures
   → Return: RuleStatistics

4. _max_consecutive_failures() helper
   → Sort events by timestamp
   → Track consecutive failure count
   → Return: maximum consecutive failures
```

## User Stories

### Primary User Story
**As a** pattern discovery system
**I want to** generate DSL formulas and statistics
**So that** discovered rules are complete and usable

### Additional Stories
- **As a** developer, **I want to** valid DSL syntax, **So that** formulas work with the DSL parser
- **As a** trader, **I want to** accurate statistics, **So that** I can evaluate rule quality

## Acceptance Scenarios

### Scenario 1: Single Condition Formula
**Given** one condition [rsi(14) < 30]
**When** building formula
**Then** result is "rsi(14) < 30"

### Scenario 2: Multiple Conditions Formula
**Given** conditions [rsi(14) < 30, volume > 1000000]
**When** building formula
**Then** result is "rsi(14) < 30 AND volume > 1000000"

### Scenario 3: Float Threshold Formatting
**Given** threshold = 2.5
**When** formatting threshold
**Then** result is "2.5" not "2.50000001"

### Scenario 4: Statistics Calculation
**Given** 7 matching events: 5 success, 1 failure, 1 neutral
**When** calculating statistics
**Then** hit_rate = 5/6 = 0.833

### Scenario 5: Profit Factor Infinite
**Given** only successful trades (no losses)
**When** calculating profit_factor
**Then** result is infinity (float('inf'))

### Scenario 6: Event Filtering
**Given** events with various indicator values
**When** filtering for rsi < 30 AND volume > 1000000
**Then** only events satisfying both conditions are returned

## Requirements

### Functional Requirements
- **FR-001**: System MUST generate valid DSL formula syntax
- **FR-002**: System MUST join multiple conditions with AND
- **FR-003**: System MUST calculate all statistics correctly
- **FR-004**: System MUST handle edge cases (no losses, no events)
- **FR-005**: System MUST filter events matching all conditions

### Non-Functional Requirements
- **NFR-001**: Formula must be human-readable
- **NFR-002**: Statistics calculation must be accurate

### Technical Constraints
- **TC-001**: Must be compatible with E05 DSL parser
- **TC-002**: Must handle float formatting cleanly
- **TC-003**: Must handle division by zero (profit_factor)

## Key Entities

### Method: _build_formula()
- **Description**: Convert conditions to DSL formula string
- **Parameters**: conditions: list[IndicatorCondition]
- **Returns**: str

### Method: _filter_matching_events()
- **Description**: Filter events matching all conditions
- **Parameters**: events, conditions
- **Returns**: list[LabeledEvent]

### Method: _calculate_statistics()
- **Description**: Compute metrics for matching events
- **Parameters**: matching_events
- **Returns**: RuleStatistics

## Dependencies

### Upstream Dependencies
- [x] E08-F03-T01: PatternMiner core structure
- [x] E08-F03-T02: Condition finding
- [x] E08-F01: RuleStatistics dataclass

### Downstream Impact
- [ ] E08-F04: Uses complete pattern mining output

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Formula syntax defined
- [x] Statistics formulas specified

### Quality Gates
- [ ] Formula generation implemented
- [ ] Statistics calculation implemented
- [ ] Test coverage > 85%

## Success Criteria

### Acceptance Criteria
- [ ] `_build_formula()` generates valid DSL expressions
- [ ] Multiple conditions joined with AND
- [ ] `_calculate_statistics()` computes all metrics
- [ ] Hit rate calculated correctly
- [ ] Profit factor handles edge cases (no losses)
- [ ] Max consecutive failures tracked
- [ ] `_filter_matching_events()` applies all conditions

### Definition of Done
- [ ] Unit tests for formula generation
- [ ] Unit tests for statistics calculation
- [ ] Test coverage > 85%

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| DSL compatibility | Low | High | Test with E05 parser |
| Division by zero | Low | Low | Handle explicitly |

## Artifacts

### Input Documents
- [E08-F03-T02 Condition Finding](../T02/E08-F03-T02.spec.md)
- E05: DSL Parser (formula syntax reference)

### Output Artifacts
- [ ] `src/domain/discovery/mining/pattern_miner.py` (add formula and stats methods)
- [ ] `src/domain/discovery/mining/formula_builder.py` (optional extraction)
- [ ] `src/domain/discovery/mining/statistics.py` (optional extraction)

---
*Template Version: 2.0.0*
