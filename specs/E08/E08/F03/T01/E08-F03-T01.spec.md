# Spec: E08-F03-T01 - Implement PatternMiner Core

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E08-F03-T01
clickup_task_id: '86ew0218g'
title: Implement PatternMiner Core
type: task

# === HIERARCHY ===
parent: E08-F03
children: []
epic: E08
feature: F03
task: T01
domain: discovery

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [pattern-mining, algorithm, service]
effort: large
risk: medium
---

**Status**: Draft
**Type**: Task
**Parent**: [E08-F03](../E08-F03.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement the core PatternMiner class that discovers indicator patterns predicting successful outcomes from labeled events. The miner separates success/failure groups, finds discriminating conditions, generates rule combinations, validates rules, and returns the top 10 by profit factor.

## Execution Flow

```
1. Initialize PatternMiner
   → Set minimum separation score = 0.3

2. discover_patterns() receives labeled events and config
   → Separate events into SUCCESS and FAILURE groups
   → If success_count < min_samples: Return empty list

3. Find discriminating conditions (delegated to T02)
   → If no conditions found: Return empty list

4. Generate condition combinations
   → Create combinations of 1-3 conditions using itertools.combinations
   → For each combination: call _build_and_validate_rule()

5. Validate and build rules
   → Build formula from conditions
   → Filter matching events
   → If matching < min_samples: Skip rule
   → Calculate statistics
   → If hit_rate < 55% OR profit_factor < 1.0: Discard rule

6. Return top 10 rules
   → Sort by profit_factor descending
   → Return: rules[:10]
```

## User Stories

### Primary User Story
**As a** pattern discovery system
**I want to** find indicator conditions that predict success
**So that** traders can build data-driven strategies

### Additional Stories
- **As a** developer, **I want to** combine multiple conditions, **So that** complex patterns can be discovered
- **As a** trader, **I want to** quality thresholds enforced, **So that** only reliable rules are returned

## Acceptance Scenarios

### Scenario 1: Insufficient Samples
**Given** only 20 success events with min_samples=30
**When** pattern mining runs
**Then** empty list is returned

### Scenario 2: No Discriminating Conditions
**Given** events with no indicators that separate success from failure
**When** pattern mining runs
**Then** empty list is returned

### Scenario 3: Single Condition Rule
**Given** events where RSI < 30 correlates with success
**When** pattern mining runs
**Then** rule "rsi(14) < 30" is discovered

### Scenario 4: Multi-Condition Rule
**Given** events where RSI < 30 AND volume > average correlates with success
**When** pattern mining runs
**Then** rule with both conditions is discovered

### Scenario 5: Top 10 Limit
**Given** 20 valid rules discovered
**When** pattern mining completes
**Then** only top 10 by profit factor are returned

## Requirements

### Functional Requirements
- **FR-001**: System MUST separate events into success/failure groups
- **FR-002**: System MUST generate combinations of 1-3 conditions
- **FR-003**: System MUST require hit_rate >= 55% for valid rules
- **FR-004**: System MUST require profit_factor >= 1.0 for valid rules
- **FR-005**: System MUST return top 10 rules sorted by profit_factor

### Non-Functional Requirements
- **NFR-001**: Performance: Mine patterns from 1000 events in <5 seconds
- **NFR-002**: Memory: Handle large condition sets efficiently

### Technical Constraints
- **TC-001**: Must generate valid DSL formula syntax
- **TC-002**: Must limit to 10 output rules
- **TC-003**: Must use itertools for combinations

## Key Entities

### Class: PatternMiner
- **Description**: Service that discovers patterns from labeled events
- **Methods**: discover_patterns(), _generate_condition_combinations(), _build_and_validate_rule(), _is_valid_rule()
- **Dependencies**: None (pure logic)

### Dataclass: IndicatorCondition
- **Description**: A single indicator condition
- **Attributes**: indicator, operator, threshold, score

## Dependencies

### Upstream Dependencies
- [x] E08-F01: LabeledEvent, DiscoveredRule, RuleStatistics
- [x] E08-F02: Produces LabeledEvent[] input

### Downstream Impact
- [ ] E08-F03-T02: Provides _find_discriminating_conditions()
- [ ] E08-F03-T03: Provides _build_formula(), _calculate_statistics()
- [ ] E08-F04: Uses PatternMiner in use case

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Mining algorithm defined
- [x] Quality thresholds specified

### Quality Gates
- [ ] PatternMiner class implemented
- [ ] Unit tests with synthetic data
- [ ] Test coverage > 80%

## Success Criteria

### Acceptance Criteria
- [ ] `PatternMiner` class implemented
- [ ] `discover_patterns()` returns top 10 rules
- [ ] Rules sorted by profit factor descending
- [ ] Minimum sample requirement enforced
- [ ] Hit rate >= 55% for valid rules
- [ ] Profit factor >= 1.0 for valid rules
- [ ] Condition combinations of 1-3 indicators

### Definition of Done
- [ ] Unit tests with synthetic labeled data
- [ ] Test coverage > 80%
- [ ] Performance validated

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Overfitting | Medium | High | Require min samples, validate hit rate |
| No patterns found | Medium | Low | Return helpful message |
| Slow with many indicators | Low | Medium | Limit to top 10 indicators |

## Artifacts

### Input Documents
- [E08-F03 Pattern Mining](../E08-F03.spec.md)
- PRD Section 5.3.1: Discovery Workflow (Step 3)

### Output Artifacts
- [ ] `src/domain/discovery/mining/pattern_miner.py`
- [ ] `src/domain/discovery/mining/indicator_condition.py`
- [ ] `src/domain/discovery/mining/__init__.py`

---
*Template Version: 2.0.0*
