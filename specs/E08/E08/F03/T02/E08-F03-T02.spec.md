# Spec: E08-F03-T02 - Implement Condition Finding Algorithm

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E08-F03-T02
clickup_task_id: '86ew02193'
title: Implement Condition Finding Algorithm
type: task

# === HIERARCHY ===
parent: E08-F03
children: []
epic: E08
feature: F03
task: T02
domain: discovery

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [pattern-mining, algorithm, statistics, threshold-finding]
effort: large
risk: medium
---

**Status**: Draft
**Type**: Task
**Parent**: [E08-F03](../E08-F03.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement the condition finding algorithm that identifies indicator thresholds discriminating between successful and failed outcomes. For each indicator, the algorithm finds the best threshold and operator (< or >) that separates success from failure events.

## Execution Flow

```
1. _find_discriminating_conditions() receives success and failure events
   → Collect all indicator names from events
   → For each indicator: call _find_best_threshold()
   → Filter conditions with score > 0.3
   → Sort by separation score descending
   → Return: top 10 conditions

2. _find_best_threshold() for one indicator
   → Extract values for success and failure groups
   → Get unique values as candidate thresholds
   → For each threshold value:
     → Test "indicator < threshold" → calculate separation score
     → Test "indicator > threshold" → calculate separation score
     → Track best score and condition
   → If best_score > min_separation_score: Return condition
   → Else: Return None

3. _separation_score() calculation
   → success_rate = success_match / success_total
   → failure_rate = failure_match / failure_total
   → Return: success_rate - failure_rate
```

## User Stories

### Primary User Story
**As a** pattern discovery system
**I want to** find indicator thresholds that separate success from failure
**So that** these can be combined into predictive rules

### Additional Stories
- **As a** developer, **I want to** both operators tested, **So that** the best condition is found
- **As a** developer, **I want to** minimum separation score, **So that** weak conditions are filtered

## Acceptance Scenarios

### Scenario 1: Perfect Separation
**Given** success events all have RSI < 30, failure events all have RSI >= 30
**When** finding conditions
**Then** "RSI < 30" condition with score = 1.0 is found

### Scenario 2: Partial Separation
**Given** 70% success match, 30% failure match for RSI < 35
**When** calculating separation score
**Then** score = 0.7 - 0.3 = 0.4

### Scenario 3: No Separation
**Given** 50% match in both success and failure groups
**When** finding conditions
**Then** no condition returned (score = 0)

### Scenario 4: Both Operators Tested
**Given** indicator values
**When** finding best threshold
**Then** both < and > operators are tested

### Scenario 5: Missing Indicator Values
**Given** some events lack an indicator value
**When** extracting values
**Then** default to 0 or skip gracefully

## Requirements

### Functional Requirements
- **FR-001**: System MUST test both < and > operators for each indicator
- **FR-002**: System MUST calculate separation score correctly
- **FR-003**: System MUST filter conditions with score < 0.3
- **FR-004**: System MUST return top 10 conditions by score
- **FR-005**: System MUST handle missing indicator values

### Non-Functional Requirements
- **NFR-001**: Performance: Process 50+ indicators efficiently
- **NFR-002**: Accuracy: Separation score calculation must be exact

### Technical Constraints
- **TC-001**: Must store score in IndicatorCondition for ranking
- **TC-002**: Must handle edge cases (empty values, single value)

## Key Entities

### Method: _find_discriminating_conditions()
- **Description**: Find conditions that separate success from failure
- **Parameters**: success_events, failure_events
- **Returns**: list[IndicatorCondition]

### Method: _find_best_threshold()
- **Description**: Find best threshold for one indicator
- **Parameters**: indicator, success_values, failure_values
- **Returns**: Optional[IndicatorCondition]

### Method: _separation_score()
- **Description**: Calculate how well a condition separates groups
- **Parameters**: success_match, success_total, failure_match, failure_total
- **Returns**: float (-1 to 1)

## Dependencies

### Upstream Dependencies
- [x] E08-F03-T01: PatternMiner core structure
- [x] E08-F01: LabeledEvent with indicator_values

### Downstream Impact
- [ ] E08-F03-T03: Uses discovered conditions for formula building

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Algorithm defined
- [x] Separation score formula specified

### Quality Gates
- [ ] Condition finding implemented
- [ ] All separation scenarios tested
- [ ] Test coverage > 85%

## Success Criteria

### Acceptance Criteria
- [ ] `_find_discriminating_conditions()` implemented
- [ ] `_find_best_threshold()` tests both < and > operators
- [ ] `_separation_score()` calculates correct discrimination
- [ ] Minimum separation score threshold (0.3) enforced
- [ ] Top 10 indicators by separation score returned
- [ ] Handles missing indicator values (default to 0)

### Definition of Done
- [ ] Unit tests with controlled indicator data
- [ ] Test coverage > 85%
- [ ] Edge cases handled

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Numerical precision | Low | Low | Use exact float comparisons |
| Many indicators slow | Low | Medium | Limit to top 10 conditions |

## Artifacts

### Input Documents
- [E08-F03-T01 PatternMiner Core](../T01/E08-F03-T01.spec.md)
- Decision Tree: Gini impurity concepts

### Output Artifacts
- [ ] `src/domain/discovery/mining/pattern_miner.py` (add condition finding methods)
- [ ] `src/domain/discovery/mining/condition_finder.py` (optional extraction)

---
*Template Version: 2.0.0*
