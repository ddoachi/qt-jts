# Spec: E08 - Pattern Discovery

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E08
clickup_task_id: ''
title: Pattern Discovery
type: epic

# === HIERARCHY ===
parent: prd
children: [E08-F01, E08-F02, E08-F03, E08-F04, E08-F05]
epic: E08
feature: ''
task: ''
domain: discovery

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 28
actual_hours: 0

# === METADATA ===
tags: [pattern-discovery, machine-learning, trading]
effort: epic
risk: medium
---

**Status**: Draft
**Type**: Epic
**Parent**: PRD
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Pattern Discovery enables traders to automatically discover profitable entry/exit/stop-loss patterns from historical scan events. The system analyzes what happened after each event (forward returns), labels outcomes as SUCCESS/FAILURE/NEUTRAL, and uses statistical analysis to find indicator conditions that predict good outcomes. The output is a ranked list of formula rules with hit rates, profit factors, and sample matches for human validation.

## Execution Flow

```
1. User selects scan results as input events
   → If no scan sessions available: ERROR "No scan results found"
   → If session has no matches: WARN "Selected scan has 0 matches"

2. User configures discovery parameters
   → Set discovery type (Entry/Exit/Stop-Loss)
   → Set lookahead period (default: 5 days)
   → Set success threshold (default: +3%)
   → Set failure threshold (default: -2%)
   → Set minimum samples (default: 30)

3. System labels each event with outcome
   → Fetch forward candles for lookahead period
   → If high reaches success_threshold: SUCCESS
   → If low reaches failure_threshold: FAILURE
   → Else: NEUTRAL with final return
   → If forward data unavailable: Skip event

4. System mines patterns from labeled events
   → Separate SUCCESS and FAILURE groups
   → Find indicator thresholds that discriminate groups
   → Generate formula combinations (1-3 conditions)
   → Calculate statistics for each rule
   → Filter by hit_rate >= 55% and profit_factor >= 1.0

5. System presents discovered rules
   → Rank by profit factor
   → Show top 10 rules with statistics
   → Include sample matches for validation
   → Return: SUCCESS with DiscoveredRule[]
```

## User Stories

### Primary User Story
**As a** trader
**I want to** automatically discover patterns that predict profitable trades
**So that** I can build systematic trading strategies based on data, not intuition

### Additional Stories
- **As a** trader, **I want to** see sample matches for each discovered rule, **So that** I can validate the pattern makes sense
- **As a** trader, **I want to** configure success/failure thresholds, **So that** I can adjust for my risk tolerance
- **As a** trader, **I want to** add discovered rules to my strategy library, **So that** I can use them in backtesting

## Acceptance Scenarios

### Scenario 1: Happy Path - Discover Entry Patterns
**Given** a scan session with 100 volume surge events from the past year
**When** I run pattern discovery with Entry type, +3% success, -2% failure
**Then** the system labels events and returns up to 10 entry rules sorted by profit factor

### Scenario 2: Insufficient Data
**Given** a scan session with only 15 events
**When** I run pattern discovery with min_samples=30
**Then** the system shows error "Insufficient data: 15 events, need 30"

### Scenario 3: No Patterns Found
**Given** events where success and failure have similar indicator distributions
**When** pattern mining finds no discriminating conditions
**Then** the system shows "No profitable patterns found" with suggestions

## Requirements

### Functional Requirements
- **FR-001**: System MUST label events based on forward price action within lookahead period
- **FR-002**: System MUST support three discovery types: Entry, Exit, Stop-Loss
- **FR-003**: System MUST find indicator thresholds that separate success from failure
- **FR-004**: System MUST generate DSL formula expressions for discovered patterns
- **FR-005**: System MUST calculate hit rate, profit factor, and other statistics
- **FR-006**: System MUST persist discovered rules to repository

### Non-Functional Requirements
- **NFR-001**: Performance: Label 1000 events in <10 seconds
- **NFR-002**: Quality: Only output rules with hit_rate >= 55%
- **NFR-003**: Reliability: Handle missing forward data gracefully

### Technical Constraints
- **TC-001**: Must integrate with E07 Scanner (ScanMatch, ScanSession)
- **TC-002**: Must use E05 DSL for formula syntax
- **TC-003**: Must access historical candle data from E04 repository

## Key Entities

### Entity: DiscoveryConfig
- **Description**: Configuration for pattern discovery process
- **Key Attributes**: discovery_type, lookahead_period, success_threshold, failure_threshold, min_samples
- **Relationships**: Used by OutcomeLabeler and PatternMiner

### Entity: LabeledEvent
- **Description**: A scan match event with forward-looking outcome label
- **Key Attributes**: symbol, timestamp, candle, indicator_values, outcome, forward_return, exit_reason
- **Relationships**: Created from ScanMatch, input to PatternMiner

### Entity: DiscoveredRule
- **Description**: A pattern discovered from labeled events
- **Key Attributes**: id, formula, discovery_type, statistics, sample_matches
- **Relationships**: Contains RuleStatistics, persisted to repository

### Entity: RuleStatistics
- **Description**: Performance metrics for a discovered rule
- **Key Attributes**: hit_rate, profit_factor, avg_return, max_consecutive_failures
- **Relationships**: Belongs to DiscoveredRule

## Dependencies

### Upstream Dependencies
- [x] E07: Market Scanner - Provides ScanMatch and ScanSession entities
- [x] E05: DSL Parser - Formula syntax for discovered rules
- [x] E04: Data Collection - Historical candle data for outcome labeling
- [x] E01: Base UI - PyQt widget framework

### Downstream Impact
- [ ] E09: Strategy Builder - Will consume discovered rules
- [ ] E10: Backtesting - Will test discovered patterns

## Features

| Feature ID | Title | Complexity | Tasks | Wave |
|------------|-------|------------|-------|------|
| [E08-F01](F01/E08-F01.spec.md) | Discovery Domain Model | Medium | 2 | 1 |
| [E08-F02](F02/E08-F02.spec.md) | Outcome Labeling | Large | 2 | 2 |
| [E08-F03](F03/E08-F03.spec.md) | Pattern Mining | Large | 3 | 3 |
| [E08-F04](F04/E08-F04.spec.md) | Discovery Use Cases | Medium | 1 | 4 |
| [E08-F05](F05/E08-F05.spec.md) | Discovery UI | Large | 5 | 3-5 |

**Total: 5 Features, 13 Tasks**

## Wave Analysis for Parallel Execution

### Dependency Graph

```
                    ┌─────────────────────────────────────────────────────────┐
                    │                      E07 (Scanner)                       │
                    └────────────────────────────┬────────────────────────────┘
                                                 │
Wave 1 ──────────────────────────────────────────┼────────────────────────────
                    ┌────────────────────────────┴────────────────────────────┐
                    │                                                          │
            ┌───────▼───────┐                                          ┌───────▼───────┐
            │ E08-F01-T01   │                                          │ E08-F05-T01   │
            │ Domain: Config│                                          │ UI: MainView  │
            └───────┬───────┘                                          └───────┬───────┘
                    │                                                          │
            ┌───────▼───────┐                                                  │
            │ E08-F01-T02   │                                                  │
            │ Domain: Rule  │                                                  │
            └───────┬───────┘                                                  │
                    │                                                          │
Wave 2 ─────────────┼──────────────────────────────────────────────────────────┤
                    │                                                          │
            ┌───────▼───────┐                                                  │
            │ E08-F02-T01   │                                                  │
            │ Labeler Core  │                                                  │
            └───────┬───────┘                                                  │
                    │                                                          │
            ┌───────▼───────┐                                                  │
            │ E08-F02-T02   │                                                  │
            │ Forward Calc  │                                                  │
            └───────┬───────┘                                                  │
                    │                                                          │
Wave 3 ─────────────┼──────────────────────────────────────────────────────────┤
                    │                              ┌───────────────────────────┤
            ┌───────▼───────┐              ┌───────▼───────┐           ┌───────▼───────┐
            │ E08-F03-T01   │              │ E08-F05-T02   │           │ E08-F05-T03   │
            │ Miner Core    │              │ EventSelect   │           │ OutcomeConfig │
            └───────┬───────┘              └───────────────┘           └───────────────┘
                    │
            ┌───────▼───────┐
            │ E08-F03-T02   │
            │ Condition Find│
            └───────┬───────┘
                    │
            ┌───────▼───────┐
            │ E08-F03-T03   │
            │ Formula Gen   │
            └───────┬───────┘
                    │
Wave 4 ─────────────┼──────────────────────────────────────────────────────────
                    │                                                          │
            ┌───────▼───────┐                                          ┌───────▼───────┐
            │ E08-F04-T01   │                                          │ E08-F05-T04   │
            │ UseCase       │                                          │ ResultsWidget │
            └───────────────┘                                          └───────┬───────┘
                                                                               │
Wave 5 ────────────────────────────────────────────────────────────────────────┤
                                                                               │
                                                                       ┌───────▼───────┐
                                                                       │ E08-F05-T05   │
                                                                       │ ReviewWidget  │
                                                                       └───────────────┘
```

### Wave Summary

| Wave | Tasks | Can Parallelize | Estimated Effort |
|------|-------|-----------------|------------------|
| **Wave 1** | F01-T01, F01-T02, F05-T01 | F01-T01 ∥ F05-T01 | 4-5 hours |
| **Wave 2** | F02-T01, F02-T02 | Sequential | 5-7 hours |
| **Wave 3** | F03-T01→T02→T03, F05-T02, F05-T03 | F03 ∥ (F05-T02, F05-T03) | 8-10 hours |
| **Wave 4** | F04-T01, F05-T04 | F04-T01 ∥ F05-T04 | 5-7 hours |
| **Wave 5** | F05-T05 | Single | 2-3 hours |

## Tasks Breakdown

| Task ID | Title | Effort | Wave | Dependencies |
|---------|-------|--------|------|--------------|
| [E08-F01-T01](F01/T01/E08-F01-T01.spec.md) | Define DiscoveryConfig and LabeledEvent | M | 1 | E07 |
| [E08-F01-T02](F01/T02/E08-F01-T02.spec.md) | Define DiscoveredRule and RuleStatistics | M | 1 | T01 |
| [E08-F02-T01](F02/T01/E08-F02-T01.spec.md) | Implement OutcomeLabeler core | L | 2 | F01 |
| [E08-F02-T02](F02/T02/E08-F02-T02.spec.md) | Implement forward return calculation | M | 2 | F02-T01 |
| [E08-F03-T01](F03/T01/E08-F03-T01.spec.md) | Implement PatternMiner core | L | 3 | F02 |
| [E08-F03-T02](F03/T02/E08-F03-T02.spec.md) | Implement condition finding algorithm | L | 3 | F03-T01 |
| [E08-F03-T03](F03/T03/E08-F03-T03.spec.md) | Implement formula generation | M | 3 | F03-T02 |
| [E08-F04-T01](F04/T01/E08-F04-T01.spec.md) | Implement RunDiscoveryUseCase | M | 4 | F02, F03 |
| [E08-F05-T01](F05/T01/E08-F05-T01.spec.md) | Create DiscoveryView | M | 1 | E01 |
| [E08-F05-T02](F05/T02/E08-F05-T02.spec.md) | Create EventSelectionWidget | M | 3 | F05-T01 |
| [E08-F05-T03](F05/T03/E08-F05-T03.spec.md) | Create OutcomeConfigWidget | M | 3 | F05-T01 |
| [E08-F05-T04](F05/T04/E08-F05-T04.spec.md) | Create DiscoveryResultsWidget | L | 4 | F05-T01, F01 |
| [E08-F05-T05](F05/T05/E08-F05-T05.spec.md) | Create RuleReviewWidget | M | 5 | F05-T04 |

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Performance requirements specified
- [x] Security requirements defined (N/A for this epic)
- [x] Scale requirements clear
- [x] PRD compliance verified (Section 5.3)

### Quality Gates
- [ ] All features have specs
- [ ] All tasks have specs
- [ ] Dependencies identified
- [ ] Risk assessment complete

## Success Criteria

### Acceptance Criteria (PRD 8.3)
- [ ] 스캔 결과에서 패턴 자동 발견
- [ ] 발견된 규칙의 과거 성과 표시
- [ ] 진입/청산/손절 규칙 각각 발견 가능
- [ ] Discovered rules have > 55% hit rate
- [ ] Sample matches displayed for validation
- [ ] Clear statistics for each rule

### Definition of Done
- [ ] All 5 features implemented
- [ ] All 13 tasks completed
- [ ] Unit tests for OutcomeLabeler
- [ ] Unit tests for PatternMiner
- [ ] Integration test with real scan data
- [ ] Test coverage > 80%
- [ ] Documentation complete

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Insufficient discriminating patterns | Medium | Medium | Lower min separation threshold, suggest broader scans |
| Forward data gaps | Low | Medium | Skip events without data, show warning count |
| Overfitting to historical data | Medium | High | Require minimum samples, walk-forward validation |
| Performance with large datasets | Low | Medium | Batch processing, progress indicators |

## Notes and Clarifications

### Open Questions
- None remaining

### Decisions Made
- 2025-12-28: Use optimistic labeling (check success before failure on same candle)
- 2025-12-28: Limit to top 10 rules to avoid overwhelming user
- 2025-12-28: Require 55% hit rate minimum for valid rules

### Research Needed
- [ ] Evaluate more sophisticated pattern mining algorithms (future enhancement)
- [ ] Consider machine learning approaches (future enhancement)

## Artifacts

### Input Documents
- [Product Requirements](../../docs/prd.md) - Section 5.3
- [E07 Scanner Spec](../E07/E07.spec.md) - Event source

### Output Artifacts (to be generated)
- [ ] `E08.context.md` - Implementation context and progress
- [ ] `E08.pre-docs.md` - Pre-implementation documentation
- [ ] `E08.post-docs.md` - Post-implementation learnings
- [ ] `E08-implementation-narrative.md` - Comprehensive implementation story

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
