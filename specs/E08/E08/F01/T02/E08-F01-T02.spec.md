# Spec: E08-F01-T02 - Define DiscoveredRule and RuleStatistics

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E08-F01-T02
clickup_task_id: '86ew0215t'
title: Define DiscoveredRule and RuleStatistics
type: task

# === HIERARCHY ===
parent: E08-F01
children: []
epic: E08
feature: F01
task: T02
domain: discovery

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 2
actual_hours: 0

# === METADATA ===
tags: [domain-model, entities, statistics, repository]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E08-F01](../E08-F01.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Define entities for discovered patterns and their performance metrics: `RuleStatistics` dataclass with computed properties, `DiscoveredRule` dataclass representing discovered patterns, and `IDiscoveredRuleRepository` interface for persistence.

## Execution Flow

```
1. Create RuleStatistics dataclass
   → Add all metric fields
   → Implement __post_init__ validation
   → If hit_rate not 0-1: ERROR "Invalid hit_rate"
   → Add is_profitable property
   → Add total_labeled property

2. Create DiscoveredRule dataclass
   → Add id, formula, discovery_type, statistics, sample_matches, created_at
   → Limit sample_matches to 10 in __post_init__
   → If formula empty: ERROR "formula cannot be empty"

3. Create IDiscoveredRuleRepository interface
   → Define save(), get_by_id(), get_by_type(), get_top_by_profit_factor(), delete()
   → Return: SUCCESS with all entities defined
```

## User Stories

### Primary User Story
**As a** developer
**I want to** have well-defined rule and statistics entities
**So that** I can store and analyze discovered patterns

### Additional Stories
- **As a** developer, **I want to** computed properties, **So that** I can easily check profitability
- **As a** developer, **I want to** a repository interface, **So that** I can persist rules

## Acceptance Scenarios

### Scenario 1: Create Valid RuleStatistics
**Given** valid metrics (hit_rate=0.65, profit_factor=1.8)
**When** I create RuleStatistics
**Then** the dataclass is created with computed properties working

### Scenario 2: Invalid Hit Rate
**Given** hit_rate = 1.5 (above 1)
**When** I create RuleStatistics
**Then** ValueError is raised with message

### Scenario 3: is_profitable Property
**Given** RuleStatistics with profit_factor = 2.0
**When** I check is_profitable
**Then** it returns True

### Scenario 4: Sample Matches Limit
**Given** DiscoveredRule with 15 sample matches
**When** the rule is created
**Then** sample_matches is limited to 10

### Scenario 5: Empty Formula Rejected
**Given** empty formula string
**When** I create DiscoveredRule
**Then** ValueError is raised

## Requirements

### Functional Requirements
- **FR-001**: `RuleStatistics` MUST validate hit_rate is between 0 and 1
- **FR-002**: `RuleStatistics.is_profitable` MUST return profit_factor > 1.0
- **FR-003**: `DiscoveredRule` MUST limit sample_matches to 10 items
- **FR-004**: `DiscoveredRule` MUST reject empty formulas
- **FR-005**: `IDiscoveredRuleRepository` MUST define CRUD operations

### Non-Functional Requirements
- **NFR-001**: All types MUST pass mypy strict mode
- **NFR-002**: Test coverage MUST be > 90%

### Technical Constraints
- **TC-001**: Must use Python dataclasses
- **TC-002**: Repository must be async (async/await)
- **TC-003**: Must be JSON serializable

## Key Entities

### Entity: RuleStatistics
- **Description**: Performance metrics for a discovered rule
- **Attributes**: total_events, success_count, failure_count, neutral_count, hit_rate, avg_return, avg_success_return, avg_failure_return, profit_factor, max_consecutive_failures
- **Properties**: is_profitable, total_labeled

### Entity: DiscoveredRule
- **Description**: A pattern discovered from data
- **Attributes**: id, formula, discovery_type, statistics, sample_matches, created_at

### Interface: IDiscoveredRuleRepository
- **Description**: Repository interface for discovered rules
- **Methods**: save(), get_by_id(), get_by_type(), get_top_by_profit_factor(), delete()

## Dependencies

### Upstream Dependencies
- [x] E08-F01-T01: DiscoveryType, LabeledEvent

### Downstream Impact
- [ ] E08-F03: Uses DiscoveredRule, RuleStatistics
- [ ] E08-F04: Uses IDiscoveredRuleRepository

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] All entity attributes defined
- [x] Repository methods specified

### Quality Gates
- [ ] All entities implemented
- [ ] Unit tests written
- [ ] mypy passes

## Success Criteria

### Acceptance Criteria
- [ ] `RuleStatistics` dataclass with all metrics
- [ ] `RuleStatistics.is_profitable` property works correctly
- [ ] `DiscoveredRule` dataclass with all fields
- [ ] `DiscoveredRule` limits sample_matches to 10
- [ ] `IDiscoveredRuleRepository` interface defined

### Definition of Done
- [ ] All types are JSON serializable
- [ ] Type hints pass mypy strict mode
- [ ] Unit tests for validation and properties
- [ ] Test coverage > 90%

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Type incompatibility | Low | Medium | Use strict typing, test serialization |
| Property calculation errors | Low | Low | Comprehensive test cases |

## Artifacts

### Input Documents
- [E08-F01-T01 Config and Events](../T01/E08-F01-T01.spec.md)
- PRD Section 5.3.4: Discovered Rules Output

### Output Artifacts
- [ ] `src/domain/discovery/entities.py` (add DiscoveredRule)
- [ ] `src/domain/discovery/value_objects.py` (add RuleStatistics)
- [ ] `src/domain/discovery/repositories.py`

---
*Template Version: 2.0.0*
