# Spec: E08-F01 - Discovery Domain Model

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E08-F01
clickup_task_id: ''
title: Discovery Domain Model
type: feature

# === HIERARCHY ===
parent: E08
children: [E08-F01-T01, E08-F01-T02]
epic: E08
feature: F01
task: ''
domain: discovery

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [domain-model, entities, value-objects]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Feature
**Parent**: [E08](../E08.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Define the core domain entities for pattern discovery including configuration objects, labeled events, discovered rules, and statistics. These entities form the foundation for the outcome labeling and pattern mining features.

## Execution Flow

```
1. Define DiscoveryType enum (ENTRY, EXIT, STOP_LOSS)
   → Ensure string values for JSON serialization

2. Define DiscoveryConfig dataclass
   → Add validation in __post_init__
   → If lookahead_period < 1: ERROR "Invalid lookahead"
   → If success_threshold <= 0: ERROR "Invalid threshold"

3. Define OutcomeLabel enum (SUCCESS, FAILURE, NEUTRAL)

4. Define LabeledEvent dataclass
   → Include all required fields
   → Make immutable (frozen=True)

5. Define RuleStatistics dataclass
   → Add computed properties (is_profitable, total_labeled)
   → Validate hit_rate is 0-1

6. Define DiscoveredRule dataclass
   → Limit sample_matches to 10

7. Define IDiscoveredRuleRepository interface
   → Return: SUCCESS with all entities defined
```

## User Stories

### Primary User Story
**As a** developer
**I want to** have well-defined domain entities
**So that** I can implement outcome labeling and pattern mining with type safety

### Additional Stories
- **As a** developer, **I want to** immutable entities, **So that** data integrity is maintained
- **As a** developer, **I want to** validated entities, **So that** invalid states are caught early

## Acceptance Scenarios

### Scenario 1: Create Valid DiscoveryConfig
**Given** valid parameters (lookahead=5, success=0.03, failure=-0.02, min_samples=30)
**When** I create a DiscoveryConfig
**Then** the dataclass is created successfully

### Scenario 2: Invalid Threshold
**Given** success_threshold = -0.01 (negative)
**When** I try to create DiscoveryConfig
**Then** ValueError is raised with message

### Scenario 3: Rule Statistics Validation
**Given** a RuleStatistics with hit_rate = 1.5 (invalid)
**When** I create the dataclass
**Then** ValueError is raised

## Requirements

### Functional Requirements
- **FR-001**: DiscoveryType MUST have three values: ENTRY, EXIT, STOP_LOSS
- **FR-002**: DiscoveryConfig MUST validate all parameters in __post_init__
- **FR-003**: LabeledEvent MUST be immutable (frozen dataclass)
- **FR-004**: DiscoveredRule MUST limit sample_matches to 10 items
- **FR-005**: All enums MUST have string values for JSON serialization

### Non-Functional Requirements
- **NFR-001**: All types MUST pass mypy strict mode
- **NFR-002**: Test coverage MUST be > 90%

### Technical Constraints
- **TC-001**: Must use Python dataclasses
- **TC-002**: Must use Python Enum for type enums
- **TC-003**: Must be JSON serializable

## Key Entities

### Entity: DiscoveryType
- **Description**: Enum for discovery types
- **Values**: ENTRY, EXIT, STOP_LOSS

### Entity: DiscoveryConfig
- **Description**: Configuration for pattern discovery
- **Attributes**: discovery_type, lookahead_period, success_threshold, failure_threshold, min_samples

### Entity: LabeledEvent
- **Description**: Event with forward-looking outcome
- **Attributes**: symbol, timestamp, candle, indicator_values, outcome, forward_return, exit_timestamp, exit_reason

### Entity: DiscoveredRule
- **Description**: Discovered pattern rule
- **Attributes**: id, formula, discovery_type, statistics, sample_matches, created_at

### Entity: RuleStatistics
- **Description**: Performance metrics
- **Attributes**: total_events, success_count, failure_count, neutral_count, hit_rate, avg_return, profit_factor, max_consecutive_failures

## Dependencies

### Upstream Dependencies
- [x] E07: Candle entity for LabeledEvent

### Downstream Impact
- [ ] E08-F02: Uses DiscoveryConfig, LabeledEvent
- [ ] E08-F03: Uses LabeledEvent, DiscoveredRule, RuleStatistics
- [ ] E08-F04: Uses all entities

## Tasks Preview

| Task ID | Title | Effort | Dependencies |
|---------|-------|--------|--------------|
| [E08-F01-T01](T01/E08-F01-T01.spec.md) | Define DiscoveryConfig and LabeledEvent | M | E07 |
| [E08-F01-T02](T02/E08-F01-T02.spec.md) | Define DiscoveredRule and RuleStatistics | M | T01 |

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] All entity attributes defined
- [x] Validation rules specified

### Quality Gates
- [ ] All entities implemented
- [ ] Unit tests written
- [ ] mypy passes

## Success Criteria

### Acceptance Criteria
- [ ] All entity types defined with proper type hints
- [ ] Entities are immutable (frozen dataclasses)
- [ ] Enums have string values for JSON serialization
- [ ] Repository interface defined

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] 90% test coverage
- [ ] mypy strict mode passes

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Type incompatibility | Low | Medium | Use strict typing, test serialization |

## Artifacts

### Input Documents
- [E08 Epic](../E08.spec.md)

### Output Artifacts
- [ ] `src/domain/discovery/entities.py`
- [ ] `src/domain/discovery/value_objects.py`
- [ ] `src/domain/discovery/repositories.py`

---
*Template Version: 2.0.0*
