# Spec: E08-F02-T02 - Implement Forward Return Calculation

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E08-F02-T02
clickup_task_id: '86ew0217e'
title: Implement Forward Return Calculation
type: task

# === HIERARCHY ===
parent: E08-F02
children: []
epic: E08
feature: F02
task: T02
domain: discovery

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 3
actual_hours: 0

# === METADATA ===
tags: [labeling, calculation, outcome, forward-return]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E08-F02](../E08-F02.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement the `_calculate_outcome()` method that determines whether an event resulted in SUCCESS, FAILURE, or NEUTRAL based on forward price action. The algorithm checks if price hits the success or failure threshold during the lookahead period.

## Execution Flow

```
1. Receive entry candle, forward candles, and config
   → Extract entry_price from entry_candle.close

2. For each forward candle (in chronological order)
   → Calculate high_return = (candle.high - entry_price) / entry_price
   → Calculate low_return = (candle.low - entry_price) / entry_price
   → If high_return >= success_threshold: Return SUCCESS with exit info
   → If low_return <= failure_threshold: Return FAILURE with exit info

3. No threshold hit during lookahead period
   → Calculate final_return from last candle close
   → Return: NEUTRAL with final_return and "timeout" reason
```

## User Stories

### Primary User Story
**As a** pattern discovery system
**I want to** calculate forward outcomes for events
**So that** events are correctly labeled for pattern mining

### Additional Stories
- **As a** trader, **I want to** know exit reasons, **So that** I understand how outcomes were determined
- **As a** developer, **I want to** optimistic assumption, **So that** success is checked before failure

## Acceptance Scenarios

### Scenario 1: Success Outcome (Hit Target)
**Given** entry price 10,000 and forward candle with high 10,400
**When** success_threshold is 3% (10,300)
**Then** outcome is SUCCESS with exit_reason "hit_target"

### Scenario 2: Failure Outcome (Hit Stop)
**Given** entry price 10,000 and forward candle with low 9,700
**When** failure_threshold is -2% (9,800)
**Then** outcome is FAILURE with exit_reason "hit_stop"

### Scenario 3: Neutral Outcome (Timeout)
**Given** entry price 10,000 and no threshold hit during lookahead
**When** final close is 10,150 (1.5% gain)
**Then** outcome is NEUTRAL with forward_return 0.015 and exit_reason "timeout"

### Scenario 4: Both Thresholds Same Candle
**Given** a candle where both high and low hit thresholds
**When** calculating outcome
**Then** SUCCESS wins (optimistic assumption - check success first)

### Scenario 5: Exact Threshold Match
**Given** high exactly equals success_threshold
**When** using >= comparison
**Then** outcome is SUCCESS

## Requirements

### Functional Requirements
- **FR-001**: System MUST check success threshold before failure (optimistic)
- **FR-002**: System MUST use >= for success, <= for failure comparison
- **FR-003**: System MUST record exit_timestamp and exit_reason
- **FR-004**: System MUST return NEUTRAL with final return if no threshold hit

### Non-Functional Requirements
- **NFR-001**: Calculation must be deterministic
- **NFR-002**: Floating point comparisons must be exact

### Technical Constraints
- **TC-001**: Must return tuple of (outcome_label, forward_return, exit_info_dict)
- **TC-002**: Must handle edge cases (exact threshold, same-day hit)

## Key Entities

### Method: _calculate_outcome()
- **Description**: Determines outcome based on forward price action
- **Parameters**: entry_candle, forward_candles, config
- **Returns**: tuple[OutcomeLabel, float, dict]

## Dependencies

### Upstream Dependencies
- [x] E08-F02-T01: OutcomeLabeler core structure
- [x] E08-F01: OutcomeLabel enum

### Downstream Impact
- [ ] E08-F03: Receives correctly labeled events

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Algorithm defined
- [x] Edge cases documented

### Quality Gates
- [ ] Method implemented
- [ ] All outcome scenarios tested
- [ ] Test coverage > 90%

## Success Criteria

### Acceptance Criteria
- [ ] `_calculate_outcome()` method implemented
- [ ] Success detected when high >= threshold
- [ ] Failure detected when low <= threshold
- [ ] Neutral returned with final return when no threshold hit
- [ ] Exit timestamp and reason recorded correctly
- [ ] Optimistic assumption (check success before failure)

### Definition of Done
- [ ] Unit tests for all outcome scenarios
- [ ] Edge case tests
- [ ] Test coverage > 90%

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Floating point precision | Low | Low | Use exact comparisons |
| Edge case bugs | Low | Medium | Comprehensive test coverage |

## Artifacts

### Input Documents
- [E08-F02-T01 OutcomeLabeler Core](../T01/E08-F02-T01.spec.md)
- PRD Section 5.3.3: Discovery Parameters

### Output Artifacts
- [ ] `src/domain/discovery/labeling/outcome_labeler.py` (add _calculate_outcome)
- [ ] `src/domain/discovery/labeling/forward_calculator.py` (optional extraction)

---
*Template Version: 2.0.0*
