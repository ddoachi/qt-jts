# Spec: E08-F02-T01 - Implement OutcomeLabeler Core

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E08-F02-T01
clickup_task_id: '86ew0216q'
title: Implement OutcomeLabeler Core
type: task

# === HIERARCHY ===
parent: E08-F02
children: []
epic: E08
feature: F02
task: T01
domain: discovery

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [labeling, async, service, forward-analysis]
effort: large
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E08-F02](../E08-F02.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement the core OutcomeLabeler class that processes scan match events and labels them with forward-looking outcomes (SUCCESS, FAILURE, NEUTRAL). This service fetches forward candles and delegates outcome calculation to the forward calculator.

## Execution Flow

```
1. Initialize OutcomeLabeler with ICandleRepository
   → Store repository reference

2. label_events() receives events and config
   → If events empty: Return empty list
   → For each event: call _label_single_event()
   → Filter out None results (skipped events)
   → Return: list of LabeledEvent

3. _label_single_event() processes one event
   → Call _get_forward_candles() for lookahead period
   → If no forward data: Return None (skip event)
   → Call _calculate_outcome() (delegated to T02)
   → Create and return LabeledEvent

4. _get_forward_candles() fetches price data
   → Calculate end date with buffer for weekends
   → Query candle repository
   → Return: candles limited to lookahead period
```

## User Stories

### Primary User Story
**As a** pattern discovery system
**I want to** label events with forward-looking outcomes
**So that** the pattern miner can find conditions that predict success

### Additional Stories
- **As a** developer, **I want to** async batch processing, **So that** large event sets are processed efficiently
- **As a** developer, **I want to** events without forward data skipped, **So that** only valid labels are produced

## Acceptance Scenarios

### Scenario 1: Empty Input
**Given** an empty events list
**When** I call label_events()
**Then** an empty list is returned

### Scenario 2: All Events Labeled
**Given** 100 events with forward data available
**When** I call label_events()
**Then** 100 LabeledEvents are returned

### Scenario 3: Some Events Skipped
**Given** 100 events where 20 lack forward data
**When** I call label_events()
**Then** 80 LabeledEvents are returned (20 skipped)

### Scenario 4: Forward Candles Fetched
**Given** an event on 2024-11-15 with lookahead=5
**When** forward candles are fetched
**Then** candles from 2024-11-16 to 2024-11-20 (excluding weekends) are returned

## Requirements

### Functional Requirements
- **FR-001**: System MUST skip events without forward data
- **FR-002**: System MUST fetch forward candles for lookahead period
- **FR-003**: System MUST handle weekends in date calculations
- **FR-004**: System MUST process events asynchronously

### Non-Functional Requirements
- **NFR-001**: Performance: Process 1000+ events efficiently
- **NFR-002**: Async batch processing support

### Technical Constraints
- **TC-001**: Must use ICandleRepository for forward data
- **TC-002**: Must be async/await compatible
- **TC-003**: Must handle market closures in date calculations

## Key Entities

### Class: OutcomeLabeler
- **Description**: Service that labels events with outcomes
- **Methods**: label_events(), _label_single_event(), _get_forward_candles()
- **Dependencies**: ICandleRepository

## Dependencies

### Upstream Dependencies
- [x] E08-F01: DiscoveryConfig, LabeledEvent, OutcomeLabel
- [x] E07: ScanMatch entity
- [x] E04: ICandleRepository

### Downstream Impact
- [ ] E08-F02-T02: Provides _calculate_outcome() method
- [ ] E08-F04: Uses OutcomeLabeler in use case

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Class structure defined
- [x] Method signatures specified

### Quality Gates
- [ ] OutcomeLabeler implemented
- [ ] Unit tests with mocked repository
- [ ] Test coverage > 85%

## Success Criteria

### Acceptance Criteria
- [ ] `OutcomeLabeler` class implemented
- [ ] `label_events()` processes batch of events
- [ ] Events with no forward data are skipped
- [ ] Async batch processing works correctly

### Definition of Done
- [ ] Proper type hints throughout
- [ ] Unit tests with mocked candle repository
- [ ] Test coverage > 85%

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Missing forward data | Medium | Low | Skip events, report count |
| Date calculation errors | Low | Medium | Account for weekends/holidays |

## Artifacts

### Input Documents
- [E08-F02 Outcome Labeling](../E08-F02.spec.md)
- PRD Section 5.3.1: Discovery Workflow (Step 2)

### Output Artifacts
- [ ] `src/domain/discovery/labeling/outcome_labeler.py`
- [ ] `src/domain/discovery/labeling/__init__.py`

---
*Template Version: 2.0.0*
