# Spec: E08-F02 - Outcome Labeling

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E08-F02
clickup_task_id: ''
title: Outcome Labeling
type: feature

# === HIERARCHY ===
parent: E08
children: [E08-F02-T01, E08-F02-T02]
epic: E08
feature: F02
task: ''
domain: discovery

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 6
actual_hours: 0

# === METADATA ===
tags: [labeling, forward-analysis, outcome]
effort: large
risk: low
---

**Status**: Draft
**Type**: Feature
**Parent**: [E08](../E08.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement the OutcomeLabeler that processes scan match events and labels them with forward-looking outcomes (SUCCESS, FAILURE, NEUTRAL) based on price action during the lookahead period. This is the second step in the discovery workflow.

## Execution Flow

```
1. Receive list of ScanMatch events and DiscoveryConfig
   → If events empty: Return empty list

2. For each event, fetch forward candles
   → Get candles for lookahead_period days after event
   → If no forward data available: Skip event, continue

3. Calculate outcome for each event
   → For each forward candle (in order):
     → If high >= success_threshold: SUCCESS, exit
     → If low <= failure_threshold: FAILURE, exit
   → If no threshold hit: NEUTRAL with final return

4. Create LabeledEvent for each processed event
   → Include exit_timestamp and exit_reason

5. Return list of LabeledEvent
   → Return: SUCCESS with LabeledEvent[]
```

## User Stories

### Primary User Story
**As a** pattern discovery system
**I want to** label events with forward-looking outcomes
**So that** the pattern miner can find conditions that predict success

### Additional Stories
- **As a** trader, **I want to** know exit reasons, **So that** I understand how outcomes were determined

## Acceptance Scenarios

### Scenario 1: Success Outcome
**Given** an event with entry price 10,000 and forward candle with high 10,400
**When** success_threshold is 3% (10,300)
**Then** outcome is SUCCESS with exit_reason "hit_target"

### Scenario 2: Failure Outcome
**Given** an event with entry price 10,000 and forward candle with low 9,700
**When** failure_threshold is -2% (9,800)
**Then** outcome is FAILURE with exit_reason "hit_stop"

### Scenario 3: Neutral Outcome (Timeout)
**Given** an event where no threshold is hit during lookahead period
**When** final close is 10,150 (1.5% gain)
**Then** outcome is NEUTRAL with forward_return 0.015 and exit_reason "timeout"

### Scenario 4: No Forward Data
**Given** an event with no available forward candles
**When** labeling is attempted
**Then** the event is skipped (not included in output)

## Requirements

### Functional Requirements
- **FR-001**: System MUST label events based on forward price action
- **FR-002**: System MUST check success threshold before failure (optimistic)
- **FR-003**: System MUST record exit_timestamp and exit_reason
- **FR-004**: System MUST skip events without forward data
- **FR-005**: System MUST use exact thresholds (>= for success, <= for failure)

### Non-Functional Requirements
- **NFR-001**: Performance: Process 1000+ events efficiently
- **NFR-002**: Async batch processing support

### Technical Constraints
- **TC-001**: Must use ICandleRepository for forward data
- **TC-002**: Must handle market closures (weekends) in date calculations

## Key Entities

### Entity: OutcomeLabeler
- **Description**: Service that labels events with outcomes
- **Methods**: label_events(), _calculate_outcome()
- **Dependencies**: ICandleRepository

## Dependencies

### Upstream Dependencies
- [x] E08-F01: DiscoveryConfig, LabeledEvent, OutcomeLabel
- [x] E07: ScanMatch entity
- [x] E04: ICandleRepository

### Downstream Impact
- [ ] E08-F03: Receives LabeledEvent[] for pattern mining
- [ ] E08-F04: Uses OutcomeLabeler in use case

## Tasks Preview

| Task ID | Title | Effort | Dependencies |
|---------|-------|--------|--------------|
| [E08-F02-T01](T01/E08-F02-T01.spec.md) | Implement OutcomeLabeler core | L | E08-F01 |
| [E08-F02-T02](T02/E08-F02-T02.spec.md) | Implement forward return calculation | M | T01 |

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Labeling algorithm defined
- [x] Edge cases documented

### Quality Gates
- [ ] OutcomeLabeler implemented
- [ ] All outcome scenarios tested
- [ ] Performance validated

## Success Criteria

### Acceptance Criteria
- [ ] Labels events correctly based on forward price action
- [ ] Success threshold reached → SUCCESS label
- [ ] Failure threshold reached → FAILURE label
- [ ] No threshold hit → NEUTRAL with final return
- [ ] Exit timestamp and reason tracked

### Definition of Done
- [ ] Unit tests with mock candle data
- [ ] Edge case tests
- [ ] Test coverage > 85%

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Missing forward data | Medium | Low | Skip events, report count |
| Date calculation errors | Low | Medium | Account for weekends/holidays |

## Artifacts

### Input Documents
- [E08-F01 Domain Model](../F01/E08-F01.spec.md)

### Output Artifacts
- [ ] `src/domain/discovery/labeling/outcome_labeler.py`
- [ ] `src/domain/discovery/labeling/forward_calculator.py`

---
*Template Version: 2.0.0*
