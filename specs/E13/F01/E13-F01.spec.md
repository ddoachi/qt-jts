# Spec: E13-F01 - Live Trading Domain Models

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E13-F01
clickup_task_id: ''    # REQUIRED - Empty string if not yet created in ClickUp
title: Live Trading Domain Models
type: feature

# === HIERARCHY ===
parent: E13
children: [E13-F01-T01, E13-F01-T02, E13-F01-T03, E13-F01-T04]
epic: E13
feature: F01
domain: live-trading

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 8
actual_hours: 0

# === METADATA ===
tags: [domain, entities, live-trading, risk-controls]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Feature
**Parent**: E13 (Live Trading)
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Executive Summary

Define the core domain models and entities for live trading functionality. This includes `LiveTradingSession`, `LiveOrder`, `RiskControls`, and `PreRequisiteCheck` entities that form the foundation of the live trading system. These models capture all the business logic constraints and state transitions required for safe, controlled live trading operations.

## Execution Flow

```
1. Define enums and value objects
   -> ExecutionMode (MANUAL, SEMI_AUTO, AUTO)
   -> SessionStatus (CREATED, RUNNING, PAUSED, STOPPED, ERROR)
   -> OrderStatus (PENDING, SUBMITTED, PARTIAL, FILLED, CANCELLED, REJECTED, FAILED)
   -> OrderSide (BUY, SELL)
   -> OrderType (MARKET, LIMIT)

2. Define RiskControls dataclass
   -> max_position_size_pct (default 10.0)
   -> max_positions (default 5)
   -> max_daily_loss_pct (default 5.0)
   -> trading_hours_start/end
   -> require_backtest_sharpe
   -> require_paper_trading_days

3. Define LiveTradingSession entity
   -> id, strategy, broker_id, account_id
   -> symbols list
   -> risk_controls reference
   -> execution_mode, status
   -> timestamps (started_at, stopped_at, created_at)

4. Define LiveOrder entity
   -> id, session_id, symbol
   -> side, order_type, quantity, price
   -> status with state machine
   -> broker_order_id, filled_quantity, filled_price
   -> commission, timestamps, error_message

5. Define PreRequisiteCheck entity
   -> strategy_id
   -> backtest_passed, backtest_sharpe
   -> paper_trading_passed, paper_trading_days
   -> risk_parameters_set
   -> broker_connected, account_verified
   -> all_passed computed property
```

## User Stories

### Primary User Story
**As a** developer implementing live trading
**I want to** have well-defined domain models with clear constraints
**So that** I can build type-safe, validated trading logic without runtime errors

### Additional Stories
- **As a** developer, **I want to** have immutable value objects for risk controls, **So that** trading parameters cannot be accidentally modified during execution
- **As a** developer, **I want to** have clear order status transitions, **So that** I can track order lifecycle correctly
- **As a** developer, **I want to** have pre-requisite validation logic centralized, **So that** all safety checks are applied consistently

## Acceptance Scenarios

### Scenario 1: Create RiskControls with Defaults
**Given** a new live trading session is being configured
**When** RiskControls is instantiated without parameters
**Then** max_position_size_pct should be 10.0
**And** max_positions should be 5
**And** max_daily_loss_pct should be 5.0
**And** trading_hours should be 09:00 - 15:30

### Scenario 2: LiveOrder Status Transitions
**Given** a new LiveOrder is created
**When** the order progresses through its lifecycle
**Then** it should transition: PENDING -> SUBMITTED -> FILLED
**Or** it should transition: PENDING -> SUBMITTED -> REJECTED
**And** invalid transitions should be prevented

### Scenario 3: PreRequisiteCheck Validation
**Given** a strategy ready for live trading
**When** PreRequisiteCheck.all_passed is evaluated
**Then** it should return True only if ALL conditions are met:
  - backtest_passed is True
  - paper_trading_passed is True
  - risk_parameters_set is True
  - broker_connected is True
  - account_verified is True

### Scenario 4: LiveTradingSession Creation
**Given** valid configuration for live trading
**When** LiveTradingSession is created
**Then** id should be a valid UUID
**And** status should be CREATED
**And** started_at should be None
**And** created_at should be set to current UTC time

## Requirements

### Functional Requirements
- **FR-001**: System MUST define ExecutionMode enum with MANUAL, SEMI_AUTO, AUTO values
- **FR-002**: System MUST define SessionStatus enum with CREATED, RUNNING, PAUSED, STOPPED, ERROR values
- **FR-003**: System MUST define OrderStatus enum with PENDING, SUBMITTED, PARTIAL, FILLED, CANCELLED, REJECTED, FAILED values
- **FR-004**: System MUST define RiskControls dataclass with configurable limits
- **FR-005**: System MUST define LiveTradingSession entity with all required fields
- **FR-006**: System MUST define LiveOrder entity with complete order tracking
- **FR-007**: System MUST define PreRequisiteCheck with all_passed computed property

### Non-Functional Requirements
- **NFR-001**: All entities MUST be immutable or have controlled mutability
- **NFR-002**: All entities MUST have complete type hints
- **NFR-003**: All entities MUST have comprehensive docstrings
- **NFR-004**: Domain logic MUST be pure Python (no external dependencies)

### Technical Constraints
- **TC-001**: Must use Python dataclasses for entity definitions
- **TC-002**: Must use Enum for status types
- **TC-003**: Must use Decimal for monetary values (not float)
- **TC-004**: Must use UUID for entity IDs
- **TC-005**: Must use datetime with UTC timezone

## Key Entities

### Entity: RiskControls
- **Description**: Configuration for trading risk limits
- **Key Attributes**: `max_position_size_pct`, `max_positions`, `max_daily_loss_pct`, `trading_hours_start`, `trading_hours_end`
- **Relationships**: Embedded in LiveTradingSession

### Entity: LiveTradingSession
- **Description**: Represents an active live trading session
- **Key Attributes**: `id`, `strategy`, `broker_id`, `account_id`, `symbols`, `risk_controls`, `execution_mode`, `status`
- **Relationships**: Has many LiveOrders, contains RiskControls

### Entity: LiveOrder
- **Description**: Individual order in live trading
- **Key Attributes**: `id`, `session_id`, `symbol`, `side`, `order_type`, `quantity`, `status`, `broker_order_id`
- **Relationships**: Belongs to LiveTradingSession

### Entity: PreRequisiteCheck
- **Description**: Pre-requisite validation results for live trading
- **Key Attributes**: `strategy_id`, `backtest_passed`, `paper_trading_passed`, `risk_parameters_set`, `broker_connected`
- **Relationships**: References Strategy

## Dependencies

### Upstream Dependencies
- [ ] E09: Strategy entities (Strategy class reference)
- [ ] E12: Paper trading history (for paper_trading_passed check)
- [ ] E03: Broker entities (for broker_connected check)

### Downstream Impact
- [ ] E13-F02: Live Trading Engine (uses all domain models)
- [ ] E13-F03: Order Execution (uses LiveOrder, OrderStatus)
- [ ] E13-F04: UI Components (displays domain model data)

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Performance requirements specified (N/A - pure domain logic)
- [x] Security requirements defined (no sensitive data in domain models)
- [x] Scale requirements clear (single session, ~10 concurrent orders max)
- [x] PRD compliance verified (Section 5.8)

### Quality Gates
- [ ] Complexity justified (optimal granularity per auto-split analysis)
- [ ] All requirements testable
- [ ] Dependencies identified and documented
- [ ] Risk assessment complete

## Tasks Preview

### Implementation Tasks
- [ ] T01 [P] Define enums (ExecutionMode, SessionStatus, OrderStatus, OrderSide, OrderType)
- [ ] T02 [P] Define RiskControls dataclass with validation
- [ ] T03 Define LiveTradingSession and LiveOrder entities (depends on T01, T02)
- [ ] T04 Define PreRequisiteCheck entity with all_passed logic (depends on T01)

**[P]** = Can be executed in parallel

## Success Criteria

### Acceptance Criteria
- [ ] All enums defined with complete values
- [ ] RiskControls dataclass with sensible defaults
- [ ] LiveTradingSession entity with full lifecycle support
- [ ] LiveOrder entity with status tracking
- [ ] PreRequisiteCheck with correct all_passed logic
- [ ] All entities have type hints and docstrings
- [ ] All monetary values use Decimal
- [ ] Unit tests pass with > 90% coverage

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Tests passing (unit tests for all entities)
  - [ ] Unit tests for enum values
  - [ ] Unit tests for RiskControls defaults and validation
  - [ ] Unit tests for entity creation
  - [ ] Unit tests for PreRequisiteCheck.all_passed
- [ ] Documentation updated (pre-docs, post-docs)
- [ ] 90% test coverage achieved

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Type confusion with float vs Decimal | Medium | High | Use Decimal consistently, add validation |
| Missing status transitions | Low | Medium | Document all valid transitions, add tests |
| Timezone issues with datetime | Medium | Medium | Always use UTC, convert at display layer |
| Missing validation in constructors | Low | Medium | Add __post_init__ validation in dataclasses |

## Notes and Clarifications

### Open Questions
None - Domain model requirements are clear from E13 spec

### Decisions Made
- 2025-12-30: Use dataclasses for all entities for immutability
- 2025-12-30: Use Decimal for all monetary values to avoid floating point errors
- 2025-12-30: Use UTC timezone for all timestamps
- 2025-12-30: Default trading hours are KRX hours (09:00 - 15:30)

### Research Needed
None - Standard Python patterns

## Artifacts

### Input Documents
- [Product Requirements Document](../../../docs/product-requirements-document.md) (Section 5.8)
- [Parent Spec](../E13.spec.md) (Epic E13)

### Output Artifacts (to be generated)
- [ ] `E13-F01.context.md` - Implementation context and progress
- [ ] `E13-F01.pre-docs.md` - Pre-implementation documentation
- [ ] `E13-F01.post-docs.md` - Post-implementation learnings
- [ ] Unit tests: `tests/unit/domain/test_live_trading_entities.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
