# E13-F04: Live Trading UI Components - Pre-Implementation Documentation

## Feature Overview

| Field | Value |
|-------|-------|
| Feature ID | E13-F04 |
| Title | Live Trading UI Components |
| Parent Epic | E13 (Live Trading) |
| Estimated Hours | 17 |
| Tasks | 6 |
| Risk Level | Medium |

---

## 1. Implementation Strategy

### 1.1 Approach

This feature implements the user interface for live trading using PySide6. We follow Qt's Model-View pattern for tables and use signals/slots for event handling. The UI has a distinct red color scheme to visually differentiate from paper trading.

### 1.2 Key Patterns

- **Qt Signals/Slots**: For event handling
- **Model-View**: For table widgets
- **Observer**: Subscribe to engine signals
- **Timer**: For periodic UI updates

### 1.3 Implementation Order

```
T01 (SetupView) ◄──┬── T02 (AccountWidget) [P]
                   ├── T03 (PrereqWidget) [P]
                   └── T05 (ConfirmDialog) [P]
                        │
T04 (Dashboard) ◄──────┘
        │
        └──→ T06 (OrderHistory)
```

---

## 2. File Structure

```
src/presentation/live_trading/
├── __init__.py
├── setup_view.py           # T01: Setup wizard
├── dashboard.py            # T04: Main dashboard
├── widgets/
│   ├── __init__.py
│   ├── account_selection.py  # T02: Account widget
│   ├── prerequisite.py       # T03: Prerequisites checklist
│   └── order_history.py      # T06: Order history table
└── dialogs/
    ├── __init__.py
    └── order_confirmation.py  # T05: Confirmation dialog
```

---

## 3. Task Implementation Details

### 3.1 T01: SetupView Layout (3 hours)

**File**: `src/presentation/live_trading/setup_view.py`

```python
from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QGroupBox, QPushButton, QLabel
)
from PySide6.QtCore import Signal


class LiveTradingSetupView(QWidget):
    """
    Setup wizard for starting live trading.

    Visual Design:
    - Dark header with strategy name
    - Account selection with balances
    - Prerequisites checklist
    - Red "Start Trading" button

    Signals:
        start_trading_requested(config): Emitted when user confirms
        cancelled(): Emitted when user cancels
    """

    start_trading_requested = Signal(object)
    cancelled = Signal()

    def __init__(self, session_manager, strategy, parent=None):
        super().__init__(parent)
        self._session_manager = session_manager
        self._strategy = strategy
        self._setup_ui()
        self._connect_signals()
        self._load_prerequisites()

    def _setup_ui(self):
        layout = QVBoxLayout(self)
        layout.setSpacing(16)

        # Header with strategy name
        header = self._create_header()
        layout.addWidget(header)

        # Account selection
        account_group = QGroupBox("Select Broker & Account")
        self._account_widget = AccountSelectionWidget(...)
        account_group.layout().addWidget(self._account_widget)
        layout.addWidget(account_group)

        # Prerequisites
        prereq_group = QGroupBox("Prerequisites")
        self._prereq_widget = PreRequisiteWidget()
        prereq_group.layout().addWidget(self._prereq_widget)
        layout.addWidget(prereq_group)

        # Buttons
        self._start_btn = QPushButton("▶ 실전 매매 시작")
        self._start_btn.setEnabled(False)
        self._start_btn.setStyleSheet("""
            QPushButton {
                background-color: #c0392b;
                color: white;
                font-weight: bold;
                padding: 10px 20px;
            }
        """)
        layout.addWidget(self._start_btn)
```

---

### 3.2 T02: AccountSelectionWidget (3 hours)

**File**: `src/presentation/live_trading/widgets/account_selection.py`

```python
from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QRadioButton, QButtonGroup,
    QProgressBar, QLabel
)
from PySide6.QtCore import Signal


class AccountSelectionWidget(QWidget):
    """
    Widget for selecting broker and account.

    Shows:
    - List of accounts with radio buttons
    - Account type (실전투자/모의투자)
    - Balance in Korean Won
    - Rate limit status bar

    Korean Labels:
    - 실전투자: Live trading
    - 모의투자: Paper trading
    - 위탁: Margin
    """

    selection_changed = Signal()

    def __init__(self, broker_registry, parent=None):
        super().__init__(parent)
        self._broker_registry = broker_registry
        self._button_group = QButtonGroup(self)
        self._setup_ui()
        self._load_accounts()

    def _get_account_type_label(self, account_type: str) -> str:
        """Convert account type to Korean label"""
        return {
            "live": "실전투자",
            "paper": "모의투자",
            "margin": "위탁"
        }.get(account_type, account_type)

    def _create_rate_limit_indicator(self):
        """Create rate limit progress bar"""
        self._rate_bar = QProgressBar()
        self._rate_bar.setFormat("%v/%m req/s")
        self._rate_status = QLabel("[정상]")
```

---

### 3.3 T03: PreRequisiteWidget (2 hours)

**File**: `src/presentation/live_trading/widgets/prerequisite.py`

```python
from PySide6.QtWidgets import QWidget, QVBoxLayout, QLabel
from PySide6.QtCore import Signal


class PreRequisiteWidget(QWidget):
    """
    Checklist showing prerequisites status.

    Visual Design:
    - [✓] Green checkmark for passed
    - [✗] Red X for failed
    - Detail text in parentheses
    - Tooltip shows full reason
    """

    status_changed = Signal()

    def set_check(self, check: PreRequisiteCheck):
        """Update display with check results"""
        # Backtest
        if check.backtest_passed:
            self._backtest_item.set_passed(f"Sharpe: {check.backtest_sharpe:.2f}")
        else:
            self._backtest_item.set_failed("Sharpe < 1.0")

        # Paper trading
        if check.paper_trading_passed:
            self._paper_item.set_passed(f"{check.paper_trading_days} days")
        else:
            self._paper_item.set_failed(f"{check.paper_trading_days or 0}/5 days")

        # Risk parameters
        if check.risk_parameters_set:
            self._risk_item.set_passed()
        else:
            self._risk_item.set_failed("Not configured")

        # Broker
        if check.broker_connected:
            self._broker_item.set_passed()
        else:
            self._broker_item.set_failed("Not connected")

        self.status_changed.emit()


class PreRequisiteItem(QWidget):
    """Single prerequisite item with icon and text"""

    def set_passed(self, detail: str = ""):
        self._icon.setText("[✓]")
        self._icon.setStyleSheet("color: #27ae60;")
        self._detail.setText(f"({detail})" if detail else "")

    def set_failed(self, reason: str = ""):
        self._icon.setText("[✗]")
        self._icon.setStyleSheet("color: #c0392b;")
        self._detail.setText(f"({reason})" if reason else "")
        self.setToolTip(reason)
```

---

### 3.4 T04: LiveTradingDashboard (5 hours)

**File**: `src/presentation/live_trading/dashboard.py`

```python
from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QTableWidget, QSplitter, QGroupBox
)
from PySide6.QtCore import Qt, Signal, QTimer


class LiveTradingDashboard(QWidget):
    """
    Main dashboard for active live trading.

    Sections:
    1. Header (red) - Session info, stop button
    2. Account Summary - Balance, positions, daily P&L
    3. Positions Table - Open positions with real-time P&L
    4. Signals List - Pending signals awaiting confirmation
    5. Order History - Completed orders

    Visual Design:
    - Red header indicates live trading
    - Green P&L for profit, red for loss
    - Auto-updates every 1 second
    """

    stop_requested = Signal()
    close_position_requested = Signal(str)

    def __init__(self, session, runner, parent=None):
        super().__init__(parent)
        self._session = session
        self._runner = runner
        self._setup_ui()
        self._connect_signals()
        self._start_update_timer()

    def _start_update_timer(self):
        """Update UI every second"""
        self._timer = QTimer(self)
        self._timer.timeout.connect(self._update_display)
        self._timer.start(1000)

    def _update_positions(self):
        """Update positions table with current prices"""
        for row, (symbol, pos) in enumerate(self._runner._positions.items()):
            # P&L percentage with color
            pnl_pct = ((pos.current_price - pos.entry_price) / pos.entry_price) * 100
            pnl_item = QTableWidgetItem(f"{pnl_pct:+.1f}%")
            pnl_item.setForeground(Qt.green if pnl_pct >= 0 else Qt.red)
            self._positions_table.setItem(row, 5, pnl_item)
```

---

### 3.5 T05: OrderConfirmationDialog (2 hours)

**File**: `src/presentation/live_trading/dialogs/order_confirmation.py`

```python
from PySide6.QtWidgets import QDialog, QVBoxLayout, QLabel, QPushButton
from decimal import Decimal


class OrderConfirmationDialog(QDialog):
    """
    Modal dialog for order confirmation.

    Shows:
    - Order details (symbol, direction, quantity, price)
    - Total value
    - Warning for large orders (> 10% of balance)

    Buttons:
    - Confirm (green)
    - Cancel
    """

    def __init__(self, signal, account_balance, parent=None):
        super().__init__(parent)
        self._signal = signal
        self._balance = account_balance
        self.setWindowTitle("Order Confirmation")
        self.setModal(True)
        self._setup_ui()

    def _setup_ui(self):
        layout = QVBoxLayout(self)

        # Order details
        layout.addWidget(QLabel(f"Symbol: {self._signal.symbol}"))
        layout.addWidget(QLabel(f"Direction: {self._signal.direction.value.upper()}"))
        layout.addWidget(QLabel(f"Quantity: {self._signal.quantity:,}"))
        layout.addWidget(QLabel(f"Price: ₩{self._signal.price:,.0f}"))

        total = self._signal.price * self._signal.quantity
        layout.addWidget(QLabel(f"Total: ₩{total:,.0f}"))

        # Warning for large orders
        if self._is_large_order():
            warning = QLabel("⚠️ This order is more than 10% of your balance")
            warning.setStyleSheet("color: #e67e22; font-weight: bold;")
            layout.addWidget(warning)

        # Buttons
        confirm_btn = QPushButton("Confirm Order")
        confirm_btn.setStyleSheet("background: #27ae60; color: white;")
        confirm_btn.clicked.connect(self.accept)
        layout.addWidget(confirm_btn)

    def _is_large_order(self) -> bool:
        total = self._signal.price * self._signal.quantity
        return total > self._balance * Decimal("0.1")
```

---

### 3.6 T06: OrderHistoryWidget (2 hours)

**File**: `src/presentation/live_trading/widgets/order_history.py`

```python
from PySide6.QtWidgets import QWidget, QTableWidget, QTableWidgetItem
from PySide6.QtGui import QColor


class OrderHistoryWidget(QWidget):
    """
    Table showing order history.

    Columns:
    - Time (HH:MM)
    - Symbol
    - Side (BUY green, SELL red)
    - Quantity
    - Price
    - Status (with icon)

    Status Icons:
    - ✓ Filled (green)
    - ✗ Rejected/Failed (red)
    - ◐ Partial (yellow)
    - ○ Pending (gray)
    """

    MAX_ORDERS = 100

    def add_order(self, order: LiveOrder):
        """Add or update order in history"""
        existing_idx = self._find_order_index(order.id)
        if existing_idx is not None:
            self._update_row(existing_idx, order)
        else:
            self._insert_order(order)

    def _create_status_item(self, order: LiveOrder) -> QTableWidgetItem:
        """Create status cell with icon and color"""
        icons = {
            OrderStatus.FILLED: "✓",
            OrderStatus.REJECTED: "✗",
            OrderStatus.FAILED: "✗",
            OrderStatus.PARTIAL: "◐",
            OrderStatus.PENDING: "○",
        }
        colors = {
            OrderStatus.FILLED: "#27ae60",
            OrderStatus.REJECTED: "#c0392b",
            OrderStatus.FAILED: "#c0392b",
            OrderStatus.PARTIAL: "#f39c12",
        }

        item = QTableWidgetItem(f"{icons.get(order.status, '?')} {order.status.value}")
        item.setForeground(QColor(colors.get(order.status, "#7f8c8d")))

        if order.error_message:
            item.setToolTip(order.error_message)

        return item
```

---

## 4. Visual Design

### 4.1 Color Scheme

| Element | Color | Hex |
|---------|-------|-----|
| Live Trading Header | Dark Red | #c0392b |
| Positive P&L | Green | #27ae60 |
| Negative P&L | Red | #c0392b |
| Warning | Orange | #e67e22 |
| Neutral | Gray | #7f8c8d |

### 4.2 Korean Text

| English | Korean |
|---------|--------|
| Live Trading | 실전 매매 |
| Paper Trading | 모의투자 |
| Margin Account | 위탁 |
| Balance | 잔고 |
| Start Trading | 실전 매매 시작 |
| Stop | 중지 |
| Normal | 정상 |
| Warning | 주의 |

---

## 5. Testing Strategy

### 5.1 Unit Tests

| Component | Coverage Target |
|-----------|-----------------|
| SetupView | 80% |
| AccountWidget | 80% |
| PrereqWidget | 85% |
| Dashboard | 75% |
| ConfirmDialog | 85% |
| OrderHistory | 80% |

### 5.2 UI Tests with pytest-qt

```python
def test_start_button_disabled_initially(qtbot):
    view = LiveTradingSetupView(mock_manager, mock_strategy)
    qtbot.addWidget(view)
    assert view._start_btn.isEnabled() == False

def test_start_button_enabled_when_ready(qtbot):
    view = LiveTradingSetupView(...)
    view._prereq_widget.set_check(all_passed_check)
    view._account_widget.select_account("KIS", "123")
    assert view._start_btn.isEnabled() == True
```

---

## 6. Acceptance Checklist

- [ ] Setup view matches wireframe
- [ ] Account selection shows all brokers
- [ ] Prerequisites checklist works
- [ ] Start button enabled only when ready
- [ ] Dashboard shows real-time updates
- [ ] P&L color coded correctly
- [ ] Order confirmation for MANUAL mode
- [ ] Large order warning (> 10%)
- [ ] Order history with status icons
- [ ] Korean text displays correctly
- [ ] Red theme for live trading
- [ ] > 80% test coverage

---

*Pre-docs generated: 2025-12-30*
