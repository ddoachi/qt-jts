# Spec: E13-F04-T02 - Create AccountSelectionWidget

---
id: E13-F04-T02
clickup_task_id: '86ew0fpkg'
title: Create AccountSelectionWidget
type: task
parent: E13-F04
epic: E13
feature: F04
domain: live-trading
status: draft
priority: high
created: '2025-12-30'
updated: '2025-12-30'
estimated_hours: 3
actual_hours: 0
tags: [ui, account-selection, pyside6]
effort: medium
risk: low
parallel: true
---

**Status**: Draft | **Type**: Task | **Parent**: E13-F04 | **Parallel**: Yes [P]

## Summary

Create the `AccountSelectionWidget` that displays available brokers and accounts with their balances and rate limit status. Users select which account to use for live trading.

## Implementation Details

### File Location
`src/presentation/live_trading/widgets/account_selection.py`

### AccountSelectionWidget Implementation

```python
from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel,
    QRadioButton, QButtonGroup, QProgressBar, QFrame
)
from PySide6.QtCore import Signal

class AccountSelectionWidget(QWidget):
    """
    Widget for selecting broker and account.

    Layout:
    ┌─────────────────────────────────────────────────────┐
    │ ○ KIS - 50012345-01 (실전투자)  잔고: ₩52,340,000   │
    │ ● KIS - 50012345-02 (모의투자)  잔고: ₩100,000,000  │
    │ ○ Creon - 12345678 (위탁)       잔고: ₩28,500,000   │
    │                                                     │
    │ Rate Limit: ████████░░ 16/20 req/s   [정상]        │
    └─────────────────────────────────────────────────────┘
    """

    selection_changed = Signal()

    def __init__(self, broker_registry: IBrokerRegistry, parent=None):
        super().__init__(parent)
        self._broker_registry = broker_registry
        self._button_group = QButtonGroup(self)

        self._selected_broker_id: str = ""
        self._selected_account_id: str = ""

        self._setup_ui()
        self._load_accounts()

    def _setup_ui(self):
        """Set up the UI layout"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)

        # Account list container
        self._account_list = QVBoxLayout()
        layout.addLayout(self._account_list)

        # Rate limit indicator
        self._rate_limit_frame = self._create_rate_limit_indicator()
        layout.addWidget(self._rate_limit_frame)

    def _create_rate_limit_indicator(self) -> QFrame:
        """Create rate limit status indicator"""
        frame = QFrame()
        layout = QHBoxLayout(frame)
        layout.setContentsMargins(0, 8, 0, 0)

        label = QLabel("Rate Limit:")
        layout.addWidget(label)

        self._rate_bar = QProgressBar()
        self._rate_bar.setMaximum(20)
        self._rate_bar.setValue(16)
        self._rate_bar.setFormat("%v/%m req/s")
        self._rate_bar.setStyleSheet("""
            QProgressBar {
                border: 1px solid #bdc3c7;
                border-radius: 4px;
                text-align: center;
            }
            QProgressBar::chunk {
                background-color: #27ae60;
            }
        """)
        layout.addWidget(self._rate_bar)

        self._rate_status = QLabel("[정상]")
        self._rate_status.setStyleSheet("color: #27ae60; font-weight: bold;")
        layout.addWidget(self._rate_status)

        return frame

    def _load_accounts(self):
        """Load accounts from all healthy brokers"""
        brokers = self._broker_registry.get_healthy()

        for broker in brokers:
            for account in broker.get_accounts():
                self._add_account_row(broker, account)

        # Connect button group
        self._button_group.buttonClicked.connect(self._on_selection_changed)

    def _add_account_row(self, broker, account):
        """Add a row for an account"""
        row = QWidget()
        layout = QHBoxLayout(row)
        layout.setContentsMargins(0, 4, 0, 4)

        # Radio button
        radio = QRadioButton()
        self._button_group.addButton(radio)
        radio.setProperty("broker_id", broker.id)
        radio.setProperty("account_id", account.id)
        layout.addWidget(radio)

        # Account info
        account_type = self._get_account_type_label(account.account_type)
        info = QLabel(
            f"{broker.name} - {account.id} ({account_type})"
        )
        info.setStyleSheet("font-weight: bold;")
        layout.addWidget(info)

        layout.addStretch()

        # Balance
        balance = QLabel(f"잔고: ₩{account.balance:,.0f}")
        balance.setStyleSheet("color: #2980b9;")
        layout.addWidget(balance)

        self._account_list.addWidget(row)

    def _get_account_type_label(self, account_type: str) -> str:
        """Get Korean label for account type"""
        labels = {
            "live": "실전투자",
            "paper": "모의투자",
            "margin": "위탁"
        }
        return labels.get(account_type, account_type)

    def _on_selection_changed(self, button):
        """Handle account selection change"""
        self._selected_broker_id = button.property("broker_id")
        self._selected_account_id = button.property("account_id")
        self.selection_changed.emit()

        # Update rate limit for selected broker
        self._update_rate_limit()

    def _update_rate_limit(self):
        """Update rate limit display for selected broker"""
        if not self._selected_broker_id:
            return

        broker = self._broker_registry.get(self._selected_broker_id)
        if broker:
            current = broker.rate_limiter.current_usage
            limit = broker.rate_limiter.limit
            self._rate_bar.setMaximum(limit)
            self._rate_bar.setValue(current)

            if current >= limit * 0.9:
                self._rate_status.setText("[주의]")
                self._rate_status.setStyleSheet("color: #e67e22; font-weight: bold;")
            else:
                self._rate_status.setText("[정상]")
                self._rate_status.setStyleSheet("color: #27ae60; font-weight: bold;")

    @property
    def selected_broker_id(self) -> str:
        return self._selected_broker_id

    @property
    def selected_account_id(self) -> str:
        return self._selected_account_id

    def has_selection(self) -> bool:
        """Check if an account is selected"""
        return bool(self._selected_broker_id and self._selected_account_id)

    def select_account(self, broker_id: str, account_id: str):
        """Programmatically select an account"""
        for button in self._button_group.buttons():
            if (button.property("broker_id") == broker_id and
                button.property("account_id") == account_id):
                button.setChecked(True)
                self._on_selection_changed(button)
                break
```

## Acceptance Criteria

- [ ] Displays list of accounts from all brokers
- [ ] Shows broker name, account ID, account type
- [ ] Shows account balance in Korean Won format
- [ ] Radio buttons for single selection
- [ ] selection_changed signal emitted on change
- [ ] Rate limit indicator shows current/max
- [ ] Rate status shows 정상/주의 based on usage
- [ ] Korean text displays correctly (실전투자, 모의투자, etc.)

## Dependencies

- **Upstream**: E03 (Broker Registry, Account info)
- **Downstream**: E13-F04-T01 (used in SetupView)

## Testing

```python
def test_account_selection_displays_accounts(qtbot):
    widget = create_widget_with_mock_accounts(3)
    assert widget._button_group.buttons().__len__() == 3

def test_account_selection_emits_signal(qtbot):
    widget = create_widget()
    with qtbot.waitSignal(widget.selection_changed):
        widget._button_group.buttons()[0].click()

def test_account_selection_properties(qtbot):
    widget = create_widget()
    widget.select_account("KIS", "50012345-01")
    assert widget.selected_broker_id == "KIS"
    assert widget.selected_account_id == "50012345-01"
    assert widget.has_selection() == True
```

---
*Estimated: 3 hours | Risk: Low*
