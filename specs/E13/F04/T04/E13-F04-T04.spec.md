# Spec: E13-F04-T04 - Create LiveTradingDashboard

---
id: E13-F04-T04
clickup_task_id: '86ew0fpkn'
title: Create LiveTradingDashboard
type: task
parent: E13-F04
epic: E13
feature: F04
domain: live-trading
status: draft
priority: high
created: '2025-12-30'
updated: '2025-12-30'
estimated_hours: 5
actual_hours: 0
tags: [ui, dashboard, positions, pyside6]
effort: large
risk: medium
parallel: false
---

**Status**: Draft | **Type**: Task | **Parent**: E13-F04 | **Parallel**: No

## Summary

Create the `LiveTradingDashboard` - the main monitoring view for an active live trading session. This includes account summary, positions table, pending signals, and order history sections with real-time updates.

## Implementation Details

### File Location
`src/presentation/live_trading/dashboard.py`

### LiveTradingDashboard Implementation

```python
from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel,
    QPushButton, QGroupBox, QTableWidget, QTableWidgetItem,
    QHeaderView, QSplitter
)
from PySide6.QtCore import Qt, Signal, QTimer

class LiveTradingDashboard(QWidget):
    """
    Main dashboard for active live trading.

    Layout:
    ┌─────────────────────────────────────────────────────────────────┐
    │ Live Trading: [Strategy Name]              Status: Running [중지]│
    │ Account: KIS 50012345-01 (실전투자)                              │
    ├─────────────────────────────────────────────────────────────────┤
    │ Account Summary                                                  │
    │ Balance: ₩52,340,000  Positions: 3  Daily P&L: +₩1,250,000      │
    ├─────────────────────────────────────────────────────────────────┤
    │ Open Positions                      │ Pending Signals            │
    │ ┌──────────────────────────────────┐│ ┌────────────────────────┐│
    │ │ Positions Table                  ││ │ Signals List           ││
    │ └──────────────────────────────────┘│ └────────────────────────┘│
    ├─────────────────────────────────────────────────────────────────┤
    │ Order History                                                    │
    │ ┌───────────────────────────────────────────────────────────────┐
    │ │ Order History Table                                           │
    │ └───────────────────────────────────────────────────────────────┘
    └─────────────────────────────────────────────────────────────────┘
    """

    stop_requested = Signal()
    close_position_requested = Signal(str)  # symbol

    def __init__(
        self,
        session: LiveTradingSession,
        runner: LiveTradingRunner,
        parent=None
    ):
        super().__init__(parent)
        self._session = session
        self._runner = runner

        self._setup_ui()
        self._connect_signals()
        self._start_update_timer()

    def _setup_ui(self):
        """Set up the UI layout"""
        layout = QVBoxLayout(self)
        layout.setSpacing(12)

        # Header
        header = self._create_header()
        layout.addWidget(header)

        # Account summary
        summary = self._create_account_summary()
        layout.addWidget(summary)

        # Middle section: Positions and Signals
        middle_splitter = QSplitter(Qt.Horizontal)

        positions_group = self._create_positions_section()
        middle_splitter.addWidget(positions_group)

        signals_group = self._create_signals_section()
        middle_splitter.addWidget(signals_group)

        middle_splitter.setSizes([600, 400])
        layout.addWidget(middle_splitter)

        # Order history
        history_group = self._create_order_history_section()
        layout.addWidget(history_group)

    def _create_header(self) -> QWidget:
        """Create header with session info and controls"""
        header = QWidget()
        header.setStyleSheet("""
            QWidget {
                background-color: #c0392b;
                border-radius: 4px;
                padding: 8px;
            }
            QLabel {
                color: white;
            }
        """)

        layout = QHBoxLayout(header)

        # Left: Session info
        left = QVBoxLayout()
        title = QLabel(f"Live Trading: {self._session.strategy_name}")
        title.setStyleSheet("font-size: 16px; font-weight: bold;")
        left.addWidget(title)

        account = QLabel(f"Account: {self._session.broker_id} {self._session.account_id}")
        left.addWidget(account)
        layout.addLayout(left)

        layout.addStretch()

        # Right: Status and controls
        right = QHBoxLayout()

        self._status_label = QLabel("Status: Running")
        self._status_label.setStyleSheet("font-weight: bold;")
        right.addWidget(self._status_label)

        self._stop_btn = QPushButton("중지")
        self._stop_btn.setStyleSheet("""
            QPushButton {
                background-color: #7f8c8d;
                color: white;
                padding: 8px 16px;
                border-radius: 4px;
            }
            QPushButton:hover {
                background-color: #95a5a6;
            }
        """)
        self._stop_btn.clicked.connect(self.stop_requested.emit)
        right.addWidget(self._stop_btn)

        layout.addLayout(right)

        return header

    def _create_account_summary(self) -> QGroupBox:
        """Create account summary section"""
        group = QGroupBox("Account Summary")
        layout = QHBoxLayout(group)

        self._balance_label = QLabel("Balance: ₩0")
        self._balance_label.setStyleSheet("font-size: 14px;")
        layout.addWidget(self._balance_label)

        layout.addSpacing(20)

        self._positions_label = QLabel("Positions: 0")
        layout.addWidget(self._positions_label)

        layout.addSpacing(20)

        self._daily_pnl_label = QLabel("Daily P&L: ₩0")
        layout.addWidget(self._daily_pnl_label)

        layout.addStretch()

        return group

    def _create_positions_section(self) -> QGroupBox:
        """Create open positions section"""
        group = QGroupBox("Open Positions")
        layout = QVBoxLayout(group)

        self._positions_table = QTableWidget()
        self._positions_table.setColumnCount(6)
        self._positions_table.setHorizontalHeaderLabels([
            "종목코드", "종목명", "수량", "매입가", "현재가", "수익률"
        ])
        self._positions_table.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)
        self._positions_table.setSelectionBehavior(QTableWidget.SelectRows)

        layout.addWidget(self._positions_table)

        return group

    def _create_signals_section(self) -> QGroupBox:
        """Create pending signals section"""
        group = QGroupBox("Pending Signals")
        layout = QVBoxLayout(group)

        self._signals_list = QTableWidget()
        self._signals_list.setColumnCount(5)
        self._signals_list.setHorizontalHeaderLabels([
            "시간", "방향", "종목", "가격", "액션"
        ])
        self._signals_list.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)

        layout.addWidget(self._signals_list)

        return group

    def _create_order_history_section(self) -> QGroupBox:
        """Create order history section"""
        group = QGroupBox("Order History")
        layout = QVBoxLayout(group)

        # Will be replaced with OrderHistoryWidget
        self._order_history = OrderHistoryWidget()
        layout.addWidget(self._order_history)

        return group

    def _connect_signals(self):
        """Connect runner signals for updates"""
        self._runner.add_signal_handler(self._on_signal_received)
        self._runner.add_order_handler(self._on_order_updated)

    def _start_update_timer(self):
        """Start timer for periodic updates"""
        self._update_timer = QTimer(self)
        self._update_timer.timeout.connect(self._update_display)
        self._update_timer.start(1000)  # Update every second

    def _update_display(self):
        """Update all display elements"""
        self._update_account_summary()
        self._update_positions()
        self._update_status()

    def _update_account_summary(self):
        """Update account summary values"""
        risk_status = self._runner.get_risk_status()

        self._positions_label.setText(
            f"Positions: {risk_status.current_positions}/{risk_status.max_positions}"
        )

        pnl = risk_status.daily_pnl
        pnl_color = "#27ae60" if pnl >= 0 else "#c0392b"
        self._daily_pnl_label.setText(f"Daily P&L: ₩{pnl:+,.0f}")
        self._daily_pnl_label.setStyleSheet(f"color: {pnl_color}; font-weight: bold;")

    def _update_positions(self):
        """Update positions table"""
        positions = self._runner._positions

        self._positions_table.setRowCount(len(positions))

        for row, (symbol, pos) in enumerate(positions.items()):
            self._positions_table.setItem(row, 0, QTableWidgetItem(symbol))
            self._positions_table.setItem(row, 1, QTableWidgetItem(pos.symbol_name))
            self._positions_table.setItem(row, 2, QTableWidgetItem(str(pos.quantity)))
            self._positions_table.setItem(row, 3, QTableWidgetItem(f"₩{pos.entry_price:,.0f}"))
            self._positions_table.setItem(row, 4, QTableWidgetItem(f"₩{pos.current_price:,.0f}"))

            # P&L percentage
            pnl_pct = ((pos.current_price - pos.entry_price) / pos.entry_price) * 100
            pnl_item = QTableWidgetItem(f"{pnl_pct:+.1f}%")
            pnl_item.setForeground(
                Qt.green if pnl_pct >= 0 else Qt.red
            )
            self._positions_table.setItem(row, 5, pnl_item)

    def _update_status(self):
        """Update session status display"""
        status = self._session.status.value
        self._status_label.setText(f"Status: {status.title()}")

    def _on_signal_received(self, signal: TradingSignal):
        """Handle new trading signal"""
        # Add to signals list
        row = self._signals_list.rowCount()
        self._signals_list.insertRow(row)
        # ... populate row

    def _on_order_updated(self, order: LiveOrder):
        """Handle order update"""
        self._order_history.add_order(order)
```

## Acceptance Criteria

- [ ] Dashboard layout matches wireframe
- [ ] Header shows strategy name, account, status
- [ ] Header has red background (live trading indicator)
- [ ] Stop button emits stop_requested signal
- [ ] Account summary shows balance, positions, daily P&L
- [ ] Positions table shows open positions with P&L
- [ ] P&L color coded (green positive, red negative)
- [ ] Pending signals list shows unconfirmed signals
- [ ] Order history section shows completed orders
- [ ] Auto-updates every second
- [ ] Receives signals and orders from runner

## Dependencies

- **Upstream**: E13-F02 (Runner), E13-F01 (Entities), E13-F04-T06 (OrderHistoryWidget)
- **Downstream**: None (final UI)

## Testing

```python
def test_dashboard_updates_positions(qtbot):
    dashboard = create_dashboard_with_runner()
    runner.add_position(create_position("005930", 100, 70000, 72000))
    dashboard._update_positions()
    assert dashboard._positions_table.rowCount() == 1
    assert "+2.9%" in dashboard._positions_table.item(0, 5).text()

def test_dashboard_pnl_color_coding(qtbot):
    dashboard = create_dashboard()
    dashboard._runner._daily_pnl = Decimal(1000000)
    dashboard._update_account_summary()
    assert "#27ae60" in dashboard._daily_pnl_label.styleSheet()  # green
```

---
*Estimated: 5 hours | Risk: Medium*
