# Spec: E13-F02-T02 - Implement Prerequisite Checking Logic

---
id: E13-F02-T02
clickup_task_id: '86ew0fphy'
title: Implement Prerequisite Checking Logic
type: task
parent: E13-F02
epic: E13
feature: F02
domain: live-trading
status: draft
priority: high
created: '2025-12-30'
updated: '2025-12-30'
estimated_hours: 3
actual_hours: 0
tags: [prerequisites, validation, safety]
effort: medium
risk: medium
parallel: false
---

**Status**: Draft | **Type**: Task | **Parent**: E13-F02 | **Parallel**: No

## Summary

Implement the `check_prerequisites` method in `LiveTradingSessionManager` that validates all safety requirements before allowing live trading to begin. This includes checking backtest results, paper trading history, risk configuration, and broker connectivity.

## Implementation Details

### File Location
`src/application/live_trading/session_manager.py` (add to existing class)

### check_prerequisites Implementation

```python
async def check_prerequisites(
    self,
    strategy: Strategy
) -> PreRequisiteCheck:
    """
    Check all prerequisites for live trading.

    Evaluates:
    1. Backtest performance (Sharpe ratio >= threshold)
    2. Paper trading history (minimum days completed)
    3. Risk parameters configured
    4. Broker connected and healthy
    5. Account verified

    Returns PreRequisiteCheck with detailed results.
    """
    # Check backtest history
    backtest = await self._get_latest_backtest(strategy.id)
    backtest_passed = False
    backtest_sharpe = None
    backtest_total_trades = None

    if backtest:
        backtest_sharpe = backtest.metrics.sharpe_ratio
        backtest_total_trades = backtest.metrics.total_trades
        # Default threshold is 1.0, can be customized in risk_controls
        threshold = 1.0
        if strategy.risk_config:
            threshold = strategy.risk_config.require_backtest_sharpe or 1.0
        backtest_passed = backtest_sharpe >= threshold

    # Check paper trading history
    paper_sessions = await self._get_paper_trading_sessions(strategy.id)
    paper_trading_days = len(paper_sessions)
    paper_trading_pnl = sum(s.total_pnl for s in paper_sessions) if paper_sessions else 0

    # Default threshold is 5 days
    required_days = 5
    if strategy.risk_config:
        required_days = strategy.risk_config.require_paper_trading_days or 5
    paper_trading_passed = paper_trading_days >= required_days

    # Check risk parameters
    risk_parameters_set = strategy.risk_config is not None

    # Check broker connectivity
    healthy_brokers = self._broker_registry.get_healthy()
    broker_connected = len(healthy_brokers) > 0

    # Account verification (placeholder - implement based on broker API)
    account_verified = True  # TODO: Implement actual verification

    # Get account balance if broker connected
    account_balance = None
    if broker_connected and healthy_brokers:
        try:
            broker = healthy_brokers[0]
            account_info = await broker.get_account_info()
            account_balance = float(account_info.balance)
        except Exception:
            pass

    return PreRequisiteCheck(
        strategy_id=strategy.id,
        backtest_passed=backtest_passed,
        backtest_sharpe=backtest_sharpe,
        backtest_total_trades=backtest_total_trades,
        paper_trading_passed=paper_trading_passed,
        paper_trading_days=paper_trading_days,
        paper_trading_pnl=paper_trading_pnl,
        risk_parameters_set=risk_parameters_set,
        broker_connected=broker_connected,
        account_verified=account_verified,
        account_balance=account_balance
    )

async def _get_latest_backtest(self, strategy_id: int):
    """Get the most recent backtest for a strategy"""
    return await self._backtest_repo.get_latest_by_strategy(strategy_id)

async def _get_paper_trading_sessions(self, strategy_id: int):
    """Get paper trading sessions for a strategy"""
    return await self._paper_session_repo.get_by_strategy(strategy_id)
```

## Acceptance Criteria

- [ ] Checks backtest Sharpe ratio against threshold
- [ ] Checks paper trading days against threshold
- [ ] Checks risk parameters are configured
- [ ] Checks broker connectivity
- [ ] Checks account verification
- [ ] Returns complete PreRequisiteCheck with all details
- [ ] Handles missing backtest gracefully
- [ ] Handles missing paper trading sessions gracefully
- [ ] Uses configurable thresholds from strategy.risk_config

## Dependencies

- **Upstream**: E13-F02-T01, E12 (Paper Trading), E03 (Broker)
- **Downstream**: Used by start_session

## Testing

```python
async def test_check_prerequisites_all_pass():
    manager = create_test_manager()
    strategy = create_strategy_with_all_requirements()
    check = await manager.check_prerequisites(strategy)
    assert check.all_passed == True
    assert check.backtest_sharpe >= 1.0
    assert check.paper_trading_days >= 5

async def test_check_prerequisites_no_backtest():
    manager = create_test_manager(backtest=None)
    strategy = create_strategy()
    check = await manager.check_prerequisites(strategy)
    assert check.backtest_passed == False
    assert check.backtest_sharpe is None

async def test_check_prerequisites_low_sharpe():
    manager = create_test_manager(backtest_sharpe=0.5)
    strategy = create_strategy()
    check = await manager.check_prerequisites(strategy)
    assert check.backtest_passed == False
    assert "backtest" in check.failed_checks
```

---
*Estimated: 3 hours | Risk: Medium*
