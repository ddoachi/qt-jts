# Spec: E13-F02 - Live Trading Engine

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E13-F02
clickup_task_id: ''    # REQUIRED - Empty string if not yet created in ClickUp
title: Live Trading Engine
type: feature

# === HIERARCHY ===
parent: E13
children: [E13-F02-T01, E13-F02-T02, E13-F02-T03, E13-F02-T04]
epic: E13
feature: F02
domain: live-trading

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 16
actual_hours: 0

# === METADATA ===
tags: [engine, session-manager, runner, risk-controls, live-trading]
effort: large
risk: high
---

**Status**: Draft
**Type**: Feature
**Parent**: E13 (Live Trading)
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Executive Summary

Implement the core live trading engine consisting of `LiveTradingSessionManager` and `LiveTradingRunner`. The SessionManager handles session lifecycle (create, start, stop, pause) and prerequisite validation. The Runner executes the main trading loop, processing signals, applying risk controls, and coordinating with the order execution layer. This is the heart of the live trading system where strategy signals become real trades.

## Execution Flow

```
1. SessionManager.check_prerequisites(strategy)
   -> Get latest backtest results for strategy
   -> Get paper trading session history
   -> Check risk parameters are configured
   -> Check broker connectivity
   -> Return PreRequisiteCheck result
   -> If any check fails: Log warning, return failed check

2. SessionManager.start_session(config)
   -> Verify prerequisites via check_prerequisites()
   -> If prerequisites fail: Raise PreRequisiteNotMetError
   -> Get broker from registry by broker_id
   -> If broker not found: Raise BrokerNotFoundError
   -> Create LiveTradingSession entity
   -> Save session to repository
   -> Create LiveTradingRunner instance
   -> Store runner in active_sessions dict
   -> Start runner in background task
   -> Return session

3. LiveTradingRunner.run()
   -> Set _is_running = True
   -> Load existing positions from broker
   -> Enter main loop while _is_running:
     -> Check if within trading hours
       -> If outside hours: Sleep 60s, continue
     -> Check daily loss limit
       -> If limit reached: Log warning, sleep 60s, continue
     -> For each symbol in session.symbols:
       -> Call _process_symbol(symbol)
     -> Sleep 1s (configurable tick interval)

4. LiveTradingRunner._process_symbol(symbol)
   -> Get latest quote from broker
   -> If no quote: Return early
   -> If position exists for symbol:
     -> Update current price
     -> Call _check_exit(symbol, quote)
   -> Else (no position):
     -> Call _check_entry(symbol, quote)

5. LiveTradingRunner._check_entry(symbol, quote)
   -> Get recent candles from broker
   -> Convert to DataFrame
   -> Evaluate strategy entry rule via ProcessingEngine
   -> If entry rule not triggered: Return
   -> Run risk checks via _passes_risk_check(quote)
   -> If risk check fails: Return
   -> Calculate position size
   -> Generate TradingSignal
   -> Emit signal to handlers
   -> If execution_mode == AUTO: Execute order immediately
   -> If MANUAL/SEMI_AUTO: Wait for user confirmation

6. LiveTradingRunner._passes_risk_check(quote)
   -> Check max_positions limit
   -> Check position_size_pct limit
   -> Check daily_loss limit
   -> Return True only if all checks pass
```

## User Stories

### Primary User Story
**As a** trader
**I want to** have my validated strategy execute trades automatically
**So that** I can capture trading opportunities without constant manual monitoring

### Additional Stories
- **As a** trader, **I want to** have prerequisites verified before live trading starts, **So that** I don't accidentally trade with an untested strategy
- **As a** trader, **I want to** have risk limits enforced automatically, **So that** I'm protected from excessive losses
- **As a** trader, **I want to** have the trading engine respect market hours, **So that** I don't attempt trades outside valid trading times
- **As a** trader, **I want to** be able to pause and resume trading sessions, **So that** I can take breaks without losing my session state

## Acceptance Scenarios

### Scenario 1: Successful Session Start
**Given** a strategy that has passed backtesting (Sharpe > 1.0) and paper trading (5+ days)
**And** risk parameters are configured
**And** broker is connected
**When** start_session() is called with valid config
**Then** a new LiveTradingSession should be created with status RUNNING
**And** a LiveTradingRunner should start executing
**And** the session should be stored in the repository

### Scenario 2: Prerequisites Not Met
**Given** a strategy that has not been paper traded
**When** start_session() is called
**Then** PreRequisiteNotMetError should be raised
**And** no session should be created
**And** the error should contain details about which prerequisite failed

### Scenario 3: Risk Control - Max Positions
**Given** an active session with max_positions = 5
**And** 5 positions are already open
**When** an entry signal is generated for a new symbol
**Then** the signal should be blocked by risk controls
**And** no order should be placed
**And** the blocked signal should be logged

### Scenario 4: Risk Control - Daily Loss Limit
**Given** an active session with max_daily_loss_pct = 5.0
**And** current daily P&L is -5.5%
**When** the trading loop iterates
**Then** trading should be paused
**And** a warning should be logged
**And** no new signals should be processed

### Scenario 5: Outside Trading Hours
**Given** an active session with trading_hours 09:00-15:30
**And** current time is 16:00
**When** the trading loop iterates
**Then** no symbols should be processed
**And** the runner should sleep until next check

### Scenario 6: Auto Execution Mode
**Given** an active session with execution_mode = AUTO
**When** an entry signal passes all risk checks
**Then** an order should be placed immediately without user confirmation
**And** the order should be tracked in the session

## Requirements

### Functional Requirements
- **FR-001**: System MUST validate all prerequisites before starting live trading
- **FR-002**: System MUST support session lifecycle: start, pause, resume, stop
- **FR-003**: System MUST enforce max_positions risk limit
- **FR-004**: System MUST enforce max_position_size_pct risk limit
- **FR-005**: System MUST enforce max_daily_loss_pct limit and pause trading when reached
- **FR-006**: System MUST respect trading hours configuration
- **FR-007**: System MUST evaluate entry/exit rules from strategy
- **FR-008**: System MUST emit signals for both MANUAL and AUTO modes
- **FR-009**: System MUST execute orders immediately in AUTO mode

### Non-Functional Requirements
- **NFR-001**: Main loop MUST have configurable tick interval (default 1s)
- **NFR-002**: Risk checks MUST complete in < 10ms
- **NFR-003**: Signal processing MUST complete in < 100ms
- **NFR-004**: Engine MUST handle broker disconnections gracefully
- **NFR-005**: Engine MUST log all trading decisions for audit

### Technical Constraints
- **TC-001**: Must use asyncio for concurrent operations
- **TC-002**: Must use dependency injection for broker and repositories
- **TC-003**: Must integrate with ProcessingEngine for formula evaluation
- **TC-004**: Must use repository pattern for session persistence
- **TC-005**: Must emit signals via observer pattern for UI updates

## Key Entities

### Entity: LiveTradingSessionManager
- **Description**: Manages lifecycle of live trading sessions
- **Key Attributes**: `_broker_registry`, `_engine`, `_session_repo`, `_order_repo`, `_active_sessions`
- **Relationships**: Creates LiveTradingRunner instances, uses repositories

### Entity: LiveTradingRunner
- **Description**: Executes the main trading loop for a session
- **Key Attributes**: `_session`, `_broker`, `_engine`, `_is_running`, `_daily_pnl`, `_positions`
- **Relationships**: Uses broker gateway, emits signals

## Dependencies

### Upstream Dependencies
- [ ] E13-F01: Domain Models (LiveTradingSession, RiskControls, etc.)
- [ ] E03: Broker Integration (IBrokerGateway, IBrokerRegistry)
- [ ] E09: Strategy & ProcessingEngine (formula evaluation)
- [ ] E12: Paper Trading (session history for prerequisites)

### Downstream Impact
- [ ] E13-F03: Order Execution (receives orders from Runner)
- [ ] E13-F04: UI Components (receives signals for display)

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Performance requirements specified (< 10ms risk check, < 100ms signal)
- [x] Security requirements defined (audit logging, no credential storage)
- [x] Scale requirements clear (single session, ~20 symbols max)
- [x] PRD compliance verified (Section 5.8)

### Quality Gates
- [ ] Complexity justified (optimal granularity per auto-split analysis)
- [ ] All requirements testable
- [ ] Dependencies identified and documented
- [ ] Risk assessment complete

## Tasks Preview

### Implementation Tasks
- [ ] T01 Implement LiveTradingSessionManager core (depends on F01)
- [ ] T02 Implement prerequisite checking logic (depends on T01, E03, E12)
- [ ] T03 Implement LiveTradingRunner with main loop (depends on F01, E03)
- [ ] T04 Implement risk control enforcement (depends on T03)

## Success Criteria

### Acceptance Criteria
- [ ] SessionManager creates and manages sessions correctly
- [ ] Prerequisites are validated before session start
- [ ] PreRequisiteNotMetError raised when conditions not met
- [ ] Runner executes main loop with correct tick interval
- [ ] Trading hours are respected
- [ ] Daily loss limit pauses trading
- [ ] Max positions limit is enforced
- [ ] Position size limit is enforced
- [ ] Signals emitted for entry/exit conditions
- [ ] AUTO mode executes orders immediately
- [ ] All decisions are logged for audit

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Tests passing (unit, integration)
  - [ ] Unit tests for SessionManager lifecycle
  - [ ] Unit tests for prerequisite checking
  - [ ] Unit tests for risk control checks
  - [ ] Integration tests for runner loop
  - [ ] Integration tests with mock broker
- [ ] Documentation updated (pre-docs, post-docs)
- [ ] 85% test coverage achieved
- [ ] Performance validated (risk check < 10ms)

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Race conditions in async code | Medium | High | Use locks for shared state, thorough testing |
| Broker disconnection during order | Medium | High | Implement retry logic, state recovery |
| Incorrect risk calculation | Low | Critical | Extensive unit tests, code review |
| Memory leak in long-running sessions | Low | Medium | Monitor memory, cleanup handlers |
| Unhandled exceptions crash runner | Medium | High | Comprehensive exception handling, restart logic |

## Notes and Clarifications

### Open Questions
None - Engine design is clear from E13 spec

### Decisions Made
- 2025-12-30: Use asyncio for concurrent broker operations
- 2025-12-30: Default tick interval is 1 second
- 2025-12-30: Trading is paused (not stopped) when daily limit reached
- 2025-12-30: All trading decisions logged for audit trail
- 2025-12-30: Runner uses observer pattern for signal emission

### Research Needed
None - Standard async patterns apply

## Artifacts

### Input Documents
- [Product Requirements Document](../../../docs/product-requirements-document.md) (Section 5.8)
- [Parent Spec](../E13.spec.md) (Epic E13)
- [Domain Models Spec](../F01/E13-F01.spec.md)

### Output Artifacts (to be generated)
- [ ] `E13-F02.context.md` - Implementation context and progress
- [ ] `E13-F02.pre-docs.md` - Pre-implementation documentation
- [ ] `E13-F02.post-docs.md` - Post-implementation learnings
- [ ] Unit tests: `tests/unit/application/test_live_trading_engine.py`
- [ ] Integration tests: `tests/integration/test_live_trading_flow.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
