# Spec: E03 - Broker Integration

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E03
clickup_task_id: ''
title: Broker Integration
type: epic

# === HIERARCHY ===
parent: null
children:
  - E03-F01
  - E03-F02
  - E03-F03
  - E03-F04
  - E03-F05
epic: E03
feature: null
task: null
domain: broker

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 80
actual_hours: 0

# === METADATA ===
tags:
  - broker
  - grpc
  - trading
  - rate-limiting
effort: epic
risk: medium
---

**Status**: Draft
**Type**: Epic
**Parent**: null
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Integrate with Korean stock brokers (KIS, Creon, Kiwoom) via gRPC for real-time and historical market data, account balance and position queries, order placement and management, and rate limit compliance. The existing JTS project has a gRPC server running on Windows that wraps the Creon COM API, enabling cross-platform broker access from the Qt desktop application.

## Execution Flow

```
1. Initialize broker configuration
   → If missing config: ERROR "Broker configuration not found"
   → Load broker settings from config file
2. Establish gRPC connection to JTS server
   → If connection fails: WARN "Connection failed, retrying..."
   → Validate server health
3. Initialize rate limiter per broker
   → Configure token bucket with broker-specific limits
   → Start usage monitoring
4. Register broker gateway in registry
   → Track connection status
   → Enable health checks
5. Ready for broker operations
   → Return: SUCCESS with connected gateway
```

## User Stories

### Primary User Story
**As a** trader
**I want to** connect to multiple Korean stock brokers
**So that** I can access market data and execute trades across different brokers

### Additional Stories
- **As a** developer, **I want to** use a mock broker gateway, **So that** I can develop and test without real broker connections
- **As a** user, **I want to** see rate limit usage, **So that** I know when I'm approaching API limits
- **As a** trader, **I want to** manage multiple accounts per broker, **So that** I can trade with different account types

## Acceptance Scenarios

### Scenario 1: Happy Path - Connect to Broker
**Given** valid broker configuration with gRPC endpoint
**When** user initiates broker connection
**Then** connection is established and broker is registered in registry

### Scenario 2: Edge Case - Rate Limit Reached
**Given** broker rate limit is at capacity
**When** new API request is made
**Then** request is queued until token available

### Scenario 3: Error Case - Connection Failure
**Given** gRPC server is unavailable
**When** connection attempt is made
**Then** system falls back to offline mode with cached data

## Requirements

### Functional Requirements
- **FR-001**: System MUST connect to JTS gRPC server and fetch symbol list
- **FR-002**: System MUST fetch historical candles with rate limiting
- **FR-003**: System MUST query account balance and positions
- **FR-004**: System MUST place and cancel orders (paper trading mode)
- **FR-005**: System MUST display real-time rate limit usage

### Non-Functional Requirements
- **NFR-001**: Performance: < 100ms latency for gRPC calls (local network)
- **NFR-002**: Reliability: Auto-reconnect on connection failure
- **NFR-003**: Availability: Graceful degradation when broker unavailable
- **NFR-004**: Testability: MockBrokerGateway enables full offline testing

### Technical Constraints
- **TC-001**: Must use existing proto definitions from `project-jts/jts/schemas/protobuf/`
- **TC-002**: Must support KIS (20 req/sec), Creon (15 req/sec), Kiwoom (5 req/sec) rate limits
- **TC-003**: Must use Python gRPC async client

## Key Entities

### Entity: BrokerConfig
- **Description**: Broker connection configuration
- **Key Attributes**: broker_type, grpc_host, grpc_port, rate_limit, accounts
- **Relationships**: Has many AccountConfig

### Entity: Balance
- **Description**: Account balance value object
- **Key Attributes**: account_id, total_equity, cash_balance, buying_power, currency
- **Relationships**: Belongs to Account

### Entity: Position
- **Description**: Stock position value object
- **Key Attributes**: symbol_code, symbol_name, quantity, avg_price, current_price
- **Relationships**: Belongs to Account

### Entity: Order
- **Description**: Trading order entity
- **Key Attributes**: id, account_id, symbol_code, side, order_type, quantity, price, status
- **Relationships**: Belongs to Account, creates Position

## Dependencies

### Upstream Dependencies
- [ ] E01: Qt Framework for UI components
- [ ] E02: Storage for cached data
- [ ] JTS gRPC Server: Running on Windows with Creon HTS

### Downstream Impact
- [ ] E04 (Charting): Will use broker data for charts
- [ ] E05 (Backtesting): Will use broker data for backtests

## Gate Checks

### Pre-Implementation Gates
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Performance requirements specified
- [x] Security requirements defined
- [x] Scale requirements clear
- [x] PRD compliance verified

### Quality Gates
- [ ] Complexity justified if exceeding guidelines
- [x] All requirements testable
- [x] Dependencies identified
- [x] Risk assessment complete

## Child Specs

### Features

| ID | Title | Status | Tasks | Effort |
|----|-------|--------|-------|--------|
| [E03-F01](F01/E03-F01.spec.md) | Domain Entities & Interfaces | Draft | 3 | M |
| [E03-F02](F02/E03-F02.spec.md) | gRPC Integration | Draft | 3 | L |
| [E03-F03](F03/E03-F03.spec.md) | Mock Gateway | Draft | 2 | M |
| [E03-F04](F04/E03-F04.spec.md) | Broker Registry | Draft | 2 | M-L |
| [E03-F05](F05/E03-F05.spec.md) | UI Components | Draft | 2 | M-L |

### Tasks by Feature

#### E03-F01: Domain Entities & Interfaces
| ID | Title | Effort | Wave |
|----|-------|--------|------|
| [E03-F01-T01](F01/T01/E03-F01-T01.spec.md) | Define domain entities | M | 1 |
| [E03-F01-T02](F01/T02/E03-F01-T02.spec.md) | Define IBrokerGateway interface | M | 2 |
| [E03-F01-T03](F01/T03/E03-F01-T03.spec.md) | Implement RateLimiter | M | 1 |

#### E03-F02: gRPC Integration
| ID | Title | Effort | Wave |
|----|-------|--------|------|
| [E03-F02-T01](F02/T01/E03-F02-T01.spec.md) | Generate Python gRPC stubs | M | 1 |
| [E03-F02-T02](F02/T02/E03-F02-T02.spec.md) | Implement GrpcBrokerGateway | L | 2 |
| [E03-F02-T03](F02/T03/E03-F02-T03.spec.md) | Implement connection management | M | 3 |

#### E03-F03: Mock Gateway
| ID | Title | Effort | Wave |
|----|-------|--------|------|
| [E03-F03-T01](F03/T01/E03-F03-T01.spec.md) | Implement MockBrokerGateway | M | 2 |
| [E03-F03-T02](F03/T02/E03-F03-T02.spec.md) | Create mock data generators | M | 3 |

#### E03-F04: Broker Registry
| ID | Title | Effort | Wave |
|----|-------|--------|------|
| [E03-F04-T01](F04/T01/E03-F04-T01.spec.md) | Implement BrokerRegistry | M | 3 |
| [E03-F04-T02](F04/T02/E03-F04-T02.spec.md) | Create broker configuration UI | L | 4 |

#### E03-F05: UI Components
| ID | Title | Effort | Wave |
|----|-------|--------|------|
| [E03-F05-T01](F05/T01/E03-F05-T01.spec.md) | Create RateLimitIndicator widget | M | 2 |
| [E03-F05-T02](F05/T02/E03-F05-T02.spec.md) | Create BrokerStatusWidget | L | 4 |

## Wave Analysis (Parallelization)

```
Wave 1 (Parallel - Foundation):     3 tasks
├── E03-F01-T01: Define domain entities
├── E03-F01-T03: Implement RateLimiter
└── E03-F02-T01: Generate Python gRPC stubs

Wave 2 (Parallel - Core):           4 tasks
├── E03-F01-T02: Define IBrokerGateway interface
├── E03-F02-T02: Implement GrpcBrokerGateway
├── E03-F03-T01: Implement MockBrokerGateway
└── E03-F05-T01: Create RateLimitIndicator widget

Wave 3 (Parallel - Integration):    3 tasks
├── E03-F02-T03: Implement connection management
├── E03-F03-T02: Create mock data generators
└── E03-F04-T01: Implement BrokerRegistry

Wave 4 (Parallel - UI):             2 tasks
├── E03-F04-T02: Create broker configuration UI
└── E03-F05-T02: Create BrokerStatusWidget
```

**Total Waves**: 4
**Max Parallelism**: 4 concurrent tasks
**Critical Path**: F01-T01 → F01-T02 → F02-T02 → F04-T02

## Success Criteria

### Acceptance Criteria
- [ ] All functional requirements implemented
- [ ] All acceptance scenarios pass
- [ ] Performance targets met (< 100ms)
- [ ] Zero critical bugs
- [ ] 80% test coverage

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Tests passing (unit, integration)
- [ ] Documentation updated
- [ ] Performance validated
- [ ] Deployed to staging

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Rate limit exceeded | Medium | High | Token bucket rate limiter |
| gRPC server unavailable | Medium | High | Mock gateway fallback |
| Connection instability | Low | Medium | Auto-reconnection logic |
| Proto file changes | Low | Medium | Version lock, monitoring |

## Notes and Clarifications

### Open Questions
- None currently

### Decisions Made
- 2025-12-28: Use gRPC for cross-platform broker access
- 2025-12-28: Reuse existing JTS proto definitions
- 2025-12-28: Token bucket algorithm for rate limiting

### Research Needed
- [ ] Verify JTS gRPC server proto compatibility
- [ ] Benchmark gRPC latency on local network

## Artifacts

### Input Documents
- [Product Requirements](../../docs/prd.md)

### Output Artifacts (to be generated)
- [ ] `E03.context.md` - Implementation context and progress
- [ ] `E03.pre-docs.md` - Pre-implementation documentation
- [ ] `E03.post-docs.md` - Post-implementation learnings

## Architecture

### Broker Abstraction

```
┌─────────────────────────────────────────────────────────────┐
│                      Domain Layer                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ IBrokerGateway                                         │  │
│  │ ├─ get_symbols() -> list[Symbol]                       │  │
│  │ ├─ get_candles(symbol, timeframe, start, end)         │  │
│  │ ├─ get_balance(account_id) -> Balance                  │  │
│  │ ├─ get_positions(account_id) -> list[Position]        │  │
│  │ ├─ place_order(order) -> OrderResult                   │  │
│  │ └─ get_order_status(order_id) -> OrderStatus          │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │ GrpcBrokerGateway│ │ MockBrokerGateway│ │ RateLimiter │ │
│  │ (Production)     │ │ (Testing)        │ │             │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### gRPC Gateway Architecture

```
┌─────────────────────────┐         ┌─────────────────────────┐
│  Qt Desktop App         │  gRPC   │  JTS gRPC Server        │
│  (Linux/macOS/Windows)  │────────►│  (Windows)              │
│                         │         │                         │
│  - BrokerGateway        │         │  - Creon COM wrapper    │
│  - Rate Limiter         │         │  - KIS REST client      │
└─────────────────────────┘         └─────────────────────────┘
```

## References

- [gRPC Python](https://grpc.io/docs/languages/python/)
- [Token Bucket Algorithm](https://en.wikipedia.org/wiki/Token_bucket)
- PRD Section 5.0: Broker & Account Management
- Existing JTS: `/home/joohan/dev/project-jts/jts/libs/grpc/`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
