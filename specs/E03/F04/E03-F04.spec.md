# Spec: E03-F04 - Broker Registry

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E03-F04
clickup_task_id: ''
title: Broker Registry
type: feature

# === HIERARCHY ===
parent: E03
children:
  - E03-F04-T01
  - E03-F04-T02
epic: E03
feature: F04
task: null
domain: broker

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 20
actual_hours: 0

# === METADATA ===
tags:
  - registry
  - management
  - ui
  - configuration
effort: medium
risk: low
---

**Status**: Draft
**Type**: Feature
**Parent**: E03
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement a central registry for managing multiple broker gateways. This provides centralized broker lifecycle management, health monitoring for all connections, and a broker configuration UI for users to add/remove brokers and accounts.

## Execution Flow

```
1. Implement BrokerRegistry
   → Thread-safe registration and lookup
   → Status tracking per broker
   → Health monitoring support
2. Create broker configuration UI
   → Display all configured brokers
   → Add/edit/remove broker configurations
   → Account management per broker
   → Return: SUCCESS with registry and UI ready
```

## User Stories

### Primary User Story
**As a** user
**I want to** manage my broker configurations
**So that** I can connect to multiple brokers with different accounts

### Additional Stories
- **As a** developer, **I want to** a central registry, **So that** I can access any broker easily
- **As a** user, **I want to** see broker status, **So that** I know which brokers are connected

## Acceptance Scenarios

### Scenario 1: Register Broker
**Given** a configured broker gateway
**When** it is registered in the registry
**Then** it can be retrieved by ID

### Scenario 2: List All Brokers
**Given** multiple registered brokers
**When** list_all() is called
**Then** all brokers with status are returned

### Scenario 3: Configure via UI
**Given** broker configuration dialog
**When** user adds new broker
**Then** broker is registered and connection tested

## Requirements

### Functional Requirements
- **FR-001**: Register and unregister broker gateways
- **FR-002**: Thread-safe broker lookup
- **FR-003**: List all brokers with status information
- **FR-004**: UI displays all configured brokers and accounts

### Non-Functional Requirements
- **NFR-001**: Thread-safe with RLock
- **NFR-002**: Fast lookup O(1) by broker ID
- **NFR-003**: UI updates reflect registry changes

### Technical Constraints
- **TC-001**: Use Qt for UI components
- **TC-002**: Support Korean text (UTF-8)

## Key Entities

### Entity: BrokerRegistry
- **Description**: Central registry for broker management
- **Key Attributes**: brokers, configs, metadata
- **Relationships**: Contains multiple IBrokerGateway instances

### Entity: BrokerInfo
- **Description**: Information about a registered broker
- **Key Attributes**: broker_id, broker_type, status, rate_limit_usage
- **Relationships**: Represents a registered broker

## Dependencies

### Upstream Dependencies
- [ ] E03-F01: Domain entities and interfaces
- [ ] E03-F02: gRPC gateway implementation
- [ ] E03-F03: Mock gateway implementation
- [ ] E01: Qt framework for UI

### Downstream Impact
- [ ] E03-F05: Status widgets use registry data

## Gate Checks

### Pre-Implementation Gates
- [x] Gateway implementations ready (F02, F03)
- [x] Entity definitions clear

### Quality Gates
- [ ] Thread safety tests
- [ ] UI integration tests
- [ ] Concurrent access tests

## Tasks Preview

| ID | Title | Effort | Wave | Dependencies |
|----|-------|--------|------|--------------|
| [E03-F04-T01](T01/E03-F04-T01.spec.md) | Implement BrokerRegistry | M | 3 | F01, F02, F03 |
| [E03-F04-T02](T02/E03-F04-T02.spec.md) | Create broker configuration UI | L | 4 | T01, E01 |

## Success Criteria

### Acceptance Criteria
- [ ] Registry working correctly
- [ ] UI functional and responsive
- [ ] Thread-safe operations verified
- [ ] 80% test coverage

### Definition of Done
- [ ] Code reviewed
- [ ] Tests passing
- [ ] UI tested manually

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Thread safety bugs | Low | High | RLock and thorough testing |
| UI responsiveness | Low | Medium | Async operations |

## Notes and Clarifications

### Decisions Made
- 2025-12-28: Use RLock for thread safety
- 2025-12-28: Qt-based configuration UI

## Artifacts

### Input Documents
- [Parent Epic](../E03.spec.md)

### Output Artifacts
- [ ] `E03-F04.pre-docs.md` - Pre-implementation documentation

## UI Mockup

```
┌─────────────────────────────────────────────────────────────────────────┐
│ Broker & Account Management                                              │
├─────────────────────────────────────────────────────────────────────────┤
│ KIS (한국투자증권)                                      [+ 계좌 추가]   │
│ ├─ 계좌 1: 50012345-01 (실전투자)         잔고: ₩52,340,000   [활성] ● │
│ ├─ 계좌 2: 50012345-02 (모의투자)         잔고: ₩100,000,000  [활성] ● │
│ └─ Rate Limit: 20 req/sec                 Used: 12 req/sec    [정상]   │
└─────────────────────────────────────────────────────────────────────────┘
```

## References

- PRD Section 5.0.2: Multi-Account Configuration

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
