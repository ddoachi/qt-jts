---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F04-T03
clickup_task_id: '86ew020j6'
title: Create Function Reference Dialog
type: task

# === HIERARCHY ===
parent: E05-F04
children:
  - E05-F04-T03-S01
  - E05-F04-T03-S02
  - E05-F04-T03-S03
epic: E05
feature: F04
task: T03
domain: ui

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-01-15'
updated: '2025-12-28'
due_date: ''
estimated_hours: 10
actual_hours: 0

# === METADATA ===
tags:
  - function-reference
  - dialog
  - ui
  - wave-6
effort: medium
risk: low
---

# Spec: E05-F04-T03 - Create Function Reference Dialog

---

**Status**: Draft
**Type**: Task
**Parent**: E05-F04
**Created**: 2025-01-15
**Updated**: 2025-12-28

## Executive Summary

Create a dialog that displays all available DSL functions with their signatures, descriptions, and examples. Users can search functions and insert them directly into the editor. The dialog provides categorized navigation and detailed documentation for each function to improve formula authoring discoverability and usability.

## Execution Flow

```
1. Initialize FunctionReferenceDialog
   → Set window title and size (600x400)
   → Set up UI components
2. Populate function list from FUNCTION_DOCS registry
   → Group functions by category
   → Create tree structure with expandable categories
3. On search text change
   → Filter functions by name and description
   → Show matching functions across all categories
4. On function selection
   → Display signature, description, and example in detail panel
   → Enable insert action
5. On function double-click or insert button
   → Emit function_selected signal with function template
   → Close dialog (optional)
6. Return: SUCCESS with selected function template
```

## User Stories

### Primary User Story
**As a** formula author
**I want to** browse and search available DSL functions
**So that** I can discover and use the right function for my trading strategy

### Additional Stories
- **As a** user, **I want to** see function signatures and examples, **So that** I know how to use each function correctly
- **As a** user, **I want to** insert functions directly into my formula, **So that** I can work more efficiently
- **As a** user, **I want to** filter functions by category, **So that** I can find related functions quickly

## Acceptance Scenarios

### Scenario 1: Browse Functions by Category
**Given** the Function Reference Dialog is open
**When** I expand the "Moving Averages" category
**Then** I see SMA, EMA, and Average functions listed

### Scenario 2: Search Functions
**Given** the Function Reference Dialog is open
**When** I type "momentum" in the search box
**Then** I see RSI and MACD functions that match the search term

### Scenario 3: View Function Details
**Given** I select "RSI" from the function list
**When** the detail panel updates
**Then** I see the signature `rsi(period)`, description, and example `rsi(14)`

### Scenario 4: Insert Function into Editor
**Given** I have selected a function
**When** I double-click or click the insert button
**Then** the function template is inserted into the formula editor

## Requirements

### Functional Requirements
- **FR-001**: Dialog MUST display all available DSL functions
- **FR-002**: Functions MUST be grouped by category (Moving Averages, Momentum, Volatility, Range, Cross Detection, Utility)
- **FR-003**: Dialog MUST provide a search box that filters by name and description
- **FR-004**: Dialog MUST show function signature, description, and example in detail panel
- **FR-005**: Dialog MUST support inserting function template via double-click
- **FR-006**: Dialog MUST emit `function_selected` signal with function template

### Non-Functional Requirements
- **NFR-001**: Usability: Dialog must resize to 600x400 default
- **NFR-002**: Performance: Search filtering must be instantaneous
- **NFR-003**: Accessibility: Tree navigation must support keyboard

### Technical Constraints
- **TC-001**: Must extend QDialog
- **TC-002**: Must use QTreeWidget for categorized function list
- **TC-003**: Must integrate with FormulaEditorWidget (E05-F04-T01)

## Key Entities

### Entity: FunctionReferenceDialog
- **Description**: Dialog for browsing and inserting DSL functions
- **Key Attributes**: _search (QLineEdit), _list (QTreeWidget), _detail (QTextBrowser)
- **Relationships**: Launched from FormulaEditorWidget, emits to FormulaEditorWidget

### Entity: FUNCTION_DOCS
- **Description**: Registry of function documentation
- **Key Attributes**: name, signature, description, example, category
- **Relationships**: Data source for FunctionReferenceDialog

## Dependencies

### Upstream Dependencies
- [ ] E05-F04-T01: FormulaEditorWidget to launch dialog from and insert into

### Downstream Impact
- [ ] None: This is a leaf component

## Gate Checks

### Pre-Implementation Gates
- [ ] All DSL functions documented in FUNCTION_DOCS
- [ ] FormulaEditorWidget available for integration
- [ ] UI design approved

### Quality Gates
- [ ] All functions display correctly
- [ ] Search works for name and description
- [ ] Insert functionality works correctly
- [ ] Keyboard navigation works

## Subtasks Preview

| Subtask ID | Title | Effort | Status |
|------------|-------|--------|--------|
| E05-F04-T03-S01 | Create FunctionReferenceDialog with searchable list | M | pending |
| E05-F04-T03-S02 | Add function documentation and examples | M | pending |
| E05-F04-T03-S03 | Implement insert-to-editor functionality | S | pending |

## Success Criteria

### Acceptance Criteria
- [ ] Dialog with searchable function list
- [ ] Functions grouped by category
- [ ] Detail panel with signature, description, example
- [ ] Double-click to insert function template
- [ ] Search filters by name and description
- [ ] 80% test coverage

### Definition of Done
- [ ] Code reviewed and approved
- [ ] All unit tests passing
- [ ] UI mockup matches implementation
- [ ] Integration with FormulaEditorWidget confirmed
- [ ] Documentation updated

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Incomplete function documentation | Medium | Medium | Review all functions before implementation |
| Tree widget complexity | Low | Low | Use standard Qt patterns |
| Search performance | Low | Low | Simple string matching sufficient |
| Insert position issues | Medium | Medium | Clear cursor position handling |

## Artifacts

### Input Documents
- [Parent Feature](../E05-F04.spec.md)
- [FormulaEditorWidget Spec](../T01/E05-F04-T01.spec.md)

### Output Artifacts
- [ ] `libs/ui/formula/reference_dialog.py` - Dialog implementation

### Function Documentation Registry

```python
FUNCTION_DOCS = {
    'sma': {
        'name': 'SMA (Simple Moving Average)',
        'signature': 'sma(field, period)',
        'description': 'Calculate the simple moving average of a field over the specified period.',
        'example': 'sma(close, 20)',
        'category': 'Moving Averages',
    },
    'ema': {
        'name': 'EMA (Exponential Moving Average)',
        'signature': 'ema(field, period)',
        'description': 'Calculate the exponential moving average with more weight on recent values.',
        'example': 'ema(close, 12)',
        'category': 'Moving Averages',
    },
    'rsi': {
        'name': 'RSI (Relative Strength Index)',
        'signature': 'rsi(period)',
        'description': 'Momentum oscillator measuring speed and magnitude of price changes (0-100).',
        'example': 'rsi(14)',
        'category': 'Momentum',
    },
    'macd': {
        'name': 'MACD (Moving Average Convergence Divergence)',
        'signature': 'macd(fast, slow, signal)',
        'description': 'Trend-following momentum indicator showing relationship between two EMAs.',
        'example': 'macd(12, 26, 9)',
        'category': 'Momentum',
    },
    'atr': {
        'name': 'ATR (Average True Range)',
        'signature': 'atr(period)',
        'description': 'Volatility indicator measuring the average range of price movement.',
        'example': 'atr(14)',
        'category': 'Volatility',
    },
    'highest': {
        'name': 'Highest',
        'signature': 'highest(field, period)',
        'description': 'Return the highest value of a field over the specified period.',
        'example': 'highest(high, 52)',
        'category': 'Range',
    },
    'lowest': {
        'name': 'Lowest',
        'signature': 'lowest(field, period)',
        'description': 'Return the lowest value of a field over the specified period.',
        'example': 'lowest(low, 20)',
        'category': 'Range',
    },
    'std': {
        'name': 'Standard Deviation',
        'signature': 'std(field, period)',
        'description': 'Calculate the rolling standard deviation for Bollinger Bands, etc.',
        'example': 'std(close, 20)',
        'category': 'Volatility',
    },
    'lag': {
        'name': 'Lag (Previous Value)',
        'signature': 'lag(field, n)',
        'description': 'Return the value from N bars ago.',
        'example': 'lag(close, 1)',
        'category': 'Utility',
    },
    'average': {
        'name': 'Average (SMA Alias)',
        'signature': 'average(field, period)',
        'description': 'Alias for SMA function.',
        'example': 'average(volume, 20)',
        'category': 'Moving Averages',
    },
    'crosses_above': {
        'name': 'Crosses Above',
        'signature': 'A crosses_above B',
        'description': 'Detect when series A crosses above series B (golden cross).',
        'example': 'sma(close, 20) crosses_above sma(close, 60)',
        'category': 'Cross Detection',
    },
    'crosses_below': {
        'name': 'Crosses Below',
        'signature': 'A crosses_below B',
        'description': 'Detect when series A crosses below series B (death cross).',
        'example': 'sma(close, 20) crosses_below sma(close, 60)',
        'category': 'Cross Detection',
    },
}
```

### UI Mockup

```
+-----------------------------------------------------+
| Function Reference                              [X] |
+-----------------------------------------------------+
| [Search functions...                              ] |
+-----------------------------------------------------+
| > Moving Averages                                   |
|   +- SMA (Simple Moving Average)                    |
|   +- EMA (Exponential Moving Average)               |
|   +- Average (SMA Alias)                            |
| > Momentum                                          |
|   +- RSI (Relative Strength Index)                  |
|   +- MACD (Moving Average Convergence Divergence)   |
| > Volatility                                        |
| > Range                                             |
| > Cross Detection                                   |
+-----------------------------------------------------+
| RSI (Relative Strength Index)                       |
| Signature: rsi(period)                              |
|                                                     |
| Momentum oscillator measuring speed and magnitude   |
| of price changes. Values range from 0 to 100.       |
|                                                     |
| Example: rsi(14)                                    |
|                                                     |
| Double-click to insert                              |
+-----------------------------------------------------+
```

### Technical Implementation

```python
class FunctionReferenceDialog(QDialog):
    """Dialog showing available DSL functions"""

    function_selected = Signal(str)  # Emits function template

    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Function Reference")
        self.resize(600, 400)
        self._setup_ui()

    def _setup_ui(self):
        layout = QVBoxLayout(self)

        # Search box
        self._search = QLineEdit()
        self._search.setPlaceholderText("Search functions...")
        self._search.textChanged.connect(self._filter_functions)

        # Function list with categories
        self._list = QTreeWidget()
        self._list.setHeaderHidden(True)
        self._list.itemDoubleClicked.connect(self._on_select)

        # Detail panel
        self._detail = QTextBrowser()

        layout.addWidget(self._search)
        layout.addWidget(self._list)
        layout.addWidget(self._detail)
```

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
