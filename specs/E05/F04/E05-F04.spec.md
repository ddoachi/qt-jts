---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F04
clickup_task_id: ''
title: Formula Editor UI Components
type: feature

# === HIERARCHY ===
parent: E05
children: [E05-F04-T01, E05-F04-T02, E05-F04-T03]
epic: E05
feature: F04
domain: ui

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 32
actual_hours: 0

# === METADATA ===
tags: [ui, pyqt6, editor, syntax-highlighting]
effort: large
risk: low
---

# Spec: E05-F04 - Formula Editor UI Components

**Status**: Draft
**Type**: Feature
**Parent**: [E05](../E05.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement PyQt6 widgets for formula editing with syntax highlighting, real-time validation, and function reference. These components provide the user interface for creating and editing trading formulas with a professional development experience.

## Execution Flow

```
1. User opens formula editor
   → Initialize editor with syntax highlighter
2. User types formula expression
   → Debounce input (300ms)
3. Validate expression via FormulaService
   → If valid: Show green checkmark
   → If invalid: Show red error with message
4. Update syntax highlighting
   → Color keywords, functions, fields, parameters
5. User clicks Functions Reference
   → Show dialog with searchable function list
6. User double-clicks function
   → Insert function template at cursor
```

## User Stories

### Primary User Story
**As a** trader
**I want to** edit formulas with syntax highlighting
**So that** I can easily read and write complex expressions

### Additional Stories
- **As a** trader, **I want to** see validation errors in real-time, **So that** I can fix mistakes quickly
- **As a** trader, **I want to** browse available functions, **So that** I can discover DSL capabilities
- **As a** trader, **I want to** edit parameters with a UI, **So that** I don't have to modify expression text

## Acceptance Scenarios

### Scenario 1: Syntax Highlighting
**Given** formula "rsi(14) < 30 AND close > sma(close, 20)"
**When** displayed in editor
**Then** keywords (AND) blue, functions (rsi, sma) yellow, fields (close) light blue, numbers green

### Scenario 2: Real-time Validation
**Given** user typing "close >"
**When** 300ms after last keystroke
**Then** red error message shown below editor

### Scenario 3: Function Reference
**Given** user clicks "Functions Reference" button
**When** dialog opens
**Then** shows all 12 functions with descriptions and examples

## Requirements

### Functional Requirements
- **FR-001**: Editor MUST display syntax highlighting for all DSL elements
- **FR-002**: Validation MUST be debounced (300ms)
- **FR-003**: Function reference MUST be searchable
- **FR-004**: Double-click function MUST insert at cursor
- **FR-005**: Parameter editor MUST appear when parameters detected

### Non-Functional Requirements
- **NFR-001**: Syntax highlighting without UI lag
- **NFR-002**: Responsive UI during validation
- **NFR-003**: Accessible keyboard navigation

### Technical Constraints
- **TC-001**: Use PyQt6 (dependency on E01)
- **TC-002**: Use QSyntaxHighlighter for highlighting
- **TC-003**: Use QPlainTextEdit for editor

## Key Entities

### Entity: FormulaEditorWidget
- **Description**: Main editor widget
- **Components**: QPlainTextEdit, StatusLabel, ParameterPanel, HelpButton

### Entity: FormulaSyntaxHighlighter
- **Description**: QSyntaxHighlighter subclass
- **Rules**: Keywords, functions, fields, parameters, numbers

### Entity: FunctionReferenceDialog
- **Description**: Dialog with function documentation
- **Components**: SearchBox, CategoryTree, DetailPanel

## Dependencies

### Upstream Dependencies
- [ ] E05-F03: FormulaService for validation
- [ ] E01: PyQt6 UI framework

### Downstream Impact
- [ ] Application: Main window integrates formula editor

## Gate Checks

### Pre-Implementation Gates
- [ ] E05-F03 complete
- [ ] E01 UI framework available
- [ ] Color scheme finalized

### Quality Gates
- [ ] Visual tests for highlighting
- [ ] Accessibility tested

## Tasks Preview

| Task ID | Title | Effort | Wave | Subtasks |
|---------|-------|--------|------|----------|
| [E05-F04-T01](T01/E05-F04-T01.spec.md) | FormulaEditorWidget | L | 6 | 4 |
| [E05-F04-T02](T02/E05-F04-T02.spec.md) | FormulaSyntaxHighlighter | M | 6 | 5 |
| [E05-F04-T03](T03/E05-F04-T03.spec.md) | Function reference dialog | M | 6 | 3 |

**Note**: T02 and T03 can run in parallel after T01 widget is created

## Success Criteria

### Acceptance Criteria
- [ ] Syntax highlighting for all DSL elements
- [ ] Real-time validation with debounce
- [ ] Function reference dialog working
- [ ] Parameter editor functional

### Definition of Done
- [ ] All tasks completed
- [ ] Visual tests passing
- [ ] Usability tested
- [ ] Documentation complete

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| UI responsiveness | Medium | Medium | Debounce, async validation |
| E01 dependency delay | Medium | Medium | Mock PyQt6 widgets early |

## Artifacts

### Input Documents
- [E05 Epic](../E05.spec.md)
- [E05-F03 Service](../F03/E05-F03.spec.md)

### Output Artifacts
- [ ] `E05-F04.pre-docs.md`
- [ ] `E05-F04.post-docs.md`
- [ ] `libs/ui/formula/editor_widget.py`
- [ ] `libs/ui/formula/syntax_highlighter.py`
- [ ] `libs/ui/formula/reference_dialog.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
