---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F04-T02
clickup_task_id: '86ew020hz'
title: Implement FormulaSyntaxHighlighter
type: task

# === HIERARCHY ===
parent: E05-F04
children:
  - E05-F04-T02-S01
  - E05-F04-T02-S02
  - E05-F04-T02-S03
  - E05-F04-T02-S04
  - E05-F04-T02-S05
epic: E05
feature: F04
task: T02
domain: ui

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-01-15'
updated: '2025-12-28'
due_date: ''
estimated_hours: 12
actual_hours: 0

# === METADATA ===
tags:
  - syntax-highlighter
  - ui
  - editor
  - wave-6
effort: medium
risk: low
---

# Spec: E05-F04-T02 - Implement FormulaSyntaxHighlighter

---

**Status**: Draft
**Type**: Task
**Parent**: E05-F04
**Created**: 2025-01-15
**Updated**: 2025-12-28

## Executive Summary

Implement a QSyntaxHighlighter subclass that provides color-coded syntax highlighting for DSL expressions, making formulas easier to read and understand. The highlighter uses a VS Code-like color scheme with distinct colors for keywords, functions, fields, parameters, numbers, and error indicators.

## Execution Flow

```
1. Initialize FormulaSyntaxHighlighter with QTextDocument
   → Set up highlighting rules list
   → Initialize error ranges list
2. Configure highlighting rules for each element type
   → Define format for keywords (blue, bold)
   → Define format for functions (yellow)
   → Define format for fields (light blue)
   → Define format for parameters (orange)
   → Define format for numbers (green)
3. On highlightBlock called for text block
   → Iterate through all rules
   → Apply regex matching for each pattern
   → Set format for matched ranges
4. Apply error highlighting
   → If error ranges set: apply red underline
   → Trigger rehighlight if errors changed
5. Return: SUCCESS with highlighted text block
```

## User Stories

### Primary User Story
**As a** formula author
**I want to** see my DSL code with syntax highlighting
**So that** I can easily distinguish different elements and spot errors

### Additional Stories
- **As a** user, **I want to** see keywords in bold blue, **So that** logical operators stand out
- **As a** user, **I want to** see functions in yellow, **So that** I can identify function calls
- **As a** user, **I want to** see errors underlined in red, **So that** I can quickly locate syntax issues

## Acceptance Scenarios

### Scenario 1: Keyword Highlighting
**Given** a formula containing `AND`, `OR`, or `NOT`
**When** the formula is displayed in the editor
**Then** keywords are highlighted in bold blue (#569CD6)

### Scenario 2: Function Highlighting
**Given** a formula containing functions like `sma`, `rsi`, `macd`
**When** the formula is displayed in the editor
**Then** function names are highlighted in yellow (#DCDCAA)

### Scenario 3: Parameter Highlighting
**Given** a formula containing parameters like `:period`, `:threshold`
**When** the formula is displayed in the editor
**Then** parameters are highlighted in orange (#CE9178)

### Scenario 4: Error Highlighting
**Given** a formula with syntax errors
**When** validation fails and error positions are set
**Then** error regions are underlined in red (#F44747)

## Requirements

### Functional Requirements
- **FR-001**: Highlighter MUST color keywords (AND, OR, NOT, crosses_above, crosses_below) in blue bold
- **FR-002**: Highlighter MUST color functions (sma, ema, rsi, macd, atr, highest, lowest, average, std, lag) in yellow
- **FR-003**: Highlighter MUST color fields (open, high, low, close, volume) in light blue
- **FR-004**: Highlighter MUST color parameters (`:name` format) in orange
- **FR-005**: Highlighter MUST color numbers (integers and decimals) in green
- **FR-006**: Highlighter MUST apply red underline for error ranges
- **FR-007**: Highlighter MUST update in real-time as text changes

### Non-Functional Requirements
- **NFR-001**: Performance: Highlighting must not cause visible lag during typing
- **NFR-002**: Consistency: Colors must match VS Code dark theme
- **NFR-003**: Efficiency: Regex patterns must be case-insensitive

### Technical Constraints
- **TC-001**: Must extend QSyntaxHighlighter
- **TC-002**: Must integrate with FormulaEditorWidget (E05-F04-T01)
- **TC-003**: Must use regex for pattern matching

## Key Entities

### Entity: FormulaSyntaxHighlighter
- **Description**: Qt syntax highlighter for DSL formulas
- **Key Attributes**: _rules (list of pattern/format pairs), _error_ranges (list of error positions)
- **Relationships**: Attached to QTextDocument of FormulaEditorWidget

### Entity: HighlightRule
- **Description**: Pattern-format pair for highlighting
- **Key Attributes**: pattern (regex string), format (QTextCharFormat)
- **Relationships**: Used by FormulaSyntaxHighlighter

## Dependencies

### Upstream Dependencies
- [ ] E05-F04-T01: FormulaEditorWidget to attach highlighter to

### Downstream Impact
- [ ] None: This is a leaf component

## Gate Checks

### Pre-Implementation Gates
- [ ] Color scheme approved by UX team
- [ ] FormulaEditorWidget available for integration
- [ ] All DSL tokens documented

### Quality Gates
- [ ] All token types highlighted correctly
- [ ] Error underlines synchronized with validation
- [ ] No performance degradation during typing
- [ ] Unit tests for all patterns

## Subtasks Preview

| Subtask ID | Title | Effort | Status |
|------------|-------|--------|--------|
| E05-F04-T02-S01 | Create QSyntaxHighlighter subclass with rule engine | S | pending |
| E05-F04-T02-S02 | Implement keyword highlighting (AND, OR, NOT, crosses) | S | pending |
| E05-F04-T02-S03 | Implement function highlighting (sma, ema, rsi, etc.) | S | pending |
| E05-F04-T02-S04 | Implement field, parameter, number highlighting | S | pending |
| E05-F04-T02-S05 | Add error highlighting for invalid syntax | M | pending |

## Success Criteria

### Acceptance Criteria
- [ ] Keywords highlighted in blue bold
- [ ] Functions highlighted in yellow
- [ ] Fields highlighted in light blue
- [ ] Parameters highlighted in orange
- [ ] Numbers highlighted in green
- [ ] Error underlines synchronized with validation
- [ ] 80% test coverage

### Definition of Done
- [ ] Code reviewed and approved
- [ ] All unit tests passing
- [ ] Visual verification against mockups
- [ ] Integration with FormulaEditorWidget confirmed
- [ ] Documentation updated

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Regex performance issues | Low | Medium | Profile and optimize patterns |
| Color visibility issues | Low | Low | Test on different monitors |
| Pattern conflicts | Medium | Low | Order rules by priority |
| Error sync timing | Medium | Medium | Use signals for coordination |

## Artifacts

### Input Documents
- [Parent Feature](../E05-F04.spec.md)
- [FormulaEditorWidget Spec](../T01/E05-F04-T01.spec.md)
- [QSyntaxHighlighter Documentation](https://doc.qt.io/qt-6/qsyntaxhighlighter.html)

### Output Artifacts
- [ ] `libs/ui/formula/syntax_highlighter.py` - Highlighter implementation

### Color Scheme Reference

| Element | Color | Hex | Example |
|---------|-------|-----|---------|
| Keywords | Blue Bold | #569CD6 | `AND`, `OR`, `NOT` |
| Functions | Yellow | #DCDCAA | `sma`, `rsi`, `macd` |
| Fields | Light Blue | #9CDCFE | `open`, `high`, `close` |
| Parameters | Orange | #CE9178 | `:period`, `:threshold` |
| Numbers | Green | #B5CEA8 | `14`, `20.5` |
| Operators | White | #D4D4D4 | `>`, `<`, `+` |
| Errors | Red Underline | #F44747 | Invalid syntax |

### Visual Example

```
+-----------------------------------------------------+
| rsi(14) < 30 AND volume > average(volume, 20)       |
| ---      --    --- ------   ------- ------  --      |
| yel grn  grn  blu  ltblu   yellow  ltblu  grn      |
+-----------------------------------------------------+
```

### Technical Implementation

```python
class FormulaSyntaxHighlighter(QSyntaxHighlighter):
    """Syntax highlighting for DSL formulas"""

    def __init__(self, document):
        super().__init__(document)
        self._rules = []
        self._error_ranges = []
        self._setup_rules()

    def _setup_rules(self):
        # Keywords (blue, bold)
        kw_fmt = self._create_format("#569CD6", bold=True)
        for kw in ['AND', 'OR', 'NOT', 'crosses_above', 'crosses_below']:
            self._rules.append((rf'\b{kw}\b', kw_fmt))

        # Functions (yellow)
        fn_fmt = self._create_format("#DCDCAA")
        for fn in ['sma', 'ema', 'rsi', 'macd', 'atr', 'highest',
                   'lowest', 'average', 'std', 'lag']:
            self._rules.append((rf'\b{fn}\b', fn_fmt))

        # Fields (light blue)
        field_fmt = self._create_format("#9CDCFE")
        for field in ['open', 'high', 'low', 'close', 'volume']:
            self._rules.append((rf'\b{field}\b', field_fmt))

        # Parameters (orange)
        param_fmt = self._create_format("#CE9178")
        self._rules.append((r':\w+', param_fmt))

        # Numbers (green)
        num_fmt = self._create_format("#B5CEA8")
        self._rules.append((r'\b\d+\.?\d*\b', num_fmt))

    def highlightBlock(self, text):
        for pattern, fmt in self._rules:
            for match in re.finditer(pattern, text, re.IGNORECASE):
                self.setFormat(match.start(), match.end() - match.start(), fmt)

        # Apply error underlines
        for start, length in self._error_ranges:
            self._apply_error_underline(start, length)

    def set_errors(self, errors: list[tuple[int, int]]):
        """Set error positions for red underlines"""
        self._error_ranges = errors
        self.rehighlight()
```

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
