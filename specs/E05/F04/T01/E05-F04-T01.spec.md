---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F04-T01
clickup_task_id: '86ew020gf'
title: Create FormulaEditorWidget
type: task

# === HIERARCHY ===
parent: E05-F04
children:
  - E05-F04-T01-S01
  - E05-F04-T01-S02
  - E05-F04-T01-S03
  - E05-F04-T01-S04
epic: E05
feature: F04
task: T01
domain: ui

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-01-15'
updated: '2025-12-28'
due_date: ''
estimated_hours: 16
actual_hours: 0

# === METADATA ===
tags:
  - formula-editor
  - ui
  - widget
  - wave-6
effort: large
risk: medium
---

# Spec: E05-F04-T01 - Create FormulaEditorWidget

---

**Status**: Draft
**Type**: Task
**Parent**: E05-F04
**Created**: 2025-01-15
**Updated**: 2025-12-28

## Executive Summary

Create the main formula editor widget that provides a text editor for DSL expressions with real-time validation, parameter editing, and integration with the FormulaService. This widget serves as the primary interface for users to write, edit, and validate trading formulas in the DSL language.

## Execution Flow

```
1. Initialize FormulaEditorWidget with FormulaService
   → If FormulaService is null: ERROR "FormulaService is required"
   → Set up validation timer with 300ms debounce
2. Set up UI components (editor, status label, parameter panel, help button)
   → Apply monospace font (Consolas, 11pt)
   → Connect text change signals to validation handler
3. On text change, start debounce timer
   → If timer already running: restart timer
   → After 300ms: trigger validation
4. Validate expression via FormulaService
   → If valid: display green status, update parameters
   → If invalid: display red status with error message
5. Extract parameters and show parameter editor panel
   → If parameters found: make panel visible with input fields
   → If no parameters: hide parameter panel
6. Return: SUCCESS with validated formula and parameters
```

## User Stories

### Primary User Story
**As a** trader/developer
**I want to** write DSL formulas with real-time feedback
**So that** I can quickly identify and fix syntax errors

### Additional Stories
- **As a** user, **I want to** see parameter fields automatically, **So that** I can easily configure formula parameters
- **As a** user, **I want to** access function reference, **So that** I can discover available DSL functions
- **As a** user, **I want to** save and load formulas, **So that** I can reuse my trading strategies

## Acceptance Scenarios

### Scenario 1: Valid Formula Entry
**Given** the formula editor is open
**When** I type a valid DSL expression like `rsi(14) < 30`
**Then** the status shows green "Valid formula" after 300ms

### Scenario 2: Invalid Formula Entry
**Given** the formula editor is open
**When** I type an invalid expression like `rsi(14 < 30`
**Then** the status shows red with a descriptive error message

### Scenario 3: Parameter Detection
**Given** I enter a formula with parameters like `rsi(:period) < :threshold`
**When** validation completes successfully
**Then** the parameter panel appears with input fields for `period` and `threshold`

### Scenario 4: Empty Editor
**Given** the formula editor is empty
**When** no text has been entered
**Then** the status shows gray "Enter formula..."

## Requirements

### Functional Requirements
- **FR-001**: Widget MUST provide a monospace text editor for formula input
- **FR-002**: Widget MUST validate formulas in real-time with 300ms debounce
- **FR-003**: Widget MUST display validation status with color indicators (green/red/gray)
- **FR-004**: Widget MUST show a dynamic parameter editor when parameters are detected
- **FR-005**: Widget MUST integrate with FormulaService for validation and persistence
- **FR-006**: Widget MUST provide a "Functions Reference" button to open help dialog

### Non-Functional Requirements
- **NFR-001**: Performance: Validation debounce must be exactly 300ms
- **NFR-002**: UX: Editor must use Consolas 11pt font for readability
- **NFR-003**: Responsiveness: UI must remain responsive during validation

### Technical Constraints
- **TC-001**: Must integrate with FormulaService from E05-F03
- **TC-002**: Must use Qt widgets (QWidget, QPlainTextEdit, QLabel, QTimer)
- **TC-003**: Must emit signals for formula_changed and formula_valid events

## Key Entities

### Entity: FormulaEditorWidget
- **Description**: Main formula editing widget with validation
- **Key Attributes**: _editor (QPlainTextEdit), _status_label (QLabel), _param_panel (ParameterEditorPanel), _service (FormulaService)
- **Relationships**: Contains ParameterEditorPanel, uses FormulaService

### Entity: ParameterEditorPanel
- **Description**: Dynamic parameter input panel
- **Key Attributes**: parameter fields (dict), visibility state
- **Relationships**: Child of FormulaEditorWidget

## Dependencies

### Upstream Dependencies
- [ ] E05-F03: FormulaService for validation and persistence
- [ ] E01: Core infrastructure and base widgets

### Downstream Impact
- [ ] E05-F04-T02: FormulaSyntaxHighlighter will enhance this editor
- [ ] E05-F04-T03: Function Reference Dialog will be launched from this widget

## Gate Checks

### Pre-Implementation Gates
- [ ] FormulaService interface defined (E05-F03)
- [ ] Parameter extraction logic available
- [ ] UI design mockups approved

### Quality Gates
- [ ] Widget renders correctly on all target platforms
- [ ] Validation timing is accurate (300ms debounce)
- [ ] All signals emit correctly
- [ ] Unit tests cover all scenarios

## Subtasks Preview

| Subtask ID | Title | Effort | Status |
|------------|-------|--------|--------|
| E05-F04-T01-S01 | Create base widget layout and editor component | M | pending |
| E05-F04-T01-S02 | Integrate real-time validation with FormulaService | M | pending |
| E05-F04-T01-S03 | Add parameter editor UI | M | pending |
| E05-F04-T01-S04 | Implement save/load formula functionality | S | pending |

## Success Criteria

### Acceptance Criteria
- [ ] Editor with monospace font and proper sizing
- [ ] Real-time validation with 300ms debounce
- [ ] Green/red/gray status indicator works correctly
- [ ] Dynamic parameter editor appears when parameters detected
- [ ] Save/load via FormulaService functions correctly
- [ ] 80% test coverage

### Definition of Done
- [ ] Code reviewed and approved
- [ ] All unit tests passing
- [ ] Integration tests with FormulaService passing
- [ ] UI mockup matches implementation
- [ ] Documentation updated

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Validation performance lag | Medium | Medium | Debounce timer, async validation |
| Parameter extraction errors | Low | Medium | Comprehensive error handling |
| UI responsiveness issues | Low | High | Non-blocking validation |
| FormulaService integration issues | Medium | High | Early integration testing |

## Artifacts

### Input Documents
- [Parent Feature](../E05-F04.spec.md)
- [FormulaService Spec](../../F03/E05-F03.spec.md)
- [Epic Spec](../../E05.spec.md)

### Output Artifacts
- [ ] `libs/ui/formula/editor_widget.py` - Main widget implementation

### UI Mockup

```
+-----------------------------------------------------+
| +-----------------------------------------------+   |
| | rsi(:period) < :threshold AND                 |   |
| | volume > average(volume, :vol_period) * 2     |   |
| |                                               |   |
| +-----------------------------------------------+   |
| [check] Valid formula                               |
| +-----------------------------------------------+   |
| | Parameters:                                   |   |
| | period:      [14    ]                         |   |
| | threshold:   [30    ]                         |   |
| | vol_period:  [20    ]                         |   |
| +-----------------------------------------------+   |
| [Functions Reference]                               |
+-----------------------------------------------------+
```

### Technical Implementation

```python
class FormulaEditorWidget(QWidget):
    """Formula editor with validation and parameters"""

    formula_changed = Signal(str)
    formula_valid = Signal(bool)

    def __init__(self, formula_service: FormulaService, parent=None):
        super().__init__(parent)
        self._service = formula_service
        self._validation_timer = QTimer()
        self._setup_ui()

    def _setup_ui(self):
        layout = QVBoxLayout(self)

        # Code editor with monospace font
        self._editor = QPlainTextEdit()
        self._editor.setFont(QFont("Consolas", 11))
        self._editor.textChanged.connect(self._on_text_changed)

        # Validation status
        self._status_label = QLabel("Enter formula...")
        self._status_label.setStyleSheet("color: gray")

        # Parameter editor (dynamic)
        self._param_panel = ParameterEditorPanel()
        self._param_panel.setVisible(False)

        # Help button
        self._help_button = QPushButton("Functions Reference")

        layout.addWidget(self._editor)
        layout.addWidget(self._status_label)
        layout.addWidget(self._param_panel)
        layout.addWidget(self._help_button)

    def _on_text_changed(self):
        """Debounce validation to avoid excessive calls"""
        self._validation_timer.stop()
        self._validation_timer.singleShot(300, self._validate)

    def _validate(self):
        """Validate current expression"""
        expression = self._editor.toPlainText()
        if not expression.strip():
            self._update_status("Enter formula...", "gray")
            return

        result = self._service.validate(expression)
        if result.is_valid:
            self._update_status("[check] Valid formula", "green")
            self._update_parameters(expression)
            self.formula_valid.emit(True)
        else:
            self._update_status(f"[x] {result.error}", "red")
            self.formula_valid.emit(False)
```

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
