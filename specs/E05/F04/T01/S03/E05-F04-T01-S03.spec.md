---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F04-T01-S03
clickup_task_id: '86ew020hf'
title: Add parameter editor UI
type: subtask

# === HIERARCHY ===
parent: E05-F04-T01
children: []
epic: E05
feature: F04
task: T01
subtask: S03
domain: ui

# === WORKFLOW ===
status: pending
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags:
  - formula-editor
  - parameters
  - dynamic-ui
  - panel
effort: medium
risk: medium
---

# Spec: E05-F04-T01-S03 - Add parameter editor UI

---

**Status**: Pending
**Type**: Subtask
**Parent**: E05-F04-T01
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Create a dynamic `ParameterEditorPanel` that displays input fields for formula parameters (e.g., `:period`, `:threshold`). The panel should automatically show/hide based on whether parameters are detected in the formula. When a valid formula contains parameters, extract them and create labeled input fields for each.

## Scope

### In Scope
- Create `ParameterEditorPanel` class as a separate widget
- Dynamically generate input fields for detected parameters
- Show panel when parameters exist, hide when none
- Integrate panel into `FormulaEditorWidget` layout
- Extract parameters after successful validation
- Provide method to get parameter values as dict

### Out of Scope
- Parameter type inference (all treated as strings)
- Parameter validation rules
- Save/load of parameter values (S04)
- Default parameter value suggestions

## Acceptance Criteria

- [ ] `ParameterEditorPanel` class exists and can be instantiated
- [ ] Panel is hidden by default
- [ ] Panel becomes visible when formula contains parameters
- [ ] Each parameter gets a labeled `QLineEdit` input field
- [ ] Panel hides when formula has no parameters
- [ ] `get_parameters()` returns dict of parameter name → value
- [ ] Parameter fields are cleared when formula changes significantly
- [ ] Panel header shows "Parameters:" label

## Technical Implementation

### ParameterEditorPanel Class
```python
from PySide6.QtWidgets import QWidget, QVBoxLayout, QHBoxLayout, QLabel, QLineEdit, QGroupBox
from typing import Dict, List

class ParameterEditorPanel(QWidget):
    """Dynamic panel for editing formula parameters."""

    def __init__(self, parent=None):
        super().__init__(parent)
        self._param_fields: Dict[str, QLineEdit] = {}
        self._setup_ui()

    def _setup_ui(self):
        """Set up the panel layout."""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)

        self._group_box = QGroupBox("Parameters")
        self._params_layout = QVBoxLayout(self._group_box)

        layout.addWidget(self._group_box)

    def set_parameters(self, param_names: List[str]):
        """Update panel with new parameter fields."""
        # Clear existing fields
        self._clear_fields()

        if not param_names:
            self.setVisible(False)
            return

        # Create field for each parameter
        for name in param_names:
            row = QHBoxLayout()
            label = QLabel(f"{name}:")
            label.setMinimumWidth(80)
            field = QLineEdit()
            field.setPlaceholderText(f"Enter {name}...")

            row.addWidget(label)
            row.addWidget(field)
            self._params_layout.addLayout(row)
            self._param_fields[name] = field

        self.setVisible(True)

    def _clear_fields(self):
        """Clear all parameter fields."""
        for field in self._param_fields.values():
            field.deleteLater()
        self._param_fields.clear()

        # Clear layout
        while self._params_layout.count():
            item = self._params_layout.takeAt(0)
            if item.layout():
                while item.layout().count():
                    child = item.layout().takeAt(0)
                    if child.widget():
                        child.widget().deleteLater()

    def get_parameters(self) -> Dict[str, str]:
        """Get current parameter values."""
        return {name: field.text() for name, field in self._param_fields.items()}
```

### Integration with FormulaEditorWidget
```python
class FormulaEditorWidget(QWidget):
    # ... existing code ...

    def _setup_ui(self):
        # ... existing widgets ...

        # Parameter editor panel (between status and help button)
        self._param_panel = ParameterEditorPanel()
        self._param_panel.setVisible(False)

        layout.addWidget(self._editor)
        layout.addWidget(self._status_label)
        layout.addWidget(self._param_panel)  # NEW
        layout.addWidget(self._help_button)

    def _validate(self):
        """Validate and extract parameters."""
        # ... existing validation ...

        if result.is_valid:
            self._update_status("✓ Valid formula", "green")
            self._update_parameters(expression)  # NEW
            self.formula_valid.emit(True)
        else:
            self._update_status(f"✗ {result.error}", "red")
            self._param_panel.setVisible(False)  # Hide on error
            self.formula_valid.emit(False)

    def _update_parameters(self, expression: str):
        """Extract and display parameters from formula."""
        params = self._service.extract_parameters(expression)
        self._param_panel.set_parameters(params)

    def get_parameter_values(self) -> Dict[str, str]:
        """Get current parameter values from panel."""
        return self._param_panel.get_parameters()
```

### UI Mockup
```
+-----------------------------------------------+
| Parameters                                    |
| +-------------------------------------------+ |
| | period:     [14                         ] | |
| | threshold:  [30                         ] | |
| | vol_period: [20                         ] | |
| +-------------------------------------------+ |
+-----------------------------------------------+
```

## Dependencies

### Upstream
- S01: Base widget layout
- S02: Validation integration (triggers parameter extraction)
- E05-F03: FormulaService with `extract_parameters()` method

### Downstream
- S04 will include parameter values in save/load

## Testing Requirements

- [ ] Unit test: Panel hidden by default
- [ ] Unit test: Panel visible when parameters set
- [ ] Unit test: Correct number of fields created
- [ ] Unit test: Field labels match parameter names
- [ ] Unit test: `get_parameters()` returns correct dict
- [ ] Unit test: Panel hides when empty list passed
- [ ] Integration test: Panel updates after validation

---
*Template Version: 2.0.0 - Subtask Specification*
