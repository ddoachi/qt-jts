---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F04-T01-S02
clickup_task_id: '86ew020h7'
title: Integrate real-time validation with FormulaService
type: subtask

# === HIERARCHY ===
parent: E05-F04-T01
children: []
epic: E05
feature: F04
task: T01
subtask: S02
domain: ui

# === WORKFLOW ===
status: pending
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags:
  - formula-editor
  - validation
  - debounce
  - service-integration
effort: medium
risk: medium
---

# Spec: E05-F04-T01-S02 - Integrate real-time validation with FormulaService

---

**Status**: Pending
**Type**: Subtask
**Parent**: E05-F04-T01
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Integrate the `FormulaEditorWidget` with `FormulaService` to provide real-time formula validation. Implement a 300ms debounce timer to avoid excessive validation calls during typing. Update the status label with color-coded feedback (green for valid, red for errors, gray for empty).

## Scope

### In Scope
- Add `FormulaService` dependency to widget constructor
- Implement 300ms debounce timer using `QTimer`
- Connect text changes to debounced validation
- Call `FormulaService.validate()` on timer expiry
- Update status label with validation results
- Color-code status: green (valid), red (invalid), gray (empty)
- Emit `formula_valid` signal with validation result

### Out of Scope
- Parameter extraction and display (S03)
- Save/load functionality (S04)
- Syntax highlighting (T02)

## Acceptance Criteria

- [ ] Widget constructor accepts `FormulaService` parameter
- [ ] Validation triggers 300ms after last keystroke (debounce)
- [ ] Valid formula shows green "✓ Valid formula" status
- [ ] Invalid formula shows red "✗ {error message}" status
- [ ] Empty editor shows gray "Enter formula..." status
- [ ] `formula_valid` signal emits `True` for valid, `False` for invalid
- [ ] UI remains responsive during validation

## Technical Implementation

### Updated Class Structure
```python
from PySide6.QtCore import Signal, QTimer

class FormulaEditorWidget(QWidget):
    """Formula editor widget with validation and parameter editing."""

    formula_changed = Signal(str)
    formula_valid = Signal(bool)

    VALIDATION_DEBOUNCE_MS = 300

    def __init__(self, formula_service: FormulaService, parent=None):
        super().__init__(parent)
        self._service = formula_service
        self._validation_timer = QTimer()
        self._validation_timer.setSingleShot(True)
        self._validation_timer.timeout.connect(self._validate)
        self._setup_ui()

    def _on_text_changed(self):
        """Handle text changes with debounced validation."""
        self.formula_changed.emit(self._editor.toPlainText())
        # Restart debounce timer
        self._validation_timer.stop()
        self._validation_timer.start(self.VALIDATION_DEBOUNCE_MS)

    def _validate(self):
        """Validate current expression via FormulaService."""
        expression = self._editor.toPlainText()

        if not expression.strip():
            self._update_status("Enter formula...", "gray")
            return

        result = self._service.validate(expression)

        if result.is_valid:
            self._update_status("✓ Valid formula", "green")
            self.formula_valid.emit(True)
        else:
            self._update_status(f"✗ {result.error}", "red")
            self.formula_valid.emit(False)

    def _update_status(self, message: str, color: str):
        """Update status label with message and color."""
        self._status_label.setText(message)
        self._status_label.setStyleSheet(f"color: {color};")
```

### Validation Flow
```
User types → textChanged signal
         → _on_text_changed()
         → Restart 300ms timer
         → ... (user keeps typing, timer restarts)
         → User stops typing
         → 300ms passes
         → _validate() called
         → FormulaService.validate(expression)
         → Update status label
         → Emit formula_valid signal
```

## Dependencies

### Upstream
- S01: Base widget layout must exist
- E05-F03: FormulaService with `validate()` method

### Downstream
- S03 will use validation result to trigger parameter extraction

## Testing Requirements

- [ ] Unit test: Validation debounce is exactly 300ms
- [ ] Unit test: Valid formula shows green status
- [ ] Unit test: Invalid formula shows red status with error
- [ ] Unit test: Empty formula shows gray status
- [ ] Unit test: `formula_valid` signal emits correct boolean
- [ ] Integration test: FormulaService.validate() is called correctly
- [ ] Performance test: UI remains responsive during validation

---
*Template Version: 2.0.0 - Subtask Specification*
