---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F04-T01-S04
clickup_task_id: '86ew020hj'
title: Implement save/load formula functionality
type: subtask

# === HIERARCHY ===
parent: E05-F04-T01
children: []
epic: E05
feature: F04
task: T01
subtask: S04
domain: ui

# === WORKFLOW ===
status: pending
priority: medium

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 3
actual_hours: 0

# === METADATA ===
tags:
  - formula-editor
  - persistence
  - save-load
effort: small
risk: low
---

# Spec: E05-F04-T01-S04 - Implement save/load formula functionality

---

**Status**: Pending
**Type**: Subtask
**Parent**: E05-F04-T01
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Add save and load functionality to the `FormulaEditorWidget` that persists formulas with their parameter values via the `FormulaService`. Implement methods to save the current formula state and load previously saved formulas, restoring both the expression text and parameter values.

## Scope

### In Scope
- Add `save_formula(name: str)` method to widget
- Add `load_formula(name: str)` method to widget
- Integrate with FormulaService persistence methods
- Save formula expression and parameter values together
- Restore editor text and parameter values on load
- Handle save/load errors gracefully

### Out of Scope
- Formula browser/picker UI (separate task)
- Formula versioning
- Formula sharing/export
- Auto-save functionality

## Acceptance Criteria

- [ ] `save_formula(name)` saves expression and parameters via FormulaService
- [ ] `load_formula(name)` restores expression and parameters
- [ ] Editor text is updated after load
- [ ] Parameter panel values are restored after load
- [ ] Invalid/missing formula name returns appropriate error
- [ ] Save with empty formula is prevented
- [ ] Signals emitted after successful load to trigger validation

## Technical Implementation

### Updated FormulaEditorWidget
```python
from typing import Optional
from dataclasses import dataclass

@dataclass
class FormulaData:
    """Data structure for saved formula."""
    expression: str
    parameters: Dict[str, str]

class FormulaEditorWidget(QWidget):
    # ... existing code ...

    formula_loaded = Signal(str)  # Emits formula name after load
    formula_saved = Signal(str)   # Emits formula name after save

    def save_formula(self, name: str) -> bool:
        """
        Save current formula with the given name.

        Args:
            name: Unique identifier for the formula

        Returns:
            True if save successful, False otherwise
        """
        expression = self._editor.toPlainText()

        if not expression.strip():
            return False

        # Validate before saving
        result = self._service.validate(expression)
        if not result.is_valid:
            return False

        parameters = self._param_panel.get_parameters()

        try:
            self._service.save_formula(
                name=name,
                expression=expression,
                parameters=parameters
            )
            self.formula_saved.emit(name)
            return True
        except Exception as e:
            # Log error, return failure
            return False

    def load_formula(self, name: str) -> bool:
        """
        Load a saved formula by name.

        Args:
            name: Unique identifier of the formula to load

        Returns:
            True if load successful, False otherwise
        """
        try:
            formula_data = self._service.load_formula(name)

            if formula_data is None:
                return False

            # Update editor (this triggers validation via text change)
            self._editor.setPlainText(formula_data.expression)

            # Wait for validation to complete, then set parameters
            # Using QTimer to allow validation to process first
            def restore_params():
                if formula_data.parameters:
                    for param, value in formula_data.parameters.items():
                        if param in self._param_panel._param_fields:
                            self._param_panel._param_fields[param].setText(value)

            QTimer.singleShot(350, restore_params)  # After validation debounce

            self.formula_loaded.emit(name)
            return True

        except Exception as e:
            # Log error, return failure
            return False

    def get_formula_data(self) -> Optional[FormulaData]:
        """Get current formula state as data object."""
        expression = self._editor.toPlainText()
        if not expression.strip():
            return None

        return FormulaData(
            expression=expression,
            parameters=self._param_panel.get_parameters()
        )
```

### FormulaService Interface (Expected)
```python
class FormulaService:
    def save_formula(self, name: str, expression: str, parameters: Dict[str, str]) -> None:
        """Persist formula to storage."""
        ...

    def load_formula(self, name: str) -> Optional[FormulaData]:
        """Load formula from storage."""
        ...

    def list_formulas(self) -> List[str]:
        """List all saved formula names."""
        ...

    def delete_formula(self, name: str) -> bool:
        """Delete a saved formula."""
        ...
```

### Save/Load Flow
```
SAVE:
  User clicks Save → save_formula(name)
                   → Validate expression
                   → Get parameter values
                   → FormulaService.save_formula()
                   → Emit formula_saved signal

LOAD:
  User selects formula → load_formula(name)
                       → FormulaService.load_formula()
                       → Set editor text
                       → Trigger validation (300ms)
                       → Restore parameter values
                       → Emit formula_loaded signal
```

## Dependencies

### Upstream
- S01: Base widget layout
- S02: Validation integration
- S03: Parameter panel for value persistence
- E05-F03: FormulaService with save/load methods

### Downstream
- Formula browser/picker UI will use these methods

## Testing Requirements

- [ ] Unit test: `save_formula()` calls FormulaService correctly
- [ ] Unit test: `save_formula()` returns False for empty formula
- [ ] Unit test: `save_formula()` returns False for invalid formula
- [ ] Unit test: `load_formula()` restores editor text
- [ ] Unit test: `load_formula()` restores parameter values
- [ ] Unit test: `load_formula()` returns False for missing formula
- [ ] Unit test: `formula_saved` signal emits on success
- [ ] Unit test: `formula_loaded` signal emits on success
- [ ] Integration test: Round-trip save and load preserves data

---
*Template Version: 2.0.0 - Subtask Specification*
