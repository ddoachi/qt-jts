---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F02-T01
clickup_task_id: '86ew020fp'
title: Implement Base Evaluator Infrastructure
type: task

# === HIERARCHY ===
parent: E05-F02
children:
  - E05-F02-T01-S01
  - E05-F02-T01-S02
  - E05-F02-T01-S03
  - E05-F02-T01-S04
  - E05-F02-T01-S05
epic: E05
feature: F02
task: T01
domain: dsl

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-01-15'
updated: '2025-01-15'
due_date: ''
estimated_hours: 16
actual_hours: 0

# === METADATA ===
tags: [evaluator, visitor-pattern, pandas, vectorized]
effort: large
risk: medium
---

# Spec: E05-F02-T01 - Implement Base Evaluator Infrastructure

**Status**: Draft
**Type**: Task
**Parent**: E05-F02
**Created**: 2025-01-15
**Updated**: 2025-01-15

## Executive Summary

Implement the base evaluator class that traverses AST nodes and evaluates expressions on pandas DataFrames. This component uses the visitor pattern for extensible node handling, enabling dynamic dispatch based on node type. All operations return pd.Series for vectorized computation, supporting runtime parameter substitution and providing clear evaluation errors with context.

## Execution Flow

```
1. Initialize Evaluator with DataFrame and optional parameters
   → If DataFrame is None: ERROR "DataFrame required for evaluation"
   → If DataFrame is empty: WARN "Empty DataFrame will produce empty results"
2. Receive AST node for evaluation
   → Determine node type via class name
   → Look up corresponding visitor method
3. Dispatch to appropriate visitor method
   → If no visitor method exists: ERROR "Cannot evaluate {node_type}"
   → Process node according to its type
4. Evaluate child nodes recursively (for composite nodes)
   → Recursively call evaluate() on child nodes
   → Combine results according to operator semantics
5. Return pd.Series result
   → Return: SUCCESS with evaluated pd.Series
```

## User Stories

### Primary User Story
**As a** DSL engine developer
**I want to** evaluate parsed AST expressions against pandas DataFrames
**So that** I can compute technical indicator values for trading formulas

### Additional Stories
- **As a** formula author, **I want to** use parameters in expressions, **So that** I can create reusable formulas with runtime values
- **As a** debugging developer, **I want to** get clear error messages, **So that** I can quickly identify evaluation issues

## Acceptance Scenarios

### Scenario 1: Evaluate Literal Values
**Given** an AST with NumberLiteral node containing value 100
**When** the evaluator processes the node
**Then** it returns a pd.Series filled with 100 matching DataFrame length

### Scenario 2: Evaluate Binary Operations
**Given** an AST with BinaryOp node (close > 100)
**When** the evaluator processes the node
**Then** it returns a boolean pd.Series comparing close column to 100

### Scenario 3: Unknown Node Type Error
**Given** an AST with an unrecognized node type
**When** the evaluator attempts to process it
**Then** it raises EvaluationError with descriptive message

### Scenario 4: Parameter Substitution
**Given** an AST with Parameter node ":period" and parameters dict {period: 20}
**When** the evaluator processes the node
**Then** it substitutes the parameter value and returns appropriate Series

## Requirements

### Functional Requirements
- **FR-001**: System MUST implement visitor pattern dispatch based on AST node type
- **FR-002**: System MUST evaluate all literal types (Number, String, Identifier, Parameter)
- **FR-003**: System MUST evaluate all binary operators (+, -, *, /, >, <, >=, <=, ==, !=)
- **FR-004**: System MUST evaluate logical operators (AND, OR, NOT) using bitwise operations
- **FR-005**: System MUST support runtime parameter substitution
- **FR-006**: System MUST return pd.Series for all evaluations

### Non-Functional Requirements
- **NFR-001**: Performance: Evaluation should be vectorized, avoiding row-by-row iteration
- **NFR-002**: Reliability: Clear error messages for all failure cases
- **NFR-003**: Maintainability: Extensible visitor pattern for new node types

### Technical Constraints
- **TC-001**: Must integrate with AST nodes from E05-F01-T01
- **TC-002**: Must use pandas for all vectorized operations
- **TC-003**: File location: `libs/dsl/evaluator.py`

## Key Entities

### Entity: Evaluator
- **Description**: Main class that traverses and evaluates AST nodes
- **Key Attributes**: _df (DataFrame), _params (dict)
- **Relationships**: Uses ASTNode classes, produces pd.Series

### Entity: EvaluationError
- **Description**: Custom exception for evaluation failures
- **Key Attributes**: message, node_type, context
- **Relationships**: Raised by Evaluator on failures

## Dependencies

### Upstream Dependencies
- [ ] E05-F01-T01: AST Node classes (ASTNode, BinaryOp, etc.)
- [ ] E05-F01-T03: Parser to produce AST from expressions

### Downstream Impact
- [ ] E05-F02-T02: Moving average functions depend on this evaluator
- [ ] E05-F02-T03: Momentum indicators depend on this evaluator
- [ ] E05-F02-T04: Range functions depend on this evaluator
- [ ] E05-F02-T05: Cross detection depends on this evaluator

## Gate Checks

### Pre-Implementation Gates
- [ ] AST node classes defined and tested
- [ ] Parser produces valid AST nodes
- [ ] Error handling strategy defined
- [ ] Test data prepared

### Quality Gates
- [ ] All node types have visitor methods
- [ ] Unit tests cover all operators
- [ ] Error messages are informative
- [ ] Code follows visitor pattern correctly

## Subtasks Preview

| Subtask ID | Title | Effort | Status |
|------------|-------|--------|--------|
| E05-F02-T01-S01 | Create Evaluator class with visitor pattern dispatch | M | pending |
| E05-F02-T01-S02 | Implement literal evaluation (Number, String, Identifier, Parameter) | M | pending |
| E05-F02-T01-S03 | Implement binary operator evaluation | M | pending |
| E05-F02-T01-S04 | Implement logical operator evaluation (AND, OR, NOT) | S | pending |
| E05-F02-T01-S05 | Add type checking and validation | M | pending |

## Success Criteria

### Acceptance Criteria
- [ ] Evaluate all node types (literals, operators, identifiers)
- [ ] Parameter substitution works correctly
- [ ] Binary operators return correct pd.Series
- [ ] Logical operators use bitwise ops for boolean Series
- [ ] Clear error messages for unknown identifiers/operators

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing with >90% coverage
- [ ] Integration tests with parser
- [ ] Documentation updated
- [ ] Performance validated with large DataFrames

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Type mismatch in operations | Medium | Medium | Add type checking in S05 |
| Performance issues with large datasets | Low | High | Use vectorized pandas operations |
| Missing node type handlers | Low | Medium | Comprehensive visitor method coverage |

## Notes and Clarifications

### Technical Details

#### Evaluator Class Structure
```python
import pandas as pd
from typing import Any

class Evaluator:
    """Evaluate AST on pandas DataFrame"""

    def __init__(self, df: pd.DataFrame, parameters: dict[str, Any] = None):
        self._df = df
        self._params = parameters or {}

    def evaluate(self, node: ASTNode) -> pd.Series:
        """Evaluate AST node using visitor pattern"""
        method_name = f'_eval_{type(node).__name__}'
        method = getattr(self, method_name, None)
        if not method:
            raise EvaluationError(f"Cannot evaluate {type(node).__name__}")
        return method(node)
```

#### Operator Mapping
```python
BINARY_OPS = {
    '+': lambda l, r: l + r,
    '-': lambda l, r: l - r,
    '*': lambda l, r: l * r,
    '/': lambda l, r: l / r,
    '>': lambda l, r: l > r,
    '<': lambda l, r: l < r,
    '>=': lambda l, r: l >= r,
    '<=': lambda l, r: l <= r,
    '==': lambda l, r: l == r,
    '!=': lambda l, r: l != r,
    'AND': lambda l, r: l & r,
    'OR': lambda l, r: l | r,
}
```

### Decisions Made
- Using visitor pattern for extensibility and clean separation
- All operations return pd.Series for consistency
- Parameters use colon prefix syntax (:param_name)

## Artifacts

### Input Documents
- [Parent Feature](../E05-F02.spec.md)
- [Dependency: AST Nodes](../../F01/T01/E05-F01-T01.spec.md)
- [Epic Spec](../../E05.spec.md) Section 4.3

### Output Artifacts
- [ ] `libs/dsl/evaluator.py` - Main evaluator implementation
- [ ] `tests/dsl/test_evaluator.py` - Unit tests

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
