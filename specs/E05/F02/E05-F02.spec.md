---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F02
clickup_task_id: ''
title: Expression Evaluator & Technical Indicators
type: feature

# === HIERARCHY ===
parent: E05
children: [E05-F02-T01, E05-F02-T02, E05-F02-T03, E05-F02-T04, E05-F02-T05]
epic: E05
feature: F02
domain: dsl

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 56
actual_hours: 0

# === METADATA ===
tags: [evaluator, technical-indicators, pandas, vectorized]
effort: large
risk: medium
---

# Spec: E05-F02 - Expression Evaluator & Technical Indicators

**Status**: Draft
**Type**: Feature
**Parent**: [E05](../E05.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement the vectorized evaluation engine with pandas for efficient processing of trading formulas on historical data. Includes all 12 technical indicator functions defined in the DSL specification, using pandas rolling and ewm operations for performance.

## Execution Flow

```
1. Receive AST and DataFrame
   → If DataFrame empty: ERROR "Empty data"
2. Initialize Evaluator with data and parameters
3. Visit AST nodes using visitor pattern
   → dispatch to _eval_{NodeType} methods
4. Evaluate literals and identifiers
   → If unknown field: ERROR "Unknown field: {name}"
   → If missing parameter: ERROR "Missing parameter: {name}"
5. Evaluate operators and functions
   → If unknown function: ERROR "Unknown function: {name}"
6. Return pd.Series result
   → Return: SUCCESS with boolean/numeric Series
```

## User Stories

### Primary User Story
**As a** formula engine
**I want to** evaluate parsed expressions on DataFrames
**So that** users can scan for matching candles

### Additional Stories
- **As a** trader, **I want to** use SMA/EMA indicators, **So that** I can identify trends
- **As a** trader, **I want to** use RSI/MACD, **So that** I can identify momentum conditions
- **As a** trader, **I want to** detect crossovers, **So that** I can find entry signals

## Acceptance Scenarios

### Scenario 1: Simple Comparison
**Given** expression "close > 100" and DataFrame with close=[99,100,101]
**When** evaluated
**Then** returns Series [False, False, True]

### Scenario 2: SMA Calculation
**Given** expression "sma(close, 3)" and DataFrame with close=[1,2,3,4,5]
**When** evaluated
**Then** returns Series [NaN, NaN, 2.0, 3.0, 4.0]

### Scenario 3: Crosses Above Detection
**Given** two series where A crosses above B at index 3
**When** "A crosses_above B" is evaluated
**Then** returns Series with True only at index 3

## Requirements

### Functional Requirements
- **FR-001**: Evaluator MUST support all AST node types
- **FR-002**: All 12 built-in functions MUST be implemented
- **FR-003**: Technical indicators MUST match TA-Lib reference values
- **FR-004**: Parameter substitution MUST work correctly
- **FR-005**: Cross detection MUST handle edge cases (NaN, equal values)

### Non-Functional Requirements
- **NFR-001**: Performance: Evaluate on 1M candles in < 1 second
- **NFR-002**: Memory: Efficient Series operations
- **NFR-003**: Test coverage > 90%

### Technical Constraints
- **TC-001**: Use pandas for all vectorized operations
- **TC-002**: Use visitor pattern for AST evaluation

## Key Entities

### Entity: Evaluator
- **Description**: AST visitor that evaluates nodes on DataFrame
- **Key Attributes**: _df (DataFrame), _params (dict)
- **Methods**: evaluate(node), _eval_*, _func_*

## Dependencies

### Upstream Dependencies
- [ ] E05-F01: AST node definitions
- [ ] pandas: DataFrame operations
- [ ] numpy: Numerical computations

### Downstream Impact
- [ ] E05-F03: FormulaService.evaluate() uses Evaluator

## Gate Checks

### Pre-Implementation Gates
- [x] All 12 functions specified
- [x] TA-Lib reference values documented
- [ ] E05-F01 AST nodes complete

### Quality Gates
- [ ] Each function tested against TA-Lib
- [ ] Edge cases documented and tested

## Tasks Preview

| Task ID | Title | Effort | Wave | Subtasks |
|---------|-------|--------|------|----------|
| [E05-F02-T01](T01/E05-F02-T01.spec.md) | Base Evaluator infrastructure | L | 3 | 5 |
| [E05-F02-T02](T02/E05-F02-T02.spec.md) | Core moving averages (SMA, EMA) | M | 4 | 3 |
| [E05-F02-T03](T03/E05-F02-T03.spec.md) | Momentum/volatility (RSI, MACD, ATR) | M | 4 | 4 |
| [E05-F02-T04](T04/E05-F02-T04.spec.md) | Range/lag functions | M | 4 | 2 |
| [E05-F02-T05](T05/E05-F02-T05.spec.md) | Cross detection operators | M | 4 | 3 |

**[P]** = Tasks T02-T05 can be executed in parallel after T01

## Success Criteria

### Acceptance Criteria
- [ ] All example formulas evaluate correctly
- [ ] Indicators match TA-Lib within 0.01 tolerance
- [ ] Performance target met (1M candles < 1s)
- [ ] All edge cases handled

### Definition of Done
- [ ] All tasks completed
- [ ] Unit tests passing
- [ ] TA-Lib comparison tests passing
- [ ] Documentation updated

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Indicator accuracy | Low | High | TA-Lib comparison tests |
| Performance on large data | Medium | Medium | Profiling and optimization |

## Artifacts

### Input Documents
- [E05 Epic](../E05.spec.md)
- [E05-F01 Parser](../F01/E05-F01.spec.md)

### Output Artifacts
- [ ] `E05-F02.pre-docs.md`
- [ ] `E05-F02.post-docs.md`
- [ ] `libs/dsl/evaluator.py`
- [ ] `libs/dsl/functions/moving_averages.py`
- [ ] `libs/dsl/functions/momentum.py`
- [ ] `libs/dsl/functions/range.py`
- [ ] `libs/dsl/functions/cross.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
