---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F02-T03
clickup_task_id: '86ew020ft'
title: Implement Momentum and Volatility Indicators
type: task

# === HIERARCHY ===
parent: E05-F02
children:
  - E05-F02-T03-S01
  - E05-F02-T03-S02
  - E05-F02-T03-S03
  - E05-F02-T03-S04
epic: E05
feature: F02
task: T03
domain: dsl

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-01-15'
updated: '2025-01-15'
due_date: ''
estimated_hours: 12
actual_hours: 0

# === METADATA ===
tags: [momentum, volatility, rsi, macd, atr, technical-indicators]
effort: medium
risk: medium
---

# Spec: E05-F02-T03 - Implement Momentum and Volatility Indicators

**Status**: Draft
**Type**: Task
**Parent**: E05-F02
**Created**: 2025-01-15
**Updated**: 2025-01-15

## Executive Summary

Implement momentum and volatility indicators (RSI, MACD, ATR, std) that are commonly used in technical analysis for identifying overbought/oversold conditions and measuring volatility. These functions match industry-standard TA-Lib calculations with efficient vectorized pandas operations, handling edge cases like NaN values and zero division.

## Execution Flow

```
1. Receive function call with appropriate arguments
   → For RSI: period argument
   → For MACD: fast, slow, signal arguments
   → For ATR: period argument
   → For std: field, period arguments
2. Validate input parameters
   → If period <= 0: ERROR "Period must be positive"
   → If fast >= slow for MACD: ERROR "Fast period must be less than slow"
3. Extract required price data from DataFrame
   → RSI/MACD: close prices
   → ATR: high, low, close prices
4. Perform indicator calculation
   → Apply formula-specific logic
   → Handle edge cases (NaN, zero division)
5. Return calculated pd.Series
   → Return: SUCCESS with indicator Series
```

## User Stories

### Primary User Story
**As a** technical analyst
**I want to** compute momentum and volatility indicators
**So that** I can identify overbought/oversold conditions and measure market volatility

### Additional Stories
- **As a** trader, **I want to** use RSI to identify extreme conditions, **So that** I can time entries and exits
- **As a** risk manager, **I want to** measure volatility with ATR, **So that** I can set appropriate stop-loss levels
- **As a** trend follower, **I want to** use MACD for signal generation, **So that** I can identify trend changes

## Acceptance Scenarios

### Scenario 1: RSI Overbought Detection
**Given** a DataFrame with a strong uptrend (prices rising consistently)
**When** RSI(14) is evaluated
**Then** RSI values are > 70 indicating overbought conditions

### Scenario 2: MACD Bullish Crossover
**Given** a DataFrame where short-term trend exceeds long-term trend
**When** MACD(12, 26, 9) is evaluated
**Then** histogram transitions from negative to positive

### Scenario 3: ATR Volatility Measurement
**Given** a DataFrame with high, low, close prices
**When** ATR(14) is evaluated
**Then** result reflects true range averaged over 14 periods

### Scenario 4: Standard Deviation Calculation
**Given** a DataFrame with close prices
**When** std(close, 20) is evaluated
**Then** result matches pandas rolling.std() output

## Requirements

### Functional Requirements
- **FR-001**: System MUST implement RSI with values bounded between 0 and 100
- **FR-002**: System MUST implement MACD returning the histogram (MACD line - Signal line)
- **FR-003**: System MUST implement ATR using true range calculation
- **FR-004**: System MUST implement std using pandas rolling standard deviation
- **FR-005**: System MUST handle division by zero gracefully in RSI calculation

### Non-Functional Requirements
- **NFR-001**: Accuracy: RSI must match TA-Lib within 0.01 tolerance
- **NFR-002**: Accuracy: MACD histogram must match TA-Lib
- **NFR-003**: Performance: All indicators should use vectorized operations

### Technical Constraints
- **TC-001**: Must integrate with base Evaluator from E05-F02-T01
- **TC-002**: ATR requires access to high, low, close columns
- **TC-003**: File location: `libs/dsl/functions/momentum.py`

## Key Entities

### Entity: RSI (Relative Strength Index)
- **Description**: Momentum oscillator measuring speed and change of price movements
- **Range**: 0-100 (>70 overbought, <30 oversold)
- **Formula**: 100 - (100 / (1 + RS)), where RS = avg_gain / avg_loss

### Entity: MACD (Moving Average Convergence Divergence)
- **Description**: Trend-following momentum indicator
- **Components**: MACD Line (fast EMA - slow EMA), Signal Line (EMA of MACD), Histogram
- **Default Parameters**: fast=12, slow=26, signal=9

### Entity: ATR (Average True Range)
- **Description**: Volatility indicator measuring market volatility
- **Formula**: Rolling mean of True Range
- **True Range**: max(high-low, |high-prev_close|, |low-prev_close|)

### Entity: Standard Deviation
- **Description**: Statistical measure of price dispersion
- **Formula**: Rolling standard deviation over specified period

## Dependencies

### Upstream Dependencies
- [ ] E05-F02-T01: Base Evaluator infrastructure for function dispatch
- [ ] E05-F02-T02: EMA function used by MACD internally

### Downstream Impact
- [ ] Trading strategies using RSI for overbought/oversold signals
- [ ] Volatility-based position sizing using ATR
- [ ] MACD-based trend following strategies

## Gate Checks

### Pre-Implementation Gates
- [ ] Base Evaluator function dispatch working
- [ ] EMA function available for MACD
- [ ] Test data with known TA-Lib values prepared
- [ ] Edge case scenarios documented

### Quality Gates
- [ ] RSI bounded between 0-100
- [ ] RSI matches TA-Lib within 0.01 tolerance
- [ ] MACD histogram matches TA-Lib
- [ ] ATR uses correct true range formula
- [ ] All indicators handle NaN appropriately

## Subtasks Preview

| Subtask ID | Title | Effort | Status |
|------------|-------|--------|--------|
| E05-F02-T03-S01 | Implement RSI (Relative Strength Index) | M | pending |
| E05-F02-T03-S02 | Implement MACD (Moving Average Convergence Divergence) | M | pending |
| E05-F02-T03-S03 | Implement ATR (Average True Range) | M | pending |
| E05-F02-T03-S04 | Implement std() standard deviation | S | pending |

## Success Criteria

### Acceptance Criteria
- [ ] RSI values between 0 and 100
- [ ] RSI matches TA-Lib within 0.01 tolerance
- [ ] MACD histogram matches TA-Lib
- [ ] ATR correctly uses true range calculation
- [ ] std() matches pandas rolling std

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing with known TA-Lib values
- [ ] Integration tests with Evaluator
- [ ] Documentation updated
- [ ] Performance validated

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| RSI division by zero | Medium | Medium | Handle avg_loss = 0 case explicitly |
| MACD calculation mismatch | Low | Medium | Verify EMA parameters match TA-Lib |
| ATR missing price columns | Medium | High | Validate required columns exist |
| NaN propagation in chained calculations | Low | Medium | Document NaN behavior |

## Notes and Clarifications

### Technical Details

#### RSI Formula
```python
def _func_rsi(self, period: pd.Series) -> pd.Series:
    """Relative Strength Index"""
    p = int(period.iloc[0])
    close = self._df['close']
    delta = close.diff()

    gain = delta.where(delta > 0, 0)
    loss = (-delta).where(delta < 0, 0)

    avg_gain = gain.rolling(window=p).mean()
    avg_loss = loss.rolling(window=p).mean()

    rs = avg_gain / avg_loss
    return 100 - (100 / (1 + rs))
```

#### MACD Formula
```python
def _func_macd(self, fast: pd.Series, slow: pd.Series, signal: pd.Series) -> pd.Series:
    """MACD Histogram"""
    f, s, sig = int(fast.iloc[0]), int(slow.iloc[0]), int(signal.iloc[0])
    close = self._df['close']

    ema_fast = close.ewm(span=f, adjust=False).mean()
    ema_slow = close.ewm(span=s, adjust=False).mean()
    macd_line = ema_fast - ema_slow
    signal_line = macd_line.ewm(span=sig, adjust=False).mean()

    return macd_line - signal_line  # Histogram
```

#### ATR Formula
```python
def _func_atr(self, period: pd.Series) -> pd.Series:
    """Average True Range"""
    p = int(period.iloc[0])
    high, low, close = self._df['high'], self._df['low'], self._df['close']

    tr1 = high - low
    tr2 = abs(high - close.shift(1))
    tr3 = abs(low - close.shift(1))

    tr = pd.concat([tr1, tr2, tr3], axis=1).max(axis=1)
    return tr.rolling(window=p).mean()
```

### Test Cases
```python
# RSI test with known values
def test_rsi_overbought():
    # After strong uptrend, RSI should be > 70
    prices = [100 + i * 2 for i in range(20)]  # Steady rise
    result = evaluate("rsi(14)")
    assert result.iloc[-1] > 70

# MACD test
def test_macd_bullish_crossover():
    # Golden cross: MACD crosses above signal
    result = evaluate("macd(12, 26, 9)")
    # Verify histogram goes from negative to positive
```

### Decisions Made
- RSI returns 100 when avg_loss is 0 (all gains)
- MACD returns histogram by default (not MACD line)
- ATR uses simple rolling mean (not EMA variant)

## Artifacts

### Input Documents
- [Parent Feature](../E05-F02.spec.md)
- [Dependency: Base Evaluator](../T01/E05-F02-T01.spec.md)
- [TA-Lib RSI Reference](https://ta-lib.org/d_api/ta_rsi.html)
- [TA-Lib MACD Reference](https://ta-lib.org/d_api/ta_macd.html)
- [TA-Lib ATR Reference](https://ta-lib.org/d_api/ta_atr.html)

### Output Artifacts
- [ ] `libs/dsl/functions/momentum.py` - Function implementations
- [ ] `tests/dsl/functions/test_momentum.py` - Unit tests

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
