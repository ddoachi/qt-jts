---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F02-T02
clickup_task_id: '86ew020fq'
title: Implement Core Moving Average Functions
type: task

# === HIERARCHY ===
parent: E05-F02
children:
  - E05-F02-T02-S01
  - E05-F02-T02-S02
  - E05-F02-T02-S03
epic: E05
feature: F02
task: T02
domain: dsl

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-01-15'
updated: '2025-01-15'
due_date: ''
estimated_hours: 8
actual_hours: 0

# === METADATA ===
tags: [moving-average, sma, ema, pandas, technical-indicators]
effort: medium
risk: low
---

# Spec: E05-F02-T02 - Implement Core Moving Average Functions

**Status**: Draft
**Type**: Task
**Parent**: E05-F02
**Created**: 2025-01-15
**Updated**: 2025-01-15

## Executive Summary

Implement the core moving average functions (SMA, EMA, average) that form the foundation for many technical indicators and trading formulas. These functions leverage pandas rolling and ewm operations for efficient vectorized calculations, ensuring accuracy that matches industry-standard TA-Lib reference calculations.

## Execution Flow

```
1. Receive function call with field and period arguments
   → If period <= 0: ERROR "Period must be positive"
   → If field is not pd.Series: ERROR "Field must be a Series"
2. Extract period value from Series
   → Convert first element to integer
   → Validate period is within reasonable bounds
3. Apply pandas rolling/ewm operation
   → For SMA: Use rolling(window=p).mean()
   → For EMA: Use ewm(span=p, adjust=False).mean()
4. Handle edge cases
   → First (n-1) values will be NaN for SMA
   → EMA starts from first value
5. Return calculated pd.Series
   → Return: SUCCESS with moving average Series
```

## User Stories

### Primary User Story
**As a** quantitative analyst
**I want to** compute moving averages on price data
**So that** I can identify trends and generate trading signals

### Additional Stories
- **As a** formula author, **I want to** use SMA and EMA interchangeably, **So that** I can compare different averaging methods
- **As a** backtester, **I want to** accurate historical calculations, **So that** my strategy results are reliable

## Acceptance Scenarios

### Scenario 1: Simple Moving Average Calculation
**Given** a DataFrame with close prices [100, 102, 104, 103, 105]
**When** SMA(close, 3) is evaluated
**Then** result is [NaN, NaN, 102.0, 103.0, 104.0]

### Scenario 2: Exponential Moving Average Calculation
**Given** a DataFrame with close prices [1, 2, 3, 4, 5]
**When** EMA(close, 3) is evaluated
**Then** result approximately matches TA-Lib EMA calculation

### Scenario 3: Average Alias
**Given** a call to average(close, 20)
**When** evaluated
**Then** it returns identical results to SMA(close, 20)

### Scenario 4: Invalid Period
**Given** a period value of 0 or negative
**When** any moving average function is called
**Then** an appropriate error is raised

## Requirements

### Functional Requirements
- **FR-001**: System MUST implement SMA using pandas `rolling().mean()`
- **FR-002**: System MUST implement EMA using pandas `ewm(span=n, adjust=False).mean()`
- **FR-003**: System MUST implement `average()` as an alias for SMA
- **FR-004**: System MUST validate period parameter is positive integer
- **FR-005**: System MUST handle NaN values appropriately in calculations

### Non-Functional Requirements
- **NFR-001**: Performance: Moving averages should compute in O(n) time
- **NFR-002**: Accuracy: SMA must match pandas `rolling().mean()` exactly
- **NFR-003**: Accuracy: EMA must match TA-Lib `EMA()` within 0.0001 tolerance

### Technical Constraints
- **TC-001**: Must integrate with base Evaluator from E05-F02-T01
- **TC-002**: Must use pandas rolling/ewm for vectorized operations
- **TC-003**: File location: `libs/dsl/functions/moving_averages.py`

## Key Entities

### Entity: SMA (Simple Moving Average)
- **Description**: Arithmetic mean of last n values
- **Formula**: Sum(close[i-n+1:i+1]) / n
- **Pandas**: `series.rolling(n).mean()`

### Entity: EMA (Exponential Moving Average)
- **Description**: Weighted average giving more weight to recent values
- **Formula**: alpha * close + (1-alpha) * EMA_prev, where alpha = 2 / (n + 1)
- **Pandas**: `series.ewm(span=n, adjust=False).mean()`

## Dependencies

### Upstream Dependencies
- [ ] E05-F02-T01: Base Evaluator infrastructure for function dispatch
- [ ] E05-F01-T01: AST FunctionCall node definition

### Downstream Impact
- [ ] E05-F02-T03: MACD uses EMA internally
- [ ] E05-F02-T05: Cross detection commonly uses moving averages
- [ ] Trading strategies: Golden/Death cross patterns

## Gate Checks

### Pre-Implementation Gates
- [ ] Base Evaluator function dispatch working
- [ ] Test data with known TA-Lib values prepared
- [ ] Edge case scenarios documented

### Quality Gates
- [ ] SMA matches pandas exactly
- [ ] EMA matches TA-Lib within tolerance
- [ ] Period validation prevents invalid inputs
- [ ] Unit tests cover all edge cases

## Subtasks Preview

| Subtask ID | Title | Effort | Status |
|------------|-------|--------|--------|
| E05-F02-T02-S01 | Implement SMA (Simple Moving Average) | S | pending |
| E05-F02-T02-S02 | Implement EMA (Exponential Moving Average) | S | pending |
| E05-F02-T02-S03 | Implement average() alias and validate edge cases | S | pending |

## Success Criteria

### Acceptance Criteria
- [ ] SMA matches `pandas.rolling().mean()` exactly
- [ ] EMA matches TA-Lib `EMA()` function
- [ ] First n-1 values are NaN for SMA
- [ ] Period parameter validation (> 0)
- [ ] Unit tests with known values

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing with known TA-Lib values
- [ ] Integration tests with Evaluator
- [ ] Documentation updated
- [ ] Performance validated

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| EMA calculation mismatch with TA-Lib | Low | Medium | Use adjust=False, verify against reference |
| Integer overflow with large periods | Very Low | Low | Validate reasonable period bounds |
| NaN propagation issues | Low | Medium | Document expected NaN behavior |

## Notes and Clarifications

### Technical Details

#### Function Definitions
```python
def _func_sma(self, field: pd.Series, period: pd.Series) -> pd.Series:
    """Simple Moving Average - rolling mean"""
    p = int(period.iloc[0])
    return field.rolling(window=p).mean()

def _func_ema(self, field: pd.Series, period: pd.Series) -> pd.Series:
    """Exponential Moving Average - ewm mean"""
    p = int(period.iloc[0])
    return field.ewm(span=p, adjust=False).mean()

def _func_average(self, field: pd.Series, period: pd.Series) -> pd.Series:
    """Alias for SMA"""
    return self._func_sma(field, period)
```

#### Formula Reference

| Function | Formula | Pandas Implementation |
|----------|---------|----------------------|
| SMA(n) | Sum(close[i-n+1:i+1]) / n | `series.rolling(n).mean()` |
| EMA(n) | alpha * close + (1-alpha) * EMA_prev | `series.ewm(span=n).mean()` |

Where alpha = 2 / (n + 1)

### Test Cases
```python
# Test data: [1, 2, 3, 4, 5]
# SMA(3): [NaN, NaN, 2.0, 3.0, 4.0]
# EMA(3): [1.0, 1.5, 2.25, 3.125, 4.0625] (approximate)

def test_sma_calculation():
    df = pd.DataFrame({'close': [100, 102, 104, 103, 105]})
    result = evaluator.evaluate(parse("sma(close, 3)"))
    assert pd.isna(result.iloc[0])
    assert pd.isna(result.iloc[1])
    assert result.iloc[2] == pytest.approx(102.0)
```

### Decisions Made
- Using pandas ewm with adjust=False to match TA-Lib behavior
- average() is pure alias for SMA (no additional logic)
- Period extracted from first element of Series argument

## Artifacts

### Input Documents
- [Parent Feature](../E05-F02.spec.md)
- [Dependency: Base Evaluator](../T01/E05-F02-T01.spec.md)
- [TA-Lib SMA Reference](https://ta-lib.org/d_api/ta_sma.html)
- [pandas ewm documentation](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.ewm.html)

### Output Artifacts
- [ ] `libs/dsl/functions/moving_averages.py` - Function implementations
- [ ] `tests/dsl/functions/test_moving_averages.py` - Unit tests

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
