---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F02-T04
clickup_task_id: '86ew020fx'
title: Implement Range and Lag Functions
type: task

# === HIERARCHY ===
parent: E05-F02
children:
  - E05-F02-T04-S01
  - E05-F02-T04-S02
epic: E05
feature: F02
task: T04
domain: dsl

# === WORKFLOW ===
status: draft
priority: medium

# === TRACKING ===
created: '2025-01-15'
updated: '2025-01-15'
due_date: ''
estimated_hours: 6
actual_hours: 0

# === METADATA ===
tags: [range, lag, highest, lowest, lookback, technical-indicators]
effort: medium
risk: low
---

# Spec: E05-F02-T04 - Implement Range and Lag Functions

**Status**: Draft
**Type**: Task
**Parent**: E05-F02
**Created**: 2025-01-15
**Updated**: 2025-01-15

## Executive Summary

Implement range functions (highest, lowest) and lag function for looking at historical highs, lows, and past values. These are essential for breakout detection and pattern recognition in trading strategies, using straightforward pandas rolling operations for efficient window calculations.

## Execution Flow

```
1. Receive function call with field and period arguments
   → If period <= 0: ERROR "Period must be positive"
   → If field is not pd.Series: ERROR "Field must be a Series"
2. Extract period value from Series
   → Convert first element to integer
   → Validate period is within data bounds
3. Apply pandas operation
   → For highest: Use rolling(window=p).max()
   → For lowest: Use rolling(window=p).min()
   → For lag: Use shift(periods)
4. Handle edge cases
   → First (n-1) values will be NaN for rolling operations
   → First n values will be NaN for lag
5. Return calculated pd.Series
   → Return: SUCCESS with result Series
```

## User Stories

### Primary User Story
**As a** breakout trader
**I want to** identify historical highs and lows
**So that** I can detect price breakouts and set support/resistance levels

### Additional Stories
- **As a** pattern analyst, **I want to** compare current prices to past values, **So that** I can identify momentum and reversals
- **As a** risk manager, **I want to** track rolling extremes, **So that** I can calculate drawdowns and risk metrics

## Acceptance Scenarios

### Scenario 1: Highest Value Detection
**Given** a DataFrame with high prices [10, 15, 12, 18, 14]
**When** highest(high, 3) is evaluated
**Then** result is [NaN, NaN, 15, 18, 18]

### Scenario 2: Lowest Value Detection
**Given** a DataFrame with low prices [10, 8, 12, 9, 11]
**When** lowest(low, 3) is evaluated
**Then** result is [NaN, NaN, 8, 8, 9]

### Scenario 3: Lag Lookback
**Given** a DataFrame with close prices [100, 102, 104, 103, 105]
**When** lag(close, 1) is evaluated
**Then** result is [NaN, 100, 102, 104, 103]

### Scenario 4: Breakout Detection Pattern
**Given** current close price exceeds highest(high, 52)
**When** formula `close > highest(high, 52)` is evaluated
**Then** result indicates 52-week high breakout

## Requirements

### Functional Requirements
- **FR-001**: System MUST implement `highest()` returning rolling maximum
- **FR-002**: System MUST implement `lowest()` returning rolling minimum
- **FR-003**: System MUST implement `lag()` for historical value lookback
- **FR-004**: System MUST validate period parameter is positive integer
- **FR-005**: System MUST support any field (not just OHLC columns)

### Non-Functional Requirements
- **NFR-001**: Performance: Rolling operations should be O(n)
- **NFR-002**: Accuracy: Results must match pandas rolling exactly
- **NFR-003**: Flexibility: Support any numeric Series as input

### Technical Constraints
- **TC-001**: Must integrate with base Evaluator from E05-F02-T01
- **TC-002**: Must use pandas rolling/shift for vectorized operations
- **TC-003**: File location: `libs/dsl/functions/range.py`

## Key Entities

### Entity: highest() Function
- **Description**: Returns rolling maximum over specified period
- **Signature**: `highest(field, period)`
- **Pandas**: `field.rolling(window=period).max()`
- **Use Case**: Breakout detection, resistance levels

### Entity: lowest() Function
- **Description**: Returns rolling minimum over specified period
- **Signature**: `lowest(field, period)`
- **Pandas**: `field.rolling(window=period).min()`
- **Use Case**: Support levels, drawdown calculation

### Entity: lag() Function
- **Description**: Shifts series by N periods for historical lookback
- **Signature**: `lag(field, n)`
- **Pandas**: `field.shift(n)`
- **Use Case**: Day-over-day comparison, momentum calculation

## Dependencies

### Upstream Dependencies
- [ ] E05-F02-T01: Base Evaluator infrastructure for function dispatch
- [ ] E05-F01-T01: AST FunctionCall node definition

### Downstream Impact
- [ ] Breakout detection strategies using highest/lowest
- [ ] Mean reversion strategies using support/resistance levels
- [ ] Momentum strategies using lag for comparisons

## Gate Checks

### Pre-Implementation Gates
- [ ] Base Evaluator function dispatch working
- [ ] Test data prepared with known values
- [ ] Edge case scenarios documented

### Quality Gates
- [ ] highest() returns correct rolling max
- [ ] lowest() returns correct rolling min
- [ ] lag() shifts data correctly
- [ ] First n-1 values are NaN as expected
- [ ] Period validation prevents invalid inputs

## Subtasks Preview

| Subtask ID | Title | Effort | Status |
|------------|-------|--------|--------|
| E05-F02-T04-S01 | Implement highest() and lowest() range functions | S | pending |
| E05-F02-T04-S02 | Implement lag() for historical lookback | S | pending |

## Success Criteria

### Acceptance Criteria
- [ ] highest() returns rolling max
- [ ] lowest() returns rolling min
- [ ] lag() shifts data correctly
- [ ] First n-1 values are NaN
- [ ] Period validation (> 0)

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing
- [ ] Integration tests with Evaluator
- [ ] Documentation updated
- [ ] Performance validated

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Incorrect period handling | Low | Medium | Validate and test edge cases |
| NaN propagation confusion | Low | Low | Document expected behavior |
| Large period exceeds data length | Low | Medium | Handle gracefully with NaN |

## Notes and Clarifications

### Technical Details

#### Range Functions
```python
def _func_highest(self, field: pd.Series, period: pd.Series) -> pd.Series:
    """Rolling maximum over period"""
    p = int(period.iloc[0])
    return field.rolling(window=p).max()

def _func_lowest(self, field: pd.Series, period: pd.Series) -> pd.Series:
    """Rolling minimum over period"""
    p = int(period.iloc[0])
    return field.rolling(window=p).min()
```

#### Lag Function
```python
def _func_lag(self, field: pd.Series, n: pd.Series) -> pd.Series:
    """Shift series by N periods (lookback)"""
    periods = int(n.iloc[0])
    return field.shift(periods)
```

### Use Cases

| Formula | Description | Use Case |
|---------|-------------|----------|
| `highest(high, 52)` | 52-week high | Breakout detection |
| `lowest(low, 20)` | 20-day low | Support level |
| `lag(close, 1)` | Yesterday's close | Day-over-day comparison |
| `close > highest(high, 20)` | 20-day breakout | Trend following entry |

### Test Cases
```python
# Range test
def test_highest():
    df = pd.DataFrame({'high': [10, 15, 12, 18, 14]})
    result = evaluate("highest(high, 3)")
    # [NaN, NaN, 15, 18, 18]
    assert result.iloc[4] == 18

# Lag test
def test_lag():
    df = pd.DataFrame({'close': [100, 102, 104, 103, 105]})
    result = evaluate("lag(close, 1)")
    # [NaN, 100, 102, 104, 103]
    assert result.iloc[3] == 104
```

### Decisions Made
- All functions accept any field, not limited to OHLC
- Period extracted from first element of Series argument
- Positive shift values look backward (lag behavior)

## Artifacts

### Input Documents
- [Parent Feature](../E05-F02.spec.md)
- [Dependency: Base Evaluator](../T01/E05-F02-T01.spec.md)

### Output Artifacts
- [ ] `libs/dsl/functions/range.py` - Function implementations
- [ ] `tests/dsl/functions/test_range.py` - Unit tests

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
