---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F03
clickup_task_id: ''
title: Formula Service & Validation
type: feature

# === HIERARCHY ===
parent: E05
children: [E05-F03-T01, E05-F03-T02, E05-F03-T03, E05-F03-T04]
epic: E05
feature: F03
domain: dsl

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 32
actual_hours: 0

# === METADATA ===
tags: [service, validation, parameters, api]
effort: large
risk: low
---

# Spec: E05-F03 - Formula Service & Validation

**Status**: Draft
**Type**: Feature
**Parent**: [E05](../E05.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Provide a high-level API for formula management, validation, and evaluation. This service layer abstracts the parsing and evaluation pipeline, handles parameter management, and integrates with the storage layer for formula persistence.

## Execution Flow

```
1. User calls parse(expression)
   → Tokenize with Lexer
   → Parse with Parser
   → Extract parameters from AST
   → Return: Formula object
2. User calls validate(expression)
   → Parse expression
   → If syntax error: Return ValidationResult(is_valid=False)
   → Run semantic validation
   → Return: ValidationResult
3. User calls evaluate(formula, df, params)
   → Merge default and runtime parameters
   → Create Evaluator
   → Return: pd.Series
4. User calls find_matches(formula, candles, params)
   → Evaluate formula
   → Filter matching indices
   → Return: list[FormulaMatch]
```

## User Stories

### Primary User Story
**As a** application developer
**I want to** use a simple API for formula operations
**So that** I don't need to manage lexer/parser/evaluator directly

### Additional Stories
- **As a** UI developer, **I want to** validate formulas in real-time, **So that** I can show validation status
- **As a** trader, **I want to** save/load formulas, **So that** I can reuse them

## Acceptance Scenarios

### Scenario 1: Parse and Extract Parameters
**Given** expression "rsi(:period) < :threshold"
**When** parsed
**Then** returns Formula with parameters [{name: "period"}, {name: "threshold"}]

### Scenario 2: Validate Invalid Expression
**Given** expression "close >"
**When** validated
**Then** returns ValidationResult(is_valid=False, error="...")

### Scenario 3: Find Matches
**Given** formula "rsi(14) < 30" and candle data
**When** find_matches is called
**Then** returns list of FormulaMatch with matching candles

## Requirements

### Functional Requirements
- **FR-001**: FormulaService MUST orchestrate lexer/parser/evaluator
- **FR-002**: Parameter extraction MUST find all :param references
- **FR-003**: Validation MUST check function signatures and field names
- **FR-004**: find_matches MUST return FormulaMatch with candle data

### Non-Functional Requirements
- **NFR-001**: Validation response < 50ms
- **NFR-002**: Test coverage > 90%

### Technical Constraints
- **TC-001**: Must integrate with IFormulaRepository from E02
- **TC-002**: Validation must be callable without evaluation

## Key Entities

### Entity: Formula
- **Description**: Parsed and validated formula
- **Key Attributes**: id, name, expression, category, parameters[]

### Entity: FormulaParameter
- **Description**: Extracted parameter metadata
- **Key Attributes**: name, data_type, default_value, description

### Entity: ValidationResult
- **Description**: Result of validation check
- **Key Attributes**: is_valid, error, line, column, suggestions[]

### Entity: FormulaMatch
- **Description**: Candle matching formula condition
- **Key Attributes**: timestamp, candle, values

## Dependencies

### Upstream Dependencies
- [ ] E05-F01: Lexer and Parser
- [ ] E05-F02: Evaluator
- [ ] E02: IFormulaRepository interface

### Downstream Impact
- [ ] E05-F04: UI uses FormulaService for validation
- [ ] E06: Backtesting uses FormulaService
- [ ] E07: Scanning uses find_matches()

## Gate Checks

### Pre-Implementation Gates
- [ ] E05-F01 complete
- [ ] E05-F02 complete
- [ ] E02 interface defined

### Quality Gates
- [ ] Integration tests passing
- [ ] API documented

## Tasks Preview

| Task ID | Title | Effort | Wave | Subtasks |
|---------|-------|--------|------|----------|
| [E05-F03-T01](T01/E05-F03-T01.spec.md) | FormulaService core | M | 5 | 3 |
| [E05-F03-T02](T02/E05-F03-T02.spec.md) | Parameter extraction | M | 5 | 2 |
| [E05-F03-T03](T03/E05-F03-T03.spec.md) | Formula validation | M | 5 | 3 |
| [E05-F03-T04](T04/E05-F03-T04.spec.md) | find_matches implementation | M | 5 | 2 |

**Note**: T02-T04 can run in parallel after T01 completes

## Success Criteria

### Acceptance Criteria
- [ ] Parse formulas and return Formula objects
- [ ] Validate expressions with helpful errors
- [ ] Evaluate with parameter merging
- [ ] Find matches efficiently

### Definition of Done
- [ ] All tasks completed
- [ ] Integration tests passing
- [ ] API documentation complete
- [ ] Code reviewed

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| E02 interface changes | Low | Medium | Define interface early |
| Validation performance | Low | Low | Cache validation results |

## Artifacts

### Input Documents
- [E05 Epic](../E05.spec.md)
- [E05-F01 Parser](../F01/E05-F01.spec.md)
- [E05-F02 Evaluator](../F02/E05-F02.spec.md)

### Output Artifacts
- [ ] `E05-F03.pre-docs.md`
- [ ] `E05-F03.post-docs.md`
- [ ] `libs/dsl/service.py`
- [ ] `libs/dsl/parameters.py`
- [ ] `libs/dsl/validation.py`
- [ ] `libs/dsl/matching.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
