---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F03-T01
clickup_task_id: '86ew020g5'
title: Create FormulaService Core Infrastructure
type: task

# === HIERARCHY ===
parent: E05-F03
children: [E05-F03-T01-S01, E05-F03-T01-S02, E05-F03-T01-S03]
epic: E05
feature: F03
task: T01
domain: dsl

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 8
actual_hours: 0

# === METADATA ===
tags: [service, api, repository, infrastructure]
effort: medium
risk: low
---

# Spec: E05-F03-T01 - Create FormulaService Core Infrastructure

**Status**: Draft
**Type**: Task
**Parent**: [E05-F03](../E05-F03.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Create the FormulaService class that provides a high-level API for formula operations including parsing, validation, and evaluation. This service orchestrates the lexer, parser, and evaluator components, providing a simple entry point for all formula operations while integrating with the storage layer for persistence.

## Execution Flow

```
1. Initialize FormulaService with repository
   → Inject IFormulaRepository dependency
   → Store reference for persistence operations
2. User calls parse(expression)
   → Tokenize with Lexer
   → If lexer error: ERROR "Invalid token at position X"
   → Parse with Parser
   → If parser error: ERROR "Syntax error: expected X"
   → Extract parameters from AST
   → Return: Formula object with parameters
3. User calls evaluate(formula, df, params)
   → Merge default parameters with provided parameters
   → Create Evaluator with DataFrame and merged params
   → Evaluate AST
   → If evaluation error: ERROR "Evaluation failed: X"
   → Return: pd.Series result
```

## User Stories

### Primary User Story
**As a** application developer
**I want to** use a simple API for formula operations
**So that** I don't need to manage lexer/parser/evaluator directly

### Additional Stories
- **As a** UI developer, **I want to** parse formulas and get parameter info, **So that** I can build dynamic parameter inputs
- **As a** system integrator, **I want to** inject repository implementations, **So that** I can swap storage backends

## Acceptance Scenarios

### Scenario 1: Parse Expression and Return Formula
**Given** a valid expression "rsi(:period) < :threshold"
**When** parse() is called
**Then** returns Formula with extracted parameters [period, threshold]

### Scenario 2: Evaluate Formula with Merged Parameters
**Given** a Formula with default parameter period=14
**When** evaluate() is called with parameters={period: 20}
**Then** evaluation uses period=20 (override wins)

### Scenario 3: Repository Integration
**Given** a FormulaService with injected repository
**When** service operations require persistence
**Then** repository methods are called correctly

### Scenario 4: Error Wrapping
**Given** an expression that causes a lexer/parser error
**When** parse() is called
**Then** low-level errors are wrapped in service exceptions

## Requirements

### Functional Requirements
- **FR-001**: FormulaService MUST accept IFormulaRepository via constructor injection
- **FR-002**: parse() MUST tokenize, parse, and extract parameters from expression
- **FR-003**: evaluate() MUST merge default and runtime parameters before evaluation
- **FR-004**: Service MUST wrap low-level errors in FormulaServiceError exceptions

### Non-Functional Requirements
- **NFR-001**: Parse operation < 10ms for typical expressions
- **NFR-002**: Test coverage > 90% for service methods

### Technical Constraints
- **TC-001**: Must use IFormulaRepository interface from E02
- **TC-002**: Must integrate with Lexer, Parser from E05-F01
- **TC-003**: Must integrate with Evaluator from E05-F02

## Key Entities

### Entity: FormulaService
- **Description**: High-level API for formula operations
- **Key Attributes**: _repo (IFormulaRepository)
- **Methods**: parse(), evaluate()

### Entity: Formula
- **Description**: Parsed formula with metadata
- **Key Attributes**: id, name, expression, category, parameters[]
- **Relationships**: Contains FormulaParameter list

## Dependencies

### Upstream Dependencies
- [ ] E05-F01: Lexer and Parser components
- [ ] E05-F02: Evaluator component
- [ ] E02: IFormulaRepository interface

### Downstream Impact
- [ ] E05-F03-T02: Uses FormulaService for parameter extraction
- [ ] E05-F03-T03: Adds validate() method to FormulaService
- [ ] E05-F03-T04: Adds find_matches() method to FormulaService

## Gate Checks

### Pre-Implementation Gates
- [ ] E05-F01 Lexer and Parser complete
- [ ] E05-F02 Evaluator complete
- [ ] E02 IFormulaRepository interface defined

### Quality Gates
- [ ] Unit tests for all public methods
- [ ] Integration test with mock repository
- [ ] Error handling tested

## Subtasks Preview

| Subtask ID | Title | Effort |
|------------|-------|--------|
| [E05-F03-T01-S01](S01/E05-F03-T01-S01.spec.md) | Create FormulaService class with repository integration | S |
| [E05-F03-T01-S02](S02/E05-F03-T01-S02.spec.md) | Implement parse() method | M |
| [E05-F03-T01-S03](S03/E05-F03-T01-S03.spec.md) | Implement evaluate() method with parameter merging | M |

## Success Criteria

### Acceptance Criteria
- [ ] Parse expression and return Formula with parameters
- [ ] Evaluate formula with merged parameters
- [ ] Repository integration works correctly
- [ ] Service exceptions wrap low-level errors

### Definition of Done
- [ ] All subtasks completed
- [ ] Unit tests passing
- [ ] Code reviewed
- [ ] API documented

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Interface mismatch with E02 | Low | Medium | Define interface contract early |
| Parameter merging edge cases | Low | Low | Comprehensive test cases |

## Artifacts

### Input Documents
- [Parent Feature](../E05-F03.spec.md)
- [E05-F01 Parser](../../F01/E05-F01.spec.md)
- [E05-F02 Evaluator](../../F02/E05-F02.spec.md)

### Output Artifacts
- [ ] `libs/dsl/service.py`
- [ ] Unit tests for FormulaService

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
