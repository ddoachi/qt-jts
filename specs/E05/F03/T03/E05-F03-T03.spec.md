---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F03-T03
clickup_task_id: '86ew020g8'
title: Implement Formula Validation and Type Checking
type: task

# === HIERARCHY ===
parent: E05-F03
children: [E05-F03-T03-S01, E05-F03-T03-S02, E05-F03-T03-S03]
epic: E05
feature: F03
task: T03
domain: dsl

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 8
actual_hours: 0

# === METADATA ===
tags: [validation, type-checking, semantic-analysis, errors]
effort: medium
risk: low
---

# Spec: E05-F03-T03 - Implement Formula Validation and Type Checking

**Status**: Draft
**Type**: Task
**Parent**: [E05-F03](../E05-F03.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement semantic validation for formula expressions that checks function signatures, argument types, and identifier validity before evaluation. This provides helpful error messages with suggestions, enabling pre-execution validation and improving developer experience with clear, actionable feedback.

## Execution Flow

```
1. Receive AST for validation
   → Initialize SemanticValidator
2. Traverse AST and validate each node
   → If FunctionCall node:
     → Check function name in FUNCTION_SIGNATURES
     → If unknown: ERROR "Unknown function: X" with suggestions
     → Check argument count matches signature
     → If mismatch: ERROR "X expects Y arguments, got Z"
   → If Identifier node:
     → Check name in VALID_FIELDS
     → If unknown: ERROR "Unknown field: X"
   → If BinaryOp node:
     → Check operand types are compatible
     → If incompatible: ERROR "Cannot compare X with Y"
3. Build ValidationResult
   → If all checks pass: Return ValidationResult(is_valid=True)
   → If error found: Return ValidationResult(is_valid=False, error, line, column, suggestions)
```

## User Stories

### Primary User Story
**As a** formula author
**I want to** validate formulas before execution
**So that** I catch errors early with helpful messages

### Additional Stories
- **As a** UI developer, **I want to** show validation status in real-time, **So that** users get immediate feedback
- **As a** developer, **I want to** get suggestions for typos, **So that** I can quickly fix mistakes

## Acceptance Scenarios

### Scenario 1: Detect Unknown Function
**Given** expression "unknownfn(close, 20)"
**When** validated
**Then** returns ValidationResult with error "Unknown function: unknownfn" and suggestions like "sma"

### Scenario 2: Wrong Argument Count
**Given** expression "sma(close)"
**When** validated
**Then** returns ValidationResult with error "sma expects 2 arguments, got 1"

### Scenario 3: Unknown Field Name
**Given** expression "invalidfield > 100"
**When** validated
**Then** returns ValidationResult with error "Unknown field: invalidfield"

### Scenario 4: Valid Formula
**Given** expression "close > sma(close, 20) AND rsi(14) < 30"
**When** validated
**Then** returns ValidationResult(is_valid=True)

## Requirements

### Functional Requirements
- **FR-001**: Validator MUST detect unknown function names
- **FR-002**: Validator MUST check function argument counts
- **FR-003**: Validator MUST validate field/identifier names
- **FR-004**: Validator MUST return line/column for errors
- **FR-005**: Validator MUST provide suggestions for unknown functions

### Non-Functional Requirements
- **NFR-001**: Validation response < 50ms
- **NFR-002**: Test coverage > 90%

### Technical Constraints
- **TC-001**: Must maintain FUNCTION_SIGNATURES registry
- **TC-002**: Must maintain VALID_FIELDS set
- **TC-003**: Must integrate with FormulaService.validate()

## Key Entities

### Entity: SemanticValidator
- **Description**: Validates AST for semantic correctness
- **Key Attributes**: VALID_FIELDS, FUNCTION_SIGNATURES
- **Methods**: validate(ast) -> ValidationResult

### Entity: ValidationResult
- **Description**: Result of validation check
- **Key Attributes**: is_valid, error, line, column, suggestions[]

### Entity: FUNCTION_SIGNATURES
- **Description**: Registry of known functions with signatures
- **Key Attributes**: Dictionary mapping function name to {args, types[]}

## Dependencies

### Upstream Dependencies
- [ ] E05-F03-T01: FormulaService base class
- [ ] E05-F01: AST node definitions

### Downstream Impact
- [ ] UI components: Use validation for real-time feedback
- [ ] FormulaService: Exposes validate() method

## Gate Checks

### Pre-Implementation Gates
- [ ] E05-F03-T01 FormulaService class exists
- [ ] Function signatures documented

### Quality Gates
- [ ] Unit tests for all validation rules
- [ ] Suggestion algorithm tested
- [ ] Error message quality reviewed

## Subtasks Preview

| Subtask ID | Title | Effort |
|------------|-------|--------|
| [E05-F03-T03-S01](S01/E05-F03-T03-S01.spec.md) | Create semantic validator for AST | M |
| [E05-F03-T03-S02](S02/E05-F03-T03-S02.spec.md) | Implement ValidationResult with detailed error messages | S |
| [E05-F03-T03-S03](S03/E05-F03-T03-S03.spec.md) | Add validate() method to FormulaService | S |

## Success Criteria

### Acceptance Criteria
- [ ] Detect unknown functions with suggestions
- [ ] Validate function argument counts
- [ ] Validate field names
- [ ] Return line/column in error
- [ ] Include suggestions in ValidationResult

### Definition of Done
- [ ] All subtasks completed
- [ ] Unit tests passing
- [ ] Code reviewed
- [ ] Error messages reviewed for clarity

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Missing function signatures | Medium | Low | Update registry as functions added |
| Poor suggestion quality | Low | Low | Use Levenshtein distance |

## Artifacts

### Input Documents
- [Parent Feature](../E05-F03.spec.md)
- [E05-F03-T01](../T01/E05-F03-T01.spec.md)

### Output Artifacts
- [ ] `libs/dsl/validation.py`
- [ ] Unit tests for validation

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
