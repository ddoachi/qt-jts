---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F03-T02
clickup_task_id: '86ew020g6'
title: Implement Parameter Extraction from AST
type: task

# === HIERARCHY ===
parent: E05-F03
children: [E05-F03-T02-S01, E05-F03-T02-S02]
epic: E05
feature: F03
task: T02
domain: dsl

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 6
actual_hours: 0

# === METADATA ===
tags: [parameters, ast, visitor, extraction]
effort: medium
risk: low
---

# Spec: E05-F03-T02 - Implement Parameter Extraction from AST

**Status**: Draft
**Type**: Task
**Parent**: [E05-F03](../E05-F03.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement parameter extraction that traverses the AST to find all Parameter nodes and returns metadata about formula parameters. This enables dynamic parameter UI generation and default value management by discovering all `:param` references in expressions.

## Execution Flow

```
1. Receive AST root node
   → Initialize empty parameters list
   → Initialize seen set for deduplication
2. Traverse AST recursively
   → If node is Parameter and name not seen:
     → Add name to seen set
     → Create FormulaParameter with inferred metadata
     → Append to parameters list
   → If node has child nodes:
     → Recursively visit each child
3. Infer parameter metadata
   → Check COMMON_PARAMETERS for known names
   → If known: Use predefined type and description
   → If unknown: Default to float type
4. Return: list[FormulaParameter] in discovery order
```

## User Stories

### Primary User Story
**As a** UI developer
**I want to** get parameter metadata from formulas
**So that** I can generate dynamic input forms with appropriate controls

### Additional Stories
- **As a** formula author, **I want to** see all parameters in my formula, **So that** I can verify they're correct
- **As a** system, **I want to** deduplicate parameters, **So that** each parameter appears only once

## Acceptance Scenarios

### Scenario 1: Extract Multiple Parameters
**Given** expression "rsi(:period) < :threshold AND volume > average(volume, :vol_period)"
**When** parameters are extracted
**Then** returns parameters [period, threshold, vol_period] in order of appearance

### Scenario 2: Deduplicate Repeated Parameters
**Given** expression "sma(close, :period) > sma(open, :period)"
**When** parameters are extracted
**Then** returns parameters [period] with single entry

### Scenario 3: Infer Known Parameter Types
**Given** expression with parameter ":rsi_period"
**When** parameters are extracted
**Then** parameter has data_type="int" and description="RSI period"

### Scenario 4: Handle Unknown Parameters
**Given** expression with parameter ":custom_value"
**When** parameters are extracted
**Then** parameter has data_type="float" and generic description

## Requirements

### Functional Requirements
- **FR-001**: Extractor MUST find all Parameter nodes in AST
- **FR-002**: Extractor MUST deduplicate parameters by name
- **FR-003**: Extractor MUST preserve order of first appearance
- **FR-004**: Extractor MUST infer types for common parameter names

### Non-Functional Requirements
- **NFR-001**: Extraction < 5ms for typical expressions
- **NFR-002**: Test coverage > 90%

### Technical Constraints
- **TC-001**: Must use visitor pattern for AST traversal
- **TC-002**: Must handle all ASTNode types from E05-F01
- **TC-003**: Must return FormulaParameter dataclass instances

## Key Entities

### Entity: FormulaParameter
- **Description**: Extracted parameter metadata
- **Key Attributes**: name, data_type, default_value, description

### Entity: COMMON_PARAMETERS
- **Description**: Lookup table for known parameter names
- **Key Attributes**: Dictionary mapping name to {data_type, description}

## Dependencies

### Upstream Dependencies
- [ ] E05-F03-T01: FormulaService base class
- [ ] E05-F01: AST node definitions

### Downstream Impact
- [ ] UI components: Use parameter info for form generation
- [ ] Validation: Use parameters for completeness checks

## Gate Checks

### Pre-Implementation Gates
- [ ] E05-F03-T01 FormulaService class exists
- [ ] AST node types defined

### Quality Gates
- [ ] Unit tests for all parameter patterns
- [ ] Edge cases tested (empty, nested, duplicates)

## Subtasks Preview

| Subtask ID | Title | Effort |
|------------|-------|--------|
| [E05-F03-T02-S01](S01/E05-F03-T02-S01.spec.md) | Create AST visitor for parameter discovery | M |
| [E05-F03-T02-S02](S02/E05-F03-T02-S02.spec.md) | Implement parameter deduplication and metadata | S |

## Success Criteria

### Acceptance Criteria
- [ ] Find all Parameter nodes in AST
- [ ] Remove duplicate parameter references
- [ ] Infer parameter types from common names
- [ ] Return FormulaParameter list in order of appearance

### Definition of Done
- [ ] All subtasks completed
- [ ] Unit tests passing
- [ ] Code reviewed

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Missing AST node types | Low | Medium | Test with all node combinations |
| Type inference gaps | Low | Low | Provide safe default type |

## Artifacts

### Input Documents
- [Parent Feature](../E05-F03.spec.md)
- [E05-F03-T01](../T01/E05-F03-T01.spec.md)

### Output Artifacts
- [ ] `libs/dsl/parameters.py`
- [ ] Unit tests for parameter extraction

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
