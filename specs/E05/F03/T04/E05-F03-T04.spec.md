---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E05-F03-T04
clickup_task_id: '86ew020gb'
title: Implement find_matches() for Scan Results
type: task

# === HIERARCHY ===
parent: E05-F03
children: [E05-F03-T04-S01, E05-F03-T04-S02]
epic: E05
feature: F03
task: T04
domain: dsl

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-28'
updated: '2025-12-28'
due_date: ''
estimated_hours: 6
actual_hours: 0

# === METADATA ===
tags: [matching, scanning, filtering, results]
effort: medium
risk: low
---

# Spec: E05-F03-T04 - Implement find_matches() for Scan Results

**Status**: Draft
**Type**: Task
**Parent**: [E05-F03](../E05-F03.spec.md)
**Created**: 2025-12-28
**Updated**: 2025-12-28

## Executive Summary

Implement the find_matches() method that evaluates a formula on candle data and returns a list of matching candles with their values. This is the core method for market scanning, enabling efficient boolean filtering on Series data and returning rich result objects with candle data and computed values.

## Execution Flow

```
1. Receive formula, candle_series, and optional parameters
   → Convert CandleSeries to DataFrame
2. Evaluate formula on DataFrame
   → Call evaluate() with merged parameters
   → Result: pd.Series of boolean values
3. Filter to matching indices
   → Select indices where result == True
   → If no matches: Return empty list
4. Build FormulaMatch objects
   → For each matching index:
     → Get timestamp from index
     → Get Candle from CandleSeries
     → Extract OHLCV values
     → Create FormulaMatch object
5. Return: list[FormulaMatch]
```

## User Stories

### Primary User Story
**As a** trader
**I want to** find all candles matching my formula
**So that** I can identify trading opportunities

### Additional Stories
- **As a** backtester, **I want to** get matches with candle data, **So that** I can analyze entry points
- **As a** scanner, **I want to** efficient filtering, **So that** scans complete quickly

## Acceptance Scenarios

### Scenario 1: Find Matching Candles
**Given** formula "rsi(14) < 30" and candle data
**When** find_matches() is called
**Then** returns list of FormulaMatch with all candles where RSI < 30

### Scenario 2: Include Candle Values
**Given** matching candles exist
**When** FormulaMatch objects are created
**Then** each match includes timestamp, candle, and OHLCV values

### Scenario 3: No Matches Found
**Given** formula that matches no candles
**When** find_matches() is called
**Then** returns empty list []

### Scenario 4: Insufficient Data
**Given** candle data with fewer bars than indicator period
**When** find_matches() is called
**Then** returns empty list (indicator returns NaN)

## Requirements

### Functional Requirements
- **FR-001**: find_matches() MUST return FormulaMatch for each matching candle
- **FR-002**: FormulaMatch MUST include timestamp, candle, and OHLCV values
- **FR-003**: Method MUST handle empty results gracefully
- **FR-004**: Method MUST use efficient boolean filtering

### Non-Functional Requirements
- **NFR-001**: Filtering < 100ms for 10,000 candles
- **NFR-002**: Memory efficient (no large intermediate copies)
- **NFR-003**: Test coverage > 90%

### Technical Constraints
- **TC-001**: Must integrate with FormulaService.evaluate()
- **TC-002**: Must work with CandleSeries from data layer
- **TC-003**: Must not materialize large intermediate results

## Key Entities

### Entity: FormulaMatch
- **Description**: A candle that matched the formula
- **Key Attributes**: timestamp (datetime), candle (Candle), values (dict[str, Any])

### Entity: CandleSeries
- **Description**: Time series of candle data
- **Key Attributes**: as_dataframe, get_at(idx)

## Dependencies

### Upstream Dependencies
- [ ] E05-F03-T01: FormulaService.evaluate() method
- [ ] Data layer: CandleSeries class

### Downstream Impact
- [ ] E07: Scanning uses find_matches()
- [ ] E06: Backtesting uses find_matches()

## Gate Checks

### Pre-Implementation Gates
- [ ] E05-F03-T01 evaluate() method complete
- [ ] CandleSeries interface defined

### Quality Gates
- [ ] Unit tests with various formulas
- [ ] Performance benchmarks
- [ ] Edge cases tested

## Subtasks Preview

| Subtask ID | Title | Effort |
|------------|-------|--------|
| [E05-F03-T04-S01](S01/E05-F03-T04-S01.spec.md) | Create FormulaMatch result class | S |
| [E05-F03-T04-S02](S02/E05-F03-T04-S02.spec.md) | Implement efficient boolean filtering on Series | M |

## Success Criteria

### Acceptance Criteria
- [ ] Return FormulaMatch for each matching candle
- [ ] Include timestamp, candle, and computed values
- [ ] Efficient filtering (no full iteration)
- [ ] Handle empty results gracefully

### Definition of Done
- [ ] All subtasks completed
- [ ] Unit tests passing
- [ ] Performance validated
- [ ] Code reviewed

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Performance with large datasets | Medium | Medium | Use vectorized filtering |
| Memory pressure | Low | Medium | Avoid intermediate copies |

## Artifacts

### Input Documents
- [Parent Feature](../E05-F03.spec.md)
- [E05-F03-T01](../T01/E05-F03-T01.spec.md)

### Output Artifacts
- [ ] `libs/dsl/matching.py`
- [ ] Unit tests for find_matches

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
