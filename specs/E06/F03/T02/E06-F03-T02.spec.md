---
id: E06-F03-T02
clickup_task_id: null
title: Register All PRD Indicators
type: task
parent: E06-F03
children: []
epic: E06
feature: F03
task: T02
domain: Indicator Pipeline
status: Draft
priority: Medium
dates:
  start_date: null
  target_date: null
  end_date: null
hours:
  estimate: 8
  actual: null
tags:
  - indicators
  - registration
  - pipeline
effort: M
risk: Low
---

# Spec: E06-F03-T02 - Register All PRD Indicators

**Status:** Draft | **Priority:** Medium | **Effort:** M (Medium)

---

## Executive Summary

Register all technical indicators required by the PRD into the IndicatorPipeline. This provides a complete library of pre-defined indicators for formula evaluation. The task ensures all moving averages, momentum, volatility, and volume indicators are properly implemented and registered with default initialization.

**Key Objectives:**
1. Implement all PRD-required indicator calculations
2. Register default indicators on pipeline initialization
3. Ensure calculation correctness against known values
4. Optimize calculations for performance

---

## Execution Flow

1. **Initialize IndicatorPipeline** with default registration flag
2. **Register Moving Averages** (SMA and EMA variants)
3. **Register Momentum Indicators** (RSI, MACD, Stochastic)
4. **Register Volatility Indicators** (ATR, Bollinger Bands)
5. **Register Volume Indicators** (Volume SMA, OBV, VWAP)
6. **Validate Registration** through `get_available_indicators()`
7. **Execute Unit Tests** for correctness verification

---

## User Stories

**US-001:** As a formula evaluator, I need all standard technical indicators available so that I can reference them in formula expressions without manual registration.

**US-002:** As a system integrator, I need automatic default indicator registration so that the pipeline is immediately usable after initialization.

**US-003:** As a quality assurance engineer, I need correct indicator calculations verified against reference implementations so that formula results are mathematically accurate.

---

## Acceptance Scenarios

| Scenario | Given | When | Then |
|----------|-------|------|------|
| Default Initialization | IndicatorPipeline instantiated | with `register_defaults=True` | All PRD indicators are automatically registered |
| Manual Initialization | IndicatorPipeline instantiated | with `register_defaults=False` | No indicators are pre-registered |
| RSI Calculation | Sample price data (19 closes) | RSI computed at index 14 | Result matches reference value (≈70.53) |
| All Indicators Available | Pipeline initialized with defaults | Call `get_available_indicators()` | All 17 required indicators present in list |
| Incorrect Calculation | Any indicator | Uses wrong formula/period | Test fails and prevents deployment |

---

## Requirements

### Functional Requirements

**F-001: Moving Averages**
- Implement Simple Moving Averages (SMA): 20, 50, 200 periods
- Implement Exponential Moving Averages (EMA): 12, 26 periods

**F-002: Momentum Indicators**
- Implement RSI (14 periods)
- Implement MACD line (12/26 EMA)
- Implement MACD Signal (9-period EMA of MACD)
- Implement MACD Histogram (MACD - Signal)
- Implement Stochastic %K (14 periods)
- Implement Stochastic %D (3-period SMA of %K)

**F-003: Volatility Indicators**
- Implement ATR (14 periods)
- Implement Bollinger Bands: Upper, Middle, Lower (20 periods, 2 std dev)

**F-004: Volume Indicators**
- Implement Volume SMA (20 periods)
- Implement OBV (On-Balance Volume)
- Implement VWAP (Volume-Weighted Average Price)

### Non-Functional Requirements

**NF-001: Performance**
- All indicator calculations complete within 100ms for typical datasets (1000 rows)
- Memory usage optimized for pandas vectorized operations

**NF-002: Correctness**
- All calculations verified against reference implementations (TA-Lib, pandas_ta)
- Deviation tolerance: ±0.5 for normalized indicators, ±1% for value-based indicators

**NF-003: Reliability**
- No missing data handling errors
- Graceful degradation for insufficient data (rolling window not filled)

---

## Key Entities

| Entity | Description | Location |
|--------|-------------|----------|
| IndicatorPipeline | Main pipeline class managing indicator registration and computation | `indicator_pipeline.py` |
| IndicatorCalculator | Type alias for callable indicator functions | `types.py` |
| IIndicatorPipeline | Interface defining pipeline contract | `interfaces.py` |
| RSI Calculator | Relative Strength Index computation | `_calc_rsi()` method |
| ATR Calculator | Average True Range computation | `_calc_atr()` method |
| Bollinger Bands | Upper, middle, lower band calculations | `_calc_bb_*()` methods |

---

## Dependencies

### Parent Task
- **E06-F03-T01:** Implement Core IndicatorPipeline Interface (MUST be completed first)

### External Dependencies
- `pandas`: DataFrame operations and rolling window calculations
- `numpy`: Numerical computations
- Reference implementations for validation (TA-Lib or pandas_ta)

### Data Dependencies
- OHLCV data (Open, High, Low, Close, Volume) in pandas DataFrame format
- Minimum 200 rows for full indicator calculation (200-period SMA requirement)

---

## Gate Checks

- [ ] **Design Review:** Core IndicatorPipeline interface approved and implemented
- [ ] **Implementation Ready:** All indicator calculation algorithms verified against reference sources
- [ ] **Code Quality:** All methods have docstrings and type hints
- [ ] **Testing Prepared:** Test suite skeleton with assertions ready
- [ ] **Performance Baseline:** Initial performance measurements established

---

## Tasks Preview

1. **Implement Moving Average Indicators**
   - Register SMA 20, 50, 200
   - Register EMA 12, 26
   - Unit tests for each

2. **Implement Momentum Indicators**
   - Implement and test RSI (14)
   - Implement and test MACD (including signal and histogram)
   - Implement and test Stochastic (K and D)

3. **Implement Volatility Indicators**
   - Implement and test ATR (14)
   - Implement and test Bollinger Bands (upper, middle, lower)

4. **Implement Volume Indicators**
   - Implement and test Volume SMA (20)
   - Implement and test OBV
   - Implement and test VWAP

5. **Verification & Testing**
   - Run all unit tests
   - Perform correctness tests against reference values
   - Validate all 17 indicators are registered
   - Performance optimization if needed

---

## Success Criteria

- [ ] All moving averages implemented and registered (5 indicators)
- [ ] RSI calculation correct, verified against known values (44.34...46.00 data set → RSI[14] ≈ 70.53)
- [ ] MACD components implemented (3 indicators: line, signal, histogram)
- [ ] Stochastic indicators implemented (%K and %D)
- [ ] ATR calculation correct
- [ ] Bollinger Bands fully implemented (3 indicators: upper, middle, lower)
- [ ] Volume indicators implemented (3 indicators: SMA, OBV, VWAP)
- [ ] Unit tests for each of 17 indicators passing
- [ ] Correctness tests against reference implementations passing
- [ ] All indicators appear in `get_available_indicators()` output
- [ ] Default registration occurs automatically when `register_defaults=True`
- [ ] Manual registration possible when `register_defaults=False`

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|-----------|
| Calculation accuracy divergence from reference | Medium | High | Comprehensive test suite against TA-Lib, tight tolerance ranges |
| Performance bottleneck in rolling calculations | Low | Medium | Profile with realistic data sizes, optimize with pandas vectorization |
| Missing edge cases in indicator logic | Medium | Medium | Extensive unit tests, edge case scenarios, boundary value analysis |
| Stochastic indicator complexity | Low | Low | Clear code documentation, reference implementation verification |

---

## Notes and Clarifications

### Implementation Notes

**RSI Calculation Logic:**
```python
def _calc_rsi(self, df: pd.DataFrame, period: int = 14) -> pd.Series:
    """Calculate Relative Strength Index"""
    delta = df['close'].diff()
    gain = delta.where(delta > 0, 0)
    loss = (-delta).where(delta < 0, 0)

    avg_gain = gain.rolling(period).mean()
    avg_loss = loss.rolling(period).mean()

    rs = avg_gain / avg_loss
    return 100 - (100 / (1 + rs))
```

**ATR Calculation Logic:**
```python
def _calc_atr(self, df: pd.DataFrame, period: int = 14) -> pd.Series:
    """Calculate Average True Range"""
    high, low, close = df['high'], df['low'], df['close']

    tr1 = high - low
    tr2 = abs(high - close.shift(1))
    tr3 = abs(low - close.shift(1))

    tr = pd.concat([tr1, tr2, tr3], axis=1).max(axis=1)
    return tr.rolling(period).mean()
```

**Default Registration Pattern:**
```python
class IndicatorPipeline(IIndicatorPipeline):

    def __init__(self, register_defaults: bool = True):
        self._indicators: dict[str, IndicatorCalculator] = {}
        if register_defaults:
            self._register_defaults()

    def _register_defaults(self) -> None:
        """Register all PRD indicators"""
        # Moving Averages
        self.register('sma_20', lambda df: df['close'].rolling(20).mean())
        self.register('sma_50', lambda df: df['close'].rolling(50).mean())
        self.register('sma_200', lambda df: df['close'].rolling(200).mean())
        self.register('ema_12', lambda df: df['close'].ewm(span=12).mean())
        self.register('ema_26', lambda df: df['close'].ewm(span=26).mean())

        # Momentum
        self.register('rsi_14', self._calc_rsi)
        self.register('macd', self._calc_macd)
        self.register('macd_signal', self._calc_macd_signal)
        self.register('macd_histogram', self._calc_macd_histogram)

        # Volatility
        self.register('atr_14', self._calc_atr)
        self.register('bb_upper', self._calc_bb_upper)
        self.register('bb_middle', self._calc_bb_middle)
        self.register('bb_lower', self._calc_bb_lower)

        # Volume
        self.register('volume_sma_20', lambda df: df['volume'].rolling(20).mean())
        self.register('obv', self._calc_obv)
```

### Clarifications

- **VWAP Implementation:** While listed in indicators table, VWAP requires daily reset logic and special handling; consider as lower priority or future enhancement
- **Stochastic %K and %D:** Included in overview but specific implementation deferred to detailed task breakdown
- **Default Period Values:** All periods specified in indicators table are non-negotiable per PRD Section 7
- **Data Window Requirements:** Ensure DataFrames have sufficient rows; rolling(200) requires at least 200 data points for non-NaN results

---

## Artifacts

### Code Artifacts
- `/indicator_pipeline.py` - Main pipeline implementation with default registration
- `/indicators/moving_averages.py` - SMA and EMA calculation methods
- `/indicators/momentum.py` - RSI, MACD, Stochastic calculation methods
- `/indicators/volatility.py` - ATR and Bollinger Bands calculation methods
- `/indicators/volume.py` - Volume indicator calculation methods
- `/tests/test_indicators.py` - Comprehensive unit test suite

### Documentation Artifacts
- Calculation formulas verified against reference sources
- Performance baseline measurements
- Test coverage report

### Test Data Artifacts
- Known test dataset for RSI validation (19 close prices provided)
- Reference comparison datasets from TA-Lib

---

## Metadata

| Property | Value |
|----------|-------|
| Task ID | E06-F03-T02 |
| Title | Register All PRD Indicators |
| Status | Draft |
| Type | Implementation Task |
| Feature | E06-F03: Indicator Pipeline |
| Epic | E06 |
| Effort | M (Medium) |
| Hours Estimate | 8 |
| Priority | Medium |
| Risk Level | Low |
| Dependencies | E06-F03-T01 |
| Created | 2025-12-28 |
| Last Updated | 2025-12-28 |

**Indicators to Register (17 Total):**
- Moving Averages: sma_20, sma_50, sma_200, ema_12, ema_26 (5)
- Momentum: rsi_14, macd, macd_signal, macd_histogram, stoch_k, stoch_d (6)
- Volatility: atr_14, bb_upper, bb_middle, bb_lower (4)
- Volume: volume_sma_20, obv, vwap (3)
