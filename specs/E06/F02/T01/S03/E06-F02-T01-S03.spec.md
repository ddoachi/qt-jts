# Spec: E06-F02-T01-S03 - Batch Orchestration

---

id: E06-F02-T01-S03
clickup_task_id: ""
title: Batch Orchestration
type: subtask
parent: E06-F02-T01
children: []
epic: E06
feature: F02
task: T01
subtask: S03
domain: ProcessingEngine
status: Draft
priority: Medium
dates:
  start: ""
  target: ""
  actual: ""
hours:
  estimate: 8
  actual: 0
tags:
  - batch-processing
  - sequential
  - orchestration
effort: S
risk: Low

---

**Status:** Draft

---

## Executive Summary

Implement the `process_batch()` method that orchestrates processing multiple symbols sequentially. This provides a working batch processor that will be enhanced with parallelism in E06-F02-T02.

---

## Execution Flow

1. Receive ProcessingJob with multiple symbols
2. Initialize results collection and progress tracking
3. Iterate through each symbol sequentially:
   - Call `_process_symbol()` for each symbol
   - Append result to results collection
   - Log processing status (success/error)
   - Invoke progress callback if provided
4. Aggregate summary statistics
5. Log completion summary
6. Return collected results

---

## User Stories

- As a developer, I want to process multiple symbols in a single batch operation so that I can efficiently scan multiple securities
- As a developer, I want to receive progress updates during batch processing so that I can monitor long-running operations
- As a developer, I want batch processing to continue on error so that a single symbol failure doesn't halt the entire batch

---

## Acceptance Scenarios

| Scenario | Given | When | Then |
|----------|-------|------|------|
| Successful batch | Job with 3 symbols | process_batch() called | All 3 results returned with no errors |
| Progress tracking | Job with 4 symbols | progress_callback provided | Callback invoked 4 times with (1,4), (2,4), (3,4), (4,4) |
| Error resilience | Job where symbol B fails | process_batch() executes | Symbol A succeeds, B has error, C succeeds; batch completes |
| Summary logging | Batch of 5 symbols | process_batch() completes | Summary logged with processed count, error count, matches, total time |

---

## Requirements

### Functional Requirements

1. Implement `process_batch()` method on ProcessingEngine
2. Support sequential processing of all symbols in job.symbols
3. Invoke progress callback after each symbol completion with (completed_count, total_count)
4. Handle errors without stopping batch processing
5. Collect all ProcessingResult objects and return as list
6. Log per-symbol results (success or error)
7. Log summary statistics on batch completion

### Non-Functional Requirements

1. No external dependencies beyond existing ProcessingEngine structure
2. Logging at appropriate levels (info for start/completion, warning for errors, debug for per-symbol)
3. Progress callback should be optional

---

## Key Entities

### ProcessingJob
- `id`: Unique job identifier
- `symbols`: List of symbols to process
- `timeframe`: Trading timeframe (e.g., "1d")
- `date_range`: DateRange object with start and end dates
- `formula`: Trading formula to evaluate
- `parameters`: Configuration parameters

### ProcessingResult
- `symbol`: Symbol processed
- `matches`: List of matching candles/conditions
- `error`: Error message if processing failed
- `processing_time_ms`: Time taken to process

---

## Dependencies

### Internal Dependencies
- E06-F02-T01-S02: Single Symbol Processing (`_process_symbol()` method)
- ProcessingJob model
- ProcessingResult model
- IProcessingEngine interface

### External Dependencies
- None

### Blocking Dependencies
- E06-F02-T01-S02 must be completed before batch processing can function

---

## Gate Checks

- [ ] ProcessingJob and ProcessingResult models finalized
- [ ] `_process_symbol()` method implemented and working
- [ ] IProcessingEngine interface defined
- [ ] Logging infrastructure available
- [ ] Unit testing framework configured

---

## Tasks Preview

1. Implement process_batch() synchronous method
2. Implement async wrapper (process_batch_async)
3. Add comprehensive error handling
4. Add progress callback support
5. Add summary logging
6. Write and pass unit tests

---

## Success Criteria

- [x] process_batch() method implemented on ProcessingEngine
- [x] Sequential processing of all symbols
- [x] Progress callback invoked after each symbol completion
- [x] Error handling without stopping batch
- [x] Summary logging on completion
- [x] All results collected and returned
- [x] Unit tests for batch scenarios pass
- [x] Code review approval

---

## Risk Assessment

### Risks

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|-----------|
| Single symbol error halts batch | High | Medium | Implement try-catch per symbol, continue on error |
| Progress callback performance impact | Medium | Low | Make callback optional, benchmark if needed |
| Memory issues with large batches | Medium | Low | Consider batching by chunks in future; document limits |

---

## Notes and Clarifications

### Implementation Notes

- The `process_batch()` method is synchronous, blocking operation
- The async wrapper `process_batch_async()` uses `asyncio.to_thread()` to run synchronous code
- Progress callback receives (completed: int, total: int) tuple
- Errors are captured in ProcessingResult.error field, not raised

### Future Enhancements

- E06-F02-T02: Parallel Processing with true async/await
- Chunked batch processing for memory optimization
- Real-time streaming results (instead of batch return)

### Open Questions

- Should very large batches (>10k symbols) be automatically chunked?
- Should there be a timeout per symbol or per batch?

---

## Artifacts

### Code Files

- `/ProcessingEngine.process_batch()` - Main batch orchestration method
- `/ProcessingEngine.process_batch_async()` - Async wrapper
- `/ProcessingEngine._process_batch_sync()` - Helper for thread execution

### Test Files

- `test_batch_processing_sequential()` - Validates all symbols processed
- `test_batch_progress_callback()` - Validates progress tracking
- `test_batch_continues_on_error()` - Validates error resilience

---

## Metadata

| Field | Value |
|-------|-------|
| Subtask ID | E06-F02-T01-S03 |
| Title | Batch Orchestration |
| Status | Draft |
| Task | E06-F02-T01: Implement ProcessingEngine Core |
| Effort | S (Small) |
| Dependencies | E06-F02-T01-S02 |
| Created | 2025-12-28 |
| Last Modified | 2025-12-28 |
