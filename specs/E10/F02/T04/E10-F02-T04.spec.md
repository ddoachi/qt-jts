# Task E10-F02-T04: Equity and Drawdown Calculation

## Metadata

| Field | Value |
|-------|-------|
| Task ID | E10-F02-T04 |
| clickup_task_id | |
| Title | Equity and Drawdown Calculation |
| Feature | E10-F02 (Backtest Engine Core) |
| Epic | E10 (Backtesting) |
| Status | Draft |
| Effort | S |
| Risk | L |
| Dependencies | E10-F01, E10-F02-T01, E10-F02-T02 |

---

## 1. Overview

### 1.1 Purpose

Implement the equity calculation and drawdown tracking methods for the backtest engine. This includes calculating total portfolio value, tracking peak-to-trough decline, creating equity points, and generating daily return series.

### 1.2 Goals

1. **Equity Calculation**: Sum cash + positions value
2. **Drawdown Tracking**: Track peak and compute decline
3. **Equity Points**: Record daily equity state
4. **Daily Returns**: Generate return series

---

## 2. Core Implementation

### 2.1 Equity Calculation

```python
def _calculate_equity(
    self,
    portfolio: Portfolio,
    symbol_data: dict[str, pd.DataFrame],
    date: date
) -> Decimal:
    """Calculate total portfolio value (cash + positions)"""
    cash = portfolio.cash
    positions_value = Decimal(0)

    for symbol, position in portfolio.positions.items():
        if symbol in symbol_data:
            candle = self._get_candle_at(symbol_data[symbol], date)
            if candle:
                positions_value += position.current_value(candle.close)

    return cash + positions_value
```

### 2.2 Drawdown Calculation

```python
def _calculate_drawdown(
    self,
    current_equity: Decimal,
    equity_curve: list[EquityPoint]
) -> float:
    """Calculate current drawdown percentage from peak"""
    if not equity_curve:
        return 0.0

    # Find peak equity
    peak = max(e.equity for e in equity_curve)
    peak = max(peak, current_equity)

    if peak == 0:
        return 0.0

    drawdown = float((current_equity - peak) / peak) * 100
    return min(drawdown, 0.0)  # Drawdown is always <= 0
```

### 2.3 Equity Point Creation

```python
def _calculate_equity_point(
    self,
    portfolio: Portfolio,
    symbol_data: dict[str, pd.DataFrame],
    date: date,
    equity_curve: list[EquityPoint]
) -> EquityPoint:
    """Create equity point for current date"""
    equity = self._calculate_equity(portfolio, symbol_data, date)
    drawdown = self._calculate_drawdown(equity, equity_curve)

    return EquityPoint(
        date=date,
        equity=equity,
        cash=portfolio.cash,
        positions_value=equity - portfolio.cash,
        drawdown_pct=drawdown
    )
```

### 2.4 Daily Returns

```python
def _calculate_daily_returns(
    self,
    equity_curve: list[EquityPoint],
    config: BacktestConfig
) -> list[DailyReturn]:
    """Generate daily return series from equity curve"""
    if not equity_curve:
        return []

    daily_returns = []
    initial_capital = config.initial_capital

    for i, point in enumerate(equity_curve):
        if i == 0:
            prev_equity = initial_capital
        else:
            prev_equity = equity_curve[i - 1].equity

        # Daily return
        if prev_equity != 0:
            daily_pct = float((point.equity - prev_equity) / prev_equity) * 100
        else:
            daily_pct = 0.0

        # Cumulative return
        cumulative_pct = float((point.equity - initial_capital) / initial_capital) * 100

        daily_returns.append(DailyReturn(
            date=point.date,
            return_pct=daily_pct,
            cumulative_return_pct=cumulative_pct
        ))

    return daily_returns
```

---

## 3. Acceptance Criteria

### 3.1 Equity Calculation

- [ ] Sums cash and position market values
- [ ] Uses current prices for position valuation
- [ ] Handles empty positions dict
- [ ] Uses Decimal for monetary values

### 3.2 Drawdown Calculation

- [ ] Tracks running peak equity
- [ ] Returns negative percentage when below peak
- [ ] Returns 0.0 when at or above peak
- [ ] Handles empty equity curve

### 3.3 Equity Point

- [ ] Contains date, equity, cash, positions_value
- [ ] Contains drawdown_pct
- [ ] All values correctly calculated

### 3.4 Daily Returns

- [ ] Daily return computed from previous day
- [ ] First day uses initial_capital as previous
- [ ] Cumulative return relative to initial_capital
- [ ] Handles empty equity curve

### 3.5 Testing

- [ ] Unit tests for equity calculation
- [ ] Unit tests for drawdown calculation
- [ ] Unit tests for daily returns
- [ ] Edge case tests (zero values, empty data)
- [ ] Test coverage > 90%

---

## 4. Technical Notes

### 4.1 Design Decisions

| Decision | Choice | Reason |
|----------|--------|--------|
| Drawdown | Negative percentage | Standard convention |
| Peak tracking | Running maximum | Efficient calculation |
| First day return | vs initial_capital | Consistent baseline |

### 4.2 Edge Cases

```python
# Empty equity curve: drawdown = 0.0
# Zero equity: drawdown = 0.0 (avoid division by zero)
# First day: daily return = (equity - initial_capital) / initial_capital
```

### 4.3 Estimated LOC

- `_calculate_equity()`: ~15 LOC
- `_calculate_drawdown()`: ~15 LOC
- `_calculate_equity_point()`: ~15 LOC
- `_calculate_daily_returns()`: ~25 LOC
- Tests: ~100 LOC
- **Total: ~70-80 LOC (production code)**

### 4.4 Files to Modify

- `libs/core/src/backtesting/engine/backtest_engine.py` (extended)
- `tests/unit/backtesting/engine/test_equity_calculation.py`

---

## 5. Dependencies

### 5.1 Upstream

| Dependency | Provides |
|------------|----------|
| E10-F01 | EquityPoint, DailyReturn models |
| E10-F02-T01 | Portfolio class with positions |
| E10-F02-T02 | _get_candle_at() method |

### 5.2 Downstream

| Dependent | Uses |
|-----------|------|
| E10-F04 | equity_curve and daily_returns for metrics |
| E10-F05 | equity_curve for charting |

---

## 6. References

- E10-F02.spec.md Section 3.3: Key Methods
- E10-F01: EquityPoint, DailyReturn models
