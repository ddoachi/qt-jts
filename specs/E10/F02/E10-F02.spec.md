# Spec: E10-F02 - Backtest Engine Core

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E10-F02
clickup_task_id: ''
title: Backtest Engine Core
type: feature

# === HIERARCHY ===
parent: E10
children: [E10-F02-T01, E10-F02-T02, E10-F02-T03, E10-F02-T04]
epic: E10
feature: F02
domain: backtesting

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 32
actual_hours: 0

# === METADATA ===
tags: [engine, simulation, portfolio, backtesting]
effort: large
risk: medium
complexity: L
dependencies: [E04, E06, E09]
internal_dependencies: [E10-F01]
parallel_group: wave-2
prd_sections: [5.5]
---

**Status**: Draft
**Type**: Feature
**Parent**: [E10 - Backtesting](../E10.spec.md)
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Executive Summary

Implement the core simulation engine that executes backtests by iterating through historical trading days, managing portfolio state, and coordinating with external services for data and signal evaluation.

## Goals

1. **Accurate Simulation**: Realistic trade execution with slippage and commission
2. **Fast Execution**: 1 year backtest in < 5 seconds
3. **Memory Efficient**: < 500MB memory usage during backtest
4. **Progress Tracking**: Callback support for UI progress updates

---

## Architecture

### Engine Design

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           BacktestEngine                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌──────────┐ │
│  │  Data       │───►│  Signal     │───►│  Order      │───►│  Metrics │ │
│  │  Feed       │    │  Generator  │    │  Executor   │    │  Calc    │ │
│  │             │    │             │    │             │    │          │ │
│  │  OHLCV      │    │  Entry/Exit │    │  Simulate   │    │  Sharpe, │ │
│  │  Stream     │    │  Signals    │    │  Fills      │    │  DD, etc │ │
│  └─────────────┘    └─────────────┘    └─────────────┘    └──────────┘ │
│                            │                   │                        │
│                            ▼                   ▼                        │
│                     ┌─────────────┐    ┌─────────────┐                 │
│                     │  Position   │◄───│  Portfolio  │                 │
│                     │  Manager    │    │  Tracker    │                 │
│                     └─────────────┘    └─────────────┘                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Simulation Loop

```python
for each day in date_range:
    for each symbol in universe:
        candle = get_candle(symbol, day)

        # Check exits first (priority)
        for position in open_positions[symbol]:
            if should_exit(position, candle, strategy):
                close_position(position, candle)

        # Check entries
        if not has_position(symbol):
            if should_enter(symbol, candle, strategy):
                open_position(symbol, candle)

    # End of day processing
    update_portfolio_value(day)
    check_daily_limits()
```

---

## Core Components

### BacktestEngine Class

```python
class BacktestEngine:
    """Core backtesting engine"""

    def __init__(
        self,
        candle_repo: ICandleRepository,  # From E04
        formula_service: FormulaService   # From E06
    ): ...

    async def run(
        self,
        config: BacktestConfig,
        progress_callback: Callable[[int, int], None] = None
    ) -> BacktestResult: ...
```

### Portfolio State

```python
@dataclass
class Portfolio:
    """Internal portfolio state during simulation"""
    cash: Decimal
    positions: dict[str, Position]

@dataclass
class Position:
    """Open position during simulation"""
    symbol: str
    quantity: int
    entry_price: Decimal
    entry_date: date
    side: TradeSide
```

### Key Methods

| Method | Description |
|--------|-------------|
| `run()` | Main entry point - runs complete backtest |
| `_load_data()` | Bulk load candle data for all symbols |
| `_get_trading_days()` | Get list of trading days in range |
| `_get_candle_at()` | Get candle data for symbol at date |
| `_calculate_equity()` | Calculate total portfolio value |
| `_calculate_drawdown()` | Calculate current drawdown |

---

## Acceptance Criteria

### Simulation Accuracy

- [ ] Simulation loop processes all trading days in order
- [ ] Portfolio state (cash, positions) tracked correctly
- [ ] Open positions closed at end of backtest (TIMEOUT reason)
- [ ] Commission calculated on both entry and exit
- [ ] Slippage applied to execution prices

### Performance

- [ ] 1 year backtest (252 trading days) completes in < 5 seconds
- [ ] Memory usage stays below 500MB during execution
- [ ] Data loaded in bulk for efficiency (not per-candle)

### Integration

- [ ] Uses ICandleRepository for historical data
- [ ] Uses FormulaService for signal evaluation
- [ ] Returns properly populated BacktestResult

### Progress Tracking

- [ ] Progress callback called with (current_day, total_days)
- [ ] Callback optional - engine works without it

### Testing

- [ ] Unit tests for portfolio state management
- [ ] Integration tests with mock repositories
- [ ] Performance benchmark tests
- [ ] Test coverage > 85%

---

## Technical Notes

### Design Decisions

| Decision | Choice | Reason |
|----------|--------|--------|
| Data loading | Bulk upfront | Avoid I/O during simulation loop |
| Loop order | Exit before entry | Prevent same-day reversal conflicts |
| Progress | Callback pattern | Decouples engine from UI |
| State | Mutable Portfolio | Performance over immutability |

### Performance Optimizations

- Pre-load all candle data into memory
- Use pandas DataFrame for efficient time-series operations
- Avoid object creation in hot path
- Use dict for O(1) position lookup

### Files to Create

- `libs/core/src/backtesting/engine/backtest_engine.py`
- `libs/core/src/backtesting/engine/portfolio.py`
- `libs/core/src/backtesting/engine/__init__.py`

---

## Dependencies

### External

| Dependency | Interface | From |
|------------|-----------|------|
| `ICandleRepository` | Historical candle data | E04 (Data) |
| `FormulaService` | Formula evaluation | E06 (Processing) |
| `Strategy` | Entry/exit rules | E09 (Strategy) |

### Internal

| Dependency | Provides |
|------------|----------|
| E10-F01 | BacktestConfig, BacktestResult, Trade, Position |

---

## Tasks

| Task ID | Title | Effort | Dependencies | Description |
|---------|-------|--------|--------------|-------------|
| [E10-F02-T01](T01/E10-F02-T01.spec.md) | Portfolio State Management | M | E10-F01 | Portfolio and Position classes for simulation state |
| [E10-F02-T02](T02/E10-F02-T02.spec.md) | BacktestEngine Skeleton and Data Loading | M | T01, E04, E06 | Engine class with DI and data loading methods |
| [E10-F02-T03](T03/E10-F02-T03.spec.md) | Simulation Loop Implementation | L | T01, T02 | Core simulation loop with slippage/commission |
| [E10-F02-T04](T04/E10-F02-T04.spec.md) | Equity and Drawdown Calculation | S | T01, T02 | Equity, drawdown, and daily returns calculation |

### Task Dependency Graph

```mermaid
graph TD
    subgraph E10-F02: Backtest Engine Core
        T01[T01: Portfolio State]
        T02[T02: Engine Skeleton]
        T03[T03: Simulation Loop]
        T04[T04: Equity Calculation]
    end

    subgraph External
        F01[E10-F01: Domain Models]
        E04[E04: Data]
        E06[E06: Processing]
    end

    F01 --> T01
    T01 --> T02
    E04 --> T02
    E06 --> T02
    T01 --> T03
    T02 --> T03
    T01 --> T04
    T02 --> T04
```

### Parallelization

- **Parallel**: T01 can start immediately (only needs F01)
- **Sequential**: T02 requires T01 completion
- **Parallel**: T03 and T04 can be developed in parallel after T02

---

## References

- PRD Section 5.5: Backtesting
- E04: Data Collection
- E06: Processing Engine
- E09: Strategy Builder
