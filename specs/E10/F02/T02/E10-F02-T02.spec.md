# Spec: E10-F02-T02 - BacktestEngine Skeleton and Data Loading

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E10-F02-T02
clickup_task_id: '86ew0ftw1'
title: BacktestEngine Skeleton and Data Loading
type: task

# === HIERARCHY ===
parent: E10-F02
children: []
epic: E10
feature: F02
task: T02
domain: backtesting

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 8
actual_hours: 0

# === METADATA ===
tags: [backtesting, engine, data-loading, trading-calendar]
effort: medium
risk: medium
---

**Status**: Draft
**Type**: Task
**Parent**: [E10-F02 - Backtest Engine Core](../E10-F02.spec.md)
**Created**: 2025-12-30
**Updated**: 2025-12-30

## 1. Overview

### 1.1 Purpose

Implement the `BacktestEngine` class skeleton with dependency injection and the data loading infrastructure. This includes the constructor accepting `ICandleRepository` and `FormulaService`, the bulk data loading method `_load_data()`, and the trading calendar integration method `_get_trading_days()`.

### 1.2 Goals

1. **Class Structure**: BacktestEngine with DI constructor
2. **Data Loading**: Bulk load candle data for all symbols
3. **Trading Calendar**: Generate trading days (exclude weekends)
4. **Candle Access**: Helper to retrieve candle at specific date

---

## 2. Core Implementation

### 2.1 BacktestEngine Class

```python
class BacktestEngine:
    """Core backtesting engine"""

    def __init__(
        self,
        candle_repo: ICandleRepository,  # From E04
        formula_service: FormulaService   # From E06
    ):
        self._candle_repo = candle_repo
        self._formula_service = formula_service

    async def run(
        self,
        config: BacktestConfig,
        progress_callback: Callable[[int, int], None] = None
    ) -> BacktestResult:
        """Run backtest with given configuration"""
        # Stub - implemented in T03
        pass
```

### 2.2 Data Loading

```python
async def _load_data(
    self,
    config: BacktestConfig
) -> dict[str, pd.DataFrame]:
    """Bulk load candle data for all symbols"""
    symbol_data = {}
    for symbol in config.symbols:
        candles = await self._candle_repo.get_candles(
            symbol=symbol,
            start_date=config.start_date,
            end_date=config.end_date
        )
        df = pd.DataFrame([c.to_dict() for c in candles])
        if not df.empty:
            df.set_index('date', inplace=True)
        symbol_data[symbol] = df
    return symbol_data
```

### 2.3 Trading Days

```python
def _get_trading_days(
    self,
    start_date: date,
    end_date: date
) -> list[date]:
    """Get list of trading days in range (excludes weekends)"""
    days = []
    current = start_date
    while current <= end_date:
        # Exclude Saturday (5) and Sunday (6)
        if current.weekday() < 5:
            days.append(current)
        current += timedelta(days=1)
    return days
```

### 2.4 Candle Access

```python
def _get_candle_at(
    self,
    df: pd.DataFrame,
    target_date: date
) -> Optional[Candle]:
    """Get candle data for specific date"""
    if df.empty or target_date not in df.index:
        return None
    row = df.loc[target_date]
    return Candle(
        date=target_date,
        open=Decimal(str(row['open'])),
        high=Decimal(str(row['high'])),
        low=Decimal(str(row['low'])),
        close=Decimal(str(row['close'])),
        volume=int(row['volume'])
    )
```

---

## 3. Acceptance Criteria

### 3.1 Constructor

- [ ] BacktestEngine accepts ICandleRepository
- [ ] BacktestEngine accepts FormulaService
- [ ] Dependencies stored as private attributes

### 3.2 Data Loading

- [ ] `_load_data()` loads candles for all symbols in config
- [ ] `_load_data()` loads data for config date range
- [ ] Returns dict[str, DataFrame] keyed by symbol
- [ ] Empty DataFrame for symbols with no data

### 3.3 Trading Days

- [ ] `_get_trading_days()` excludes weekends
- [ ] Returns dates in ascending order
- [ ] Includes start and end dates if trading days

### 3.4 Candle Access

- [ ] `_get_candle_at()` returns Candle for valid dates
- [ ] Returns None for dates not in DataFrame
- [ ] Handles empty DataFrame

### 3.5 Testing

- [ ] Unit tests with mock repository
- [ ] Trading days tests for various ranges
- [ ] Candle lookup edge cases
- [ ] Test coverage > 85%

---

## 4. Technical Notes

### 4.1 Design Decisions

| Decision | Choice | Reason |
|----------|--------|--------|
| Data loading | Upfront bulk load | No I/O during simulation |
| Trading calendar | Weekends only | Simple, holidays can be added later |
| DataFrame index | Date | O(1) candle lookup |
| run() | async | Support async repository calls |

### 4.2 Estimated LOC

- BacktestEngine class skeleton: ~40 LOC
- `_load_data()` method: ~30 LOC
- `_get_trading_days()` method: ~20 LOC
- `_get_candle_at()` method: ~15 LOC
- Tests: ~150 LOC
- **Total: ~100-120 LOC (production code)**

### 4.3 Files to Create

- `libs/core/src/backtesting/engine/backtest_engine.py`
- `libs/core/src/backtesting/engine/__init__.py`
- `tests/unit/backtesting/engine/test_backtest_engine.py`

---

## 5. Dependencies

### 5.1 Upstream

| Dependency | Provides |
|------------|----------|
| E10-F01 | BacktestConfig, BacktestResult |
| E10-F02-T01 | Portfolio, Position classes |
| E04 | ICandleRepository interface |
| E06 | FormulaService |

### 5.2 Downstream

| Dependent | Uses |
|-----------|------|
| E10-F02-T03 | _load_data(), _get_trading_days(), _get_candle_at() |
| E10-F02-T04 | Engine structure for equity calculation |

---

## 6. References

- E10-F02.spec.md Section 3.1: BacktestEngine Class
- E10-F02.spec.md Section 3.3: Key Methods
- E04: ICandleRepository

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
