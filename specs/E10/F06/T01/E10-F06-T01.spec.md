# Spec: E10-F06-T01 - CSV Export Service

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E10-F06-T01
clickup_task_id: '86ew0fu0a'
title: Create BacktestResultExporter CSV Service
type: task

# === HIERARCHY ===
parent: E10-F06
children: []
epic: E10
feature: F06
task: T01
domain: backtesting

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [export, csv, persistence, formatting]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E10-F06 - Export and Persistence](../E10-F06.spec.md)
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Executive Summary

Create a `BacktestResultExporter` service that exports backtest results to CSV format. The service provides trade list CSV export with all trade details and metrics summary CSV export with key performance indicators. Files use UTF-8 with BOM encoding for Korean character support in Excel.

## Execution Flow

```
1. Initialize BacktestResultExporter
   -> No state required (stateless service)
   -> Ready to export

2. Export Trade List CSV (export_trades_csv)
   -> Receive list[Trade] and file_path
   -> Write CSV header with 15 columns
   -> Iterate trades, format each field
   -> Handle optional fields (exit_date, exit_price, etc.)
   -> Write with UTF-8-sig encoding
   -> Return: SUCCESS with file written

3. Export Metrics Summary CSV (export_metrics_csv)
   -> Receive PerformanceMetrics and file_path
   -> Write "Metric,Value" header
   -> Format each metric with appropriate precision
   -> Percentages with % suffix, ratios with 2 decimals
   -> Return: SUCCESS with file written

4. Export Full Report (export_full_report)
   -> Receive BacktestResult and directory
   -> Create directory if not exists
   -> Call export_trades_csv with unique filename
   -> Call export_metrics_csv with unique filename
   -> Return: dict with file paths
```

## User Stories

### Primary User Story
**As a** trader
**I want to** export backtest results to CSV
**So that** I can analyze trades in Excel or other tools

### Additional Stories
- **As a** quant analyst, **I want to** export metrics summary, **So that** I can compare strategies in spreadsheets
- **As a** developer, **I want to** export full reports, **So that** I can archive complete backtest results

## Acceptance Scenarios

### Scenario 1: Trade List Export
**Given** a list of completed trades
**When** calling export_trades_csv()
**Then** CSV file contains all trades with correct columns

### Scenario 2: Korean Character Support
**Given** trades with Korean symbol names (e.g., "Samsung Electronics")
**When** opening exported CSV in Excel
**Then** Korean characters display correctly

### Scenario 3: Optional Fields Handling
**Given** trades with some None exit fields (open positions)
**When** exporting to CSV
**Then** empty strings used for None values

### Scenario 4: Metrics Export
**Given** PerformanceMetrics object
**When** calling export_metrics_csv()
**Then** CSV contains all key metrics with proper formatting

### Scenario 5: Full Report Export
**Given** a BacktestResult object
**When** calling export_full_report()
**Then** both trades and metrics CSVs created in target directory

## Requirements

### Functional Requirements
- **FR-001**: export_trades_csv() MUST write CSV with 15 trade columns
- **FR-002**: export_metrics_csv() MUST write CSV with all key metrics
- **FR-003**: export_full_report() MUST create both CSV files
- **FR-004**: MUST use UTF-8 with BOM encoding (utf-8-sig)
- **FR-005**: MUST handle None/Optional fields gracefully
- **FR-006**: MUST format Decimal values as float for CSV
- **FR-007**: MUST format dates as ISO 8601 strings
- **FR-008**: MUST handle special characters in symbol names

### Non-Functional Requirements
- **NFR-001**: Export 1000 trades in < 1 second
- **NFR-002**: Memory efficient streaming writes
- **NFR-003**: Thread-safe (stateless service)

### Technical Constraints
- **TC-001**: Use Python standard csv module
- **TC-002**: Use pathlib.Path for file paths
- **TC-003**: Depend only on E10-F01 domain models

## Key Entities

### Class: BacktestResultExporter
```python
from pathlib import Path
from decimal import Decimal

class BacktestResultExporter:
    """Export backtest results to CSV format"""

    def export_trades_csv(
        self,
        trades: list[Trade],
        file_path: Path
    ) -> None:
        """
        Export trade list to CSV.

        Columns:
        - ID, Symbol, Symbol Name, Side
        - Entry Date, Entry Price, Quantity
        - Exit Date, Exit Price, Exit Reason
        - P&L, P&L %, Holding Days
        - Commission, Slippage
        """
        ...

    def export_metrics_csv(
        self,
        metrics: PerformanceMetrics,
        file_path: Path
    ) -> None:
        """
        Export metrics summary to CSV.

        Format: Metric,Value
        Includes: Total Return, CAGR, Sharpe, Sortino, Calmar,
                  Max Drawdown, Win Rate, Profit Factor,
                  Total Trades, Avg Holding Days, Final Equity
        """
        ...

    def export_full_report(
        self,
        result: BacktestResult,
        directory: Path
    ) -> dict[str, Path]:
        """
        Export complete backtest report.

        Creates:
        - trades_{result.id}.csv
        - metrics_{result.id}.csv

        Returns dict with 'trades' and 'metrics' paths.
        """
        ...
```

### CSV Format: Trade List
```csv
ID,Symbol,Symbol Name,Side,Entry Date,Entry Price,Quantity,Exit Date,Exit Price,Exit Reason,P&L,P&L %,Holding Days,Commission,Slippage
trade-001,005930,Samsung Electronics,LONG,2024-01-15,72000,100,2024-01-18,75600,TAKE_PROFIT,360000,5.0,3,2160,1800
```

### CSV Format: Metrics Summary
```csv
Metric,Value
Total Return,45.2%
CAGR,22.6%
Sharpe Ratio,1.85
Sortino Ratio,2.41
Calmar Ratio,3.67
Max Drawdown,-12.3%
Win Rate,62.0%
Profit Factor,2.15
Total Trades,127
Avg Holding Days,4.3
Final Equity,145200000
```

## Dependencies

### Upstream Dependencies
- [ ] E10-F01: Trade, PerformanceMetrics, BacktestResult domain models

### Downstream Impact
- [ ] Used by E10-F05 UI Components for export functionality
- [ ] Used by user workflows for external analysis

## Gate Checks

### Pre-Implementation Gates
- [x] E10-F01 domain models defined
- [x] CSV column specifications documented

### Quality Gates
- [ ] Unit tests for each export method
- [ ] Korean character encoding test
- [ ] Large trade set performance test
- [ ] Test coverage > 90%

## Success Criteria

### Acceptance Criteria
- [ ] Trade CSV includes all 15 columns
- [ ] Metrics CSV includes all key metrics
- [ ] UTF-8 with BOM for Excel compatibility
- [ ] Optional fields handled with empty strings
- [ ] Full report creates both files

### Definition of Done
- [ ] Code reviewed
- [ ] Unit tests passing
- [ ] Documentation complete
- [ ] Korean character test verified

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Excel encoding issues | Medium | Medium | Use utf-8-sig BOM |
| Decimal precision loss | Low | Medium | Format to float explicitly |
| Large file performance | Low | Low | Streaming writes |

## Artifacts

### Output Artifacts
- [ ] `libs/core/src/backtesting/export/__init__.py`
- [ ] `libs/core/src/backtesting/export/exporter.py`
- [ ] `libs/core/tests/backtesting/export/test_exporter.py`

---
*Template Version: 2.0.0 - Enhanced with Speckit features*
