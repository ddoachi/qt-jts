# Spec: E10-F01-T03 - Result Aggregates and Performance Metrics

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E10-F01-T03
title: Result Aggregates and Performance Metrics
type: task

# === HIERARCHY ===
parent: E10-F01
children: []
epic: E10
feature: F01
task: T03
domain: backtesting

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [domain, aggregate, metrics, backtesting, result]
effort: medium
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E10-F01 - Domain Models](../E10-F01.spec.md)
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Metadata

| Field | Value |
|-------|-------|
| Task ID | E10-F01-T03 |
| Title | Result Aggregates and Performance Metrics |
| Feature | E10-F01 (Domain Models) |
| Status | Draft |
| Complexity | M (100-150 LOC) |
| Dependencies | E10-F01-T01, E10-F01-T02 |
| Estimated LOC | 130 |

---

## 1. Overview

### 1.1 Purpose

Define the `BacktestResult` aggregate root and `PerformanceMetrics` dataclass that capture the complete output of a backtest run. `BacktestResult` aggregates configuration, trades, equity curve, and calculated metrics into a single coherent result object. `PerformanceMetrics` provides comprehensive statistical analysis including returns, risk-adjusted ratios, and trade statistics.

### 1.2 Deliverables

- `PerformanceMetrics` dataclass with all metric fields
- `BacktestResult` aggregate root with serialization support
- Unit tests for all components
- Package `__init__.py` with public exports

---

## 2. Implementation

### 2.1 PerformanceMetrics

```python
from dataclasses import dataclass
from decimal import Decimal

@dataclass(frozen=True)
class PerformanceMetrics:
    """
    Key performance metrics for a backtest.

    Contains return metrics, risk-adjusted ratios, drawdown analysis,
    and comprehensive trade statistics.
    """
    # Returns
    total_return_pct: float          # Total return percentage
    cagr: float                      # Compound annual growth rate

    # Risk-adjusted ratios
    sharpe_ratio: float              # Sharpe ratio (annualized)
    sortino_ratio: float             # Sortino ratio (downside risk only)
    calmar_ratio: float              # Calmar ratio (CAGR / Max DD)

    # Drawdown metrics
    max_drawdown_pct: float          # Maximum drawdown percentage (negative)
    avg_drawdown_pct: float          # Average drawdown percentage
    max_drawdown_duration_days: int  # Longest drawdown period in days

    # Trade statistics
    total_trades: int                # Total number of trades
    winning_trades: int              # Number of winning trades
    losing_trades: int               # Number of losing trades
    win_rate: float                  # Win rate percentage (0-100)
    profit_factor: float             # Gross profit / Gross loss
    avg_win: float                   # Average winning trade P&L %
    avg_loss: float                  # Average losing trade P&L %
    largest_win: float               # Largest winning trade %
    largest_loss: float              # Largest losing trade %
    avg_holding_days: float          # Average holding period in days

    # Final values
    final_equity: Decimal            # Final portfolio value
    final_cash: Decimal              # Final cash balance

    @property
    def break_even_trades(self) -> int:
        """Trades with zero P&L"""
        return self.total_trades - self.winning_trades - self.losing_trades

    @property
    def expectancy(self) -> float:
        """Expected return per trade"""
        if self.total_trades == 0:
            return 0.0
        win_rate_decimal = self.win_rate / 100
        return (win_rate_decimal * self.avg_win) + ((1 - win_rate_decimal) * self.avg_loss)

    @property
    def is_profitable(self) -> bool:
        """Check if overall backtest was profitable"""
        return self.total_return_pct > 0

    @classmethod
    def empty(cls) -> 'PerformanceMetrics':
        """Create empty metrics for no-trade scenarios"""
        return cls(
            total_return_pct=0.0,
            cagr=0.0,
            sharpe_ratio=0.0,
            sortino_ratio=0.0,
            calmar_ratio=0.0,
            max_drawdown_pct=0.0,
            avg_drawdown_pct=0.0,
            max_drawdown_duration_days=0,
            total_trades=0,
            winning_trades=0,
            losing_trades=0,
            win_rate=0.0,
            profit_factor=0.0,
            avg_win=0.0,
            avg_loss=0.0,
            largest_win=0.0,
            largest_loss=0.0,
            avg_holding_days=0.0,
            final_equity=Decimal(0),
            final_cash=Decimal(0)
        )
```

### 2.2 BacktestResult

```python
from dataclasses import dataclass, field
from datetime import datetime
from typing import Any
import uuid

@dataclass
class BacktestResult:
    """
    Complete backtest results (aggregate root).

    Aggregates all output from a backtest run including configuration,
    performance metrics, equity curve, trades, and daily returns.
    """
    id: str
    config: 'BacktestConfig'
    metrics: PerformanceMetrics
    equity_curve: list['EquityPoint']
    trades: list['Trade']
    daily_returns: list['DailyReturn']
    execution_time_ms: float
    created_at: datetime = field(default_factory=datetime.utcnow)

    @classmethod
    def create(
        cls,
        config: 'BacktestConfig',
        metrics: PerformanceMetrics,
        equity_curve: list['EquityPoint'],
        trades: list['Trade'],
        daily_returns: list['DailyReturn'],
        execution_time_ms: float
    ) -> 'BacktestResult':
        """Factory method to create a new BacktestResult"""
        return cls(
            id=str(uuid.uuid4()),
            config=config,
            metrics=metrics,
            equity_curve=equity_curve,
            trades=trades,
            daily_returns=daily_returns,
            execution_time_ms=execution_time_ms
        )

    @property
    def trade_count(self) -> int:
        """Number of trades executed"""
        return len(self.trades)

    @property
    def duration_days(self) -> int:
        """Backtest duration in days"""
        return len(self.daily_returns)

    @property
    def has_trades(self) -> bool:
        """Check if any trades were executed"""
        return len(self.trades) > 0

    def to_dict(self) -> dict[str, Any]:
        """Serialize to dictionary for persistence"""
        return {
            'id': self.id,
            'config': {
                'strategy_id': getattr(self.config.strategy, 'id', None),
                'symbols': self.config.symbols,
                'start_date': self.config.start_date.isoformat(),
                'end_date': self.config.end_date.isoformat(),
                'initial_capital': str(self.config.initial_capital),
                'commission_pct': self.config.commission_pct,
                'slippage_pct': self.config.slippage_pct,
                'timeframe': self.config.timeframe,
            },
            'metrics': {
                'total_return_pct': self.metrics.total_return_pct,
                'cagr': self.metrics.cagr,
                'sharpe_ratio': self.metrics.sharpe_ratio,
                'sortino_ratio': self.metrics.sortino_ratio,
                'calmar_ratio': self.metrics.calmar_ratio,
                'max_drawdown_pct': self.metrics.max_drawdown_pct,
                'avg_drawdown_pct': self.metrics.avg_drawdown_pct,
                'max_drawdown_duration_days': self.metrics.max_drawdown_duration_days,
                'total_trades': self.metrics.total_trades,
                'winning_trades': self.metrics.winning_trades,
                'losing_trades': self.metrics.losing_trades,
                'win_rate': self.metrics.win_rate,
                'profit_factor': self.metrics.profit_factor,
                'avg_win': self.metrics.avg_win,
                'avg_loss': self.metrics.avg_loss,
                'largest_win': self.metrics.largest_win,
                'largest_loss': self.metrics.largest_loss,
                'avg_holding_days': self.metrics.avg_holding_days,
                'final_equity': str(self.metrics.final_equity),
                'final_cash': str(self.metrics.final_cash),
            },
            'equity_curve': [
                {
                    'date': ep.date.isoformat(),
                    'equity': str(ep.equity),
                    'cash': str(ep.cash),
                    'positions_value': str(ep.positions_value),
                    'drawdown_pct': ep.drawdown_pct,
                }
                for ep in self.equity_curve
            ],
            'trades': [
                {
                    'id': t.id,
                    'symbol': t.symbol,
                    'symbol_name': t.symbol_name,
                    'side': t.side.value,
                    'entry_date': t.entry_date.isoformat(),
                    'entry_price': str(t.entry_price),
                    'entry_quantity': t.entry_quantity,
                    'exit_date': t.exit_date.isoformat() if t.exit_date else None,
                    'exit_price': str(t.exit_price) if t.exit_price else None,
                    'exit_reason': t.exit_reason.value if t.exit_reason else None,
                    'pnl': str(t.pnl) if t.pnl else None,
                    'pnl_pct': t.pnl_pct,
                    'holding_days': t.holding_days,
                    'commission': str(t.commission),
                    'slippage': str(t.slippage),
                }
                for t in self.trades
            ],
            'daily_returns': [
                {
                    'date': dr.date.isoformat(),
                    'return_pct': dr.return_pct,
                    'cumulative_return_pct': dr.cumulative_return_pct,
                }
                for dr in self.daily_returns
            ],
            'execution_time_ms': self.execution_time_ms,
            'created_at': self.created_at.isoformat(),
        }
```

### 2.3 Package __init__.py

```python
"""
Backtesting Domain Models

Public API for backtesting domain entities and value objects.
"""

from .trade import Trade, TradeSide, ExitReason
from .config import BacktestConfig, EquityPoint, DailyReturn
from .result import BacktestResult, PerformanceMetrics

__all__ = [
    # Enums
    'TradeSide',
    'ExitReason',
    # Entities
    'Trade',
    # Value Objects
    'EquityPoint',
    'DailyReturn',
    'PerformanceMetrics',
    # Configuration
    'BacktestConfig',
    # Aggregates
    'BacktestResult',
]
```

### 2.4 File Locations

- `libs/core/src/backtesting/domain/result.py`
- `libs/core/src/backtesting/domain/metrics.py` (or combined in result.py)
- `libs/core/src/backtesting/domain/__init__.py`

---

## 3. Acceptance Criteria

- [ ] `PerformanceMetrics` is immutable (frozen dataclass)
- [ ] `PerformanceMetrics` has all 22 metric fields with proper types
- [ ] `PerformanceMetrics.expectancy` calculates expected return per trade
- [ ] `PerformanceMetrics.break_even_trades` calculates correctly
- [ ] `PerformanceMetrics.is_profitable` returns correct boolean
- [ ] `PerformanceMetrics.empty()` creates valid zero-state metrics
- [ ] `BacktestResult` has unique UUID on creation
- [ ] `BacktestResult.create()` factory method works correctly
- [ ] `BacktestResult.to_dict()` serializes all fields to JSON-compatible dict
- [ ] `BacktestResult.to_dict()` handles None values in Trade fields
- [ ] Package `__init__.py` exports all public types

---

## 4. Testing Requirements

- [ ] Test `PerformanceMetrics` creation with valid data
- [ ] Test `PerformanceMetrics` immutability
- [ ] Test `PerformanceMetrics.expectancy` calculation (positive and negative)
- [ ] Test `PerformanceMetrics.break_even_trades` calculation
- [ ] Test `PerformanceMetrics.is_profitable` for profit and loss cases
- [ ] Test `PerformanceMetrics.empty()` returns valid zero metrics
- [ ] Test `BacktestResult.create()` generates unique IDs
- [ ] Test `BacktestResult.create()` sets created_at timestamp
- [ ] Test `BacktestResult.trade_count` property
- [ ] Test `BacktestResult.duration_days` property
- [ ] Test `BacktestResult.has_trades` for empty and non-empty trade lists
- [ ] Test `BacktestResult.to_dict()` serialization completeness
- [ ] Test `BacktestResult.to_dict()` handles open trades (None exit fields)
- [ ] Test serialization roundtrip (to_dict values match original)
- [ ] Test coverage > 95%

---

## 5. Dependencies

### 5.1 Upstream Dependencies

- E10-F01-T01: Uses Trade, TradeSide, ExitReason
- E10-F01-T02: Uses BacktestConfig, EquityPoint, DailyReturn

### 5.2 Downstream Impact

- E10-F02 (Engine Core): Returns BacktestResult from backtest runs
- E10-F04 (Metrics Calculator): Creates PerformanceMetrics instances
- E10-F05 (UI Components): Displays PerformanceMetrics
- E10-F06 (Export/Persistence): Uses to_dict() for serialization

---

## 6. Technical Notes

### 6.1 Design Decisions

| Decision | Choice | Reason |
|----------|--------|--------|
| Aggregate root | `BacktestResult` | Single entry point for all backtest output |
| Factory method | `create()` | Encapsulates ID generation and defaults |
| Serialization | `to_dict()` | JSON-compatible for persistence and export |
| Frozen metrics | `PerformanceMetrics` | Immutable after calculation |
| Decimal serialization | `str()` | Preserve precision in JSON |

### 6.2 Edge Cases

- Empty backtest (no trades): Use `PerformanceMetrics.empty()`
- Very short backtest (1 day): Valid but limited metrics
- No winning or losing trades: `profit_factor` = 0, `avg_win`/`avg_loss` = 0
- Negative Sharpe/Sortino: Valid for underperforming strategies

### 6.3 Performance Metrics Definitions

| Metric | Formula |
|--------|---------|
| Win Rate | (winning_trades / total_trades) * 100 |
| Profit Factor | gross_profit / abs(gross_loss) |
| Expectancy | (win_rate * avg_win) + ((1 - win_rate) * avg_loss) |
| Sharpe Ratio | (mean_return * 252) / (std_return * sqrt(252)) |
| Calmar Ratio | CAGR / abs(max_drawdown) |

---

## 7. Artifacts

### 7.1 Output Files

- `libs/core/src/backtesting/domain/result.py`
- `libs/core/src/backtesting/domain/__init__.py`
- `libs/core/tests/backtesting/domain/test_result.py`
- `libs/core/tests/backtesting/domain/test_metrics.py`

---

*Template Version: 2.0.0 - Enhanced with Speckit features*
