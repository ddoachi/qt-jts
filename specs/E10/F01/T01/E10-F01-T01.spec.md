# Spec: E10-F01-T01 - Core Enums and Trade Entity

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E10-F01-T01
clickup_task_id: ''
title: Core Enums and Trade Entity
type: task

# === HIERARCHY ===
parent: E10-F01
children: []
epic: E10
feature: F01
task: T01
domain: backtesting

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 3
actual_hours: 0

# === METADATA ===
tags: [domain, entities, trade, enums, backtesting]
effort: small
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E10-F01 - Domain Models](../E10-F01.spec.md)
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Metadata

| Field | Value |
|-------|-------|
| Task ID | E10-F01-T01 |
| Title | Core Enums and Trade Entity |
| Feature | E10-F01 (Domain Models) |
| Status | Draft |
| Complexity | S (50-100 LOC) |
| Dependencies | None |
| Estimated LOC | 80 |

---

## 1. Overview

### 1.1 Purpose

Define the foundational enums (`TradeSide`, `ExitReason`) and the `Trade` entity with its computed properties. These components are prerequisites for all other domain models in E10-F01 and establish the core vocabulary for trade tracking in the backtesting system.

### 1.2 Deliverables

- `TradeSide` enum (LONG, SHORT)
- `ExitReason` enum (SIGNAL, STOP_LOSS, TAKE_PROFIT, TIMEOUT, DAILY_LIMIT)
- `Trade` dataclass with entry/exit fields and computed properties
- Unit tests for all components

---

## 2. Implementation

### 2.1 TradeSide Enum

```python
from enum import Enum

class TradeSide(Enum):
    """Trade direction enum"""
    LONG = "long"
    SHORT = "short"
```

### 2.2 ExitReason Enum

```python
class ExitReason(Enum):
    """Trade exit reason enum"""
    SIGNAL = "signal"           # Exit rule triggered
    STOP_LOSS = "stop_loss"     # Stop-loss hit
    TAKE_PROFIT = "take_profit" # Take-profit target reached
    TIMEOUT = "timeout"         # End of backtest period
    DAILY_LIMIT = "daily_limit" # Daily loss limit reached
```

### 2.3 Trade Entity

```python
from dataclasses import dataclass
from datetime import date
from decimal import Decimal
from typing import Optional

@dataclass
class Trade:
    """
    A completed or open trade in the backtest.

    Represents a single trade with entry and optional exit information,
    P&L calculations, and cost tracking.
    """
    id: str
    symbol: str
    symbol_name: str
    side: TradeSide
    entry_date: date
    entry_price: Decimal
    entry_quantity: int
    exit_date: Optional[date] = None
    exit_price: Optional[Decimal] = None
    exit_reason: Optional[ExitReason] = None
    pnl: Optional[Decimal] = None
    pnl_pct: Optional[float] = None
    holding_days: Optional[int] = None
    commission: Decimal = Decimal(0)
    slippage: Decimal = Decimal(0)

    def __post_init__(self):
        """Validate trade data after initialization"""
        if not self.id:
            raise ValueError("Trade ID is required")
        if not self.symbol:
            raise ValueError("Symbol is required")
        if self.entry_quantity <= 0:
            raise ValueError("Entry quantity must be positive")
        if self.entry_price <= 0:
            raise ValueError("Entry price must be positive")

    @property
    def is_winner(self) -> bool:
        """Check if trade is profitable"""
        return self.pnl is not None and self.pnl > 0

    @property
    def is_loser(self) -> bool:
        """Check if trade is a loss"""
        return self.pnl is not None and self.pnl < 0

    @property
    def is_open(self) -> bool:
        """Check if trade is still open (no exit)"""
        return self.exit_date is None

    @property
    def net_pnl(self) -> Decimal:
        """Calculate net P&L after costs"""
        if self.pnl is None:
            return Decimal(0)
        return self.pnl - self.commission - self.slippage

    @property
    def total_cost(self) -> Decimal:
        """Total transaction costs"""
        return self.commission + self.slippage

    @property
    def entry_value(self) -> Decimal:
        """Total entry position value"""
        return self.entry_price * self.entry_quantity
```

### 2.4 File Location

- `libs/core/src/backtesting/domain/trade.py`

---

## 3. Acceptance Criteria

- [ ] `TradeSide` enum has LONG and SHORT values with string representations
- [ ] `ExitReason` enum has all 5 exit reasons with string representations
- [ ] `Trade` dataclass has all required fields with proper types
- [ ] `Trade.__post_init__` validates id, symbol, quantity, and price
- [ ] `Trade.is_winner` correctly identifies profitable trades (pnl > 0)
- [ ] `Trade.is_loser` correctly identifies losing trades (pnl < 0)
- [ ] `Trade.is_open` correctly identifies trades without exit_date
- [ ] `Trade.net_pnl` correctly subtracts commission and slippage from pnl

---

## 4. Testing Requirements

- [ ] Test `TradeSide` enum values and string conversion
- [ ] Test `ExitReason` enum values and string conversion
- [ ] Test `Trade` creation with valid data
- [ ] Test `Trade` validation rejects empty id
- [ ] Test `Trade` validation rejects empty symbol
- [ ] Test `Trade` validation rejects non-positive quantity
- [ ] Test `Trade` validation rejects non-positive price
- [ ] Test `Trade.is_winner` returns True when pnl > 0
- [ ] Test `Trade.is_winner` returns False when pnl <= 0 or None
- [ ] Test `Trade.is_loser` returns True when pnl < 0
- [ ] Test `Trade.net_pnl` calculation with costs
- [ ] Test `Trade.net_pnl` returns 0 when pnl is None
- [ ] Test `Trade.is_open` for open and closed trades
- [ ] Test `Trade.entry_value` calculation
- [ ] Test coverage > 95%

---

## 5. Dependencies

### 5.1 Upstream Dependencies

- None (foundation layer)

### 5.2 Downstream Impact

- E10-F01-T02: Uses TradeSide for configuration context
- E10-F01-T03: Uses Trade, TradeSide, ExitReason in BacktestResult

---

## 6. Technical Notes

### 6.1 Design Decisions

| Decision | Choice | Reason |
|----------|--------|--------|
| Enum string values | Lowercase strings | JSON serialization compatibility |
| Decimal for money | `Decimal` type | Precision for financial calculations |
| Optional exit fields | `Optional[T]` | Support open trades during backtest |
| Validation in `__post_init__` | Dataclass pattern | Early error detection |

### 6.2 Edge Cases

- Trade with no exit (open position): `exit_date`, `exit_price`, `exit_reason`, `pnl`, `pnl_pct`, `holding_days` are all None
- Trade with zero P&L: Should return `is_winner = False` and `is_loser = False`
- Trade with None pnl: `net_pnl` should return `Decimal(0)`

---

## 7. Artifacts

### 7.1 Output Files

- `libs/core/src/backtesting/domain/trade.py`
- `libs/core/tests/backtesting/domain/test_trade.py`

---

*Template Version: 2.0.0 - Enhanced with Speckit features*
