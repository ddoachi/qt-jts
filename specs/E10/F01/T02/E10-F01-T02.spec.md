# Spec: E10-F01-T02 - Configuration and Supporting Dataclasses

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E10-F01-T02
clickup_task_id: '86ew0ftv3'
title: Configuration and Supporting Dataclasses
type: task

# === HIERARCHY ===
parent: E10-F01
children: []
epic: E10
feature: F01
task: T02
domain: backtesting

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 3
actual_hours: 0

# === METADATA ===
tags: [domain, config, dataclass, backtesting, equity-curve]
effort: small
risk: low
---

**Status**: Draft
**Type**: Task
**Parent**: [E10-F01 - Domain Models](../E10-F01.spec.md)
**Created**: 2025-12-30
**Updated**: 2025-12-30

## Metadata

| Field | Value |
|-------|-------|
| Task ID | E10-F01-T02 |
| Title | Configuration and Supporting Dataclasses |
| Feature | E10-F01 (Domain Models) |
| Status | Draft |
| Complexity | S (50-100 LOC) |
| Dependencies | E09 (Strategy) |
| Estimated LOC | 90 |

---

## 1. Overview

### 1.1 Purpose

Define the `BacktestConfig` dataclass for configuring backtest runs, along with supporting value objects `EquityPoint` and `DailyReturn` that track portfolio state over time. These components provide the input configuration and time-series data structures for backtesting.

### 1.2 Deliverables

- `BacktestConfig` dataclass with validation
- `EquityPoint` dataclass for equity curve points
- `DailyReturn` dataclass for daily return tracking
- Unit tests for all components

---

## 2. Implementation

### 2.1 BacktestConfig

```python
from dataclasses import dataclass, field
from datetime import date
from decimal import Decimal
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from strategy.domain import Strategy  # E09

@dataclass
class BacktestConfig:
    """
    Backtest configuration parameters.

    Defines all settings needed to run a backtest including strategy,
    symbols, date range, capital, and cost assumptions.
    """
    strategy: 'Strategy'          # From E09
    symbols: list[str]            # Stock symbols to trade
    start_date: date              # Backtest start date
    end_date: date                # Backtest end date
    initial_capital: Decimal = Decimal("100000000")  # 1억원 default
    commission_pct: float = 0.015   # 0.015% default
    slippage_pct: float = 0.05      # 0.05% default
    timeframe: str = "1d"           # Candle timeframe

    def __post_init__(self):
        """Validate configuration parameters"""
        if self.start_date >= self.end_date:
            raise ValueError("start_date must be before end_date")
        if self.initial_capital <= 0:
            raise ValueError("initial_capital must be positive")
        if not (0 <= self.commission_pct <= 100):
            raise ValueError("commission_pct must be between 0 and 100")
        if not (0 <= self.slippage_pct <= 100):
            raise ValueError("slippage_pct must be between 0 and 100")
        if not self.symbols:
            raise ValueError("At least one symbol is required")
        if self.timeframe not in ("1d", "1h", "4h", "1w"):
            raise ValueError(f"Invalid timeframe: {self.timeframe}")

    @property
    def date_range_days(self) -> int:
        """Calculate number of days in backtest period"""
        return (self.end_date - self.start_date).days

    @property
    def symbol_count(self) -> int:
        """Number of symbols in universe"""
        return len(self.symbols)
```

### 2.2 EquityPoint

```python
from dataclasses import dataclass
from datetime import date
from decimal import Decimal

@dataclass(frozen=True)
class EquityPoint:
    """
    A point on the equity curve.

    Represents portfolio state at end of a trading day including
    total equity, cash, position values, and drawdown.
    """
    date: date
    equity: Decimal               # Total portfolio value
    cash: Decimal                 # Available cash
    positions_value: Decimal      # Value of open positions
    drawdown_pct: float           # Current drawdown from peak (negative)

    def __post_init__(self):
        """Validate equity point data"""
        if self.equity < 0:
            raise ValueError("equity cannot be negative")
        if self.cash < 0:
            raise ValueError("cash cannot be negative")
        if self.positions_value < 0:
            raise ValueError("positions_value cannot be negative")
        if self.drawdown_pct > 0:
            raise ValueError("drawdown_pct must be <= 0 (negative represents loss)")

    @property
    def is_at_peak(self) -> bool:
        """Check if equity is at all-time high"""
        return self.drawdown_pct == 0.0
```

### 2.3 DailyReturn

```python
from dataclasses import dataclass
from datetime import date

@dataclass(frozen=True)
class DailyReturn:
    """
    Daily return record.

    Tracks the return percentage for a single day and the
    cumulative return from backtest start.
    """
    date: date
    return_pct: float             # Daily return percentage
    cumulative_return_pct: float  # Cumulative return from start

    @property
    def is_positive(self) -> bool:
        """Check if daily return is positive"""
        return self.return_pct > 0

    @property
    def is_negative(self) -> bool:
        """Check if daily return is negative"""
        return self.return_pct < 0
```

### 2.4 File Location

- `libs/core/src/backtesting/domain/config.py`

---

## 3. Acceptance Criteria

- [ ] `BacktestConfig` has all required fields with proper types
- [ ] `BacktestConfig` validates start_date < end_date
- [ ] `BacktestConfig` validates initial_capital > 0
- [ ] `BacktestConfig` validates commission_pct in range [0, 100]
- [ ] `BacktestConfig` validates slippage_pct in range [0, 100]
- [ ] `BacktestConfig` validates symbols list is not empty
- [ ] `BacktestConfig` validates timeframe is one of allowed values
- [ ] `EquityPoint` is immutable (frozen dataclass)
- [ ] `EquityPoint` validates non-negative equity, cash, positions_value
- [ ] `EquityPoint` validates drawdown_pct <= 0
- [ ] `DailyReturn` is immutable (frozen dataclass)
- [ ] `DailyReturn.is_positive` and `is_negative` work correctly

---

## 4. Testing Requirements

- [ ] Test `BacktestConfig` creation with valid data
- [ ] Test `BacktestConfig` rejects start_date >= end_date
- [ ] Test `BacktestConfig` rejects non-positive initial_capital
- [ ] Test `BacktestConfig` rejects invalid commission_pct (negative or > 100)
- [ ] Test `BacktestConfig` rejects invalid slippage_pct (negative or > 100)
- [ ] Test `BacktestConfig` rejects empty symbols list
- [ ] Test `BacktestConfig` rejects invalid timeframe
- [ ] Test `BacktestConfig.date_range_days` calculation
- [ ] Test `BacktestConfig.symbol_count` property
- [ ] Test `EquityPoint` creation with valid data
- [ ] Test `EquityPoint` immutability (cannot modify after creation)
- [ ] Test `EquityPoint` rejects negative equity
- [ ] Test `EquityPoint` rejects positive drawdown_pct
- [ ] Test `EquityPoint.is_at_peak` property
- [ ] Test `DailyReturn` creation and immutability
- [ ] Test `DailyReturn.is_positive` and `is_negative` properties
- [ ] Test coverage > 95%

---

## 5. Dependencies

### 5.1 Upstream Dependencies

- E09: Strategy Builder (Strategy entity for BacktestConfig.strategy field)

### 5.2 Downstream Impact

- E10-F01-T03: Uses BacktestConfig in BacktestResult
- E10-F01-T03: Uses EquityPoint and DailyReturn in BacktestResult

---

## 6. Technical Notes

### 6.1 Design Decisions

| Decision | Choice | Reason |
|----------|--------|--------|
| Frozen dataclasses | `EquityPoint`, `DailyReturn` | Immutability for time-series data integrity |
| Default capital | 100,000,000 KRW | Common Korean stock market starting capital |
| Default costs | 0.015% commission, 0.05% slippage | Realistic Korean market assumptions |
| Supported timeframes | 1d, 1h, 4h, 1w | Common analysis periods |

### 6.2 Edge Cases

- Single-day backtest: `start_date` and `end_date` one day apart is valid
- Zero commission/slippage: Valid configuration for friction-free backtests
- Large drawdown: `drawdown_pct` can be -100% or lower (theoretical)

### 6.3 Korean Market Context

- Default initial capital (1억원 = 100M KRW) is a common retail investor starting point
- Commission rates reflect current Korean brokerage fees
- Slippage accounts for typical bid-ask spreads in KOSPI/KOSDAQ

---

## 7. Artifacts

### 7.1 Output Files

- `libs/core/src/backtesting/domain/config.py`
- `libs/core/tests/backtesting/domain/test_config.py`

---

*Template Version: 2.0.0 - Enhanced with Speckit features*
