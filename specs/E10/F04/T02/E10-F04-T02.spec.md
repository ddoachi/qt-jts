---
id: E10-F04-T02
clickup_task_id: null
title: Drawdown Analysis Implementation
type: task
parent: E10-F04
children: []
epic: E10
feature: F04
task: T02
domain: backtesting
status: Draft
priority: High
dates:
  created: '2025-12-30'
  due: null
  started: null
  completed: null
hours:
  estimated: 5
  spent: 0
tags:
  - metrics
  - drawdown
  - risk-analysis
  - equity-curve
effort: M
risk: L
---

# Spec: E10-F04-T02 - Drawdown Analysis Implementation

**Status:** Draft | **Priority:** High | **Effort:** Medium | **Risk:** Low

---

## Executive Summary

Implement drawdown analysis calculations for the MetricsCalculator including maximum drawdown, average drawdown, and maximum drawdown duration. Drawdown metrics are critical risk indicators that measure peak-to-trough declines in portfolio equity and recovery time.

---

## Execution Flow

1. **Implement Max Drawdown**: Track running peak and calculate largest percentage decline from peak
2. **Implement Average Drawdown**: Calculate mean drawdown during drawdown periods only
3. **Implement Drawdown Duration**: Track calendar days from peak until recovery (new peak)
4. **Build Drawdown Series**: Create helper to generate complete drawdown series for analysis

---

## User Stories

- As a risk manager, I want max drawdown calculated so I can understand worst-case portfolio decline.
- As a trader, I want average drawdown so I can understand typical drawdown severity.
- As a portfolio manager, I want max drawdown duration so I can understand recovery time expectations.
- As an analyst, I want the drawdown series so I can visualize drawdown over time.

---

## Acceptance Scenarios

| Scenario | Given | When | Then |
|----------|-------|------|------|
| Simple max drawdown | Equity: 100M -> 120M -> 96M -> 110M | `_calc_max_drawdown()` | Returns -20.0 (%) |
| No drawdown | Monotonically increasing equity | `_calc_max_drawdown()` | Returns 0.0 |
| Empty equity curve | No equity points | `_calc_max_drawdown()` | Returns 0.0 |
| Average drawdown | Multiple drawdown periods | `_calc_avg_drawdown()` | Returns mean of negative drawdowns |
| Duration calculation | Peak at day 10, recovery at day 25 | `_calc_dd_duration()` | Returns 15 days |
| Never recovered | Drawdown continues to end | `_calc_dd_duration()` | Returns days from peak to end |

---

## Requirements

### Functional Requirements
- **FR-001**: `_calc_max_drawdown(equity_curve)` MUST return largest peak-to-trough decline as negative percentage
- **FR-002**: `_calc_avg_drawdown(equity_curve)` MUST return mean of drawdown periods (only when < 0)
- **FR-003**: `_calc_dd_duration(equity_curve)` MUST return longest drawdown period in calendar days
- **FR-004**: All methods MUST handle empty equity curves (return 0)
- **FR-005**: All methods MUST handle single-point equity curves (return 0)
- **FR-006**: Drawdown percentage MUST be calculated as `(equity - peak) / peak * 100`

### Non-Functional Requirements
- **NFR-001**: O(n) time complexity for all calculations (single pass)
- **NFR-002**: Use Decimal for equity comparisons to maintain precision
- **NFR-003**: Return float for percentage values
- **NFR-004**: Calendar days for duration (not trading days)

### Technical Constraints
- **TC-001**: Depend on E10-F01 EquityPoint domain model
- **TC-002**: Peak tracking must handle equity exactly equal to previous peak
- **TC-003**: Duration uses EquityPoint.date field for calendar day calculation

---

## Key Entities

### Methods to Implement

```python
class MetricsCalculator:
    """Drawdown analysis calculations"""

    def _calc_max_drawdown(self, equity_curve: list[EquityPoint]) -> float:
        """Calculate maximum drawdown percentage

        Returns the largest peak-to-trough decline as a negative percentage.
        Example: -20.0 means portfolio dropped 20% from its peak.
        """
        if not equity_curve:
            return 0.0

        peak = equity_curve[0].equity
        max_dd = 0.0

        for point in equity_curve:
            if point.equity > peak:
                peak = point.equity

            dd = float((point.equity - peak) / peak) * 100
            if dd < max_dd:
                max_dd = dd

        return max_dd

    def _calc_avg_drawdown(self, equity_curve: list[EquityPoint]) -> float:
        """Calculate average drawdown percentage

        Returns mean drawdown during periods when portfolio is below peak.
        Only considers points where drawdown < 0.
        """
        if not equity_curve:
            return 0.0

        drawdowns = []
        peak = equity_curve[0].equity

        for point in equity_curve:
            if point.equity > peak:
                peak = point.equity

            dd = float((point.equity - peak) / peak) * 100
            if dd < 0:
                drawdowns.append(dd)

        if not drawdowns:
            return 0.0

        return np.mean(drawdowns)

    def _calc_dd_duration(self, equity_curve: list[EquityPoint]) -> int:
        """Calculate maximum drawdown duration in calendar days

        Returns the longest period from a peak until a new peak is reached.
        If still in drawdown at end, counts days to final point.
        """
        if not equity_curve:
            return 0

        peak = equity_curve[0].equity
        peak_date = equity_curve[0].date
        max_duration = 0
        current_duration = 0

        for point in equity_curve:
            if point.equity >= peak:
                # New peak reached - reset
                peak = point.equity
                peak_date = point.date
                current_duration = 0
            else:
                # Still in drawdown
                current_duration = (point.date - peak_date).days
                if current_duration > max_duration:
                    max_duration = current_duration

        return max_duration

    def _build_drawdown_series(
        self,
        equity_curve: list[EquityPoint]
    ) -> list[float]:
        """Build complete drawdown series for visualization

        Returns list of drawdown percentages for each equity point.
        Useful for charting drawdown over time.
        """
        if not equity_curve:
            return []

        drawdowns = []
        peak = equity_curve[0].equity

        for point in equity_curve:
            if point.equity > peak:
                peak = point.equity

            dd = float((point.equity - peak) / peak) * 100
            drawdowns.append(dd)

        return drawdowns
```

### Algorithm Visualization

```
Equity Curve Example:

    120 |        * peak
        |       / \
    110 |      /   \      * recovery
        |     /     \    /
    100 | --*        \  /
        |             \/
     96 |             * max drawdown (-20%)
        +--+--+--+--+--+--+--+--
          D1 D2 D3 D4 D5 D6 D7 D8

Max Drawdown: (96 - 120) / 120 * 100 = -20%
Duration: D5 (peak) to D7 (recovery) = 2 days
```

---

## Dependencies

### Upstream Dependencies
- **E10-F01**: Domain Models (EquityPoint with date, equity fields)
- **numpy**: For mean calculation in average drawdown

### Downstream Impact
- **E10-F04-T01**: Calmar ratio uses max_drawdown result
- **E10-F04-T03**: Main calculate() uses all drawdown methods
- **E10-F05**: UI displays drawdown chart and metrics

---

## Gate Checks

### Pre-Implementation Gates
- [x] E10-F01 EquityPoint model defined with date and equity fields
- [x] Decimal type used for equity values

### Quality Gates
- [ ] Unit tests for each drawdown method
- [ ] Edge case tests (empty, single point, no drawdown, continuous drawdown)
- [ ] Visual verification with known equity curves
- [ ] Test coverage > 90%

---

## Success Criteria

### Acceptance Criteria
- [ ] Max drawdown calculates correct peak-to-trough decline
- [ ] Average drawdown excludes non-drawdown periods
- [ ] Duration tracks calendar days correctly
- [ ] All methods handle edge cases without exceptions
- [ ] Drawdown series builds correctly for charting

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing with > 90% coverage
- [ ] Visual validation with sample equity curves
- [ ] Integration with T03 orchestrator verified

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Peak detection edge cases | Low | Medium | Test with flat periods, exact peaks |
| Date calculation errors | Low | Low | Use datetime.date subtraction |
| Precision loss | Low | Low | Use Decimal for equity, float for output |

---

## Artifacts

### Output Artifacts
- [ ] `libs/core/src/backtesting/metrics/calculator.py` (partial - drawdown methods)
- [ ] `tests/unit/backtesting/metrics/test_drawdown_analysis.py`

### Test Data
```python
# Known value test cases
def create_test_equity_curve():
    """Create equity curve for testing

    Pattern: 100M -> 110M -> 120M -> 96M -> 100M -> 115M
    Expected max_dd: -20% (from 120M to 96M)
    Expected duration: varies by date assignment
    """
    from datetime import date, timedelta
    from decimal import Decimal

    base_date = date(2024, 1, 1)
    equities = [100, 110, 120, 96, 100, 115]

    return [
        EquityPoint(
            date=base_date + timedelta(days=i),
            equity=Decimal(str(e * 1_000_000)),
            cash=Decimal(str(e * 1_000_000)),
            positions_value=Decimal(0),
            drawdown_pct=0.0  # Will be calculated
        )
        for i, e in enumerate(equities)
    ]

test_cases = {
    "max_drawdown": {
        "equity_values": [100, 110, 120, 96, 100, 115],
        "expected_max_dd": -20.0
    },
    "no_drawdown": {
        "equity_values": [100, 105, 110, 115, 120],
        "expected_max_dd": 0.0
    },
    "continuous_decline": {
        "equity_values": [100, 95, 90, 85, 80],
        "expected_max_dd": -20.0
    }
}
```

---

## Notes and Clarifications

- Drawdown is always expressed as a negative percentage (or zero)
- Peak is updated only when equity strictly exceeds previous peak (not equal)
- Duration uses calendar days, not trading days, for simplicity
- The `_build_drawdown_series()` helper is for visualization support
- EquityPoint already has `drawdown_pct` field - these methods recalculate for accuracy

---

## References

- PRD Section 5.5.2: Performance Metrics
- [Maximum Drawdown - Investopedia](https://www.investopedia.com/terms/m/maximum-drawdown-mdd.asp)
- E10-F04.spec.md Section 2.3: Drawdown Metrics

---

*Template Version: 2.0.0 - Enhanced with Speckit features*
