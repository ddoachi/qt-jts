# Spec: E10-F03-T01 - Signal Evaluation Logic

---

## Frontmatter

```yaml
id: E10-F03-T01
clickup_task_id: ''
title: Signal Evaluation Logic
type: task
parent: E10-F03
children: []
epic: E10
feature: F03
task: T01
domain: Backtesting
status: draft
priority: high
created: '2024-12-30'
updated: '2024-12-30'
due_date: ''
estimated_hours: 0
actual_hours: 0
tags:
  - backtesting
  - signals
  - formula-evaluation
effort: M
risk: medium
```

---

## Status

**Current Status**: Draft
**Last Updated**: 2024-12-30

---

## Executive Summary

Implement the signal evaluation logic for the backtesting engine, including entry signal checking and exit signal checking (stop-loss, take-profit, signal-based exits). This task integrates with the FormulaService from E06 to evaluate strategy rules against historical data while preventing look-ahead bias.

**Objectives:**
1. Implement `_check_entry()` method for entry signal evaluation
2. Implement `_check_exit()` method with priority-ordered exit conditions
3. Define `ExitSignal` response object for exit signal communication
4. Ensure look-ahead bias prevention through proper data slicing

---

## Execution Flow

1. Add signal evaluation methods to `BacktestEngine` class (from E10-F02)
2. Implement `ExitSignal` dataclass with `ExitReason` reference
3. Implement `_check_entry()` method:
   - Slice DataFrame to prevent look-ahead bias
   - Evaluate entry rule using FormulaService
   - Return boolean result
4. Implement `_check_exit()` method:
   - Check stop-loss condition (highest priority)
   - Check take-profit condition (second priority)
   - Evaluate exit rule signal (lowest priority)
   - Return `ExitSignal` with reason or None
5. Write comprehensive unit tests for all signal types
6. Integration tests with mock FormulaService

---

## User Stories

As a **backtesting engine**, I want to evaluate entry signals accurately so that I can determine when to open positions based on strategy rules.

As a **backtesting engine**, I want to evaluate exit signals with proper priority so that risk management (stop-loss) takes precedence over profit-taking and signal-based exits.

As a **quantitative analyst**, I want the backtest to prevent look-ahead bias so that my results reflect realistic trading conditions.

---

## Acceptance Scenarios

**Scenario 1: Entry Signal Detection**
- Given: A candle with OHLCV data and historical context
- When: `_check_entry()` is called with strategy entry rule
- Then: FormulaService is invoked with data up to (not beyond) current candle
- And: Boolean result reflects whether entry condition is met

**Scenario 2: Stop-Loss Trigger**
- Given: An open position with entry price of 100
- And: Strategy with 5% stop-loss
- When: Current price drops to 94 (6% loss)
- Then: `_check_exit()` returns `ExitSignal(reason=ExitReason.STOP_LOSS)`

**Scenario 3: Take-Profit Trigger**
- Given: An open position with entry price of 100
- And: Strategy with 10% take-profit
- When: Current price rises to 112 (12% gain)
- Then: `_check_exit()` returns `ExitSignal(reason=ExitReason.TAKE_PROFIT)`

**Scenario 4: Signal-Based Exit**
- Given: An open position where stop-loss/take-profit are NOT triggered
- And: Exit rule formula evaluates to True
- When: `_check_exit()` is called
- Then: `ExitSignal(reason=ExitReason.SIGNAL)` is returned

**Scenario 5: No Exit Condition Met**
- Given: An open position
- And: No stop-loss, take-profit, or exit signal triggered
- When: `_check_exit()` is called
- Then: None is returned (position remains open)

**Scenario 6: Exit Priority Order**
- Given: An open position where BOTH stop-loss AND take-profit thresholds are exceeded
- When: `_check_exit()` is called
- Then: Stop-loss takes precedence (returns STOP_LOSS reason)

---

## Requirements

### Functional Requirements

1. **Entry Signal Evaluation**
   - Must evaluate entry rule using FormulaService
   - Must slice DataFrame to current candle index (inclusive) to prevent look-ahead
   - Must return boolean indicating entry condition
   - Must handle empty result gracefully (return False)

2. **Exit Signal Evaluation**
   - Must check exit conditions in priority order: Stop-Loss > Take-Profit > Signal
   - Must calculate percentage returns correctly for long positions
   - Must evaluate exit rule only when stop-loss and take-profit are not triggered
   - Must return `ExitSignal` with appropriate reason or None

3. **ExitSignal Response Object**
   - Must be a dataclass with `reason: ExitReason` field
   - Must use `ExitReason` enum from E10-F01

### Non-Functional Requirements

1. Performance: Signal evaluation < 1ms per candle
2. Accuracy: Percentage calculations must use Decimal for precision
3. Immutability: ExitSignal should be frozen dataclass

### Technical Constraints

1. Must use FormulaService from E06 for rule evaluation
2. Must use domain models (Position, ExitReason) from E10-F01
3. Must integrate with BacktestEngine from E10-F02
4. Must use pandas DataFrame for historical data handling

---

## Key Entities

### ExitSignal (Value Object - Immutable)
```python
@dataclass(frozen=True)
class ExitSignal:
    """Exit signal with reason"""
    reason: ExitReason
```

### Methods to Implement
```python
def _check_entry(
    self,
    symbol: str,
    candle: Candle,
    df: pd.DataFrame,
    strategy: Strategy
) -> bool:
    """Check if entry rule is satisfied"""
    ...

def _check_exit(
    self,
    position: Position,
    candle: Candle,
    df: pd.DataFrame,
    strategy: Strategy
) -> Optional[ExitSignal]:
    """Check if any exit condition is met (priority order)"""
    ...
```

---

## Dependencies

### Upstream Dependencies
- **E10-F01 (Domain Models)**: Provides `Position`, `ExitReason`, `TradeSide`
- **E10-F02 (Engine Core)**: Provides `BacktestEngine` class to extend
- **E06 (Processing)**: Provides `FormulaService` for rule evaluation
- **E09 (Strategy)**: Provides `Strategy`, `StrategyRule`, `RiskConfig`

### Downstream Impact
- **E10-F03-T02**: Uses `ExitSignal` from this task for position closure

---

## Gate Checks

- [ ] FormulaService interface understood and available
- [ ] ExitReason enum defined in E10-F01
- [ ] Position dataclass defined in E10-F01/E10-F02
- [ ] Strategy and RiskConfig interfaces from E09 available
- [ ] Look-ahead bias prevention approach validated
- [ ] Exit priority order confirmed with stakeholders

---

## Tasks Preview

This task has no subtasks. It is a leaf task in the feature decomposition.

---

## Success Criteria

- [ ] `ExitSignal` dataclass implemented as frozen
- [ ] `_check_entry()` method implemented with look-ahead prevention
- [ ] `_check_exit()` method implemented with correct priority order
- [ ] Stop-loss triggers at exact threshold percentage
- [ ] Take-profit triggers at exact threshold percentage
- [ ] Exit rule evaluated via FormulaService when needed
- [ ] Unit tests for each exit condition type (stop-loss, take-profit, signal)
- [ ] Unit tests for entry signal evaluation
- [ ] Edge case tests (empty data, zero threshold, no exit rule)
- [ ] Integration test with mock FormulaService
- [ ] Test coverage > 90% for signal evaluation code

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|-----------|
| Look-ahead bias in DataFrame slicing | Medium | High | Explicit index calculation, review-based validation |
| FormulaService interface mismatch | Low | Medium | Verify interface with E06 spec before implementation |
| Percentage calculation precision | Medium | Medium | Use Decimal for all monetary calculations |
| Exit priority logic errors | Low | High | Comprehensive unit tests for all priority combinations |

---

## Notes and Clarifications

### Design Decisions

1. **Exit Priority Order**: Stop-Loss > Take-Profit > Signal. This ensures risk management always takes precedence, protecting capital before seeking profits.

2. **Look-Ahead Prevention**: Using `df.iloc[:current_idx + 1]` to include current candle but exclude future data. This is critical for backtest accuracy.

3. **ExitSignal as Frozen Dataclass**: Immutable to prevent accidental modification after creation.

4. **Percentage Calculation for Long Positions**: `(current_price - entry_price) / entry_price`. Note: Short position logic would invert this.

### Implementation Path

1. Create `signals.py` file under `libs/core/src/backtesting/engine/`
2. Define `ExitSignal` dataclass
3. Implement `_check_entry()` method
4. Implement `_check_exit()` method
5. Add methods to `BacktestEngine` class (or use mixin pattern)
6. Write unit tests in `tests/unit/backtesting/test_signals.py`

### Formula Service Interface (from E06)
```python
class FormulaService:
    def evaluate(
        self,
        formula: str,
        data: pd.DataFrame,
        parameters: dict[str, Any]
    ) -> pd.Series:
        """Evaluate formula and return boolean series"""
        ...
```

### Strategy Interface (from E09)
```python
@dataclass
class Strategy:
    entry_rule: StrategyRule
    exit_rule: Optional[StrategyRule]
    risk_config: RiskConfig

@dataclass
class RiskConfig:
    stop_loss_pct: Optional[float]
    take_profit_pct: Optional[float]
    ...
```

---

## Artifacts

### File Structure
```
libs/core/src/backtesting/engine/
├── __init__.py
├── backtest_engine.py  # Existing from E10-F02
├── portfolio.py        # Existing from E10-F02
└── signals.py          # NEW: ExitSignal, signal evaluation helpers
```

### Test Files
```
libs/core/tests/unit/backtesting/
├── test_signals.py     # NEW: Unit tests for signal evaluation
└── test_engine.py      # Existing: Integration tests
```

---

## Metadata

| Property | Value |
|----------|-------|
| Task ID | E10-F03-T01 |
| Feature | E10-F03: Signal Evaluation |
| Epic | E10: Backtesting |
| Effort Estimate | M (150-200 LOC) |
| Status | Draft |
| Created | 2024-12-30 |
| Updated | 2024-12-30 |
| Dependencies | E10-F01, E10-F02, E06, E09 |
