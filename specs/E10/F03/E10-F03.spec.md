# Feature E10-F03: Signal Evaluation

## Metadata

| Field | Value |
|-------|-------|
| Feature ID | E10-F03 |
| Title | Signal Evaluation |
| Epic | E10 (Backtesting) |
| Status | Draft |
| Complexity | M (300-400 LOC) |
| Dependencies | E06 (Processing), E09 (Strategy) |
| Internal Dependencies | E10-F01 (Domain Models), E10-F02 (Engine Core) |
| Parallel Group | Wave 3 |
| PRD Sections | 5.5 |

---

## 1. Overview

### 1.1 Purpose

Handle entry and exit signal checking using the formula service. This feature evaluates strategy rules against historical data and manages position lifecycle (entry, exit, sizing).

### 1.2 Goals

1. **Accurate Signal Detection**: Evaluate entry/exit rules correctly
2. **Multiple Exit Types**: Support signal, stop-loss, take-profit exits
3. **Position Sizing**: Calculate appropriate position sizes
4. **Risk Management**: Enforce position limits and allocation rules

---

## 2. Signal Flow

### 2.1 Entry Signal Flow

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌──────────────┐
│   Candle    │────►│  Check Entry │────►│  Can Open   │────►│  Open        │
│   Data      │     │  Rule        │     │  Position?  │     │  Position    │
└─────────────┘     └──────────────┘     └─────────────┘     └──────────────┘
                           │                    │
                           ▼                    ▼
                    ┌──────────────┐     ┌─────────────┐
                    │  Formula     │     │  Position   │
                    │  Service     │     │  Limits     │
                    └──────────────┘     └─────────────┘
```

### 2.2 Exit Signal Flow

```
┌─────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   Open      │────►│  Check Stop  │────►│  Check Take  │────►│  Check Exit  │
│   Position  │     │  Loss        │     │  Profit      │     │  Rule        │
└─────────────┘     └──────────────┘     └──────────────┘     └──────────────┘
                           │                    │                    │
                           ▼                    ▼                    ▼
                    ┌──────────────────────────────────────────────────────┐
                    │              ExitSignal (reason)                     │
                    └──────────────────────────────────────────────────────┘
```

---

## 3. Core Components

### 3.1 Entry Signal Evaluation

```python
def _check_entry(
    self,
    symbol: str,
    candle: Candle,
    df: pd.DataFrame,
    strategy: Strategy
) -> bool:
    """Check if entry rule is satisfied"""
    # Get data up to current candle (look-ahead bias prevention)
    current_idx = df.index.get_loc(candle.timestamp)
    history = df.iloc[:current_idx + 1]

    # Evaluate entry formula
    result = self._formula_service.evaluate(
        strategy.entry_rule.to_formula(),
        history,
        strategy.entry_rule.parameters
    )

    return result.iloc[-1] if len(result) > 0 else False
```

### 3.2 Exit Signal Evaluation

```python
def _check_exit(
    self,
    position: Position,
    candle: Candle,
    df: pd.DataFrame,
    strategy: Strategy
) -> Optional[ExitSignal]:
    """Check if any exit condition is met (priority order)"""
    current_price = candle.close

    # 1. Check stop-loss (highest priority)
    if strategy.risk_config.stop_loss_pct:
        loss_pct = (current_price - position.entry_price) / position.entry_price
        if loss_pct <= -strategy.risk_config.stop_loss_pct / 100:
            return ExitSignal(reason=ExitReason.STOP_LOSS)

    # 2. Check take-profit
    if strategy.risk_config.take_profit_pct:
        gain_pct = (current_price - position.entry_price) / position.entry_price
        if gain_pct >= strategy.risk_config.take_profit_pct / 100:
            return ExitSignal(reason=ExitReason.TAKE_PROFIT)

    # 3. Check exit rule signal
    if strategy.exit_rule:
        result = self._formula_service.evaluate(
            strategy.exit_rule.to_formula(),
            history,
            strategy.exit_rule.parameters
        )
        if result.iloc[-1]:
            return ExitSignal(reason=ExitReason.SIGNAL)

    return None

@dataclass
class ExitSignal:
    """Exit signal with reason"""
    reason: ExitReason
```

### 3.3 Position Management

```python
def _can_open_position(
    self,
    portfolio: Portfolio,
    config: BacktestConfig
) -> bool:
    """Check if new position can be opened"""
    # Check max positions limit
    if len(portfolio.positions) >= config.strategy.risk_config.max_positions:
        return False

    # Check available cash
    min_trade_value = config.initial_capital * Decimal("0.01")  # 1% minimum
    if portfolio.cash < min_trade_value:
        return False

    return True

def _open_position(
    self,
    portfolio: Portfolio,
    symbol: str,
    candle: Candle,
    config: BacktestConfig
) -> None:
    """Open new position with sizing"""
    # Calculate position size
    allocation = config.strategy.risk_config.position_size_pct / 100
    trade_value = portfolio.cash * Decimal(str(allocation))

    # Apply slippage to entry price
    entry_price = candle.close * Decimal(1 + config.slippage_pct / 100)

    # Calculate quantity
    quantity = int(trade_value / entry_price)
    if quantity <= 0:
        return

    # Calculate commission
    commission = trade_value * Decimal(config.commission_pct / 100)

    # Update portfolio
    portfolio.cash -= (entry_price * quantity + commission)
    portfolio.positions[symbol] = Position(
        symbol=symbol,
        quantity=quantity,
        entry_price=entry_price,
        entry_date=candle.timestamp,
        side=TradeSide.LONG
    )

def _close_position(
    self,
    portfolio: Portfolio,
    position: Position,
    candle: Candle,
    exit_reason: ExitReason,
    config: BacktestConfig
) -> Trade:
    """Close position and record trade"""
    # Apply slippage to exit price
    exit_price = candle.close * Decimal(1 - config.slippage_pct / 100)

    # Calculate P&L
    gross_pnl = (exit_price - position.entry_price) * position.quantity
    exit_commission = exit_price * position.quantity * Decimal(config.commission_pct / 100)

    # Update portfolio
    portfolio.cash += (exit_price * position.quantity - exit_commission)
    del portfolio.positions[position.symbol]

    # Create trade record
    return Trade(
        id=str(uuid.uuid4()),
        symbol=position.symbol,
        symbol_name=get_symbol_name(position.symbol),
        side=position.side,
        entry_date=position.entry_date,
        entry_price=position.entry_price,
        entry_quantity=position.quantity,
        exit_date=candle.timestamp,
        exit_price=exit_price,
        exit_reason=exit_reason,
        pnl=gross_pnl,
        pnl_pct=float(gross_pnl / (position.entry_price * position.quantity) * 100),
        holding_days=(candle.timestamp - position.entry_date).days,
        commission=exit_commission,
        slippage=abs(candle.close - exit_price) * position.quantity
    )
```

---

## 4. Key Methods

| Method | Description |
|--------|-------------|
| `_check_entry()` | Evaluate entry rule against historical data |
| `_check_exit()` | Check all exit conditions (stop-loss, take-profit, signal) |
| `_can_open_position()` | Validate position limits and available cash |
| `_open_position()` | Create position with sizing and commission |
| `_close_position()` | Close position and create Trade record |
| `_calculate_equity()` | Calculate total portfolio value |

---

## 5. Acceptance Criteria

### 5.1 Entry Signals

- [ ] Entry rule evaluated using FormulaService
- [ ] Historical data limited to current candle (no look-ahead bias)
- [ ] Returns boolean indicating entry signal

### 5.2 Exit Signals

- [ ] Stop-loss triggers at correct threshold (negative return)
- [ ] Take-profit triggers at correct threshold (positive return)
- [ ] Exit rule evaluated when no SL/TP triggered
- [ ] Exit priority: Stop-Loss > Take-Profit > Signal
- [ ] Returns ExitSignal with correct reason

### 5.3 Position Management

- [ ] Max positions limit enforced
- [ ] Minimum trade value check (avoid tiny positions)
- [ ] Position size calculated from allocation percentage
- [ ] Slippage applied to entry/exit prices
- [ ] Commission calculated on entry and exit
- [ ] Trade record created with all fields populated

### 5.4 Testing

- [ ] Unit tests for each exit condition type
- [ ] Integration tests with mock FormulaService
- [ ] Edge case tests (zero quantity, insufficient cash)
- [ ] Test coverage > 85%

---

## 6. Technical Notes

### 6.1 Design Decisions

| Decision | Choice | Reason |
|----------|--------|--------|
| Exit priority | SL > TP > Signal | Risk management first |
| Slippage direction | Unfavorable | Conservative simulation |
| Look-ahead prevention | Slice DataFrame | Ensure realistic signals |

### 6.2 Integration Points

- **FormulaService**: Entry/exit rule evaluation
- **BacktestEngine**: Position management methods called from main loop
- **Trade Entity**: Output from position closure

### 6.3 Files to Modify/Create

- `libs/core/src/backtesting/engine/backtest_engine.py` (add methods)
- `libs/core/src/backtesting/engine/signals.py` (optional: extract signal logic)

---

## 7. Dependencies

### 7.1 External

| Dependency | Interface | From |
|------------|-----------|------|
| `FormulaService` | `evaluate()` method | E06 (Processing) |
| `Strategy` | Entry/exit rules, RiskConfig | E09 (Strategy) |

### 7.2 Internal

| Dependency | Provides |
|------------|----------|
| E10-F01 | Trade, Position, ExitReason, TradeSide |
| E10-F02 | BacktestEngine class, Portfolio |

---

## 8. Tasks

| Task ID | Title | Effort | Dependencies | Description |
|---------|-------|--------|--------------|-------------|
| [E10-F03-T01](T01/E10-F03-T01.spec.md) | Signal Evaluation Logic | M | E10-F01, E10-F02, E06, E09 | Entry/exit signal checking with FormulaService |
| [E10-F03-T02](T02/E10-F03-T02.spec.md) | Position Management | M | E10-F01, E10-F02, E10-F03-T01 | Position lifecycle (open, close, sizing) |

### Task Dependency Graph

```
E10-F03-T01 (Signal Evaluation Logic)
    |
    v
E10-F03-T02 (Position Management)
```

### Task Descriptions

**T01 - Signal Evaluation Logic** (~150-200 LOC)
- `_check_entry()` - Entry signal evaluation with look-ahead bias prevention
- `_check_exit()` - Exit signal evaluation with priority ordering (SL > TP > Signal)
- `ExitSignal` dataclass - Response object for exit signals

**T02 - Position Management** (~150-200 LOC)
- `_can_open_position()` - Position limit and cash validation
- `_open_position()` - Position creation with sizing, slippage, commission
- `_close_position()` - Position closure with P&L calculation and Trade record

---

## 9. References

- PRD Section 5.5: Backtesting
- E06: Processing Engine (FormulaService)
- E09: Strategy Builder (Strategy, RiskConfig)
