# Spec: E10-F03-T02 - Position Management

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E10-F03-T02
clickup_task_id: ''
title: Position Management
type: task

# === HIERARCHY ===
parent: E10-F03
children: []
epic: E10
feature: F03
task: T02
domain: backtesting

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2024-12-30'
updated: '2024-12-30'
due_date: ''
estimated_hours: 0
actual_hours: 0

# === METADATA ===
tags: [backtesting, position-sizing, portfolio-management]
effort: medium
risk: medium
---

**Status**: Draft
**Type**: Task
**Parent**: [E10-F03 - Signal Evaluation](../E10-F03.spec.md)
**Created**: 2024-12-30
**Updated**: 2024-12-30

---

## Executive Summary

Implement position management logic for the backtesting engine, including position limit checks, position opening with sizing, and position closure with P&L calculation. This task handles the complete position lifecycle from entry validation through trade record creation.

**Objectives:**
1. Implement `_can_open_position()` for pre-entry validation
2. Implement `_open_position()` with position sizing and cost modeling
3. Implement `_close_position()` with P&L calculation and trade record creation
4. Ensure accurate commission and slippage modeling

---

## Execution Flow

1. Implement `_can_open_position()` method in BacktestEngine:
   - Check max positions limit from strategy RiskConfig
   - Check available cash for minimum trade value
   - Return boolean result
2. Implement `_open_position()` method:
   - Calculate position size from allocation percentage
   - Apply slippage to entry price
   - Calculate quantity and commission
   - Update portfolio cash and positions
3. Implement `_close_position()` method:
   - Apply slippage to exit price
   - Calculate gross P&L
   - Calculate exit commission
   - Update portfolio cash
   - Remove position from portfolio
   - Create and return Trade record
4. Write comprehensive unit tests
5. Integration tests with portfolio state management

---

## User Stories

As a **backtesting engine**, I want to validate position limits before opening so that I respect risk management constraints.

As a **backtesting engine**, I want to calculate position sizes based on allocation percentage so that trades are properly sized relative to available capital.

As a **backtesting engine**, I want to model slippage and commission realistically so that backtest results reflect real-world trading costs.

As a **quantitative analyst**, I want accurate trade records with all cost components so that I can analyze true performance.

---

## Acceptance Scenarios

**Scenario 1: Position Limit Reached**
- Given: Portfolio with 5 open positions
- And: Strategy with max_positions = 5
- When: `_can_open_position()` is called
- Then: Returns False (cannot open new position)

**Scenario 2: Insufficient Cash**
- Given: Portfolio with cash balance of 100,000 KRW
- And: Initial capital of 100,000,000 KRW (1% minimum = 1,000,000)
- When: `_can_open_position()` is called
- Then: Returns False (below minimum trade value)

**Scenario 3: Open Position with Sizing**
- Given: Portfolio with 10,000,000 KRW cash
- And: Strategy with 10% position size
- And: Stock price at 50,000 KRW
- And: Slippage of 0.05%
- When: `_open_position()` is called
- Then: Entry price = 50,000 * 1.0005 = 50,025 KRW
- And: Trade value = 10,000,000 * 0.10 = 1,000,000 KRW
- And: Quantity = int(1,000,000 / 50,025) = 19 shares
- And: Commission calculated and deducted

**Scenario 4: Close Position with P&L**
- Given: Open position with 100 shares at 50,000 KRW entry
- And: Current candle close at 55,000 KRW
- And: Slippage of 0.05%
- When: `_close_position()` is called
- Then: Exit price = 55,000 * 0.9995 = 54,972.5 KRW
- And: Gross P&L = (54,972.5 - 50,000) * 100 = 497,250 KRW
- And: Trade record created with all fields

**Scenario 5: Zero Quantity Trade Rejected**
- Given: Portfolio with low cash (e.g., 10,000 KRW)
- And: High stock price (e.g., 100,000 KRW)
- When: `_open_position()` is called
- Then: Position is NOT opened (quantity would be 0)

**Scenario 6: Trade Record Completeness**
- Given: A closed position
- When: Trade record is created
- Then: All fields populated: id, symbol, symbol_name, side, entry_date, entry_price, entry_quantity, exit_date, exit_price, exit_reason, pnl, pnl_pct, holding_days, commission, slippage

---

## Requirements

### Functional Requirements

1. **Position Limit Check (_can_open_position)**
   - Must check current position count against max_positions from RiskConfig
   - Must check available cash against minimum trade value (1% of initial capital)
   - Must return boolean indicating whether new position can be opened

2. **Position Opening (_open_position)**
   - Must calculate trade value from position_size_pct and available cash
   - Must apply slippage to entry price (unfavorable direction: add for long)
   - Must calculate integer quantity from trade value and entry price
   - Must reject trade if quantity is 0 or less
   - Must calculate commission on trade value
   - Must deduct total cost (entry_price * quantity + commission) from portfolio cash
   - Must add Position to portfolio.positions dict

3. **Position Closure (_close_position)**
   - Must apply slippage to exit price (unfavorable direction: subtract for long)
   - Must calculate gross P&L: (exit_price - entry_price) * quantity
   - Must calculate exit commission on exit value
   - Must add proceeds (exit_price * quantity - commission) to portfolio cash
   - Must remove position from portfolio.positions dict
   - Must return complete Trade entity

4. **Trade Record Creation**
   - Must generate unique ID for trade
   - Must populate all Trade fields from E10-F01
   - Must calculate holding_days from entry/exit dates
   - Must calculate pnl_pct as percentage of entry value

### Non-Functional Requirements

1. Performance: Position operations < 1ms each
2. Accuracy: All monetary calculations use Decimal
3. Audit: Trade record must capture all cost components

### Technical Constraints

1. Must use Position entity from E10-F01/E10-F02
2. Must use Trade entity from E10-F01
3. Must use Portfolio from E10-F02
4. Must integrate with BacktestEngine from E10-F02
5. Must receive ExitReason from E10-F03-T01 for trade record

---

## Key Entities

### Position (from E10-F02)
```python
@dataclass
class Position:
    """Open position during simulation"""
    symbol: str
    quantity: int
    entry_price: Decimal
    entry_date: date
    side: TradeSide
```

### Trade (from E10-F01)
```python
@dataclass
class Trade:
    """A completed trade"""
    id: str
    symbol: str
    symbol_name: str
    side: TradeSide
    entry_date: date
    entry_price: Decimal
    entry_quantity: int
    exit_date: Optional[date]
    exit_price: Optional[Decimal]
    exit_reason: Optional[ExitReason]
    pnl: Optional[Decimal]
    pnl_pct: Optional[float]
    holding_days: Optional[int]
    commission: Decimal
    slippage: Decimal
```

### Methods to Implement
```python
def _can_open_position(
    self,
    portfolio: Portfolio,
    config: BacktestConfig
) -> bool:
    """Check if new position can be opened"""
    ...

def _open_position(
    self,
    portfolio: Portfolio,
    symbol: str,
    candle: Candle,
    config: BacktestConfig
) -> None:
    """Open new position with sizing"""
    ...

def _close_position(
    self,
    portfolio: Portfolio,
    position: Position,
    candle: Candle,
    exit_reason: ExitReason,
    config: BacktestConfig
) -> Trade:
    """Close position and record trade"""
    ...
```

---

## Dependencies

### Upstream Dependencies
- **E10-F01 (Domain Models)**: Provides `Trade`, `Position`, `ExitReason`, `TradeSide`
- **E10-F02 (Engine Core)**: Provides `BacktestEngine`, `Portfolio`, `BacktestConfig`
- **E10-F03-T01 (Signal Evaluation)**: Provides `ExitReason` for exit classification
- **E09 (Strategy)**: Provides `RiskConfig` with position sizing parameters

### Downstream Impact
- **E10-F04 (Metrics Calculator)**: Consumes Trade records for performance calculation

---

## Gate Checks

- [ ] Trade entity defined in E10-F01
- [ ] Position entity defined in E10-F01/E10-F02
- [ ] Portfolio dataclass defined in E10-F02
- [ ] BacktestConfig defined in E10-F01
- [ ] RiskConfig interface from E09 available
- [ ] get_symbol_name() helper function available or defined

---

## Tasks Preview

This task has no subtasks. It is a leaf task in the feature decomposition.

---

## Success Criteria

- [ ] `_can_open_position()` correctly checks max positions limit
- [ ] `_can_open_position()` correctly checks minimum trade value
- [ ] `_open_position()` calculates position size from allocation percentage
- [ ] `_open_position()` applies slippage to entry price (unfavorable)
- [ ] `_open_position()` calculates commission correctly
- [ ] `_open_position()` rejects zero-quantity trades
- [ ] `_open_position()` updates portfolio cash and positions
- [ ] `_close_position()` applies slippage to exit price (unfavorable)
- [ ] `_close_position()` calculates P&L correctly
- [ ] `_close_position()` calculates exit commission correctly
- [ ] `_close_position()` updates portfolio cash and removes position
- [ ] `_close_position()` returns complete Trade record
- [ ] Unit tests for position limit scenarios
- [ ] Unit tests for insufficient cash scenarios
- [ ] Unit tests for position sizing calculations
- [ ] Unit tests for P&L calculations
- [ ] Edge case tests (zero quantity, negative cash)
- [ ] Test coverage > 90% for position management code

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|-----------|
| Decimal precision errors in P&L | Medium | High | Use Decimal throughout, explicit rounding rules |
| Integer quantity truncation issues | Low | Medium | Explicit int() conversion, reject zero quantity |
| Slippage direction errors | Medium | Medium | Clear comments, directional unit tests |
| Commission calculation errors | Low | Medium | Unit tests with known expected values |
| Portfolio state corruption | Low | High | Transactional approach, state validation |

---

## Notes and Clarifications

### Design Decisions

1. **Slippage Direction**: Entry slippage is ADDED (unfavorable buy), exit slippage is SUBTRACTED (unfavorable sell). This models realistic market impact.

2. **Minimum Trade Value**: 1% of initial capital prevents tiny, unrealistic trades that would skew metrics.

3. **Integer Quantity**: Korean stock market requires integer share quantities. Fractional shares are not supported.

4. **Commission Model**: Percentage-based commission on trade value, applied to both entry and exit.

5. **Portfolio Mutation**: Portfolio is mutable during simulation for performance. State is managed carefully.

### Implementation Path

1. Add methods to `BacktestEngine` class in `backtest_engine.py`
2. Implement `_can_open_position()` first (simplest)
3. Implement `_open_position()` with sizing logic
4. Implement `_close_position()` with P&L and Trade creation
5. Add helper function `get_symbol_name()` if not available
6. Write unit tests in `tests/unit/backtesting/test_positions.py`

### Calculation Reference

**Entry Price with Slippage (Long Position)**:
```python
entry_price = candle.close * Decimal(1 + config.slippage_pct / 100)
```

**Exit Price with Slippage (Long Position)**:
```python
exit_price = candle.close * Decimal(1 - config.slippage_pct / 100)
```

**Position Size**:
```python
allocation = config.strategy.risk_config.position_size_pct / 100
trade_value = portfolio.cash * Decimal(str(allocation))
quantity = int(trade_value / entry_price)
```

**Commission**:
```python
commission = trade_value * Decimal(config.commission_pct / 100)
```

**P&L Percentage**:
```python
pnl_pct = float(gross_pnl / (position.entry_price * position.quantity) * 100)
```

**Holding Days**:
```python
holding_days = (candle.timestamp - position.entry_date).days
```

---

## Artifacts

### File Structure
```
libs/core/src/backtesting/engine/
├── __init__.py
├── backtest_engine.py  # Add position management methods
├── portfolio.py        # Existing from E10-F02
└── signals.py          # From E10-F03-T01
```

### Test Files
```
libs/core/tests/unit/backtesting/
├── test_positions.py   # NEW: Unit tests for position management
├── test_signals.py     # From E10-F03-T01
└── test_engine.py      # Existing: Integration tests
```

---

*Template Version: 2.0.0 - Enhanced with Speckit features*
