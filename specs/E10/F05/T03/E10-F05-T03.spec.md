# Spec: E10-F05-T03 - Implement EquityCurveWidget with PyQtGraph

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E10-F05-T03
clickup_task_id: '86ew0ftzm'
title: Implement EquityCurveWidget with PyQtGraph
type: task

# === HIERARCHY ===
parent: E10-F05
children: []
epic: E10
feature: F05
task: T03
domain: backtesting

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 5
actual_hours: 0

# === METADATA ===
tags: [ui, pyqtgraph, chart, equity-curve, drawdown, visualization, parallel]
effort: medium
risk: medium
parallel: true
---

**Status**: Draft
**Type**: Task
**Parent**: E10-F05 (UI Components)
**Created**: 2025-12-30
**Updated**: 2025-12-30
**Parallel**: [P] Can be executed in parallel with T01, T02

## Executive Summary

Implement the `EquityCurveWidget` using PyQtGraph to display the equity curve chart with drawdown visualization. The widget shows portfolio value over time as a blue line, a dashed reference line at initial capital, grid lines for readability, and red-shaded regions indicating drawdown periods. The chart must handle large datasets (500+ days) efficiently.

## Execution Flow

```
1. Create EquityCurveWidget inheriting from QWidget
   -> Import PyQtGraph as pg
   -> Import PySide6.QtWidgets (QWidget, QVBoxLayout)
   -> Initialize PlotWidget and store reference

2. Setup PlotWidget configuration
   -> Set white background: setBackground('w')
   -> Enable grid lines: showGrid(x=True, y=True, alpha=0.3)
   -> Set Y-axis label: setLabel('left', 'Equity', units='KRW')
   -> Set X-axis label: setLabel('bottom', 'Date')
   -> Configure axis tick formatting for currency

3. Implement set_data(equity_curve, initial_capital) method
   -> Clear existing plot items: self._plot.clear()
   -> Validate equity_curve is not empty
   -> Extract x values (date indices or timestamps)
   -> Extract y values (equity as float)
   -> Plot equity line with blue color (#2196F3), width 2

4. Add initial capital reference line
   -> Convert initial_capital to float
   -> Add horizontal line at initial_capital value
   -> Style: gray color (#9E9E9E), dashed line, width 1
   -> Line serves as visual break-even reference

5. Implement drawdown shading
   -> Call _shade_drawdowns(equity_curve)
   -> Track peak equity value as iteration proceeds
   -> Identify drawdown regions (equity < peak)
   -> Create FillBetweenItem for each drawdown region
   -> Fill color: red with transparency (#F4433640)

6. Implement _shade_drawdowns(equity_curve) method
   -> Initialize peak = equity_curve[0].equity
   -> Initialize regions list for drawdown segments
   -> For each point in equity_curve:
     -> If equity > peak: Update peak, close current region
     -> If equity < peak: Add to current drawdown region
   -> For each completed region:
     -> Create FillBetweenItem between equity line and peak
     -> Add to plot with red transparent fill

7. Implement clear() method
   -> Call self._plot.clear()
   -> Remove all plot items
   -> Reset internal state
```

## User Stories

### Primary User Story
**As a** trader
**I want to** see my backtest equity curve as an interactive chart
**So that** I can visualize how my portfolio value changed over time

### Additional Stories
- **As a** trader, **I want to** see drawdown periods highlighted in red, **So that** I can identify when my strategy was losing money
- **As a** trader, **I want to** see a reference line at my starting capital, **So that** I can quickly see periods of profit vs loss
- **As a** trader, **I want to** zoom and pan the chart, **So that** I can examine specific time periods in detail

## Acceptance Scenarios

### Scenario 1: Happy Path - Display Equity Curve
**Given** EquityCurveWidget is initialized
**When** set_data() is called with equity_curve and initial_capital
**Then** a blue line should be drawn showing equity over time
**And** grid lines should be visible
**And** Y-axis should show currency labels

### Scenario 2: Initial Capital Reference Line
**Given** set_data() is called with initial_capital = 100,000,000
**When** the chart is rendered
**Then** a dashed gray horizontal line should appear at Y = 100,000,000
**And** the line should span the full width of the chart

### Scenario 3: Drawdown Shading
**Given** equity_curve contains a drawdown period (equity dropped from peak)
**When** the chart is rendered
**Then** the drawdown region should be shaded in semi-transparent red
**And** shading should extend from equity line to peak level
**And** multiple drawdown regions should each be shaded

### Scenario 4: Empty Data Handling
**Given** EquityCurveWidget is initialized
**When** set_data() is called with empty equity_curve
**Then** the chart should remain empty
**And** no error should occur
**And** previous data should be cleared

### Scenario 5: Large Dataset Performance
**Given** equity_curve contains 500+ data points
**When** set_data() is called
**Then** rendering should complete in < 500ms
**And** chart should remain responsive to zoom/pan

### Scenario 6: Chart Interaction
**Given** the equity curve is displayed
**When** the user drags to pan or scrolls to zoom
**Then** the chart should respond smoothly
**And** data points should remain accurate at all zoom levels

## Requirements

### Functional Requirements
- **FR-001**: Widget MUST display equity curve as line chart
- **FR-002**: Widget MUST show initial capital as dashed reference line
- **FR-003**: Widget MUST shade drawdown periods in red
- **FR-004**: Widget MUST display grid lines on both axes
- **FR-005**: Widget MUST provide set_data() method for data update
- **FR-006**: Widget MUST provide clear() method to reset chart
- **FR-007**: Widget MUST support pan and zoom interaction

### Non-Functional Requirements
- **NFR-001**: Chart rendering MUST complete in < 500ms for 500 data points
- **NFR-002**: Chart MUST remain responsive during zoom/pan operations
- **NFR-003**: Widget MUST handle empty data gracefully
- **NFR-004**: All public methods MUST have type hints and docstrings
- **NFR-005**: Code MUST follow PEP 8 style guidelines

### Technical Constraints
- **TC-001**: Must use PyQtGraph for chart rendering
- **TC-002**: Must use EquityPoint from E10-F01
- **TC-003**: Must support Decimal to float conversion for plotting
- **TC-004**: Must be compatible with both light and dark themes

## Key Entities

### Entity: EquityCurveWidget
- **Description**: PyQtGraph-based equity curve chart widget
- **Key Attributes**:
  - `_plot: pg.PlotWidget` - PyQtGraph plot widget
  - `_equity_line: pg.PlotDataItem` - Equity curve line (optional reference)
  - `_capital_line: pg.InfiniteLine` - Initial capital reference line
- **Key Methods**:
  - `__init__(parent)` - Constructor
  - `_setup_ui()` - Initialize chart configuration
  - `set_data(equity_curve, initial_capital)` - Plot equity data
  - `_shade_drawdowns(equity_curve)` - Add drawdown regions
  - `clear()` - Clear all chart data

### Entity: DrawdownRegion (Internal)
- **Description**: A single drawdown period for shading
- **Attributes**: start_idx, end_idx, peak_value

## Dependencies

### Upstream Dependencies
- [ ] E10-F01: EquityPoint dataclass (domain models)
- [ ] PyQtGraph: Third-party charting library

### Downstream Impact
- [ ] T04: BacktestView will integrate EquityCurveWidget

## Implementation Details

### File Structure
```
apps/desktop/src/widgets/equity_curve.py
tests/unit/widgets/test_equity_curve.py
```

### Code Skeleton
```python
import pyqtgraph as pg
from PySide6.QtWidgets import QWidget, QVBoxLayout
from PySide6.QtCore import Qt
from PySide6.QtGui import QColor
from decimal import Decimal
from typing import Optional
from libs.core.src.backtesting.domain.result import EquityPoint


class EquityCurveWidget(QWidget):
    """Equity curve chart with drawdown visualization."""

    def __init__(self, parent: Optional[QWidget] = None):
        """Initialize equity curve widget."""
        super().__init__(parent)
        self._setup_ui()

    def _setup_ui(self) -> None:
        """Setup the user interface."""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)

        # Create plot widget
        self._plot = pg.PlotWidget()
        self._plot.setBackground('w')
        self._plot.showGrid(x=True, y=True, alpha=0.3)
        self._plot.setLabel('left', 'Equity', units='KRW')
        self._plot.setLabel('bottom', 'Trading Days')

        # Enable mouse interaction
        self._plot.setMouseEnabled(x=True, y=True)

        # Configure axis formatting
        self._configure_axes()

        layout.addWidget(self._plot)

    def _configure_axes(self) -> None:
        """Configure axis labels and formatting."""
        # Y-axis: Format large numbers with commas
        y_axis = self._plot.getAxis('left')
        y_axis.setLabel('Equity (KRW)')

        # X-axis: Trading day index
        x_axis = self._plot.getAxis('bottom')
        x_axis.setLabel('Trading Days')

    def set_data(
        self,
        equity_curve: list[EquityPoint],
        initial_capital: Decimal
    ) -> None:
        """Plot equity curve with drawdown shading.

        Args:
            equity_curve: List of equity points from backtest
            initial_capital: Initial capital for reference line
        """
        self._plot.clear()

        if not equity_curve:
            return

        # Prepare data
        x_data = list(range(len(equity_curve)))
        y_data = [float(point.equity) for point in equity_curve]

        # Plot equity line
        pen = pg.mkPen(color='#2196F3', width=2)
        self._plot.plot(x_data, y_data, pen=pen, name='Equity')

        # Add initial capital reference line
        initial_float = float(initial_capital)
        ref_line = pg.InfiniteLine(
            pos=initial_float,
            angle=0,
            pen=pg.mkPen(color='#9E9E9E', width=1, style=Qt.DashLine),
            label='Initial Capital',
            labelOpts={'position': 0.05, 'color': '#9E9E9E'}
        )
        self._plot.addItem(ref_line)

        # Add drawdown shading
        self._shade_drawdowns(equity_curve, x_data, y_data)

    def _shade_drawdowns(
        self,
        equity_curve: list[EquityPoint],
        x_data: list[int],
        y_data: list[float]
    ) -> None:
        """Add red shading for drawdown periods.

        Args:
            equity_curve: Original equity points
            x_data: X-axis values (indices)
            y_data: Y-axis values (equity as float)
        """
        if len(equity_curve) < 2:
            return

        # Calculate peak equity at each point
        peak_values = []
        current_peak = y_data[0]

        for equity in y_data:
            if equity > current_peak:
                current_peak = equity
            peak_values.append(current_peak)

        # Find drawdown regions
        in_drawdown = False
        region_start = 0

        for i in range(len(y_data)):
            is_in_drawdown = y_data[i] < peak_values[i]

            if is_in_drawdown and not in_drawdown:
                # Start of drawdown region
                region_start = i
                in_drawdown = True
            elif not is_in_drawdown and in_drawdown:
                # End of drawdown region
                self._add_drawdown_fill(
                    x_data[region_start:i+1],
                    y_data[region_start:i+1],
                    peak_values[region_start:i+1]
                )
                in_drawdown = False

        # Handle drawdown at end of data
        if in_drawdown:
            self._add_drawdown_fill(
                x_data[region_start:],
                y_data[region_start:],
                peak_values[region_start:]
            )

    def _add_drawdown_fill(
        self,
        x_segment: list[int],
        equity_segment: list[float],
        peak_segment: list[float]
    ) -> None:
        """Add fill between equity and peak for a drawdown region.

        Args:
            x_segment: X values for the region
            equity_segment: Equity values (bottom of fill)
            peak_segment: Peak values (top of fill)
        """
        if len(x_segment) < 2:
            return

        # Create curves for fill
        equity_curve = pg.PlotDataItem(x_segment, equity_segment)
        peak_curve = pg.PlotDataItem(x_segment, peak_segment)

        # Create fill between curves
        fill = pg.FillBetweenItem(
            equity_curve,
            peak_curve,
            brush=pg.mkBrush(QColor(244, 67, 54, 64))  # Red with 25% opacity
        )
        self._plot.addItem(fill)

    def clear(self) -> None:
        """Clear all chart data."""
        self._plot.clear()

    def set_title(self, title: str) -> None:
        """Set chart title.

        Args:
            title: Title text to display
        """
        self._plot.setTitle(title)
```

### PyQtGraph Configuration Notes
- Use `PlotWidget` for embedded chart
- `mkPen()` for line styling
- `mkBrush()` for fill styling
- `FillBetweenItem` for drawdown shading
- `InfiniteLine` for reference line

## Success Criteria

### Acceptance Criteria
- [ ] Equity curve displays as blue line
- [ ] Initial capital shown as dashed gray reference line
- [ ] Grid lines visible on both axes
- [ ] Drawdown periods shaded in semi-transparent red
- [ ] Chart supports pan and zoom interaction
- [ ] Empty data handled gracefully (no errors)
- [ ] Large datasets (500+ points) render in < 500ms
- [ ] All methods have type hints and docstrings

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing with 80%+ coverage
  - [ ] Test widget initialization
  - [ ] Test set_data() with valid equity curve
  - [ ] Test set_data() with empty data
  - [ ] Test drawdown shading logic
  - [ ] Test reference line positioning
  - [ ] Test clear() method
- [ ] Performance validated (rendering < 500ms)
- [ ] Code follows PEP 8 style guidelines
- [ ] Docstrings complete for all public methods

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| PyQtGraph version compatibility | Low | Medium | Pin PyQtGraph version, test with specific version |
| Performance with large datasets | Medium | Medium | Profile rendering, use downsampling if needed |
| Drawdown shading complexity | Medium | Low | Test edge cases (no drawdown, continuous drawdown) |
| Memory usage with many fill items | Low | Medium | Limit number of separate drawdown regions if needed |

## Notes and Clarifications

### Design Decisions
- 2025-12-30: Use PyQtGraph over matplotlib for better Qt integration and interactive performance
- 2025-12-30: Use day index for X-axis instead of dates for simplicity (date tooltip can be added later)
- 2025-12-30: Use FillBetweenItem for drawdown shading for visual appeal
- 2025-12-30: Set 25% opacity for drawdown fill to not obscure equity line

### Implementation Notes
- Decimal values must be converted to float for PyQtGraph
- Multiple small drawdown regions may create many fill items; optimize if needed
- Consider adding date tooltips on hover in future enhancement

### Future Enhancements (Out of Scope)
- Date axis labels with tick formatting
- Hover tooltips showing exact values
- Benchmark comparison overlay
- Export chart as image

---
*Template Version: 2.0.0 - Task Level Spec*
