# Spec: E10-F05-T01 - Implement TradeTableModel and TradeHistoryWidget

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E10-F05-T01
clickup_task_id: '86ew0ftyx'
title: Implement TradeTableModel and TradeHistoryWidget
type: task

# === HIERARCHY ===
parent: E10-F05
children: []
epic: E10
feature: F05
task: T01
domain: backtesting

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 4
actual_hours: 0

# === METADATA ===
tags: [ui, pyside6, qtableview, model-view, trade-history, parallel]
effort: medium
risk: low
parallel: true
---

**Status**: Draft
**Type**: Task
**Parent**: E10-F05 (UI Components)
**Created**: 2025-12-30
**Updated**: 2025-12-30
**Parallel**: [P] Can be executed in parallel with T02, T03

## Executive Summary

Implement the `TradeTableModel` (QAbstractTableModel) and `TradeHistoryWidget` for displaying completed trades in a sortable table format. The widget includes columns for Symbol, Entry Date, Exit Date, P&L, P&L %, and Exit Reason with appropriate formatting, color coding for positive/negative P&L, and Korean localization for exit reasons. An export button triggers CSV export functionality.

## Execution Flow

```
1. Create TradeTableModel inheriting from QAbstractTableModel
   -> Import PySide6.QtCore.QAbstractTableModel
   -> Define column configuration: Symbol, Entry, Exit, P&L, P&L %, Exit Reason
   -> Initialize empty trade list: self._trades: list[Trade] = []
   -> Implement required model methods

2. Implement TradeTableModel data methods
   -> rowCount(): Return len(self._trades)
   -> columnCount(): Return 6 (fixed columns)
   -> data(): Return formatted data for DisplayRole, ForegroundRole, TextAlignmentRole
   -> headerData(): Return Korean column headers

3. Implement P&L color coding in data() method
   -> If role == ForegroundRole and column is P&L or P&L %:
     -> Return green color (#4CAF50) if value >= 0
     -> Return red color (#F44336) if value < 0
   -> Format P&L with currency symbol and sign prefix
   -> Format P&L % with percentage sign and 1 decimal

4. Implement exit reason Korean localization
   -> Create EXIT_REASON_LABELS mapping:
     -> SIGNAL -> "신호"
     -> STOP_LOSS -> "손절"
     -> TAKE_PROFIT -> "익절"
     -> TIMEOUT -> "타임아웃"
     -> DAILY_LIMIT -> "일한도"
   -> Return localized label in data() for exit reason column

5. Create TradeHistoryWidget container
   -> Create QVBoxLayout with header and table
   -> Add header row with title "Trade History" and export button
   -> Create QTableView and set TradeTableModel
   -> Enable sorting: setSortingEnabled(True)
   -> Configure column widths for readability

6. Implement set_trades() method
   -> Accept list[Trade] parameter
   -> Call beginResetModel() before update
   -> Update self._trades with new data
   -> Call endResetModel() after update
   -> Resize columns to contents

7. Implement export button signal
   -> Define export_clicked = Signal() on TradeHistoryWidget
   -> Connect QPushButton clicked to export_clicked.emit
   -> Button text: "CSV 내보내기"
```

## User Stories

### Primary User Story
**As a** trader
**I want to** see all my backtest trades in a sortable table
**So that** I can analyze individual trade performance and exit reasons

### Additional Stories
- **As a** trader, **I want to** quickly identify winning and losing trades by color, **So that** I can spot patterns in my strategy
- **As a** trader, **I want to** see exit reasons in Korean, **So that** I can understand why each position was closed
- **As a** trader, **I want to** export trades to CSV, **So that** I can perform further analysis in spreadsheet software

## Acceptance Scenarios

### Scenario 1: Happy Path - Display Trades
**Given** TradeHistoryWidget is initialized with a list of trades
**When** set_trades() is called with trade data
**Then** all trades should be displayed in the table
**And** columns should show Symbol, Entry, Exit, P&L, P&L %, Exit Reason
**And** table should be sortable by any column

### Scenario 2: P&L Color Coding
**Given** the trade table contains trades with positive and negative P&L
**When** the table is displayed
**Then** positive P&L values should be displayed in green (#4CAF50)
**And** negative P&L values should be displayed in red (#F44336)
**And** P&L should be formatted with currency sign and + prefix for positive

### Scenario 3: Korean Exit Reason Labels
**Given** a trade with exit_reason = ExitReason.STOP_LOSS
**When** the trade is displayed in the table
**Then** the Exit Reason column should show "손절"
**And** all exit reasons should display Korean labels

### Scenario 4: Export Button Click
**Given** TradeHistoryWidget is displayed
**When** the user clicks the "CSV 내보내기" button
**Then** the export_clicked signal should be emitted
**And** no file operations should occur within the widget (handled externally)

### Scenario 5: Empty Trade List
**Given** TradeHistoryWidget is initialized
**When** set_trades() is called with an empty list
**Then** the table should display no rows
**And** column headers should still be visible
**And** no error should occur

## Requirements

### Functional Requirements
- **FR-001**: TradeTableModel MUST implement QAbstractTableModel interface
- **FR-002**: Table MUST display 6 columns: Symbol, Entry, Exit, P&L, P&L %, Exit Reason
- **FR-003**: Table MUST support sorting by any column
- **FR-004**: P&L columns MUST show color coding (green positive, red negative)
- **FR-005**: Exit Reason MUST display Korean localized labels
- **FR-006**: Export button MUST emit export_clicked signal when clicked
- **FR-007**: Widget MUST handle empty trade list gracefully

### Non-Functional Requirements
- **NFR-001**: Table rendering MUST handle 500+ trades without lag
- **NFR-002**: set_trades() MUST complete in < 100ms for 500 trades
- **NFR-003**: All public methods MUST have type hints and docstrings
- **NFR-004**: Code MUST follow PEP 8 style guidelines

### Technical Constraints
- **TC-001**: Must use PySide6.QtCore.QAbstractTableModel
- **TC-002**: Must use PySide6.QtWidgets.QTableView
- **TC-003**: Must use Trade entity from E10-F01
- **TC-004**: Must use ExitReason enum from E10-F01 for localization

## Key Entities

### Entity: TradeTableModel
- **Description**: Qt table model for trade data
- **Key Attributes**:
  - `_trades: list[Trade]` - Trade data storage
  - `COLUMNS: list[str]` - Column definitions
  - `EXIT_REASON_LABELS: dict[ExitReason, str]` - Korean label mapping
- **Key Methods**:
  - `rowCount(parent) -> int` - Return number of trades
  - `columnCount(parent) -> int` - Return 6
  - `data(index, role) -> Any` - Return cell data with formatting
  - `headerData(section, orientation, role) -> str` - Return column headers
  - `set_trades(trades: list[Trade]) -> None` - Update trade data

### Entity: TradeHistoryWidget
- **Description**: Container widget with table and export button
- **Key Attributes**:
  - `_table: QTableView` - Table view instance
  - `_model: TradeTableModel` - Table model instance
  - `export_clicked: Signal()` - Export button signal
- **Key Methods**:
  - `set_trades(trades: list[Trade]) -> None` - Update displayed trades
  - `get_trades() -> list[Trade]` - Return current trades for export

## Dependencies

### Upstream Dependencies
- [ ] E10-F01: Trade entity and ExitReason enum (domain models)
- [ ] E01-F01: Base widget classes and styling (application framework)

### Downstream Impact
- [ ] T04: BacktestView will integrate TradeHistoryWidget
- [ ] E10-F06: Export feature will connect to export_clicked signal

## Implementation Details

### File Structure
```
apps/desktop/src/widgets/trade_history.py
tests/unit/widgets/test_trade_history.py
```

### Code Skeleton
```python
from PySide6.QtCore import QAbstractTableModel, QModelIndex, Qt, Signal
from PySide6.QtGui import QColor
from PySide6.QtWidgets import QWidget, QVBoxLayout, QHBoxLayout, QTableView, QPushButton, QLabel
from typing import Any, Optional
from libs.core.src.backtesting.domain.trade import Trade, ExitReason

EXIT_REASON_LABELS: dict[ExitReason, str] = {
    ExitReason.SIGNAL: "신호",
    ExitReason.STOP_LOSS: "손절",
    ExitReason.TAKE_PROFIT: "익절",
    ExitReason.TIMEOUT: "타임아웃",
    ExitReason.DAILY_LIMIT: "일한도",
}


class TradeTableModel(QAbstractTableModel):
    """Table model for backtest trade data."""

    COLUMNS = ['Symbol', 'Entry', 'Exit', 'P&L', 'P&L %', '청산사유']

    def __init__(self, parent: Optional[QWidget] = None):
        """Initialize trade table model."""
        super().__init__(parent)
        self._trades: list[Trade] = []

    def rowCount(self, parent: QModelIndex = QModelIndex()) -> int:
        """Return number of trades."""
        return len(self._trades)

    def columnCount(self, parent: QModelIndex = QModelIndex()) -> int:
        """Return number of columns."""
        return len(self.COLUMNS)

    def data(self, index: QModelIndex, role: int = Qt.DisplayRole) -> Any:
        """Return data for given index and role."""
        if not index.isValid() or index.row() >= len(self._trades):
            return None

        trade = self._trades[index.row()]
        col = index.column()

        if role == Qt.DisplayRole:
            return self._get_display_value(trade, col)
        elif role == Qt.ForegroundRole:
            return self._get_foreground_color(trade, col)
        elif role == Qt.TextAlignmentRole:
            if col in (3, 4):  # P&L columns
                return Qt.AlignRight | Qt.AlignVCenter
            return Qt.AlignLeft | Qt.AlignVCenter

        return None

    def _get_display_value(self, trade: Trade, col: int) -> str:
        """Get formatted display value for column."""
        if col == 0:
            return trade.symbol
        elif col == 1:
            return trade.entry_date.strftime('%Y-%m-%d') if trade.entry_date else ''
        elif col == 2:
            return trade.exit_date.strftime('%Y-%m-%d') if trade.exit_date else ''
        elif col == 3:
            if trade.pnl is None:
                return ''
            sign = '+' if trade.pnl >= 0 else ''
            return f"{sign}₩{trade.pnl:,.0f}"
        elif col == 4:
            if trade.pnl_pct is None:
                return ''
            sign = '+' if trade.pnl_pct >= 0 else ''
            return f"{sign}{trade.pnl_pct:.1f}%"
        elif col == 5:
            if trade.exit_reason is None:
                return ''
            return EXIT_REASON_LABELS.get(trade.exit_reason, str(trade.exit_reason.value))
        return ''

    def _get_foreground_color(self, trade: Trade, col: int) -> Optional[QColor]:
        """Get foreground color for P&L columns."""
        if col not in (3, 4):
            return None

        if col == 3 and trade.pnl is not None:
            return QColor('#4CAF50') if trade.pnl >= 0 else QColor('#F44336')
        elif col == 4 and trade.pnl_pct is not None:
            return QColor('#4CAF50') if trade.pnl_pct >= 0 else QColor('#F44336')

        return None

    def headerData(self, section: int, orientation: Qt.Orientation, role: int = Qt.DisplayRole) -> Any:
        """Return header data."""
        if orientation == Qt.Horizontal and role == Qt.DisplayRole:
            return self.COLUMNS[section]
        return None

    def set_trades(self, trades: list[Trade]) -> None:
        """Update trade data.

        Args:
            trades: List of trades to display
        """
        self.beginResetModel()
        self._trades = trades
        self.endResetModel()


class TradeHistoryWidget(QWidget):
    """Trade history table with export button."""

    export_clicked = Signal()

    def __init__(self, parent: Optional[QWidget] = None):
        """Initialize trade history widget."""
        super().__init__(parent)
        self._trades: list[Trade] = []
        self._setup_ui()

    def _setup_ui(self) -> None:
        """Setup the user interface."""
        layout = QVBoxLayout(self)

        # Header with title and export button
        header = QHBoxLayout()
        title = QLabel("Trade History")
        title.setStyleSheet("font-size: 16px; font-weight: bold;")
        header.addWidget(title)
        header.addStretch()

        export_btn = QPushButton("CSV 내보내기")
        export_btn.clicked.connect(self.export_clicked.emit)
        header.addWidget(export_btn)

        layout.addLayout(header)

        # Table view
        self._model = TradeTableModel()
        self._table = QTableView()
        self._table.setModel(self._model)
        self._table.setSortingEnabled(True)
        self._table.setAlternatingRowColors(True)
        self._table.setSelectionBehavior(QTableView.SelectRows)

        layout.addWidget(self._table)

    def set_trades(self, trades: list[Trade]) -> None:
        """Update displayed trades.

        Args:
            trades: List of trades to display
        """
        self._trades = trades
        self._model.set_trades(trades)
        self._table.resizeColumnsToContents()

    def get_trades(self) -> list[Trade]:
        """Get current trades for export."""
        return self._trades
```

## Success Criteria

### Acceptance Criteria
- [ ] TradeTableModel implements QAbstractTableModel correctly
- [ ] Table displays all 6 columns with proper headers
- [ ] P&L columns show green for positive, red for negative
- [ ] Exit reasons display Korean labels
- [ ] Table supports sorting by any column
- [ ] Export button emits export_clicked signal
- [ ] Empty trade list handled gracefully
- [ ] All methods have type hints and docstrings

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing with 80%+ coverage
  - [ ] Test TradeTableModel rowCount/columnCount
  - [ ] Test data() returns correct values for each column
  - [ ] Test P&L color coding logic
  - [ ] Test exit reason localization
  - [ ] Test set_trades() updates model correctly
  - [ ] Test export_clicked signal emission
- [ ] Code follows PEP 8 style guidelines
- [ ] Docstrings complete for all public methods

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Performance with large trade lists | Low | Medium | Use QAbstractTableModel (not storing display strings), test with 500+ trades |
| Sorting breaks with null values | Medium | Low | Handle None values in data() comparison, test edge cases |
| Color coding not visible in some themes | Low | Low | Use explicit colors, test on light/dark backgrounds |

## Notes and Clarifications

### Design Decisions
- 2025-12-30: Use QAbstractTableModel instead of QStandardItemModel for better performance with large datasets
- 2025-12-30: Korean headers for columns to match Korean exit reason labels
- 2025-12-30: Export button only emits signal; actual CSV writing handled by E10-F06

### Implementation Notes
- Column widths auto-resize on set_trades() for optimal readability
- Alternating row colors enabled for visual distinction
- Row selection mode for potential future copy functionality

---
*Template Version: 2.0.0 - Task Level Spec*
