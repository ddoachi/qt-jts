# Spec: E10-F05-T04 - Implement BacktestView and BacktestConfigWidget

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E10-F05-T04
clickup_task_id: ''
title: Implement BacktestView and BacktestConfigWidget
type: task

# === HIERARCHY ===
parent: E10-F05
children: []
epic: E10
feature: F05
task: T04
domain: backtesting

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 6
actual_hours: 0

# === METADATA ===
tags: [ui, pyside6, backtest-view, configuration, integration, sequential]
effort: large
risk: medium
parallel: false
---

**Status**: Draft
**Type**: Task
**Parent**: E10-F05 (UI Components)
**Created**: 2025-12-30
**Updated**: 2025-12-30
**Parallel**: [S] Must execute after T01, T02, T03 complete

## Executive Summary

Implement the `BacktestView` main container widget and `BacktestConfigWidget` configuration form. BacktestView integrates all child widgets (config, metrics, equity curve, trade history) into a cohesive vertical layout and coordinates data flow between them. BacktestConfigWidget provides a form for backtest configuration (strategy selection, date range, initial capital) and emits signals when the user starts a backtest. Progress indication is provided during execution.

## Execution Flow

```
1. Create BacktestConfigWidget for configuration form
   -> Import PySide6.QtWidgets (QWidget, QVBoxLayout, QHBoxLayout, QComboBox, QDateEdit, QLineEdit, QPushButton, QLabel)
   -> Create form layout with strategy selector, date pickers, capital input
   -> Create "백테스트 실행" button
   -> Define run_requested = Signal(BacktestConfig) for execution trigger

2. Implement BacktestConfigWidget form fields
   -> Strategy selector: QComboBox (populated externally)
   -> Start date: QDateEdit with date picker
   -> End date: QDateEdit with date picker
   -> Initial capital: QLineEdit with validator (numeric input)
   -> Optional: Commission %, Slippage % inputs

3. Implement BacktestConfigWidget validation
   -> Validate start_date < end_date
   -> Validate initial_capital > 0
   -> Validate strategy is selected
   -> If invalid: Show error styling, disable run button
   -> If valid: Enable run button

4. Implement BacktestConfigWidget run button handler
   -> On click: Collect form values
   -> Create BacktestConfig from form data
   -> Emit run_requested(config) signal
   -> Log configuration summary

5. Create BacktestView main container
   -> Import child widgets: BacktestConfigWidget, MetricsSummaryWidget, EquityCurveWidget, TradeHistoryWidget
   -> Create QVBoxLayout with all child widgets
   -> Add QScrollArea wrapper for overflow handling
   -> Define signals for coordination

6. Implement BacktestView layout structure
   -> Add BacktestConfigWidget at top
   -> Add QProgressBar (hidden by default)
   -> Add MetricsSummaryWidget
   -> Add EquityCurveWidget
   -> Add TradeHistoryWidget
   -> Apply spacing and margins

7. Implement BacktestView signal connections
   -> Connect config.run_requested to internal handler
   -> Connect trade_history.export_clicked to export handler
   -> Define backtest_started = Signal(BacktestConfig) for external handling
   -> Define backtest_completed = Signal(BacktestResult) for result notification
   -> Define export_requested = Signal() for CSV export

8. Implement set_result(result: BacktestResult) method
   -> Update MetricsSummaryWidget with result.metrics
   -> Update EquityCurveWidget with result.equity_curve, initial_capital
   -> Update TradeHistoryWidget with result.trades
   -> Hide progress bar
   -> Re-enable configuration form

9. Implement progress indication
   -> show_progress(current, total) method
   -> Update QProgressBar value
   -> Show estimated time remaining (optional)
   -> Disable config form during execution

10. Implement set_strategies(strategies) method
   -> Populate config widget strategy selector
   -> Used by parent to provide available strategies
```

## User Stories

### Primary User Story
**As a** trader
**I want to** configure and run backtests from a unified interface
**So that** I can easily test my strategies on historical data

### Additional Stories
- **As a** trader, **I want to** see progress during backtest execution, **So that** I know the system is working and can estimate completion time
- **As a** trader, **I want to** see all results (metrics, chart, trades) in one view, **So that** I can comprehensively analyze the backtest
- **As a** trader, **I want to** export trade history to CSV, **So that** I can perform additional analysis externally

## Acceptance Scenarios

### Scenario 1: Happy Path - Run Backtest
**Given** BacktestView is displayed with a strategy selected
**When** the user enters date range, capital, and clicks "백테스트 실행"
**Then** the backtest_started signal should be emitted with BacktestConfig
**And** the progress bar should be displayed
**And** the configuration form should be disabled

### Scenario 2: Display Backtest Results
**Given** a backtest has completed
**When** set_result(BacktestResult) is called
**Then** MetricsSummaryWidget should display metrics
**And** EquityCurveWidget should display equity curve
**And** TradeHistoryWidget should display trades
**And** progress bar should be hidden
**And** configuration form should be re-enabled

### Scenario 3: Configuration Validation Error
**Given** BacktestConfigWidget with end_date before start_date
**When** the form is validated
**Then** the run button should be disabled
**And** error styling should be applied to invalid fields
**And** no signal should be emitted on button click

### Scenario 4: Progress Update
**Given** a backtest is running
**When** progress(current=50, total=100) is called
**Then** the progress bar should show 50%
**And** the progress bar should be visible

### Scenario 5: Export Request
**Given** BacktestView is displaying results
**When** the user clicks export button in TradeHistoryWidget
**Then** the export_requested signal should be emitted from BacktestView
**And** trades should be accessible via get_trades() method

### Scenario 6: Strategy Selection
**Given** BacktestView is initialized
**When** set_strategies([strategy1, strategy2]) is called
**Then** the strategy ComboBox should contain both strategies
**And** the first strategy should be selected by default

## Requirements

### Functional Requirements
- **FR-001**: BacktestConfigWidget MUST provide strategy selector, date pickers, capital input
- **FR-002**: BacktestConfigWidget MUST validate input before emitting run signal
- **FR-003**: BacktestConfigWidget MUST emit run_requested signal with BacktestConfig
- **FR-004**: BacktestView MUST integrate all child widgets in vertical layout
- **FR-005**: BacktestView MUST provide set_result() to update all child widgets
- **FR-006**: BacktestView MUST show progress bar during execution
- **FR-007**: BacktestView MUST disable config during execution, re-enable after
- **FR-008**: BacktestView MUST emit export_requested when export clicked

### Non-Functional Requirements
- **NFR-001**: Widget layout MUST be responsive to window resize
- **NFR-002**: set_result() MUST complete in < 200ms (excluding chart rendering)
- **NFR-003**: Configuration validation MUST be instant (< 50ms)
- **NFR-004**: All public methods MUST have type hints and docstrings
- **NFR-005**: Code MUST follow PEP 8 style guidelines

### Technical Constraints
- **TC-001**: Must use PySide6.QtWidgets for all widgets
- **TC-002**: Must use BacktestConfig and BacktestResult from E10-F01
- **TC-003**: Must integrate T01, T02, T03 child widgets
- **TC-004**: Must use Qt Signal/Slot for widget coordination

## Key Entities

### Entity: BacktestConfigWidget
- **Description**: Configuration form for backtest parameters
- **Key Attributes**:
  - `_strategy_combo: QComboBox` - Strategy selector
  - `_start_date: QDateEdit` - Start date picker
  - `_end_date: QDateEdit` - End date picker
  - `_capital_input: QLineEdit` - Initial capital input
  - `_run_button: QPushButton` - Execute button
  - `run_requested: Signal(BacktestConfig)` - Execution signal
- **Key Methods**:
  - `set_strategies(strategies: list[Strategy])` - Populate strategy selector
  - `get_config() -> BacktestConfig` - Get current configuration
  - `validate() -> bool` - Validate form inputs
  - `set_enabled(enabled: bool)` - Enable/disable form

### Entity: BacktestView
- **Description**: Main container integrating all backtest widgets
- **Key Attributes**:
  - `_config_widget: BacktestConfigWidget` - Configuration form
  - `_metrics_widget: MetricsSummaryWidget` - Metrics display
  - `_equity_widget: EquityCurveWidget` - Equity chart
  - `_trades_widget: TradeHistoryWidget` - Trade table
  - `_progress_bar: QProgressBar` - Execution progress
  - `backtest_started: Signal(BacktestConfig)` - Start signal
  - `backtest_completed: Signal(BacktestResult)` - Complete signal
  - `export_requested: Signal()` - Export signal
- **Key Methods**:
  - `set_result(result: BacktestResult)` - Update all widgets with result
  - `set_progress(current: int, total: int)` - Update progress bar
  - `set_strategies(strategies: list[Strategy])` - Populate strategy selector
  - `clear()` - Clear all result displays

## Dependencies

### Upstream Dependencies
- [ ] E10-F05-T01: TradeHistoryWidget
- [ ] E10-F05-T02: MetricsSummaryWidget
- [ ] E10-F05-T03: EquityCurveWidget
- [ ] E10-F01: BacktestConfig, BacktestResult, Trade domain models
- [ ] E09: Strategy entity for selector
- [ ] E01-F01: Application framework integration

### Downstream Impact
- [ ] E10-F02: BacktestEngine will connect to backtest_started signal
- [ ] E10-F06: Export feature will connect to export_requested signal
- [ ] MainWindow: Will register BacktestView as a navigation view

## Implementation Details

### File Structure
```
apps/desktop/src/views/backtest_view.py
apps/desktop/src/widgets/backtest_config.py
tests/unit/views/test_backtest_view.py
tests/unit/widgets/test_backtest_config.py
```

### Code Skeleton
```python
from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QFormLayout,
    QComboBox, QDateEdit, QLineEdit, QPushButton,
    QLabel, QProgressBar, QScrollArea, QFrame
)
from PySide6.QtCore import Signal, QDate
from PySide6.QtGui import QDoubleValidator
from decimal import Decimal
from datetime import date
from typing import Optional

from libs.core.src.backtesting.domain.config import BacktestConfig
from libs.core.src.backtesting.domain.result import BacktestResult
from libs.core.src.strategy.domain.strategy import Strategy
from apps.desktop.src.widgets.metrics_summary import MetricsSummaryWidget
from apps.desktop.src.widgets.equity_curve import EquityCurveWidget
from apps.desktop.src.widgets.trade_history import TradeHistoryWidget


class BacktestConfigWidget(QWidget):
    """Configuration form for backtest parameters."""

    run_requested = Signal(object)  # Emits BacktestConfig

    def __init__(self, parent: Optional[QWidget] = None):
        """Initialize backtest configuration widget."""
        super().__init__(parent)
        self._strategies: list[Strategy] = []
        self._setup_ui()
        self._connect_signals()

    def _setup_ui(self) -> None:
        """Setup the user interface."""
        layout = QVBoxLayout(self)

        # Form layout
        form_layout = QFormLayout()

        # Strategy selector
        self._strategy_combo = QComboBox()
        form_layout.addRow("Strategy:", self._strategy_combo)

        # Date range row
        date_layout = QHBoxLayout()
        self._start_date = QDateEdit()
        self._start_date.setCalendarPopup(True)
        self._start_date.setDate(QDate.currentDate().addYears(-1))
        date_layout.addWidget(QLabel("Start:"))
        date_layout.addWidget(self._start_date)

        self._end_date = QDateEdit()
        self._end_date.setCalendarPopup(True)
        self._end_date.setDate(QDate.currentDate())
        date_layout.addWidget(QLabel("End:"))
        date_layout.addWidget(self._end_date)
        date_layout.addStretch()

        form_layout.addRow("Period:", date_layout)

        # Initial capital
        capital_layout = QHBoxLayout()
        self._capital_input = QLineEdit("100000000")
        self._capital_input.setValidator(QDoubleValidator(0, 1e12, 0))
        capital_layout.addWidget(self._capital_input)
        capital_layout.addWidget(QLabel("KRW"))
        capital_layout.addStretch()
        form_layout.addRow("Capital:", capital_layout)

        layout.addLayout(form_layout)

        # Run button
        button_layout = QHBoxLayout()
        button_layout.addStretch()
        self._run_button = QPushButton("백테스트 실행")
        self._run_button.setStyleSheet("""
            QPushButton {
                background-color: #2196F3;
                color: white;
                font-weight: bold;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
            }
            QPushButton:hover {
                background-color: #1976D2;
            }
            QPushButton:disabled {
                background-color: #BDBDBD;
            }
        """)
        button_layout.addWidget(self._run_button)

        layout.addLayout(button_layout)

    def _connect_signals(self) -> None:
        """Connect internal signals."""
        self._run_button.clicked.connect(self._on_run_clicked)
        self._start_date.dateChanged.connect(self._validate)
        self._end_date.dateChanged.connect(self._validate)
        self._capital_input.textChanged.connect(self._validate)

    def _on_run_clicked(self) -> None:
        """Handle run button click."""
        if not self.validate():
            return

        config = self.get_config()
        if config:
            self.run_requested.emit(config)

    def validate(self) -> bool:
        """Validate form inputs.

        Returns:
            True if all inputs are valid
        """
        # Check strategy selected
        if self._strategy_combo.currentIndex() < 0:
            return False

        # Check date range
        if self._start_date.date() >= self._end_date.date():
            return False

        # Check capital
        try:
            capital = float(self._capital_input.text().replace(',', ''))
            if capital <= 0:
                return False
        except ValueError:
            return False

        return True

    def _validate(self) -> None:
        """Update run button state based on validation."""
        self._run_button.setEnabled(self.validate())

    def get_config(self) -> Optional[BacktestConfig]:
        """Create BacktestConfig from form values.

        Returns:
            BacktestConfig if valid, None otherwise
        """
        if not self.validate():
            return None

        strategy_idx = self._strategy_combo.currentIndex()
        strategy = self._strategies[strategy_idx] if strategy_idx >= 0 else None

        if strategy is None:
            return None

        return BacktestConfig(
            strategy=strategy,
            symbols=strategy.symbols if hasattr(strategy, 'symbols') else [],
            start_date=self._start_date.date().toPython(),
            end_date=self._end_date.date().toPython(),
            initial_capital=Decimal(self._capital_input.text().replace(',', '')),
            commission_pct=0.015,
            slippage_pct=0.05,
            timeframe="1d"
        )

    def set_strategies(self, strategies: list[Strategy]) -> None:
        """Populate strategy selector.

        Args:
            strategies: List of available strategies
        """
        self._strategies = strategies
        self._strategy_combo.clear()
        for strategy in strategies:
            self._strategy_combo.addItem(strategy.name)

    def set_enabled(self, enabled: bool) -> None:
        """Enable or disable the form.

        Args:
            enabled: True to enable, False to disable
        """
        self._strategy_combo.setEnabled(enabled)
        self._start_date.setEnabled(enabled)
        self._end_date.setEnabled(enabled)
        self._capital_input.setEnabled(enabled)
        self._run_button.setEnabled(enabled and self.validate())


class BacktestView(QWidget):
    """Main backtest view container."""

    backtest_started = Signal(object)  # Emits BacktestConfig
    backtest_completed = Signal(object)  # Emits BacktestResult
    export_requested = Signal()

    def __init__(self, parent: Optional[QWidget] = None):
        """Initialize backtest view."""
        super().__init__(parent)
        self._setup_ui()
        self._connect_signals()

    def _setup_ui(self) -> None:
        """Setup the user interface."""
        main_layout = QVBoxLayout(self)

        # Scroll area for content
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setFrameShape(QFrame.NoFrame)

        content = QWidget()
        layout = QVBoxLayout(content)
        layout.setSpacing(16)

        # Configuration section
        self._config_widget = BacktestConfigWidget()
        layout.addWidget(self._config_widget)

        # Progress bar (hidden by default)
        self._progress_bar = QProgressBar()
        self._progress_bar.setVisible(False)
        self._progress_bar.setTextVisible(True)
        layout.addWidget(self._progress_bar)

        # Metrics summary
        self._metrics_widget = MetricsSummaryWidget()
        layout.addWidget(self._metrics_widget)

        # Equity curve
        self._equity_widget = EquityCurveWidget()
        self._equity_widget.setMinimumHeight(300)
        layout.addWidget(self._equity_widget)

        # Trade history
        self._trades_widget = TradeHistoryWidget()
        self._trades_widget.setMinimumHeight(200)
        layout.addWidget(self._trades_widget)

        scroll.setWidget(content)
        main_layout.addWidget(scroll)

    def _connect_signals(self) -> None:
        """Connect child widget signals."""
        self._config_widget.run_requested.connect(self._on_run_requested)
        self._trades_widget.export_clicked.connect(self.export_requested.emit)

    def _on_run_requested(self, config: BacktestConfig) -> None:
        """Handle backtest run request.

        Args:
            config: Backtest configuration
        """
        self._config_widget.set_enabled(False)
        self._progress_bar.setValue(0)
        self._progress_bar.setVisible(True)
        self.backtest_started.emit(config)

    def set_result(self, result: BacktestResult) -> None:
        """Update all widgets with backtest result.

        Args:
            result: Completed backtest result
        """
        # Update child widgets
        self._metrics_widget.set_metrics(result.metrics)
        self._equity_widget.set_data(result.equity_curve, result.config.initial_capital)
        self._trades_widget.set_trades(result.trades)

        # Hide progress, re-enable config
        self._progress_bar.setVisible(False)
        self._config_widget.set_enabled(True)

        # Emit completion signal
        self.backtest_completed.emit(result)

    def set_progress(self, current: int, total: int) -> None:
        """Update progress bar.

        Args:
            current: Current progress value
            total: Total progress value
        """
        if total > 0:
            percentage = int((current / total) * 100)
            self._progress_bar.setValue(percentage)
            self._progress_bar.setFormat(f"Processing... {current}/{total} days ({percentage}%)")

    def set_strategies(self, strategies: list[Strategy]) -> None:
        """Set available strategies for selection.

        Args:
            strategies: List of strategies
        """
        self._config_widget.set_strategies(strategies)

    def clear(self) -> None:
        """Clear all result displays."""
        self._metrics_widget.clear_metrics()
        self._equity_widget.clear()
        self._trades_widget.set_trades([])

    def get_trades(self) -> list:
        """Get current trades for export.

        Returns:
            List of trades
        """
        return self._trades_widget.get_trades()
```

## Success Criteria

### Acceptance Criteria
- [ ] BacktestConfigWidget displays strategy selector, date pickers, capital input
- [ ] Form validation prevents invalid configurations
- [ ] Run button emits run_requested signal with BacktestConfig
- [ ] BacktestView integrates all child widgets in vertical layout
- [ ] set_result() updates all child widgets correctly
- [ ] Progress bar shows during execution
- [ ] Config form disabled during execution, re-enabled after
- [ ] Export button click propagates to export_requested signal
- [ ] All methods have type hints and docstrings

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing with 80%+ coverage
  - [ ] Test BacktestConfigWidget validation
  - [ ] Test run_requested signal emission
  - [ ] Test BacktestView integration
  - [ ] Test set_result() updates all widgets
  - [ ] Test progress bar visibility
  - [ ] Test form enable/disable states
- [ ] Integration test with mock data
- [ ] Code follows PEP 8 style guidelines
- [ ] Docstrings complete for all public methods

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Widget integration issues | Medium | Medium | Test each widget independently first, then integration |
| Layout issues on resize | Low | Low | Use scroll area, test various window sizes |
| Signal connection errors | Low | Medium | Log signal emissions, unit test connections |
| Form validation edge cases | Medium | Low | Comprehensive validation tests |

## Notes and Clarifications

### Design Decisions
- 2025-12-30: Use QScrollArea to handle overflow when window is small
- 2025-12-30: Emit object type for signals to avoid PySide6 type registration issues with custom classes
- 2025-12-30: Default date range to last year to current date
- 2025-12-30: Use Korean button text "백테스트 실행" for consistency

### Implementation Notes
- BacktestView coordinates widgets but does not run backtest itself
- Actual backtest execution handled by E10-F02 (BacktestEngine)
- Strategy list populated by parent controller/presenter

### Integration Points
- MainWindow registers BacktestView as "backtesting" view
- BacktestEngine connects to backtest_started signal
- Export feature connects to export_requested signal

---
*Template Version: 2.0.0 - Task Level Spec*
