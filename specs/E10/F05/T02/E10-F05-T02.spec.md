# Spec: E10-F05-T02 - Implement MetricsSummaryWidget

---
# ============================================================================
# SPEC METADATA
# ============================================================================

# === IDENTIFICATION ===
id: E10-F05-T02
clickup_task_id: '86ew0ftzd'
title: Implement MetricsSummaryWidget
type: task

# === HIERARCHY ===
parent: E10-F05
children: []
epic: E10
feature: F05
task: T02
domain: backtesting

# === WORKFLOW ===
status: draft
priority: high

# === TRACKING ===
created: '2025-12-30'
updated: '2025-12-30'
due_date: ''
estimated_hours: 3
actual_hours: 0

# === METADATA ===
tags: [ui, pyside6, metrics, card-widget, performance-summary, parallel]
effort: small
risk: low
parallel: true
---

**Status**: Draft
**Type**: Task
**Parent**: E10-F05 (UI Components)
**Created**: 2025-12-30
**Updated**: 2025-12-30
**Parallel**: [P] Can be executed in parallel with T01, T03

## Executive Summary

Implement the `MetricsSummaryWidget` that displays key backtest performance metrics as a horizontal row of card widgets. The widget shows 5 metrics: Total Return (%), Sharpe Ratio, Max Drawdown (%), Win Rate (%), and Total Trades. Each card includes value formatting, Korean labels, and color coding for the return metric (green for positive, red for negative).

## Execution Flow

```
1. Create MetricsSummaryWidget inheriting from QWidget
   -> Import PySide6.QtWidgets (QWidget, QHBoxLayout, QFrame, QVBoxLayout, QLabel)
   -> Initialize card registry: self._cards: dict[str, QFrame] = {}
   -> Define metric configuration for 5 cards

2. Define metric card configuration
   -> Create card definitions with:
     -> key: str (internal identifier)
     -> label: str (Korean display label)
     -> format: str (format string for value)
     -> initial_value: str (default display)
   -> Cards: return (수익률), sharpe (샤프), drawdown (최대낙폭), win_rate (승률), trades (거래수)

3. Create _setup_ui() method
   -> Create QHBoxLayout for horizontal card arrangement
   -> For each metric in card config:
     -> Create card using _create_card() method
     -> Store card in self._cards[key]
     -> Add card to layout
   -> Set spacing between cards (10px)

4. Implement _create_card(label, initial_value) method
   -> Create QFrame with styled border and background
   -> Create QVBoxLayout inside frame
   -> Add value QLabel with large font, bold, centered
   -> Set value label objectName to "value" for lookup
   -> Add name QLabel with smaller font, gray color, centered
   -> Apply rounded border stylesheet to frame
   -> Return configured QFrame

5. Implement set_metrics(metrics: PerformanceMetrics) method
   -> Format and set return value with sign prefix
   -> Format sharpe ratio to 2 decimal places
   -> Format max drawdown with percentage
   -> Format win rate with percentage
   -> Format total trades as integer
   -> Apply color coding to return card

6. Implement _set_card_value(key, value) helper
   -> Find card by key in self._cards
   -> Find QLabel with objectName "value"
   -> Update label text with new value

7. Implement _apply_color(key, is_positive) helper
   -> Get card frame from self._cards
   -> If is_positive: Set background to light green (#e8f5e9)
   -> If not is_positive: Set background to light red (#ffebee)
   -> Update stylesheet maintaining rounded borders
```

## User Stories

### Primary User Story
**As a** trader
**I want to** see my backtest performance metrics at a glance
**So that** I can quickly evaluate how well my strategy performed

### Additional Stories
- **As a** trader, **I want to** see Korean labels for metrics, **So that** I can understand them in my native language
- **As a** trader, **I want to** see color-coded returns, **So that** I can instantly identify profitable vs losing backtests

## Acceptance Scenarios

### Scenario 1: Happy Path - Display Metrics
**Given** MetricsSummaryWidget is initialized
**When** set_metrics() is called with PerformanceMetrics data
**Then** all 5 metric cards should display correct values
**And** values should be properly formatted (%, ratio, count)
**And** Korean labels should be displayed

### Scenario 2: Positive Return Color Coding
**Given** MetricsSummaryWidget displays a backtest result
**When** total_return_pct is >= 0 (e.g., +45.2%)
**Then** the return card should have green background (#e8f5e9)
**And** the value should be prefixed with "+"

### Scenario 3: Negative Return Color Coding
**Given** MetricsSummaryWidget displays a backtest result
**When** total_return_pct is < 0 (e.g., -12.5%)
**Then** the return card should have red background (#ffebee)
**And** the value should show the negative sign

### Scenario 4: Initial State
**Given** MetricsSummaryWidget is created
**When** no metrics have been set
**Then** all cards should display initial placeholder values
**And** return card should have neutral background

### Scenario 5: Value Formatting
**Given** metrics with total_return_pct=45.23, sharpe_ratio=1.857, max_drawdown_pct=-12.34
**When** set_metrics() is called
**Then** return should display "+45.2%"
**And** sharpe should display "1.86"
**And** drawdown should display "-12.3%"

## Requirements

### Functional Requirements
- **FR-001**: Widget MUST display 5 metric cards in horizontal layout
- **FR-002**: Cards MUST show: Return, Sharpe, Drawdown, Win Rate, Trades
- **FR-003**: Return card MUST be color coded (green positive, red negative)
- **FR-004**: Values MUST be formatted appropriately (%, ratio, integer)
- **FR-005**: Labels MUST be displayed in Korean
- **FR-006**: Widget MUST provide set_metrics() method for data update
- **FR-007**: Cards MUST have consistent styling and sizing

### Non-Functional Requirements
- **NFR-001**: set_metrics() MUST complete in < 50ms
- **NFR-002**: Widget MUST be responsive to parent container resize
- **NFR-003**: All public methods MUST have type hints and docstrings
- **NFR-004**: Code MUST follow PEP 8 style guidelines

### Technical Constraints
- **TC-001**: Must use PySide6.QtWidgets.QWidget as base
- **TC-002**: Must use QFrame for card containers
- **TC-003**: Must use PerformanceMetrics from E10-F01
- **TC-004**: Must support both light and dark themes

## Key Entities

### Entity: MetricsSummaryWidget
- **Description**: Horizontal row of metric cards
- **Key Attributes**:
  - `_cards: dict[str, QFrame]` - Card widget registry
- **Key Methods**:
  - `__init__(parent)` - Constructor
  - `_setup_ui()` - Initialize UI layout
  - `_create_card(label, initial_value) -> QFrame` - Create metric card
  - `set_metrics(metrics: PerformanceMetrics)` - Update displayed metrics
  - `_set_card_value(key, value)` - Update single card value
  - `_apply_color(key, is_positive)` - Apply color coding

### Entity: MetricCard (Internal)
- **Description**: Single metric card (QFrame)
- **Components**: Value label (large, bold), Name label (small, gray)
- **Styling**: Rounded corners, light background, subtle border

## Dependencies

### Upstream Dependencies
- [ ] E10-F01: PerformanceMetrics dataclass (domain models)
- [ ] E01-F01: Base widget styling conventions (application framework)

### Downstream Impact
- [ ] T04: BacktestView will integrate MetricsSummaryWidget

## Implementation Details

### File Structure
```
apps/desktop/src/widgets/metrics_summary.py
tests/unit/widgets/test_metrics_summary.py
```

### Code Skeleton
```python
from PySide6.QtWidgets import QWidget, QHBoxLayout, QVBoxLayout, QFrame, QLabel
from PySide6.QtCore import Qt
from typing import Optional, NamedTuple
from libs.core.src.backtesting.domain.metrics import PerformanceMetrics


class MetricConfig(NamedTuple):
    """Configuration for a metric card."""
    key: str
    label: str
    initial_value: str


class MetricsSummaryWidget(QWidget):
    """Display key performance metrics as cards."""

    METRIC_CONFIGS = [
        MetricConfig("return", "수익률", "+0.0%"),
        MetricConfig("sharpe", "샤프", "0.00"),
        MetricConfig("drawdown", "최대낙폭", "0.0%"),
        MetricConfig("win_rate", "승률", "0%"),
        MetricConfig("trades", "거래수", "0"),
    ]

    def __init__(self, parent: Optional[QWidget] = None):
        """Initialize metrics summary widget."""
        super().__init__(parent)
        self._cards: dict[str, QFrame] = {}
        self._setup_ui()

    def _setup_ui(self) -> None:
        """Setup the user interface."""
        layout = QHBoxLayout(self)
        layout.setSpacing(10)
        layout.setContentsMargins(0, 0, 0, 0)

        for config in self.METRIC_CONFIGS:
            card = self._create_card(config.label, config.initial_value)
            self._cards[config.key] = card
            layout.addWidget(card)

    def _create_card(self, label: str, initial_value: str) -> QFrame:
        """Create a metric card widget.

        Args:
            label: Korean label for the metric
            initial_value: Initial display value

        Returns:
            Configured QFrame card widget
        """
        card = QFrame()
        card.setFrameStyle(QFrame.Box)
        card.setStyleSheet("""
            QFrame {
                background: #f5f5f5;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 10px;
            }
        """)
        card.setMinimumWidth(120)
        card.setMinimumHeight(80)

        layout = QVBoxLayout(card)
        layout.setSpacing(4)

        # Value label (large, bold, centered)
        value_label = QLabel(initial_value)
        value_label.setObjectName("value")
        value_label.setStyleSheet("""
            font-size: 24px;
            font-weight: bold;
            color: #333333;
        """)
        value_label.setAlignment(Qt.AlignCenter)
        layout.addWidget(value_label)

        # Name label (small, gray, centered)
        name_label = QLabel(label)
        name_label.setStyleSheet("""
            font-size: 12px;
            color: #666666;
        """)
        name_label.setAlignment(Qt.AlignCenter)
        layout.addWidget(name_label)

        return card

    def set_metrics(self, metrics: PerformanceMetrics) -> None:
        """Update display with performance metrics.

        Args:
            metrics: Performance metrics from backtest result
        """
        # Format and set values
        return_str = f"{metrics.total_return_pct:+.1f}%"
        self._set_card_value("return", return_str)

        self._set_card_value("sharpe", f"{metrics.sharpe_ratio:.2f}")
        self._set_card_value("drawdown", f"{metrics.max_drawdown_pct:.1f}%")
        self._set_card_value("win_rate", f"{metrics.win_rate:.0f}%")
        self._set_card_value("trades", str(metrics.total_trades))

        # Apply color coding to return card
        self._apply_color("return", metrics.total_return_pct >= 0)

    def _set_card_value(self, key: str, value: str) -> None:
        """Update a card's displayed value.

        Args:
            key: Card key identifier
            value: New value to display
        """
        if key not in self._cards:
            return

        card = self._cards[key]
        value_label = card.findChild(QLabel, "value")
        if value_label:
            value_label.setText(value)

    def _apply_color(self, key: str, is_positive: bool) -> None:
        """Apply color coding to a card.

        Args:
            key: Card key identifier
            is_positive: True for green (positive), False for red (negative)
        """
        if key not in self._cards:
            return

        card = self._cards[key]
        bg_color = "#e8f5e9" if is_positive else "#ffebee"
        border_color = "#c8e6c9" if is_positive else "#ffcdd2"

        card.setStyleSheet(f"""
            QFrame {{
                background: {bg_color};
                border: 1px solid {border_color};
                border-radius: 8px;
                padding: 10px;
            }}
        """)

    def clear_metrics(self) -> None:
        """Reset all cards to initial state."""
        for config in self.METRIC_CONFIGS:
            self._set_card_value(config.key, config.initial_value)

        # Reset return card color to neutral
        if "return" in self._cards:
            self._cards["return"].setStyleSheet("""
                QFrame {
                    background: #f5f5f5;
                    border: 1px solid #e0e0e0;
                    border-radius: 8px;
                    padding: 10px;
                }
            """)
```

## Success Criteria

### Acceptance Criteria
- [ ] Widget displays 5 metric cards in horizontal layout
- [ ] Cards show Korean labels (수익률, 샤프, 최대낙폭, 승률, 거래수)
- [ ] Return card shows green background for positive returns
- [ ] Return card shows red background for negative returns
- [ ] Values are formatted correctly (%, ratio, integer)
- [ ] Cards have consistent sizing and styling
- [ ] set_metrics() updates all card values
- [ ] All methods have type hints and docstrings

### Definition of Done
- [ ] Code reviewed and approved
- [ ] Unit tests passing with 80%+ coverage
  - [ ] Test widget initialization with default values
  - [ ] Test set_metrics() updates all cards
  - [ ] Test positive return color coding
  - [ ] Test negative return color coding
  - [ ] Test value formatting precision
  - [ ] Test clear_metrics() resets state
- [ ] Code follows PEP 8 style guidelines
- [ ] Docstrings complete for all public methods

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Card sizing issues on different screens | Low | Low | Use minimum sizes, test on various resolutions |
| Color coding visibility in dark theme | Medium | Low | Test on both themes, use sufficient contrast |
| findChild() performance | Very Low | Low | Cache label references if needed |

## Notes and Clarifications

### Design Decisions
- 2025-12-30: Use QFrame for cards instead of custom widget for simplicity and stylesheet support
- 2025-12-30: Use findChild() for value label lookup rather than direct reference for cleaner code
- 2025-12-30: Only color code return card; other metrics don't have clear positive/negative interpretation

### Implementation Notes
- Cards use fixed minimum size to prevent collapse
- Stylesheet-based styling allows easy theme customization
- clear_metrics() method provided for resetting widget state

---
*Template Version: 2.0.0 - Task Level Spec*
